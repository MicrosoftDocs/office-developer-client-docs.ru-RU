---
title: Многопоточные вычисления в Excel
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: reference
keywords:
- потоками ячеек [excel 2007], многопоточность в Excel, параллельных задач [Excel 2007], являющихся потокобезопасными функции [Excel 2007], многопоточные вычисления [Excel 2007], MTR [Excel 2007], регистрация в качестве потокобезопасными, пересчета [функции XLL [Excel 2007] Excel 2007], многопоточные, объем памяти, конфликтов [Excel 2007], регистрация XLL функции как поток безопасные небезопасные функции [Excel 2007], [Excel 2007]
localization_priority: Normal
ms.assetid: c6c831f1-4be1-4dcc-a0fa-c26052ec53c9
description: '������� ����������: Excel 2013�| Office 2013�| Visual Studio'
ms.openlocfilehash: 010a1029e0bf5ba1a36b324ebd402f6e90603fb9
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2018
ms.locfileid: "19807310"
---
# <a name="multithreaded-recalculation-in-excel"></a>Многопоточные вычисления в Excel

**Применимо к**: Excel 2013 | Office 2013 | Visual Studio 
  
Microsoft Office Excel 2007 был первая версия Excel для использования многопоточные вычисления (MTR) таблиц. Вы можете настроить Excel для до 1024 параллельных потоков пересчет, независимо от количества процессоров или ядер процессора на компьютере. 
  
> [!NOTE]
> С каждым потоком связаны затраты ресурсов операционной системы, поэтому не следует настраивать в Excel использование большего числа потоков, чем необходимо. 
  
Если компьютер имеет несколько процессоров или ядер, за эффективное распределение потоков между процессорами отвечает операционная система.
  
## <a name="excel-mtr-overview"></a>Обзор Excel MTR

Excel пытается определить части цепочки вычисления, которые можно пересчитывать одновременно в разных потоках. Ниже в качестве примера приведено очень простое дерево (где "x ← y" означает, что y зависит только от x).
  
**На рисунке 1. Параллельное вычисление на различных потоках**

![Вычисление одновременно на различных потоках] (media/12b5a52b-6308-420c-b6cf-492bd1f195ce.gif "Вычисление одновременно на различных потоках")
  
Когда выполнено вычисление для ячейки A1, можно последовательно выполнить вычисление для ячеек A2 и A3 в одном потоке, в то время как в другом потоке последовательно выполняются вычисления для B1 и C1. Это возможно при условии, что все ячейки потокобезопасны. 
  
> [!NOTE]
> Ячейка потоками терминов означает, что ячейка, которая содержит только функции являющихся потокобезопасными. Подробное описание какой используется и не являющихся потокобезопасными [и является не считаются потока безопасных по Excel](#xl2007xllsdk_threadsafe). 
  
Наиболее удобным книги содержат более сложных деревья зависимостей, чем в этом примере. Кроме того время пересчета ячейки не может быть известен, пока вычисление выполняется и не может значительно изменяться в зависимости от аргументы функций. Чтобы получить наилучшие результаты, пытается улучшить порядок вычисления на каждом вычислений, пока не будет невозможно без дополнительных оптимизации Excel.
  
Приложение Excel использует один основной поток для запуска или выполнения следующего:
  
- встроенных команд;
    
- команд XLL;
    
- Функции интерфейса диспетчера надстроек XLL (**xlAutoOpen** функции и т. д.) 
    
- пользовательских команд Microsoft Visual Basic для приложений (VBA), часто называемых макросами;
    
- пользовательских функций VBA;
    
- встроенных потоконебезопасных функций листа (см. список в следующем разделе);
    
- пользовательских команд и функций листа макросов XLM;
    
- функций и команд надстроек COM;
    
- функций и операторов в выражениях условного форматирования;
    
- функций и операторов в определениях имен, используемых в формулах листа;
    
- Принудительное вычисление выражения в поле изменить формулу, с помощью клавиши **F9** 
    
Вычисления по всем формулам листа, независимо от того, потокобезопасны функции или нет, выполняются в основном потоке, если не настроено использование нескольких потоков в Excel. Когда пользователь указывает, что следует использовать несколько потоков, дополнительные потоки используются для потокобезопасных ячеек. Обратите внимание, что основной поток также может использоваться для потокобезопасных ячеек, когда это целесообразно для балансировки нагрузки.
  
Стоит отметить, что Excel не выполняет более одной команды за раз, поэтому необязательно применять те же меры предосторожности, что и при написании потокобезопасных функций, например использовать локальную память потока и критические секции.
  
## <a name="what-is-and-is-not-considered-thread-safe-by-excel"></a>Какой используется и не является поток безопасных с Excel
<a name="xl2007xllsdk_threadsafe"> </a>

Потокобезопасными считаются только следующие элементы в Excel:
  
- все унарные и бинарные операторы в Excel;
    
- Практически во всех встроенных функций, начиная с версии Excel 2007 (см. список исключений)
    
- функции надстроек XLL, явно зарегистрированные как потокобезопасные.
    
Потоконебезопасные встроенные функции листа:
  
- **ФОНЕТИЧЕСКОЕ**
    
- **ЯЧЕЙКИ** , когда используется аргумент «адрес» или «формат» 
    
- **INDIRECT**
    
- **ПОЛУЧИТЬ.ДАННЫЕ.СВОДНОЙ.ТАБЛИЦЫ**
    
- **КУБЭЛЕМЕНТ**
    
- **КУБЗНАЧЕНИЕ**
    
- **КУБСВОЙСТВОЭЛЕМЕНТА**
    
- **КУБМНОЖ**
    
- **КУБПОРЭЛЕМЕНТ**
    
- **КУБЭЛЕМЕНТКИП**
    
- **КУБЧИСЛОЭЛМНОЖ**
    
- **Адрес** , где он получает параметр пятый (sheet_name) 
    
- Базы данных все функции (**DSUM**, **DAVERAGE**и т. д.), который относится к сводной таблицы
    
- **ОШИБКА. ТИП**
    
- **ГИПЕРССЫЛКИ**
    
Следующие элементы считаются небезопасными:
  
- пользовательские функции VBA;
    
- пользовательские функции надстроек COM;
    
- пользовательские функции листа макросов XLM;
    
- функции надстроек XLL, не зарегистрированные как потокобезопасные.
    
Вывод: следующие операции и функции потоконебезопасны и дают сбой при вызове из функции XLL, зарегистрированной как потокобезопасная:
  
- Вызовы функций XLM информации, например, **xlfGetCell** (**GET. Ячейка**).
    
- Вызывает **xlfSetName** (**SET.NAME**) для определения или удалить внутренние имена XLL.
    
- Вызовы для потока небезопасных пользовательских функций, с помощью **xlUDF**.
    
- Вызывает функцию [xlfEvaluate](xlfevaluate.md) выражения, которые содержат потока небезопасные функции или, которые содержат определенные имена, определения содержат потока небезопасные функции. 
    
- Вызовы функции [xlAbort](xlabort.md) снимите условия останова. 
    
- Вызовы функции [xlCoerce](xlcoerce.md) для получения значения ссылки на не вычисленной ячейки. 
    
> [!NOTE]
> Функции листа XLL не разрешены для вызова команд интерфейса API для C, например, **xlcSave**, независимо от того, является ли они зарегистрированных как потокобезопасными или нет. 
  
Учитывая, что функции XLL, объявленные как потокобезопасными не может вызывать информационные функции XML или ссылки на ячейки невычисляемая, Excel не разрешает функции XLL, зарегистрированные в качестве эквивалентами листа макросов также быть зарегистрирована как потокобезопасными. Поэтому попытки подключения для получения значения с помощью **xlCoerce** ссылки не вычисленной ячейки не удается выполнить с ошибкой **xlretUncalced** . Вызов XLM сведения о функции не удается выполнить с ошибкой **xlretFailed** . Другие точки из списка ранее ошибкой с кодом ошибки, представлено в Excel C API: **xlretNotThreadSafe**. 
  
Все функции обратного вызова C API потокобезопасны:
  
- **xlCoerce** (за исключением хотя приведения не вычисленной ячейки ссылается на возникает ошибка) 
    
- **xlFree**
    
- **xlStack**
    
- **xlSheetId**
    
- **xlSheetNm**
    
- **xlAbort** (за исключением при использовании снимите условие прерывания) 
    
- **xlGetInst**
    
- **xlGetHwnd**
    
- **xlGetBinaryName**
    
- **xlDefineBinaryName**
    
Одно исключение — это функция **функция xlSet** , то есть, в любом случае эквивалент команды и поэтому не могут быть вызваны любой функции рабочего листа. 
  
Функцию листа XLL можно зарегистрировать в Excel как потокобезопасную. В этом случае Excel будет знать, что вызов функции безопасен и возможен одновременно в нескольких потоках. Но необходимо убедиться, что это действительно так. Работа Excel может быть нарушена, если функция, зарегистрированная как потокобезопасная, окажется небезопасной.
  
## <a name="registering-xll-functions-as-thread-safe"></a>Регистрация функции XLL в качестве потокобезопасными
<a name="xl2007xllsdk_threadsafe"> </a>

Правила, которым должен следовать разработчик при написании потокобезопасных функций:
  
- Не вызывайте ресурсы в других библиотеках DLL, которые могут быть потоконебезопасными.
    
- Не осуществляйте потоконебезопасные вызовы с помощью C API или COM.
    
- Защищайте ресурсы, которые могут использоваться одновременно несколькими потоками, с помощью критических секций.
    
- Используйте локальную память потока для хранения данных потока и заменяйте статические переменные в функциях локальными переменными потока.
    
В Excel действует дополнительное ограничение: потокобезопасные функции невозможно зарегистрировать как эквивалентные функциям листа макросов, поэтому они не могут вызывать информационные функции XLM и получать значения непересчитанных ячеек.
  
## <a name="memory-contention"></a>Конфликты памяти
<a name="xl2007xllsdk_threadsafe"> </a>

При создании многопотоковых систем необходимо решить две фундаментальные проблемы:
  
- Как защитить память, чтение или запись данных которой должны выполнять несколько потоков.
    
- Как создать память, связанную с выполняемым потоком, и получить к ней доступ.
    
Операционная система Windows и Windows Software Development Kit (SDK) предоставляют средства для обоих приведенных: критические разделы и API хранилища локального потока (TLS) соответственно. Дополнительные сведения содержатся в разделе [Управление памятью в Excel](memory-management-in-excel.md).
  
Первая проблема может возникнуть, например, когда двум функциям листа (или двум параллельно выполняемым экземплярам одной функции) нужен доступ к глобальной переменной в проекте DLL (например, для ее изменения). Помните, что эта переменная может быть скрыта в глобально доступном экземпляре объекта класса.
  
Вторая проблема может возникнуть, например, когда функция листа объявляет статическую переменную или объект в коде функции. Компилятор C/C++ создает только одну копию, которую используют все потоки. Это означает, что один экземпляр функции может изменить значение, а другой (в другом потоке) может использовать ранее заданное значение.
  
## <a name="example-applications-of-mtr"></a>Примеры приложений MTR
<a name="xl2007xllsdk_threadsafe"> </a>

Любой XLL-модуль, который экспортирует функции листа, может использовать многопотоковый пересчет (MTR) в Excel, если эти функции не должны выполнять потоконебезопасные действия. Это позволяет Excel максимально быстро выполнять пересчет в книгах, в которых они используются, и поэтому MTR рекомендуется применять всегда.
  
В частности MTR имеет огромное влияние на время пересчета книги, которые могут вызывать пользовательские функции (UDF), сами вызова внешних процессы, используемые для получения нужного результата. В частности необходимо учитывайте UDF, который вызывает удаленного сервера, на котором можно одновременно обработать большое количество запросов и книги, содержащий много вызовов этой функции. Если пересчета книги в одном потоке, каждый вызов пользовательских Функций и поэтому к удаленному серверу, необходимо выполнить перед выполнением следующего. Выполняется это пустая способность сервера обрабатывать вызовы много раз. Если многопоточные пересчета книги Excel можно сделать несколько вызовов в то же время или быстро.
  
Если в Excel и на сервере настроено использование одинакового количества потоков (N), при этом топология дерева зависимостей книги позволяет это, общее время пересчета можно сократить до значения, которое стремится к 1/N. Это возможно, даже если у клиентского компьютера (на котором обрабатывается книга) всего один процессор, особенно если время вызова сервера невелико по сравнению с временем обработки вызова сервером. 
  
С каждым дополнительным потоком связаны затраты ресурсов операционной системы. Поэтому оптимальное количество потоков, которое должно использовать приложение Excel, для каждой книги, сервера и клиентского компьютера определяется опытным путем. 
  
Рассмотрим компьютер с одним процессором, на котором запущено приложение Excel и обрабатывается книга, содержащая 1000 ячеек. Она вызывает функцию UDF, которая, в свою очередь, вызывает один или несколько удаленных серверов. Предположим, что 1000 ячеек не зависят друг от друга, поэтому Excel не нужно ожидать завершения одного вызова для совершения другого. (Это условие можно нарушить без последствий для этого примера.) Если серверы могут обрабатывать 100 запросов одновременно, а в Excel настроено использование 100 потоков, время выполнения можно сократить до 1/100 (сотой части от времени выполнения однопотокового пересчета). Чтобы приложение Excel могло распределять вызовы между потоками, а операционная система могла управлять 100 потоками, требуются значительные ресурсы. Это показывает, что на практике такого значительного сокращения времени не будет. Мы также предполагаем, что сервер характеризуется хорошей масштабируемостью, и что одновременная обработка 100 задач сильно не повлияет на время выполнения отдельных задач.
  
Пример практического применения, при котором этот способ дает отличные результаты, — использование методов Монте-Карло, а также выполнение других ресурсоемких задач, которые можно разделить на более мелкие подзадачи и обработать на серверах.
  
## <a name="excel-services-considerations"></a>Общие сведения о службах Excel
<a name="xl2007xllsdk_threadsafe"> </a>

Службы Excel поддерживают загрузку, вычисление и обработку электронных таблиц Excel на сервере. Пользователи могут получить доступ к электронным таблицам и работать с ними, используя стандартные средства браузера.
  
Пользовательские функции служб Excel созданы с использованием управляемого кода Microsoft .NET Framework и доступны благодаря сборке .NET. XLL-модули не поддерживаются в службах Excel. Ресурс UDF сервера управляемого кода может вызывать XLL-модуль для доступа к его функциональности, что обеспечивает одинаковую функциональность при работе с книгами, загруженными на сервер и локальный компьютер.
  
Чтобы функции XLL таким образом, они должны таким образом быть заключены в сборке .NET, который преобразует аргументы и возвращаемые значения из собственных типов для типов данных платформы .NET Framework управляемых и, который вызывает функции XLL. Оболочкой .NET может экспортировать один сервер пользовательских Функций для каждой функции XLL, к которому обращается. Дополнительные требования заключается в том, что все функции XLL вызове таким образом должен быть потокобезопасными. Так как функции XLL не зарегистрировано в то, как они являются с клиента Excel, на сервере и оболочкой .NET у нет возможности применение, что они являются потокобезопасными. Это ответственность разработчика XLL убедиться в этом.
  
## <a name="see-also"></a>См. также

- [Пересчет в Excel](excel-recalculation.md)  
- [���������� ������� � Excel](memory-management-in-excel.md) 
- [Доступ к XLL-коду в Excel](accessing-xll-code-in-excel.md)  
- [�������� ���������������� � Excel](excel-programming-concepts.md)  
- [���������� �� ������� Excel 2013 XLL SDK API](excel-xll-sdk-api-function-reference.md)


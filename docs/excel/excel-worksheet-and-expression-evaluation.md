---
title: Оценка выражений и листов Excel
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
ms.topic: overview
keywords:
- expression evaluation [excel 2007],errors in worksheets [Excel 2007],long Unicode strings [Excel 2007],evaluating expressions [Excel 2007],evaluating worksheets [Excel 2007],worksheet evaluation [Excel 2007],worksheet errors [Excel 2007]
localization_priority: Normal
ms.assetid: 47b46a7d-6cfb-4f5b-946d-e0164d18512a
description: 'Относится к: Excel 2013 | Office 2013 | Visual Studio'
ms.openlocfilehash: cf1e0539136435f7d7df6ef348fc92ec4380e132
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33427768"
---
# <a name="excel-worksheet-and-expression-evaluation"></a>Оценка выражений и листов Excel

 **Относится к**: Excel 2013 | Office 2013 | Visual Studio 
  
Содержимое ячеек на листах Microsoft Excel оценивается как один из четырех базовых типов данных.
  
- **Number**;
    
- **Boolean (TRUE** или **FALSE**);
    
- **String**;
    
- **Errors**
    
Смешанные массивы с данными этих типов также можно вводить в формулы в качестве аргументов функций или в качестве значений, занимающих более одной ячейки в формуле массива.
  
Когда пользователь (или макрос команды) вводит те или иные данные в ячейку, Excel пытается интерпретировать их, а в случае неудачи выводит ошибку. Если входные данные начинаются со строкового префикса (одинарной кавычки), Excel помещает все входящие символы в ячейку в исходном виде, не меняя их. (Строковый префикс не отображается.) Если входные данные начинаются с префиксов **=**, **+** или **-**, Excel пытается интерпретировать их как формулу. Если синтаксис недопустим или оценка выражения останавливается, приложение выводит ошибку, а ячейка переводится в режим правки. В противном случае Excel пытается определить, преобразовать и оценить имена операторов и функций, а также их аргументы. 
  
Операнды оцениваются слева направо перед применением оператора. Функции оцениваются, начиная с операторов самого высокого приоритета на максимальном уровне вложенности. Если аргументы функции или операнды не удается преобразовать в ожидаемые типы, оценка завершается с ошибкой **#ЗНАЧ!**. Если токен (не являющийся литералом) не распознается как функция, определенное имя или метка, то оценка завершается с ошибкой **#ИМЯ?**. 
  
Если входные данные не начинаются ни с одного из этих префиксов, Excel сверяет их с известными шаблонами входных данных, такими как значения даты и времени, денежные суммы, проценты и числа, и интерпретирует их соответствующим образом. Это делается с учетом языкового стандарта. Если ни одна из интерпретаций не подходит, Excel рассматривает входные данные как строку и помещает их в ячейку без изменений.
  
Excel поддерживает и другие типы данных, наиболее заметным из которых является ссылка на ячейку. Excel преобразует ссылки в значения соответствующих ячеек при оценке аргументов операторов и функций, не принимающих ссылки в качестве аргументов, а также в тех случаях, когда выражение в формуле из ячейки сводится к ссылке.
  
Excel предоставляет возможность привести любую допустимую строку символов к одному из четырех базовых типов данных на листах с помощью функции XLM **ВЫЧИСЛИТЬ** и ее эквивалента в API C — **xlfEvaluate**. Эта функция предоставляет, помимо прочего, простой способ оценки именованных диапазонов в коде библиотек DLL. Эта функция работает так же, как описано выше, за тем лишь исключением, что в случае неудачной оценки она не показывает сообщения об ошибках и не включает правку ячеек, а возвращает ошибку **#ЗНАЧ!**. 
  
## <a name="numbers"></a>Числа

На внутреннем уровне все числа на листах Excel представляются как 8-байтовые числа с плавающей точкой двойной точности. Однако реализация этих чисел в Excel не полностью соответствует стандарту IEEE, как показано в приведенной ниже таблице.
  
|**Тип**|**Максимум**|**Минимум**|
|:-----|:-----|:-----|
|double (8 байт) по стандарту IEEE  <br/> |1.7976931348623157E+308  <br/> |2.2250738585072014E-308  <br/> |
|Лист (возвращается функцией или путем вставки значения)  <br/> |1.7976931348623157E+308  <br/> |2.22507385850721E-308  <br/> |
|Лист (ввод вручную)  <br/> |9.99999999999999E+307  <br/> |2.22507385850721E-308  <br/> |
   
Субнормальные числа по стандарту IEEE (то есть числа в диапазоне от 2,2250738585072009E-308 до 4,9406564584124654E-324) не поддерживаются на листах Excel, но их поддерживает тип данных double в VBA.
  
Если функция DLL возвращает положительную или отрицательную бесконечность по стандарту IEEE или недопустимое значение типа double, Excel преобразует его в ошибку **#ЧИСЛО!**. Все субнормальные числа, а также значения меньше минимального положительного нормального числа в Excel преобразуются в положительный ноль. Отрицательный ноль по стандарту IEEE поддерживается, то есть его может возвращать функция DLL, а также он отображается как **-0**. (Оператор **\<** не проверяет наличие отрицательного нуля, поэтому выражение **=A1\<0** оценивается как **TRUE**, если A1 содержит отрицательный ноль). 
  
Обратите внимание на то, что определенные числовые форматы (например, значения даты и времени) имеют более узкие диапазоны. Деление целых чисел, по сути, представляет собой деление чисел с плавающей точкой, и оно в особых случаях может возвращать дробный результат, хотя точный результат должен быть целым.
  
## <a name="long-unicode-strings"></a>Длинные строки Юникода

Все строки, которые пользователь видит в Excel, уже много версий подряд хранились на внутреннем уровне как строки Юникода. Длина строк Юникода на листах может достигать 32 767 (2<sup>15</sup> – 1), и они могут содержать любой допустимый символ Юникода. 
  
На момент появления API C строки на листах представляли собой байтовые строки длиной до 255 символов, и в API C отражались эти ограничения. С выпуском Excel 2007 API C был обновлен для обработки длинных строк Юникода в Excel. Это означает, что правильно зарегистрированные функции DLL могут принимать аргументы этого типа и возвращать строки Юникода.
  
> [!NOTE]
> API C по-прежнему полностью поддерживает байтовые строки в целях обратной совместимости. Однако их длина по-прежнему ограничена 255 символами. 
  
## <a name="returning-errors"></a>Возврат ошибок

Excel оценивает ячейки как ошибки, если не удается преобразовать аргументы функции или оператора в правильный тип, а также если не распознается функция или определенное имя. Оба этих сценария описаны ранее. В случае сбоя встроенных функций и операторов листов также возникают ошибки, сообщающие пользователю о типе сбоя. Функции ваших надстроек также должны возвращать ошибки, согласованные с поведением Excel.
  
### <a name="null"></a>#NULL!

Ошибку **#ПУСТО!** возвращают некоторые информационные функции XLM. Например, эта ошибка возвращается при вызове функции **ПОЛУЧИТЬ.ДОКУМЕНТ(78)** или эквивалентной функции API C **xlfGetDocument** с аргументом 78, если не установлено ни одного принтера. Ее также могут возвращать некоторые другие функции, например при оценке пустой строки. 
  
Функции ваших надстроек могут возвращать эту ошибку, если ни одна из других ошибок не кажется уместной.
  
### <a name="div0"></a>#DIV/0!

Оператор деления Excel возвращает ошибку **#ДЕЛ/0!**, если знаменатель оценивается как ноль или слишком мал, чтобы его можно было представить в Excel как ненулевое значение. Некоторые функции, связанные по своей природе с делением, также могут возвращать эту ошибку. Например, функция **СРЗНАЧ** возвращает эту ошибку, если ни одно из входных значений не удается преобразовать в число. 
  
Возвращать эту ошибку из функции надстройки следует только для того, чтобы сообщить об обнаружении деления на ноль.
  
### <a name="value"></a>#VALUE!

Excel возвращает ошибку **#ЗНАЧ!**, если аргумент функции или оператора невозможно преобразовать в нужный тип. В случае аргументов функций, которые невозможно преобразовать, например `=LN("X")`, Excel не вызывает код функции. Это важно помнить при написании и отладке функций собственных надстроек. 
  
Некоторые функции возвращают эту ошибку, если аргумент не удается преобразовать в коде функции. Например, выражение `DATEVALUE("30-Feb-2007")` возвращает эту ошибку, несмотря на то что тип аргумента правильный. В этом случае функция возвращает ошибку из своего кода. Некоторые функции возвращают эту ошибку, несмотря на то что типы и диапазоны значений допустимы. Пример: `FIND("a","xyz")`. 
  
Эту ошибку следует возвращать из функции надстройки, чтобы указать, что аргументы относятся к неправильному типу, их не удалось преобразовать в правильный тип или они выходят за пределы допустимого диапазона (хотя для числовых аргументов, выходящих за пределы, рекомендуем возвращать ошибку **#ЧИСЛО!**). Эту ошибку также следует возвращать, если аргументы, являющиеся диапазонами или массивами, имеют неправильную форму или размер. 
  
### <a name="ref"></a>#REF!

Excel возвращает ошибку **#ССЫЛКА!** в выражении, если оно копируется в расположение, где получившаяся относительная ссылка выходит за границы. Например, если ячейка B2 содержит формулу `=A1`, то при ее копировании в ячейку B1 получится формула **=#ССЫЛКА!**. Эту ошибку также возвращают формулы, содержащие ссылку, переписанную в ходе операции вырезания и вставки или стертую при удалении строки, столбца или листа. Некоторые функции, которые могут возвращать ссылки, также могут возвращать эту ошибку, например `OFFSET(A1,-1,-1)`. Имена листов, определения которых содержат ссылки, ставшие недействительными, также оцениваются как эта ошибка.
  
Если функция надстройки принимает в качестве аргументов ссылки, то эту ошибку рекомендуется возвращать при получении недействительных ссылок или передаче ошибок со ссылками. В разделе статьи [Управление памятью в Excel](memory-management-in-excel.md), посвященном XLOPER/XLOPER12, описано, как создавать функции, которые могут принимать и возвращать ссылки в качестве аргументов. 
  
### <a name="name"></a>#NAME?

Excel возвращает ошибку **#ИМЯ?**, если выражение содержит токен, не распознаваемый как название функции или определенное имя. Если функция надстройки пытается получить доступ к определенному имени, а оно не определено, рекомендуем возвращать эту ошибку. 
  
### <a name="num"></a>#NUM!

Многие из встроенных числовых и математических функций в Excel возвращают ошибку **#ЧИСЛО!**, если числовые входные данные выходят за пределы допустимого диапазона. Пример: `LN(0)`. Рекомендуем возвращать эту ошибку из функции надстройки, чтобы указать, что числовые входные данные недействительны или выходят за пределы допустимого диапазона.
  
### <a name="na"></a>#N/A

Ошибку **#Н/Д** часто возвращают, чтобы указать, что успешный или осмысленный результат недоступен. Например, функция ПОИСКПОЗ с нулевым третьим аргументом возвращает эту ошибку, если не удается найти точное совпадение. Эту ошибку также можно вызывать с помощью функции **НД** и отдельно обнаруживать с помощью функции **ЕНД**. Следовательно, эта ошибка часто используется на листах, чтобы указывать ряд условий, относящихся к конкретным приложениям.
  
## <a name="see-also"></a>См. также



[Понятия, связанные с программированием для Excel](excel-programming-concepts.md)
  
[Программирование с использованием API C в Excel](programming-with-the-c-api-in-excel.md)
  
[Оценка имен и других выражений в формулах листов](evaluating-names-and-other-worksheet-formula-expressions.md)
  
[Справочник по функциям API SDK XLL для Excel](excel-xll-sdk-api-function-reference.md)


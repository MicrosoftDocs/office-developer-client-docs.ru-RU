---
title: Асинхронные пользовательские функции
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: overview
localization_priority: Normal
ms.assetid: 142eb27e-fb6f-4da3-bfb7-a88115bbb5d5
description: 'Область применения: Excel 2013 | Office 2013 | Visual Studio'
ms.openlocfilehash: 7fdf3bd09914981865c911fd65a78d044ad582f4
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33412312"
---
# <a name="asynchronous-user-defined-functions"></a>Асинхронные пользовательские функции

**Область применения:** Excel 2013 | Office 2013 | Visual Studio 
  
Microsoft Excel 2013 может вызывать пользовательские функции асинхронно. Асинхронный вызов функций может повысить производительность, позволяя выполнять несколько вычислений одновременно. При выполнении пользовательских функций в вычислительном кластере асинхронный вызов функций позволяет использовать в вычислениях несколько компьютеров.
  
## <a name="when-to-use-asynchronous-user-defined-functions"></a>Когда использовать асинхронные пользовательские функции

Некоторые пользовательские функции должны ждать внешних ресурсов. Пока они ждут, поток вычислений Excel блокируется. В Excel 2013 пользовательские функции могут выполняться асинхронно. Это освободит поток вычислений для запуска других вычислений во время ожидания пользовательской функции.
  
В Excel 2007 программисты могут одновременно выполнять несколько пользовательских функций, увеличив число потоков, используемых при многопотоковом пересчете. У этого метода есть недостатки, в первую очередь потому, что число потоков — это параметр, задав область действия приложения и не контролируемый на уровне одной функции или надстройки.
  
Программисты должны использовать асинхронные вызовы пользовательских функций, когда функция должна ждать внешних ресурсов. Например, функция, которая отправляет SOAP-запрос через Интернет, должна дождаться доставки запроса в сеть, удаленный сервер для выполнения запроса и сеть для возврата результата. В этом случае не происходит никаких значительных вычислений, и Excel может продолжать другие вычисления.
  
Программисты также могут использовать асинхронные пользовательские функции, когда функция отправляет запросы в вычислительный кластер. В этом случае существует не только задержка сети, но и кластер может выполнять отдельные вызовы на отдельных серверах. Не дожидаясь завершения каждого вызова, вызовы могут перекрываться для повышения производительности. В некоторых случаях это значительное улучшение.
  
> [!NOTE]
> Пользовательские функции не могут быть зарегистрированы как асинхронные и кластерные безопасные. 
  
## <a name="writing-an-asynchronous-user-defined-function"></a>Написание асинхронной пользовательской функции

Асинхронные пользовательские функции должны отслеживать и использовать его при информировании Excel о том, что вызов функции завершен. Асинхронная пользовательизированная функция делится на две части. Первый элемент — это стандартная точка входа UDF, которая запускает вторую отдельную асинхронную операцию. Обратное вызовы в Excel следует делать во время точки входа UDF. Первая запускаемая часть функции затем возвращает управление потоком вычислений в Excel, который продолжит вычисление. После завершения второй асинхронной операции она должна снова вызвать Excel и предоставить Excel результат. 
  
> [!NOTE]
> Все аргументы, переданные в UDF, необходимые асинхронной части функции, должны быть глубоко скопированы, так как Excel освободит эти аргументы при возвращении точки входа UDF. 
  
Excel предоставляет набор событий, которые надстройка XLL может использовать для управления жизненным циклом асинхронных вызовов UDF. Эти события указывают, что Excel завершил вычисления или что вычисление было отменено.
  
### <a name="declaring-an-asynchronous-function"></a>Объявление асинхронной функции

При регистрации асинхронные пользовательские функции необходимо объявлять как асинхронные. Это выполняется путем добавления параметра, который указывает на структуру XLOPER12, представленную "X" в строке типа регистрации в любом месте списка параметров UDF. Excel использует этот параметр для прохода асинхронного обработки вызовов. Когда результат будет готов, надстройка XLL должна передать в Excel асинхронный окне вызова и результат функции. Кроме того, тип возврата UDF должен быть аннулироваться, обозначенный ">" в качестве первого символа в строке типа. Тип возвращаемого значения недействительным, так как синхронная часть UDF не возвращает значение в Excel. Вместо этого надстройка XLL асинхронно возвращает значение с помощью обратного вызова. 
  
Асинхронные функции можно объявить потокобезопасными, а затем синхронная часть UDF используется при многопотоковом пересчете. 
  
В следующем примере кода показана асинхронная пользовательо-определяемая функция, зарегистрированная с помощью "QX" в качестве строки \> типа регистрации:
  
```cpp
void MyAsyncUDF(LPXLOPER12 arg1, LPXLOPER12 pxAsyncHandle)
{
…
}
```

### <a name="returning-values"></a>Возвращающие значения

Когда результат асинхронного вызова готов, надстройка XLL возвращает результат в Excel, выполняя обратное вызов типа [xlAsyncReturn.](xlasyncreturn.md)
  
**xlAsyncReturn** — это единственный метод вызова, который можно использовать в потоках без вычисления во время пересчета. Поэтому асинхронная часть асинхронной UDF не должна выполнять другие вызовы. 
  
### <a name="handling-events"></a>Обработка событий

Начиная с Excel 2010, XLL могут получать события, предназначенные для управления жизненным циклом асинхронной функции. Дополнительные сведения см. в [этой теме.](handling-events.md)
  
## <a name="see-also"></a>См. также

- [Разработка XLL-файлов для Excel](developing-excel-xlls.md)


---
title: Асинхронные пользовательские функции
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: overview
localization_priority: Normal
ms.assetid: 142eb27e-fb6f-4da3-bfb7-a88115bbb5d5
description: 'Область применения: Excel 2013 | Office 2013 | Visual Studio'
ms.openlocfilehash: 7fdf3bd09914981865c911fd65a78d044ad582f4
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33412312"
---
# <a name="asynchronous-user-defined-functions"></a>Асинхронные пользовательские функции

**Область применения:** Excel 2013 | Office 2013 | Visual Studio 
  
Microsoft Excel 2013 может асинхронно вызывать пользовательские функции. Асинхронный вызов функций может увеличить производительность, допуская одновременное выполнение нескольких вычислений. При выполнении пользовательских функций в вычислительном кластере асинхронный вызов функций позволяет использовать в вычислениях несколько компьютеров.
  
## <a name="when-to-use-asynchronous-user-defined-functions"></a>Когда использовать асинхронные пользовательские функции

Некоторые пользовательские функции должны ожидать внешние ресурсы. Во время ожидания поток вычислений Excel блокируется. В Excel 2013 пользовательские функции могут выполняться асинхронно. При этом поток вычислений освобождается для выполнения других вычислений во время ожидания пользовательской функции.
  
В Excel 2007 программисты могут одновременно запускать несколько пользовательских функций, увеличивая количество потоков, используемых в пересчетах нескольких потоков. Этот метод имеет недостатки, в основном потому, что количество потоков является параметром, ограниченным приложением, и его невозможно контролировать на уровне одной функции или надстройки.
  
Программисты должны использовать асинхронные вызовы пользовательских функций, когда функция должна ожидать внешние ресурсы. Например, функция, которая отправляет SOAP SOAP запрос через Интернет, должна ждать, пока сеть не получит запрос, удаленный сервер для выполнения запроса, а сеть возвращает результат. В этом случае не происходит значительных вычислений, и Excel может продолжить работу с другими вычислениями.
  
При отправке запросов функцией в вычислительный кластер программисты также могут использовать асинхронные пользовательские функции. В этом случае время ожидания в сети не требуется, но кластер может выполнять отдельные вызовы на отдельных серверах. Для повышения производительности вызовы могут быть перекрывающиеся, не дожидаясь завершения каждого вызова. В некоторых случаях это улучшение является существенным.
  
> [!NOTE]
> Пользовательские функции невозможно зарегистрировать как асинхронный и надежный в кластере. 
  
## <a name="writing-an-asynchronous-user-defined-function"></a>Написание асинхронной пользовательской функции

Асинхронные пользовательские функции должны отслеживать дескриптор и использовать этот дескриптор при заполнении Excel, когда вызов функции завершен. Асинхронная пользовательская функция разделяется на две части. Первый фрагмент — это стандартная точка входа UDF, которая запустит вторую, отдельно асинхронную операцию. Обратные вызовы в Excel следует вносить во время точки входа UDF. После этого первая начальная часть функции возвращает управление потоком вычислений в Excel, что позволяет продолжить вычисление. По завершении второй асинхронной операции она должна вызвать Excel и предоставить ей результат. 
  
> [!NOTE]
> Все аргументы, переданные в UDF, необходимые асинхронной части, функция должна быть глубоко скопирована, так как Excel освобождает эти аргументы при возврате точки входа UDF. 
  
Excel предоставляет набор событий, которые может использовать надстройка XLL для управления жизненным циклом асинхронных вызовов UDF. Эти события указывают на то, что Excel завершается с вычислениями или что вычисление отменено.
  
### <a name="declaring-an-asynchronous-function"></a>Объявление асинхронной функции

Асинхронные пользовательские функции необходимо объявить асинхронно, если они зарегистрированы. Для этого добавляется параметр, указывающий на структуру, представленную "X" в строке типа регистрации, в любом месте списка параметров UDF. Excel использует этот параметр, чтобы передать маркер асинхронного вызова. Надстройка XLL должна передать маркер асинхронного вызова и результат функции обратно в Excel, когда результат будет готов. Кроме того, тип возвращаемого значения UDF должен быть **void**, обозначенным ">", как первый символ в строке типа. Возвращаемый тип — void, так как синхронная часть UDF не возвращает значение в Excel. Вместо этого надстройка XLL возвращает значение асинхронно через обратный вызов. 
  
Асинхронные функции можно объявить потокобезопасными, а затем синхронный компонент UDF используется при многопотоковой пересчете. 
  
В следующем примере кода показана асинхронная пользовательская функция, зарегистрированная с\>помощью "ККС" в качестве строки типа регистрации:
  
```cpp
void MyAsyncUDF(LPXLOPER12 arg1, LPXLOPER12 pxAsyncHandle)
{
…
}
```

### <a name="returning-values"></a>Возвращаемые значения

Когда результат асинхронного вызова готов, надстройка XLL возвращает результат в Excel, выполняя обратный вызов типа [ксласинкретурн](xlasyncreturn.md).
  
**ксласинкретурн** — единственный обратный вызов, который можно использовать в потоках, не являющихся вычислениями, во время пересчета. Таким образом, асинхронная часть асинхронной UDF не должна выполнять другие обратные вызовы. 
  
### <a name="handling-events"></a>Обработка событий

Начиная с Excel 2010 XLL могут получать события, предназначенные для управления жизненным циклом асинхронной функции. Более подробную информацию можно узнать в статье [Обработка событий](handling-events.md).
  
## <a name="see-also"></a>См. также

- [Разработка XLL-файлов для Excel](developing-excel-xlls.md)


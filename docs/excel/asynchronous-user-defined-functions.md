---
title: Асинхронные пользовательские функции
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: overview
localization_priority: Normal
ms.assetid: 142eb27e-fb6f-4da3-bfb7-a88115bbb5d5
description: 'Область применения: Excel 2013 | Office 2013 | Visual Studio'
ms.openlocfilehash: 7fdf3bd09914981865c911fd65a78d044ad582f4
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33412312"
---
# <a name="asynchronous-user-defined-functions"></a>Асинхронные пользовательские функции

**Область применения:** Excel 2013 | Office 2013 | Visual Studio 
  
Microsoft Excel 2013 можно вызывать функции, определенные пользователем, асинхронно. Асинхронно вызов функций может повысить производительность, позволяя выполнять несколько вычислений одновременно. При выполнении пользовательских функций в вычислительном кластере асинхронный вызов функций позволяет использовать в вычислениях несколько компьютеров.
  
## <a name="when-to-use-asynchronous-user-defined-functions"></a>Когда использовать асинхронные функции, определенные пользователем

Некоторые функции, определенные пользователем, должны ждать внешних ресурсов. Пока они ждут, Excel поток вычислений блокируется. В Excel 2013 г. функции, определенные пользователем, могут выполняться асинхронно. Это освободит поток вычислений для запуска других вычислений, пока функция, определяемая пользователем, будет ждать.
  
В Excel 2007 г. программисты могли одновременно выполнять несколько пользовательских функций, увеличив число потоков, используемых при пересчете нескольких потоков. Этот метод имеет недостатки, в первую очередь потому, что количество потоков — это параметр, масштабный для приложения и не может управляться на уровне одной функции или надстройки.
  
Программисты должны использовать асинхронные вызовы функции, определенные пользователем, когда функция должна ждать внешних ресурсов. Например, функция, которая отправляет запрос SOAP через Интернет, должна ждать, пока сеть доставит запрос, удаленный сервер для выполнения запроса и сеть, чтобы вернуть результат. В этом случае значительных вычислений не происходит, и Excel можно продолжить другие вычисления.
  
Программисты также могут использовать асинхронные функции, определенные пользователем, когда функция отправляет запросы в вычислительный кластер. В этом случае необходимо не только ждать задержки в сети, но и выполнять отдельные вызовы на отдельных серверах. Не дожидаясь завершения каждого звонка, можно перекрывать вызовы, чтобы повысить производительность. В некоторых случаях это существенное улучшение.
  
> [!NOTE]
> Функции, определенные пользователем, нельзя зарегистрировать как асинхронные, так и кластерные. 
  
## <a name="writing-an-asynchronous-user-defined-function"></a>Написание асинхронной функции, определяемой пользователем

Асинхронные функции, определенные пользователем, должны отслеживать ручку и использовать ее при Excel о том, что вызов функции завершен. Асинхронная функция, определяемая пользователем, делится на две части. Первая часть — это стандартная точка входа UDF, которая запускает вторую, отдельную асинхронную операцию. Вызовы в Excel должны быть сделаны во время входа в UDF. Первая часть запуска функции возвращает управление потоком вычислений в Excel, который будет продолжать вычисление. После завершения второй асинхронной операции она должна вернуться в Excel и предоставить Excel результат. 
  
> [!NOTE]
> Все аргументы, переданные в UDF, необходимые асинхронной части, функция должна быть глубоко скопирована, так как Excel эти аргументы будут освобождены при возвращении точки входа UDF. 
  
Excel предоставляет набор событий, которые надстройка XLL может использовать для управления жизненным циклом асинхронных вызовов UDF. Эти события указывают, Excel завершены вычислениями или что вычисление было отменено.
  
### <a name="declaring-an-asynchronous-function"></a>Объявление асинхронной функции

При регистрации необходимо объявить асинхронные функции, определенные пользователем, асинхронными. Это выполняется путем добавления параметра, который указывает на структуру XLOPER12, представленную "X" в строке типа регистрации в любом месте в списке параметров UDF. Excel этот параметр используется для прохода асинхронной ручки вызова. Надстройка XLL должна передать асинхронную ручку вызова и результат функции обратно в Excel, когда результат будет готов. Кроме того, возвращается тип UDF должен быть недействительным, назначенный ">" в качестве первого символа в строке типа. Тип возврата недействительным, так как синхронная часть UDF не возвращает значение Excel. Вместо этого надстройка XLL возвращает значение асинхронно с помощью обратного вызова. 
  
Можно объявить асинхронные функции безопасными для потоков, а затем синхронная часть UDF используется в многопоточной пересчете. 
  
В следующем примере кода показана асинхронная функция, определяемая пользователем, зарегистрированная с помощью \> "QX" в качестве строки типа регистрации:
  
```cpp
void MyAsyncUDF(LPXLOPER12 arg1, LPXLOPER12 pxAsyncHandle)
{
…
}
```

### <a name="returning-values"></a>Возвращающие значения

Когда результат асинхронного вызова будет готов, надстройка XLL возвращает результат Excel, выполняя обратное вызов типа [xlAsyncReturn](xlasyncreturn.md).
  
**xlAsyncReturn** — это единственный вызов, который можно использовать в потоках без расчета во время пересчета. Поэтому асинхронная часть асинхронного UDF не должна выполнять другие вызовы. 
  
### <a name="handling-events"></a>Обработка событий

Начиная с Excel 2010 г. XLLs могут получать события, предназначенные для управления жизненным циклом асинхронной функции. Дополнительные сведения см. в [дополнительных сведениях об обработке событий.](handling-events.md)
  
## <a name="see-also"></a>См. также

- [Разработка XLL-файлов для Excel](developing-excel-xlls.md)


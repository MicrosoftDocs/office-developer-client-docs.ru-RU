---
title: ���������� ������� � Excel
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
ms.topic: overview
keywords:
- xloper12 memory [excel 2007],managing memory in Excel,Excel stack,strings [Excel 2007], managing memory,memory management in Excel,XLOPER memory [Excel 2007],memory [Excel 2007], management guidelines
localization_priority: Normal
ms.assetid: 3bf5195b-6235-43cf-8795-0c7b0a63a095
description: '������� ����������: Excel 2013�| Office 2013�| Visual Studio'
ms.openlocfilehash: 97c76d762fdc5e575c571804816e5581a7bec8bb
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2018
ms.locfileid: "19807314"
---
# <a name="memory-management-in-excel"></a>���������� ������� � Excel

 **Применимо к**: Excel 2013 | Office 2013 | Visual Studio 
  
���� �� ������ ��������� ����������� � ���������� XLL-����������, ������� �������� ������� ���������� �������. ������������ ���������� ������� ����� �������� � ������ ���� ������� � Microsoft Excel � �� ��������������, ����� ��� ��������� ������ ������ ��� �� ������������� ������������� � �������������, �� ���������, ����� ��� �������������� Excel.
  
������������ ���������� ������� � �������� ���������������� ������� ��������� �������, ��������� � ������������. �������������, ���������� ������ ������ ��� ������� ������ ����������� � ���������������� ��������� ���������� �������. 
  
� ���������� �������������� ��������� ���� � Microsoft Office Excel 2007 ��������� ������� ����� �������. ���� �� ������ ��������� � �������������� ���������������� ������� ������, ���������� ��������� ���������, ������� ����� ��������� ��� ����������� ���������� ������� �� ������.
  
���� ��������� ������������ ��� ��������� ���� ����� ��������� ������:
  
- **XLOPER** � **XLOPER12**;
    
- �����, ��������� ������� ���������� �� **XLOPER** ��� **XLOPER12**;
    
- �������� **FP** � **FP12**. 
    
## <a name="xloperxloper12-memory"></a>������ XLOPER � XLOPER12

**XLOPER**/ структуру данных**XLOPER12** имеет несколько дочерних типов, которые содержат указатели на блоки памяти, а именно строки (**xltypeStr**), массивов (**xltypeMulti**) и внешние ссылки (**xltypeRef**). Обратите внимание, что **xltypeMulti** массивов может содержать строку **XLOPER**/ **XLOPER12s** , указывающие на другие блоки памяти. 
  
**XLOPER**/ **XLOPER12** может быть создано несколькими способами: 
  
- � Excel ��� ���������� ���������� ��� �������� � ������� XLL;
    
- � Excel ��� ����������� **XLOPER** ��� **XLOPER12** �� ����� ������ API C; 
    
- � DLL ��� �������� ���������� ��� �������� �� ����� ������ API C;
    
- � DLL ��� �������� ������������� �������� ������� XLL.
    
���� ������, ������������� � ���� ���������� �� ������, ����� �������� ��� ���-�� ����������� ���������:
  
- ��� ����������� ���� � ���������� DLL �� ��������� ���� ������� (� ���� ������ ������������� �������� ��� ����������� ������);
    
- ��� ����������� ���� � ���������� DLL, �������� � ��� ������� (� ���� ������ ������������� �������� ��� ����������� ������);
    
- � ������� ������������� ��������� � ������������ � ���������� DLL ( **malloc** � **free**, **new** � **delete** � �. �.);
    
- � ������� ������������� ��������� � Excel.
    
�������� ����� ��������� ���������� ������ **XLOPER**/ **XLOPER12** � ���������� ��������, � ������� ���������� ������ **XLOPER**/ **XLOPER12** ���������� ��� ������, �������������, ��� ��� ���� ����� ���� ����� �������. ��� �� �����, ���� ��������� ���������� �������� � �������������, �� ����� ����������� ���������. 
  
### <a name="rules-for-working-with-xloperxloper12"></a>������� ������ � XLOPER/XLOPER12

- �� ��������� ���������� ������ ��� ������������ ��������� ������ **XLOPERs**/ **XLOPER12**, ������� ���������� ��� ��������� � ������� XLL. ��� ��������� ������������� ������ ��� ������. �������������� �������� ��. � ������� "����������� **XLOPER** ��� **XLOPER12** � ������� ��������� ���������� �� �����" ������ [��������� ��������, ����������� ��� ���������� XLL ��� Excel](known-issues-in-excel-xll-development.md).
    
- ���� ���������� Excel �������� ������ ��������� ������ **XLOPER**/ **XLOPER12**, ������������ � DLL �� ����� ������ API C: 
    
  - ���������� ���������� ������, ����� ��� ������ �� ��������� **XLOPER**/ **XLOPER12**, � ������� ������ [xlFree](xlfree.md). �� ����������� ��� ����� ������ �����, �������� free ��� delete.
    
  - ���� ������������ ��� � **xltypeMulti**, �� ��������������� **XLOPER**/ **XLOPER12** � �������, �������� ���� ��� �������� ������ ��� �� �������� ��������� ���������� � ������� ������.
    
  - ����� ���������� � Excel **XLOPER**/ **XLOPER12** ��� ������������ �������� ������� DLL, ���������� �������� Excel � ������, ������� ���������� ���������� ����� ���������� ������. 
    
- ������� **xlFree** ���������� �������� ������ ��� ��������� ������ **XLOPER**/ **XLOPER12**, ��������� � �������� ������������� �������� ��� ������ API C. 
    
- ���� ���������� DLL �������� ������ ��������� ������ **XLOPER**/ **XLOPER12**, ������� ����� ���������� � Excel � �������� ������������� �������� ������� DLL, ���������� �������� Excel � ������, ������� ���������� DLL ������ ����������. 
    
### <a name="guidelines-for-memory-management"></a>������������ �� ���������� �������

- ����������� ������������ ����� ��� ��������� � ������������ ������ � ���������� DLL. �� ���������� ������. ����������� ������������ ������ ����� ��� ��������� ��� ����� ������, ��� ��� ����� ��������, �� ������� ��� � ������ ������.
    
- ��� �������� �������� **xltypeMulti** � ���������� DLL ��������� ������ ��� ����� ������������ ��������: ������ ��������� ������ ����������� ��� ������ ����������� ����������� ������. � ���� ������, ���������� ������, �� ������ �����, ��� ���������� ������ ����������� ������ ��� ������� ����� �� ������. 
    
- ���������� �������� ����� ���������� Excel ������ ��� ����������� ��������� � ������� Excel ��������� ������ **XLOPER**/ **XLOPER12**.
    
- �� ��������� ���������� Excel ������ **XLOPER**/ **XLOPER12** � ������� **xltypeMulti**. ���������� �������� ����� ����� � ������� ��������� �� ��� ����� � �������. 
    
## <a name="freeing-excel-allocated-xloperxloper12-memory"></a>������������ ���������� Excel ������ XLOPER/XLOPER12

� ��������� ������� XLL ������������ ������� **xlGetName** ��� ��������� ������, ���������� ��� DLL-����� � ���� � ����, � ������� **xlcAlert** ��� �� ����������� � ���������� ���� ����������.
  
```cs
int WINAPI show_DLL_name(void)
{
    XLOPER12 xDllName;
    if(Excel12(xlfGetName, &xDllName, 0) == xlretSuccess)
    {
        // Display the name.
        Excel12(xlcAlert, 0, 1, &xDllName);
        // Free the memory that Excel allocated for the string.
        Excel12(xlFree, 0, 1, &xDllName);
    }
    return 1;
}

```

����� ������� ������ �� ����� ������, �� ������� ��������� **xDllName**, ��� ����� ���������� ��, ��������� ����� [������� xlFree](xlfree.md), ����� �� ������� API C ������ ��� ��������� DLL. 
  
������� **xlFree** �������� ������� � ����������� �� �������� (��. ������ [������� ���������� API ��� C, ������� ����� ���������� ������ �� DLL ��� XLL](c-api-functions-that-can-be-called-only-from-a-dll-or-xll.md)), �� �������� �������� �� ���������:
  
- �� ������ ���������� ��������� ���������� ���������� ������ **XLOPER**/ **XLOPER12** �� ����� ������ ������ ������� **xlFree**. ������������ ����������� ��� ���� � ���������� ���������� �������, ������� �������������� � ������������ ������ Excel (30 � Excel 2003, 255 � Excel�2007 � ����� ������� ������).
    
- ������� **xlFree** ������������� ��� ������������� ��������� �������� **NULL**, ����� ���������� ������������ ��� ������� ������������ ��� ������������� ��������� ������ **XLOPER**/ **XLOPER12**. **xlFree** � ��� ������������ ������� API C, ������� �������� ���� ���������. 
    
- �� ������ ��������� �������� **xlFree** ��� ����� ��������� ������ **XLOPER**/ **XLOPER12**, ������� ������������ ��� ��������� ������������� �������� ��� ������ API C, ���������� �� ������� � ��� ��������� �� ������. 
    
## <a name="returning-xloperxloper12s-to-be-freed-by-excel"></a>����������� �������� ������ XLOPER ��� XLOPER12 ��� ������������ � Excel

Предположим, что вы хотите изменить пример команды в предыдущем разделе и измените его на функция, которая возвращает путь и имя DLL при передаче **логическое** **значение true,** аргумент, а в противном случае — **# Н/д** . Четко не может вызывать **xlFree** для освобождения памяти строку перед возвращением в Excel. Тем не менее если не освобождается определенному моменту, надстройка будет утечка памяти каждый раз при вызове функции. Чтобы обойти эту проблему, можно задать немного в поле **xltype** **XLOPER**/ **XLOPER12**, определенного как **xlbitXLFree** в xlcall.h. Это свидетельствует о том, что он должен освободить память, возвращенные, после завершения копирования значения в работе. 
  
### <a name="example"></a>������

� ��������� ������� ���� �������� �������������� ������� XLL �� ����������� ������� � ������� ����� XLL.
  
```cs
LPXLOPER12 WINAPI get_DLL_name(int calculation_trigger)
{
    static XLOPER12 xRtnValue; // Not thread-safe
    Excel12(xlfGetName, &xRtnValue, 0);
// If xlfGetName failed, xRtnValue will be #VALUE!
    if(xRtnValue.xltype == xltypeStr)
    {
// Tell Excel to free the string memory after
// it has copied out the return value.
        xRtnValue.xltype |= xlbitXLFree;
    }
    return &xRtnValue;
}
```

������� XLL, ������� ���������� **XLOPER**/ **XLOPER12**, ���������� �������� ��� �����, ������� ��������� � ���������� ��������� �� **XLOPER**/ **XLOPER12**. ������������� � ���� ������� ����������� ������ **XLOPER12** � ������� �� ���������������. �� ������ ����������� ���������������� ��� ������� ��� ����������������, �� ���������� ���� ���������� �������� **xRtnValue** ����� ������� �� ���������� ������ � ��� ������� ������. 
  
�������� **xlbitXLFree** ���������� �������� ����� ������ ������� ��������� ������ Excel, ������� ��� ��������. ���� ������ ��� �� �����, ��� ����� ������������ � �� ���� ������� �������. ���� �� ������ ������������ ��� �������� � �������� ��������� �� ����� ������ ������ ������� API C �� ��� ����������� �� ����, ��� �������� ������� �������� ����� ������ ������. � ��������� ������ �� ����������� �������, ������� �� ��������� ��� �������� �� �������� ���� **XLOPER**/ **XLLOPER12**. 
  
## <a name="returning-xloperxloper12s-to-be-freed-by-the-dll"></a>����������� �������� ������ XLOPER ��� XLOPER12 ��� ������������ � ���������� DLL

����������� �������� ���������, ����� ���������� XLL �������� ������ **XLOPER**/ **XLOPER12** � ����� ���������� �� � Excel. Excel ���������� ��� ���� ��������, ������� ����� ������ � ���� **xltype** ��������� ������ **XLOPER**/ **XLOPER12**, � **xlbitDLLFree** � xlcall.h. 
  
������� **an XLOPER**/ **XLOPER12** � ���� ���������, Excel �������� ������� ������� [xlAutoFree](xlautofree-xlautofree12.md) (��� **XLOPER**) ��� **xlAutoFree12** (��� **XLOPER12**), ������� ������ �������������� ���������� XLL. ��� ������� ����� �������� ������� � ����������� �� �������� (��. ������ [��������� ��������� � ������� XLL ����������](add-in-manager-and-xll-interface-functions.md)), �� ������ ����������� ���������� �������� �����. ��� ������������� ��� ������������ ������ **XLOPER**/ **XLOPER12** ��� �� ��������, ������� ��� ���������� ��������. 
  
### <a name="examples"></a>�������

�������� ������� � ��������� ������� ���������� �������� ���������� ������� (�� ����������� ����, ��� ��� �������� ����� "The full pathname for this DLL is" ����� ������ DLL).
  
```cs
#include <string.h>
LPXLOPER12 WINAPI get_DLL_name_2(int calculation_trigger)
{
    static XLOPER12 xRtnValue; // Not thread-safe
    Excel12(xlfGetName, &xRtnValue, 0);
// If xlfGetName failed, xRtnValue will be #VALUE!
    if(xRtnValue.xltype != xltypeStr)
        return &xRtnValue;
// Make a copy of the DLL path and file name.
    wchar_t *leader = L"The full pathname for this DLL is ";
    size_t leader_len = wcslen(leader);
    size_t dllname_len = xRtnValue.val.str[0];
    size_t msg_len = leader_len + dllname_len;
    wchar_t *msg_text = (wchar_t *)malloc(msg_len + 1);
    wcsncpy_s(msg_text + 1, leader, leader_len);
    wcsncpy_s(msg_text + 1 + leader_len, xRtnValue.val.str + 1,
        dllname_len);
    msg_text[0] = msg_len;
// Now the original string has been copied Excel can free it.
    Excel12(xlFree, 0, 1, &xRtnValue);
// Now reuse the XLOPER12 for the new string.
    xRtnValue.val.str = msg_text;
// Tell Excel to call back into the DLL to free the string
// memory after it has copied out the return value.
    xRtnValue.xltype     = xltypeStr | xlbitDLLFree;
    return &xRtnValue;
}
```

����������� ���������� ������� **xlAutoFree12** � ���������� XLL, ���������������� ���������� �������, �������� ��������� �������. 
  
```cs
void WINAPI xlAutoFree12(LPXLOPER12 p_oper)
{
    if(p_oper->xltype == (xltypeStr | xlbitDLLFree))
        free(p_oper->val.str);
}
```

���� ���������� ����������, ������ ���� ���������� XLL ���������� ������ **XLOPER12** � ��� ���������� � ������� ������� **malloc**. �������� ��������, ��� � ���� ������ ���� 
  
 ` if(p_oper->xltype == xltypeStr) `
  
���� ����, ��� ��� ������ �������� **xlbitDLLFree**. 
  
� �����, ������� **xlAutoFree** � **xlAutoFree12** ���������� ����������� ���, ����� ��� ����������� ������, ��������� � ���������� ��� ������ XLL ��������� **xltypeMulti** � �������� �������� **xltypeRef**. 
  
Можно применить XLL функций, чтобы они возвращают динамически назначаемых **XLOPER**и **XLOPER12**. В этом случае необходимо задать **xlbitDLLFree** для всех таких **XLOPER**s и **XLOPER12**независимо от того, дочерний тип. Необходимо также реализовать **xlAutoFree** и **xlAutoFree12** , чтобы освободить память и также память направлена в рамках **XLOPER**/ **XLOPER12**. Такой подход является одним из способов сделать надежных потока возвращаемое значение. Например предыдущей функции можно было бы переписать следующим образом.
  
```cs
#include <string.h>
LPXLOPER12 WINAPI get_DLL_name_3(int calculation_trigger)
{
// Thread-safe
    LPXLOPER12 pxRtnValue = (LPXLOPER12)malloc(sizeof(XLOPER12));
    Excel12(xlfGetName, pxRtnValue, 0);
// If xlfGetName failed, pxRtnValue will be #VALUE!
    if(pxRtnValue->xltype != xltypeStr)
    {
// Even though an error type does not point to memory,
// Excel needs to pass this oper to xlAutoFree12 to
// free pxRtnValue itself.
        pxRtnValue->xltype |= xlbitDLLFree;
        return pxRtnValue;
    }
// Make a copy of the DLL path and file name.
    wchar_t *leader = L"The full pathname for this DLL is ";
    size_t leader_len = wcslen(leader);
    size_t dllname_len = pxRtnValue->val.str[0];
    size_t msg_len = leader_len + dllname_len;
    wchar_t *msg_text = (wchar_t *)malloc(msg_len + 1);
    wcsncpy_s(msg_text + 1, leader, leader_len);
    wcsncpy_s(msg_text + 1 + leader_len, pxRtnValue->val.str + 1,
        dllname_len);
    msg_text[0] = msg_len;
// Now the original string has been copied Excel can free it.
    Excel12(xlFree, 0, 1, pxRtnValue);
// Now reuse the XLOPER12 for the new string.
    pxRtnValue->val.str = msg_text;
    pxRtnValue->xltype = xltypeStr | xlbitDLLFree;
    return pxRtnValue;
}
void WINAPI xlAutoFree12(LPXLOPER12 p_oper)
{
    if(p_oper->xltype == (xltypeStr | xlbitDLLFree))
        free(p_oper->val.str);
    free(p_oper);
}
```

�������������� �������� � **xlAutoFree** � **xlAutoFree12** ��. � ������ [xlAutoFree/xlAutoFree12](xlautofree-xlautofree12.md).
  
## <a name="returning-modify-in-place-arguments"></a>����������� ����������, ���������� �� �����

� Excel ������� XLL ����� ���������� ��������, ������� �������� �� �����. ��� ��������, ������ ���� �������� ���������� � ���� ���������. ��� ����� ������� ���������� ���������������� ���, ����� ������� Excel, ����� �������� ����� ����������. 
  
���� ����� ��� ����������� �������� �������������� ��� ���� ����� ������, ������� ����� ���������� � ������� ���������, �� �������� ������� ��� ��������� �����:
  
- ������ ������ ASCII, ��� ������� ������������ ������� ����� � ������� ������������ �����;
    
- ������ ����������� �������� �������, ��� ������� ������������ ������� ����� � ������� ������������ ����� (� Excel�2007 � ����� ������� ������);
    
- ������� **FP** � ��������� �������; 
    
- ������� � ��������� ������� **FP12** (� Excel�2007 � ����� ������� ������). 
    
> [!NOTE]
> [!����������] �� ������� �������� ���������� ����� ������� **XLOPER** ��� **XLOPER12**. �������������� �������� ��. � ������ [��������� ��������, ����������� ��� ���������� XLL ��� Excel](known-issues-in-excel-xll-development.md). 
  
������������ ����� ������� ��� �������������� ��������� ����������� ����������� � ���, ��� Excel �������� ������ ��� ������������ ��������. �������� ������ ������������ ������, Excel ����������� ������. ��� ����������� ������� XLL �� ���������� �������. ���� ������ ���������������: ����� ������� � Excel ���������� ������������ � ��������� �������, ��� ������� ������ ������ ������������ ���� �����.
  
��� ������ ��� ������������� ����������� ���� ����� ������, ������ ��� �������� ��������� ������ DLL ��� ������������ ������ ����� �����������, ������� ���������� ��� **XLOPER**/ **XLOPER12**, �� ���������� ��� ������� ����� � �������� **FP**/ **FP12**. �������������, ��� ����������� ��������� � ������� DLL ������ ��� ������� � ��������� ������� � ��� ���� ����������� ���� ��������. 
  
- ���������� ���������� ��������� ��� ����������� ����������� ������, ���������� ���������. �� ����� ���������� ������ ������� (1) ���������, ��� �������� ��������� � �� ����, (2) ���������� �������, ���������� �� ����� ����������� ������, � �������� �������� ���������, (3) �������� ����������� ��������� ��� ������ ����������� ����� ������.
    
- �������� ������ � ������� � ����������� ������, ������� �� ����� �����������, � ���������� ��������� � ����.
    
- �������� ��������� �� �����, ������� ������ ��� ������ ��������������� � ������������, ���������� ����������� Excel.
    
В противном случае необходимо создать **XLOPER**/ и **xlAutoFree****XLOPER12**и использования **xlbitDLLFree** / **xlAutoFree12** для освобождения ресурсов. 
  
��������� ������� ����� ���� ����� ������� ��� �������� ��������� ���� �� ����, ��� � ������������ ��������. �������� ��������, ��� ������� ������ ���������� � ��� �� ������� ����������� (��� ����� ������� ���� Excel). ������� ������ ��� ����� � �������� **FP**/ **FP12** ��������� ����. 
  
## <a name="strings"></a>������

�������� � ����������� ������� ����� � �������� ���������������� ������� ������������ ������ ���������� � ���������. ��� �������, �������� ��������� ��������� ����� ����� � �������� ���������. ���� ������, ������� ������������ ����� ��� ��� ������� ������������ ������� ����� (� ��� ������, ��� ������� ����������� ��� ��� �������); ����������� ��� ������������ ������; ������ ������������� ����� ��� ����������� �������������� �����; ������, ����������� ������������ �������� (��������, OLE Bstr), ��� ������������� ������, � ����� ������ ��������.
  
������������ C/C++ ���� ����� ���������� ������, �������������� �����. ����������� ���������� C ������������� ��� ������ � ������ ��������. ����������� ��������� �������� � ���� ������������� � ������, �������������� �����. ����� ����, Excel �������� �� �������� �� ��������� �����, ������� ������ �� ������������ �����. ��������� ���� ������ ������� ������� � ����������������� ������� � ��������� ����� � ������ ����� � DLL � XLL.
  
���� ��������� �������� ���������������� ��������.
  
- �������� ������� ��� ������������� ��������� � �������, ������� ������� ���������� ��������� � �� ��������� ��� �� ����� ��������� ��� ������������.
    
- ������������ ������ ������ ��������, ������� �� ������������ ��� �� ����� ����������� ������ ������ � ����� ������������ ������.
    
- ������� ���������� ������ ������ ������, ���� �� ����������� ��� ��� �������������, � ����� ���� ������� ������������ � ��������� �� ���������.
    
- ������ ������ � ���������� ��������� ��� ������������ ������������ ����� (������ � ����� ���������� �������).
    
### <a name="rules-for-strings"></a>������� ��� �����

��� � ��� **XLOPER**/ **XLOPER**, ��� ����� ���������� ������� � ������������, ������� ���������� ���������. ������������ �� ���������� �� ����������� � ���������� �������. �������������� ������� ��� ����� ��������� ����.
  
 **�������:**
  
- �� ��������� ���������� ������ ��� ������������ ������ **XLOPER**/ **XLOPER12**, � ����� ������� ������ �� ��������� ����� ��� ������, �������������� �����, ������� ���������� ��� ��������� � ������� XLL. ����� ��������� ������������� ������ ��� ������.
    
- ���� Excel �������� ������ ������ **XLOPER**/ **XLOPER12** ��� ��������� ������������� �������� ������� ��������� ������ API C, ���������� �� � ������� ������� **xlFree** ��� ������� �������� **xlbitXLFree** ��� �� ����������� � Excel �� ������� XLL. 
    
- Где библиотеки DLL динамически выделяет буфер строки для **XLOPER**/ **XLOPER12**сведениям в соответствии с выделением его при выполнить или возвращать его в Excel из функции XLL, установите **xlbitDLLFree** и затем освободить его в **xlAutoFree** /  **xlAutoFree12**.
    
- ���� Excel �������� ������ ������� **xltypeMulti**, ������������� � ���������� DLL �� ����� ������ API C, �� ��������������� ������ **XLOPER**/ **XLOPER12** � �������. ��� ������������ ���� �������� ���������� ������������ ������ ������� **xlFree** ��� �������� **xlbitXLFree** ��� ����������� �� ������� XLL.
    
### <a name="string-types-supported"></a>�������������� ���� �����

**������ XLOPER/XLOPER12 xltypeStr API C**

|**������ ������: **XLOPER****|**������ ����������� ��������: **XLOPER12****|
|:-----|:-----|
|��� ������ Excel  <br/> |Excel�2007 � ����� ������� ������  <br/> |
|������������ �����: 255 ������ ������������ ���� ASCII  <br/> |������������ �����: 32 767 �������� �������  <br/> |
|������ ���� (��� �����) = �����  <br/> |������ ������ ������� = �����  <br/> |
   
> [!IMPORTANT]
> [!�����!] ������ **XLOPER** ��� **XLOPER12** �� ������ ������������ �����. 
  
**������ C/C++**

|**������ ������**|**������ ����������� ��������**|
|:-----|:-----|
|Символом NULL (**символ** *) «C» Максимальная длина: 255 расширенного ASCII байт  <br/> |Символом NULL (**wchar_t** *) «% C» Максимальная длина 32 767 число знаков Юникод  <br/> |
|Со счетчиком длины (**без знака символ** *) «D»  <br/> |Со счетчиком длины (**wchar_t** *) «% D»  <br/> |
   
### <a name="strings-in-xltypemulti-xloperxloper12-arrays"></a>������ � �������� XLOPER/XLOPER12 xltypeMulti

� ��������� ������� Excel ������� ������ **xltypeMulti** ��� ������������� � ����������� DLL � XLL. ��������� �������������� ������� XLM ���������� ����� �������. ��������, ������� API C **xlfGetWorkspace** ��� �������� �� ���������  *44*  ���������� ������, ���������� ������, ������� ��������� ��� ������������������ ��������� DLL. ������� API C **xlfDialogBox** ���������� ���������� ����� ��������� �������, ���������� �������� ����� �����. ��������, ���� ����� ���������� XLL ������������ ������ **xltypeMulti** ��� ��� �������� � �������� ��������� � ������� XLL ��� �������������� � ���� ��� �� ���� ������ �� ��������. � ����� ������� Excel ������� �������� ����� ����� � �������� ������� � ��������� �� ��� � �������. 
  
���� �� ������ �������� ��� ������ � ���������� DLL, ������� ������� ����������� �������� �����. ��� �������� ����������� �������� **xltypeMulti** �� ������� �������� � ��� ���������� Excel ������ **XLOPER**/ **XLOPER12**. ���������� ���� �� ���������� �� ��������� ��� �� ���������� ������. ����� ����, ������� ��������� �������� ����� ����� � ������� ��������� �� ����� � �������.
  
 **�������**
  
� ��������� ������� ������� ������� ����������� ���������� ����� ������ ������� �� ��������� �����. �������� ��������, ��� ���������� ������� � �������� ����� ������ ���������� ������, ���������� � ���� �������, � ������� ��������� **delete**[], � �������� ������ �� ������ ������������ �����. ������ ����� ���������, ���� ��� ���������� ��� ������������, � �� ������������ �����.
  
```cs
#include <string.h>
#define MAX_V12_STRBUFFLEN    32678
    
wchar_t * deep_copy_wcs(const wchar_t *p_source)
{
    if(!p_source)
        return NULL;
    size_t source_len = p_source[0];
    bool truncated = false;
    if(source_len >= MAX_V12_STRBUFFLEN)
    {
        source_len = MAX_V12_STRBUFFLEN - 1; // Truncate the copy
        truncated = true;
    }
    wchar_t *p_copy = new wchar_t[source_len + 1];
    wcsncpy_s(p_copy, p_source, source_len + 1);
    if(truncated)
        p_copy[0] = source_len;
    return p_copy;
}
```

����� � ������� ���� ������� ����� ��������� ���������� **XLOPER12**, ��� �������� �� ������� ��������� �������������� ������� XLL, ������������ ����� ���������, ���� ��� ������. ��� ������ ���� ������������ ��� ������ ������. �������� ��������, ��� ��������� �� �������������� � ������� ���������� **#VALUE!**. ��� ������� ���������� ���������������� ��� �����, ������� ��������� �������� ���� "U", ��� �������� ������ � ���� ��������. ��� ������������ ���������� ������� **T()** ����� (�� ����������� ����, ��� **AsText** ����� ����������� ������ � ������ ������). � ���� ������� ���� ��������������, ��� **xlAutoFree12** ����������� ���������� ���������, � ����� ��� ����������, � ������� ��������� **delete**.
  
```cs
LPXLOPER12 WINAPI AsText(LPXLOPER12 pArg)
{
    LPXLOPER12 pRtnVal = new XLOPER12;
// If the input was an array, only operate on the top-left element.
    LPXLOPER *pTemp;
    if(pArg->xltype == xltypeMulti)
        pTemp = pArg->val.array.lparray;
    else
        pTemp = pArg;
    switch(pTemp->xltype)
    {
        case xltypeErr:
        case xltypeNum:
        case xltypeMissing:
        case xltypeNil:
        case xltypeBool:
            pRtnVal->xltype = xltypeStr | xlbitDLLFree;
            pRtnVal->val.str = deep_copy_wcs(L"\000");
            return pRtnVal;
        case xltypeStr:
            pRtnVal->xltype = xltypeStr | xlbitDLLFree;
            pRtnVal->val.str = deep_copy_wcs(pTemp->val.str);
            return pRtnVal;
        
        default: // xltypeSRef, xltypeRef, xltypeFlow, xltypeInt
            pRtnVal->xltype = xltypeErr | xlbitDLLFree;
            pRtnVal->val.err = xlerrValue;
            return pRtnVal;
    }
}
```

### <a name="returning-modify-in-place-string-arguments"></a>����������� ��������� ����������, ���������� �� �����

���������, ������������������ ��� ��������� ����� **F**, **G**, **F%** � **G%**, ����� �������� �� �����. ������������� ��������� ��������� ��� ���� �����, Excel ������� ����� ������������� �������. ����� Excel �������� � ���� ������ ���������, ���� ���� ��� ����������� ������. ��� ��������� ������� XLL ���������� ������������ �������� ��������������� � �� �� ������. 
  
���� ��������� ������� ������, ������������� ��� ���� �����.
  
- **������ ������:** 256 ������, ������� ������� ����� (��� "G") ��� ����������� ������ ���� (��� "F"). 
    
- **������ � ��������� ������:** 32 768 ����������� �������� (65 536 ������), ������� ������� ����� (��� "G%") ��� ����������� ������ ���� (��� "F%"). 
    
> [!NOTE]
> [!����������] ��� ������� ���������� ������� ��������������� �� Visual Basic ��� ���������� (VBA), ��� ��� �� �� ������ ������������� ��������� ������ ���������� �������� �������. ��������� ��� ������� ����� ������� ������ �� ������ ���������� DLL, ���� �� ���� �������� ���������� ������� �����. 
  
���� �������� ������ ������� XLL, ������� �������� �� �������� ������������������ ����������� �������� � ���������� ������, �������������� �����, ��������� ����������� ������� ���������� **wcsrev**. �������� � ���� ������ ����� ��������������� ��� �������� ���� **F%**.
  
```cs
void WINAPI reverse_text_xl12(wchar_t *text)
{
    _wcsrev(text);
}
```

## <a name="persistent-storage-binary-names"></a>���������� ��������� (�������� �����)

�������� ����� ������������ � ����������� � ������� �������� (�������������������) ������, ������� �������� ������ � ������. ��� ��������� � ������� ������� [xlDefineBinaryName](xldefinebinaryname.md), � ������ ����������� � ������� ������� [xlGetBinaryName](xlgetbinaryname.md). ��� ������� ����� �������� ������� � ����������� �� �������� (��. ������ [������� ���������� API ��� C, ������� ����� ���������� ������ �� DLL ��� XLL](c-api-functions-that-can-be-called-only-from-a-dll-or-xll.md)) � ���������� **XLOPER******/  **xltypeBigData**. 
  
�������� �� ��������� ���������, ������� ������������ ������������ ���������� �������� ����, ��. � ������ [��������� ��������, ����������� ��� ���������� XLL ��� Excel](known-issues-in-excel-xll-development.md).
  
## <a name="excel-stack"></a>���� Excel

Excel ���������� ���� ������ �� ����� ������������ ������������ DLL. ����� � ����� ������ ����� ��� ���������� ��� �������� �������������. � ��� �� ����� ������������, ���� �� ���������� ��������� ������������: 
  
- �� ����������� ����� ������� ��������� � �������� ���������� ������� � ���� �������� � �����. ����������� ��������� ��� ������.
    
- �� ����������� ������� ��������� � �����. ����������� ��������� �� ����������� ��� ����������� ���������� ������ ��� ����������� ���������, ������������ � �������������� ������.
    
- �� ���������� ����� ������� ��������� �������������� ���������� � ���� �������. ���� ����������, �������� �� ��� �����������.
    
- �� ��������� ������� ����������, ���� �� �������, ��� �������� ������ ����� ��������. ������ ����� ����������� ����.
    
������� �������� ����� �� ���������� DLL � ������� API C, Excel ������� ���������, ���������� �� ����� � ����� ��� ������ ������� ��������. ���� Excel ���������, ��� ���������� ����� ����� ���� ������������, �� ���������� ����� ��� ������������, ���� ���� �� ����� ���� ����� ����������. � ���� ������ ��� �������� ������ ������������ ��� **xlretFailed**. ��� ������� ������������� API C � ����� ���� ������ API C ���� �� ���������� �� ���� �������.
  
���� �� ������ ��������� ���������� ����� � ����� �� ��������� ������ ����, ������� ����� �����, ������ ������� [xlStack](xlstack.md). 
  
## <a name="see-also"></a>��. �����



[�������������� �������� � Excel](multithreaded-recalculation-in-excel.md)
  
[��������������� � ��������� ������ � Excel](multithreading-and-memory-contention-in-excel.md)
  
[���������� XLL-������� ��� Excel 2013](developing-excel-xlls.md)


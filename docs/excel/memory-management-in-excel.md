---
title: ���������� ������� � Excel
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
ms.topic: overview
keywords:
- xloper12 memory [excel 2007],managing memory in Excel,Excel stack,strings [Excel 2007], managing memory,memory management in Excel,XLOPER memory [Excel 2007],memory [Excel 2007], management guidelines
localization_priority: Normal
ms.assetid: 3bf5195b-6235-43cf-8795-0c7b0a63a095
description: '������� ����������: Excel 2013�| Office 2013�| Visual Studio'
ms.openlocfilehash: f129dac2971f01c8ada15f0028958132b1945746
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33419543"
---
# <a name="memory-management-in-excel"></a>Управление памятью в Excel

 **Область применения:** Excel 2013 | Office 2013 | Visual Studio 
  
���� �� ������ ��������� ����������� � ���������� XLL-����������, ������� �������� ������� ���������� �������. ������������ ���������� ������� ����� �������� � ������ ���� ������� � Microsoft Excel � �� ��������������, ����� ��� ��������� ������ ������ ��� �� ������������� ������������� � �������������, �� ���������, ����� ��� �������������� Excel.
  
������������ ���������� ������� � �������� ���������������� ������� ��������� �������, ��������� � ������������. �������������, ���������� ������ ������ ��� ������� ������ ����������� � ���������������� ��������� ���������� �������. 
  
� ���������� �������������� ��������� ���� � Microsoft Office Excel 2007 ��������� ������� ����� �������. ���� �� ������ ��������� � �������������� ���������������� ������� ������, ���������� ��������� ���������, ������� ����� ��������� ��� ����������� ���������� ������� �� ������.
  
���� ��������� ������������ ��� ��������� ���� ����� ��������� ������:
  
- **XLOPER** � **XLOPER12**;
    
- �����, ��������� ������� ���������� �� **XLOPER** ��� **XLOPER12**;
    
- �������� **FP** � **FP12**. 
    
## <a name="xloperxloper12-memory"></a>Память XLOPER и XLOPER12

Структура данных **XLOPER**/ **XLOPER12** содержит несколько подтипов, которые содержат указатели на блоки памяти, а именно строки (**кслтипестр**), массивы (**xltypeMulti**) и внешние ссылки (**кслтипереф**). Note also that **xltypeMulti** arrays can contain string **XLOPER**/ **XLOPER12s** that in turn point to other blocks of memory. 
  
An **XLOPER**/ **XLOPER12** can be created in several ways: 
  
- � Excel ��� ���������� ���������� ��� �������� � ������� XLL;
    
- � Excel ��� ����������� **XLOPER** ��� **XLOPER12** �� ����� ������ API C; 
    
- � DLL ��� �������� ���������� ��� �������� �� ����� ������ API C;
    
- в DLL при создании возвращаемого значения функции XLL.
    
Блок памяти, принадлежащий к типу указателей на память, можно выделить под что-то несколькими способами:
  
- как статический блок в библиотеке DLL за пределами кода функции (в этом случае необязательно выделять или освобождать память);
    
- ��� ����������� ���� � ���������� DLL, �������� � ��� ������� (� ���� ������ ������������� �������� ��� ����������� ������);
    
- � ������� ������������� ��������� � ������������ � ���������� DLL ( **malloc** � **free**, **new** � **delete** � �. �.);
    
- � ������� ������������� ��������� � Excel.
    
�������� ����� ��������� ���������� ������ **XLOPER**/ **XLOPER12** � ���������� ��������, � ������� ���������� ������ **XLOPER**/ **XLOPER12** ���������� ��� ������, �������������, ��� ��� ���� ����� ���� ����� �������. ��� �� �����, ���� ��������� ���������� �������� � �������������, �� ����� ����������� ���������. 
  
### <a name="rules-for-working-with-xloperxloper12"></a>Правила работы с XLOPER/XLOPER12

- �� ��������� ���������� ������ ��� ������������ ��������� ������ **XLOPERs**/ **XLOPER12**, ������� ���������� ��� ��������� � ������� XLL. ��� ��������� ������������� ������ ��� ������. �������������� �������� ��. � ������� "����������� **XLOPER** ��� **XLOPER12** � ������� ��������� ���������� �� �����" ������ [��������� ��������, ����������� ��� ���������� XLL ��� Excel](known-issues-in-excel-xll-development.md).
    
- ���� ���������� Excel �������� ������ ��������� ������ **XLOPER**/ **XLOPER12**, ������������ � DLL �� ����� ������ API C: 
    
  - ���������� ���������� ������, ����� ��� ������ �� ��������� **XLOPER**/ **XLOPER12**, � ������� ������ [xlFree](xlfree.md). �� ����������� ��� ����� ������ �����, �������� free ��� delete.
    
  - ���� ������������ ��� � **xltypeMulti**, �� ��������������� **XLOPER**/ **XLOPER12** � �������, �������� ���� ��� �������� ������ ��� �� �������� ��������� ���������� � ������� ������.
    
  - ����� ���������� � Excel **XLOPER**/ **XLOPER12** ��� ������������ �������� ������� DLL, ���������� �������� Excel � ������, ������� ���������� ���������� ����� ���������� ������. 
    
- ������� **xlFree** ���������� �������� ������ ��� ��������� ������ **XLOPER**/ **XLOPER12**, ��������� � �������� ������������� �������� ��� ������ API C. 
    
- ���� ���������� DLL �������� ������ ��������� ������ **XLOPER**/ **XLOPER12**, ������� ����� ���������� � Excel � �������� ������������� �������� ������� DLL, ���������� �������� Excel � ������, ������� ���������� DLL ������ ����������. 
    
### <a name="guidelines-for-memory-management"></a>Рекомендации по управлению памятью

- Используйте определенный метод для выделения и освобождения памяти в библиотеке DLL. Не смешивайте методы. Рекомендуем использовать нужный метод как структуру или класс памяти, где его можно изменять, не изменяя код в других местах.
    
- ��� �������� �������� **xltypeMulti** � ���������� DLL ��������� ������ ��� ����� ������������ ��������: ������ ��������� ������ ����������� ��� ������ ����������� ����������� ������. � ���� ������, ���������� ������, �� ������ �����, ��� ���������� ������ ����������� ������ ��� ������� ����� �� ������. 
    
- ���������� �������� ����� ���������� Excel ������ ��� ����������� ��������� � ������� Excel ��������� ������ **XLOPER**/ **XLOPER12**.
    
- �� ��������� ���������� Excel ������ **XLOPER**/ **XLOPER12** � ������� **xltypeMulti**. ���������� �������� ����� ����� � ������� ��������� �� ��� ����� � �������. 
    
## <a name="freeing-excel-allocated-xloperxloper12-memory"></a>Освобождение выделенной Excel памяти XLOPER/XLOPER12

� ��������� ������� XLL ������������ ������� **xlGetName** ��� ��������� ������, ���������� ��� DLL-����� � ���� � ����, � ������� **xlcAlert** ��� �� ����������� � ���������� ���� ����������.
  
```cs
int WINAPI show_DLL_name(void)
{
    XLOPER12 xDllName;
    if(Excel12(xlfGetName, &xDllName, 0) == xlretSuccess)
    {
        // Display the name.
        Excel12(xlcAlert, 0, 1, &xDllName);
        // Free the memory that Excel allocated for the string.
        Excel12(xlFree, 0, 1, &xDllName);
    }
    return 1;
}

```

����� ������� ������ �� ����� ������, �� ������� ��������� **xDllName**, ��� ����� ���������� ��, ��������� ����� [������� xlFree](xlfree.md), ����� �� ������� API C ������ ��� ��������� DLL. 
  
������� **xlFree** �������� ������� � ����������� �� �������� (��. ������ [������� ���������� API ��� C, ������� ����� ���������� ������ �� DLL ��� XLL](c-api-functions-that-can-be-called-only-from-a-dll-or-xll.md)), �� �������� �������� �� ���������:
  
- �� ������ ���������� ��������� ���������� ���������� ������ **XLOPER**/ **XLOPER12** �� ����� ������ ������ ������� **xlFree**. ������������ ����������� ��� ���� � ���������� ���������� �������, ������� �������������� � ������������ ������ Excel (30 � Excel 2003, 255 � Excel�2007 � ����� ������� ������).
    
- ������� **xlFree** ������������� ��� ������������� ��������� �������� **NULL**, ����� ���������� ������������ ��� ������� ������������ ��� ������������� ��������� ������ **XLOPER**/ **XLOPER12**. **xlFree** � ��� ������������ ������� API C, ������� �������� ���� ���������. 
    
- �� ������ ��������� �������� **xlFree** ��� ����� ��������� ������ **XLOPER**/ **XLOPER12**, ������� ������������ ��� ��������� ������������� �������� ��� ������ API C, ���������� �� ������� � ��� ��������� �� ������. 
    
## <a name="returning-xloperxloper12s-to-be-freed-by-excel"></a>Возвращение структур данных XLOPER или XLOPER12 для освобождения в Excel

Suppose you wanted to modify the example command in the previous section and change it to a worksheet function that returns the DLL path and file name when passed a **Boolean** **true** argument, and **#N/A** otherwise. Clearly you cannot call **xlFree** to release the string memory before returning it to Excel. However, if it is not freed at some point, the add-in will leak memory every time the function is called. To work around this problem, you can set a bit in the **xltype** field of the **XLOPER**/ **XLOPER12**, defined as **xlbitXLFree** in xlcall.h. Setting this tells Excel that it must free the returned memory when it has finished copying the value out. 
  
### <a name="example"></a>Пример

В следующем примере кода показано преобразование команды XLL из предыдущего раздела в функцию листа XLL.
  
```cs
LPXLOPER12 WINAPI get_DLL_name(int calculation_trigger)
{
    static XLOPER12 xRtnValue; // Not thread-safe
    Excel12(xlfGetName, &xRtnValue, 0);
// If xlfGetName failed, xRtnValue will be #VALUE!
    if(xRtnValue.xltype == xltypeStr)
    {
// Tell Excel to free the string memory after
// it has copied out the return value.
        xRtnValue.xltype |= xlbitXLFree;
    }
    return &xRtnValue;
}
```

������� XLL, ������� ���������� **XLOPER**/ **XLOPER12**, ���������� �������� ��� �����, ������� ��������� � ���������� ��������� �� **XLOPER**/ **XLOPER12**. ������������� � ���� ������� ����������� ������ **XLOPER12** � ������� �� ���������������. �� ������ ����������� ���������������� ��� ������� ��� ����������������, �� ���������� ���� ���������� �������� **xRtnValue** ����� ������� �� ���������� ������ � ��� ������� ������. 
  
�������� **xlbitXLFree** ���������� �������� ����� ������ ������� ��������� ������ Excel, ������� ��� ��������. ���� ������ ��� �� �����, ��� ����� ������������ � �� ���� ������� �������. ���� �� ������ ������������ ��� �������� � �������� ��������� �� ����� ������ ������ ������� API C �� ��� ����������� �� ����, ��� �������� ������� �������� ����� ������ ������. � ��������� ������ �� ����������� �������, ������� �� ��������� ��� �������� �� �������� ���� **XLOPER**/ **XLLOPER12**. 
  
## <a name="returning-xloperxloper12s-to-be-freed-by-the-dll"></a>Возвращение структур данных XLOPER или XLOPER12 для освобождения в библиотеке DLL

����������� �������� ���������, ����� ���������� XLL �������� ������ **XLOPER**/ **XLOPER12** � ����� ���������� �� � Excel. Excel ���������� ��� ���� ��������, ������� ����� ������ � ���� **xltype** ��������� ������ **XLOPER**/ **XLOPER12**, � **xlbitDLLFree** � xlcall.h. 
  
������� **an XLOPER**/ **XLOPER12** � ���� ���������, Excel �������� ������� ������� [xlAutoFree](xlautofree-xlautofree12.md) (��� **XLOPER**) ��� **xlAutoFree12** (��� **XLOPER12**), ������� ������ �������������� ���������� XLL. ��� ������� ����� �������� ������� � ����������� �� �������� (��. ������ [��������� ��������� � ������� XLL ����������](add-in-manager-and-xll-interface-functions.md)), �� ������ ����������� ���������� �������� �����. ��� ������������� ��� ������������ ������ **XLOPER**/ **XLOPER12** ��� �� ��������, ������� ��� ���������� ��������. 
  
### <a name="examples"></a>Примеры

�������� ������� � ��������� ������� ���������� �������� ���������� ������� (�� ����������� ����, ��� ��� �������� ����� "The full pathname for this DLL is" ����� ������ DLL).
  
```cs
#include <string.h>
LPXLOPER12 WINAPI get_DLL_name_2(int calculation_trigger)
{
    static XLOPER12 xRtnValue; // Not thread-safe
    Excel12(xlfGetName, &xRtnValue, 0);
// If xlfGetName failed, xRtnValue will be #VALUE!
    if(xRtnValue.xltype != xltypeStr)
        return &xRtnValue;
// Make a copy of the DLL path and file name.
    wchar_t *leader = L"The full pathname for this DLL is ";
    size_t leader_len = wcslen(leader);
    size_t dllname_len = xRtnValue.val.str[0];
    size_t msg_len = leader_len + dllname_len;
    wchar_t *msg_text = (wchar_t *)malloc(msg_len + 1);
    wcsncpy_s(msg_text + 1, leader, leader_len);
    wcsncpy_s(msg_text + 1 + leader_len, xRtnValue.val.str + 1,
        dllname_len);
    msg_text[0] = msg_len;
// Now the original string has been copied Excel can free it.
    Excel12(xlFree, 0, 1, &xRtnValue);
// Now reuse the XLOPER12 for the new string.
    xRtnValue.val.str = msg_text;
// Tell Excel to call back into the DLL to free the string
// memory after it has copied out the return value.
    xRtnValue.xltype     = xltypeStr | xlbitDLLFree;
    return &xRtnValue;
}
```

����������� ���������� ������� **xlAutoFree12** � ���������� XLL, ���������������� ���������� �������, �������� ��������� �������. 
  
```cs
void WINAPI xlAutoFree12(LPXLOPER12 p_oper)
{
    if(p_oper->xltype == (xltypeStr | xlbitDLLFree))
        free(p_oper->val.str);
}
```

���� ���������� ����������, ������ ���� ���������� XLL ���������� ������ **XLOPER12** � ��� ���������� � ������� ������� **malloc**. �������� ��������, ��� � ���� ������ ���� 
  
 ` if(p_oper->xltype == xltypeStr) `
  
���� ����, ��� ��� ������ �������� **xlbitDLLFree**. 
  
� �����, ������� **xlAutoFree** � **xlAutoFree12** ���������� ����������� ���, ����� ��� ����������� ������, ��������� � ���������� ��� ������ XLL ��������� **xltypeMulti** � �������� �������� **xltypeRef**. 
  
You might decide to implement your XLL functions so that they ALL return dynamically allocated **XLOPER**s and **XLOPER12**s. In this case, you would need to set **xlbitDLLFree** on all such **XLOPER**s and **XLOPER12**s regardless of the sub-type. You would also need to implement **xlAutoFree** and **xlAutoFree12** so that this memory was freed and also any memory pointed to within the **XLOPER**/ **XLOPER12**. This approach is one way to make the return value thread safe. For example, the previous function could be rewritten as follows.
  
```cs
#include <string.h>
LPXLOPER12 WINAPI get_DLL_name_3(int calculation_trigger)
{
// Thread-safe
    LPXLOPER12 pxRtnValue = (LPXLOPER12)malloc(sizeof(XLOPER12));
    Excel12(xlfGetName, pxRtnValue, 0);
// If xlfGetName failed, pxRtnValue will be #VALUE!
    if(pxRtnValue->xltype != xltypeStr)
    {
// Even though an error type does not point to memory,
// Excel needs to pass this oper to xlAutoFree12 to
// free pxRtnValue itself.
        pxRtnValue->xltype |= xlbitDLLFree;
        return pxRtnValue;
    }
// Make a copy of the DLL path and file name.
    wchar_t *leader = L"The full pathname for this DLL is ";
    size_t leader_len = wcslen(leader);
    size_t dllname_len = pxRtnValue->val.str[0];
    size_t msg_len = leader_len + dllname_len;
    wchar_t *msg_text = (wchar_t *)malloc(msg_len + 1);
    wcsncpy_s(msg_text + 1, leader, leader_len);
    wcsncpy_s(msg_text + 1 + leader_len, pxRtnValue->val.str + 1,
        dllname_len);
    msg_text[0] = msg_len;
// Now the original string has been copied Excel can free it.
    Excel12(xlFree, 0, 1, pxRtnValue);
// Now reuse the XLOPER12 for the new string.
    pxRtnValue->val.str = msg_text;
    pxRtnValue->xltype = xltypeStr | xlbitDLLFree;
    return pxRtnValue;
}
void WINAPI xlAutoFree12(LPXLOPER12 p_oper)
{
    if(p_oper->xltype == (xltypeStr | xlbitDLLFree))
        free(p_oper->val.str);
    free(p_oper);
}
```

�������������� �������� � **xlAutoFree** � **xlAutoFree12** ��. � ������ [xlAutoFree/xlAutoFree12](xlautofree-xlautofree12.md).
  
## <a name="returning-modify-in-place-arguments"></a>Возвращение аргументов, изменяемых на месте

В Excel функция XLL может возвращать значение, изменяя аргумент на месте. Это возможно, только если аргумент передается в виде указателя. Для этого функцию необходимо зарегистрировать так, чтобы указать Excel, какой аргумент будет изменяться. 
  
���� ����� ��� ����������� �������� �������������� ��� ���� ����� ������, ������� ����� ���������� � ������� ���������, �� �������� ������� ��� ��������� �����:
  
- ������ ������ ASCII, ��� ������� ������������ ������� ����� � ������� ������������ �����;
    
- ������ ����������� �������� �������, ��� ������� ������������ ������� ����� � ������� ������������ ����� (� Excel�2007 � ����� ������� ������);
    
- ������� **FP** � ��������� �������; 
    
- ������� � ��������� ������� **FP12** (� Excel�2007 � ����� ������� ������). 
    
> [!NOTE]
> [!����������] �� ������� �������� ���������� ����� ������� **XLOPER** ��� **XLOPER12**. �������������� �������� ��. � ������ [��������� ��������, ����������� ��� ���������� XLL ��� Excel](known-issues-in-excel-xll-development.md). 
  
������������ ����� ������� ��� �������������� ��������� ����������� ����������� � ���, ��� Excel �������� ������ ��� ������������ ��������. �������� ������ ������������ ������, Excel ����������� ������. ��� ����������� ������� XLL �� ���������� �������. ���� ������ ���������������: ����� ������� � Excel ���������� ������������ � ��������� �������, ��� ������� ������ ������ ������������ ���� �����.
  
��� ������ ��� ������������� ����������� ���� ����� ������, ������ ��� �������� ��������� ������ DLL ��� ������������ ������ ����� �����������, ������� ���������� ��� **XLOPER**/ **XLOPER12**, �� ���������� ��� ������� ����� � �������� **FP**/ **FP12**. �������������, ��� ����������� ��������� � ������� DLL ������ ��� ������� � ��������� ������� � ��� ���� ����������� ���� ��������. 
  
- ���������� ���������� ��������� ��� ����������� ����������� ������, ���������� ���������. �� ����� ���������� ������ ������� (1) ���������, ��� �������� ��������� � �� ����, (2) ���������� �������, ���������� �� ����� ����������� ������, � �������� �������� ���������, (3) �������� ����������� ��������� ��� ������ ����������� ����� ������.
    
- �������� ������ � ������� � ����������� ������, ������� �� ����� �����������, � ���������� ��������� � ����.
    
- �������� ��������� �� �����, ������� ������ ��� ������ ��������������� � ������������, ���������� ����������� Excel.
    
Otherwise, you must create an **XLOPER**/ **XLOPER12**, and use **xlbitDLLFree** and **xlAutoFree**/ **xlAutoFree12** to release the resources. 
  
��������� ������� ����� ���� ����� ������� ��� �������� ��������� ���� �� ����, ��� � ������������ ��������. �������� ��������, ��� ������� ������ ���������� � ��� �� ������� ����������� (��� ����� ������� ���� Excel). ������� ������ ��� ����� � �������� **FP**/ **FP12** ��������� ����. 
  
## <a name="strings"></a>Строки

Проблемы с управлением памятью строк — наиболее распространенная причина нестабильной работы приложений и надстроек. Это понятно, учитывая множество различных типов строк и способов обработки. Есть строки, которые оканчиваются нулем или для которых используется счетчик длины (а еще строки, для которых выполняются оба эти условия); статические или динамические буферы; строки фиксированной длины или практически неограниченной длины; память, управляемая операционной системой (например, OLE Bstr), или неуправляемые строки, а также другие варианты.
  
������������ C/C++ ���� ����� ���������� ������, �������������� �����. ����������� ���������� C ������������� ��� ������ � ������ ��������. ����������� ��������� �������� � ���� ������������� � ������, �������������� �����. ����� ����, Excel �������� �� �������� �� ��������� �����, ������� ������ �� ������������ �����. ��������� ���� ������ ������� ������� � ����������������� ������� � ��������� ����� � ������ ����� � DLL � XLL.
  
���� ��������� �������� ���������������� ��������.
  
- �������� ������� ��� ������������� ��������� � �������, ������� ������� ���������� ��������� � �� ��������� ��� �� ����� ��������� ��� ������������.
    
- ������������ ������ ������ ��������, ������� �� ������������ ��� �� ����� ����������� ������ ������ � ����� ������������ ������.
    
- Попытка освободить память буфера строки, если он статический или уже освобожденный, а также если способы освобождения и выделения не совпадают.
    
- Утечки памяти в результате выделения без последующего освобождения строк (обычно в часто вызываемой функции).
    
### <a name="rules-for-strings"></a>Правила для строк

��� � ��� **XLOPER**/ **XLOPER**, ��� ����� ���������� ������� � ������������, ������� ���������� ���������. ������������ �� ���������� �� ����������� � ���������� �������. �������������� ������� ��� ����� ��������� ����.
  
 **�������:**
  
- �� ��������� ���������� ������ ��� ������������ ������ **XLOPER**/ **XLOPER12**, � ����� ������� ������ �� ��������� ����� ��� ������, �������������� �����, ������� ���������� ��� ��������� � ������� XLL. ����� ��������� ������������� ������ ��� ������.
    
- ���� Excel �������� ������ ������ **XLOPER**/ **XLOPER12** ��� ��������� ������������� �������� ������� ��������� ������ API C, ���������� �� � ������� ������� **xlFree** ��� ������� �������� **xlbitXLFree** ��� �� ����������� � Excel �� ������� XLL. 
    
- Where your DLL dynamically allocates a string buffer for an **XLOPER**/ **XLOPER12**, free it in a way consistent with how you allocated it when done, or set **xlbitDLLFree** if returning it to Excel from an XLL function and then free it in **xlAutoFree**/ **xlAutoFree12**.
    
- ���� Excel �������� ������ ������� **xltypeMulti**, ������������� � ���������� DLL �� ����� ������ API C, �� ��������������� ������ **XLOPER**/ **XLOPER12** � �������. ��� ������������ ���� �������� ���������� ������������ ������ ������� **xlFree** ��� �������� **xlbitXLFree** ��� ����������� �� ������� XLL.
    
### <a name="string-types-supported"></a>Поддерживаемые типы строк

**������ XLOPER/XLOPER12 xltypeStr API C**

|**������ ������: **XLOPER****|**������ ����������� ��������: **XLOPER12****|
|:-----|:-----|
|��� ������ Excel  <br/> |Excel�2007 � ����� ������� ������  <br/> |
|������������ �����: 255 ������ ������������ ���� ASCII  <br/> |Максимальная длина: 32 767 символов Юникода  <br/> |
|Первый байт (без знака) = длина  <br/> |������ ������ ������� = �����  <br/> |
   
> [!IMPORTANT]
> [!�����!] ������ **XLOPER** ��� **XLOPER12** �� ������ ������������ �����. 
  
**������ C/C++**

|**������ ������**|**������ ����������� ��������**|
|:-----|:-----|
|Оканчивающиеся нулем (**char** *), тип "C", максимальная длина составляет 255 байтов расширенного кода ASCII  <br/> |Оканчивающиеся нулем (**wchar_t** *), тип "C%", максимальная длина составляет 32 767 символов Юникода  <br/> |
|Со счетчиком длины (**unsigned char** *), тип "D"  <br/> |Со счетчиком длины (**wchar_t** *), тип "D%"  <br/> |
   
### <a name="strings-in-xltypemulti-xloperxloper12-arrays"></a>Строки в массивах XLOPER/XLOPER12 xltypeMulti

� ��������� ������� Excel ������� ������ **xltypeMulti** ��� ������������� � ����������� DLL � XLL. ��������� �������������� ������� XLM ���������� ����� �������. ��������, ������� API C **xlfGetWorkspace** ��� �������� �� ���������  *44*  ���������� ������, ���������� ������, ������� ��������� ��� ������������������ ��������� DLL. ������� API C **xlfDialogBox** ���������� ���������� ����� ��������� �������, ���������� �������� ����� �����. ��������, ���� ����� ���������� XLL ������������ ������ **xltypeMulti** ��� ��� �������� � �������� ��������� � ������� XLL ��� �������������� � ���� ��� �� ���� ������ �� ��������. � ����� ������� Excel ������� �������� ����� ����� � �������� ������� � ��������� �� ��� � �������. 
  
���� �� ������ �������� ��� ������ � ���������� DLL, ������� ������� ����������� �������� �����. ��� �������� ����������� �������� **xltypeMulti** �� ������� �������� � ��� ���������� Excel ������ **XLOPER**/ **XLOPER12**. ���������� ���� �� ���������� �� ��������� ��� �� ���������� ������. ����� ����, ������� ��������� �������� ����� ����� � ������� ��������� �� ����� � �������.
  
 **�������**
  
� ��������� ������� ������� ������� ����������� ���������� ����� ������ ������� �� ��������� �����. �������� ��������, ��� ���������� ������� � �������� ����� ������ ���������� ������, ���������� � ���� �������, � ������� ��������� **delete**[], � �������� ������ �� ������ ������������ �����. ������ ����� ���������, ���� ��� ���������� ��� ������������, � �� ������������ �����.
  
```cs
#include <string.h>
#define MAX_V12_STRBUFFLEN    32678
    
wchar_t * deep_copy_wcs(const wchar_t *p_source)
{
    if(!p_source)
        return NULL;
    size_t source_len = p_source[0];
    bool truncated = false;
    if(source_len >= MAX_V12_STRBUFFLEN)
    {
        source_len = MAX_V12_STRBUFFLEN - 1; // Truncate the copy
        truncated = true;
    }
    wchar_t *p_copy = new wchar_t[source_len + 1];
    wcsncpy_s(p_copy, p_source, source_len + 1);
    if(truncated)
        p_copy[0] = source_len;
    return p_copy;
}
```

����� � ������� ���� ������� ����� ��������� ���������� **XLOPER12**, ��� �������� �� ������� ��������� �������������� ������� XLL, ������������ ����� ���������, ���� ��� ������. ��� ������ ���� ������������ ��� ������ ������. �������� ��������, ��� ��������� �� �������������� � ������� ���������� **#VALUE!**. ��� ������� ���������� ���������������� ��� �����, ������� ��������� �������� ���� "U", ��� �������� ������ � ���� ��������. ��� ������������ ���������� ������� **T()** ����� (�� ����������� ����, ��� **AsText** ����� ����������� ������ � ������ ������). � ���� ������� ���� ��������������, ��� **xlAutoFree12** ����������� ���������� ���������, � ����� ��� ����������, � ������� ��������� **delete**.
  
```cs
LPXLOPER12 WINAPI AsText(LPXLOPER12 pArg)
{
    LPXLOPER12 pRtnVal = new XLOPER12;
// If the input was an array, only operate on the top-left element.
    LPXLOPER *pTemp;
    if(pArg->xltype == xltypeMulti)
        pTemp = pArg->val.array.lparray;
    else
        pTemp = pArg;
    switch(pTemp->xltype)
    {
        case xltypeErr:
        case xltypeNum:
        case xltypeMissing:
        case xltypeNil:
        case xltypeBool:
            pRtnVal->xltype = xltypeStr | xlbitDLLFree;
            pRtnVal->val.str = deep_copy_wcs(L"\000");
            return pRtnVal;
        case xltypeStr:
            pRtnVal->xltype = xltypeStr | xlbitDLLFree;
            pRtnVal->val.str = deep_copy_wcs(pTemp->val.str);
            return pRtnVal;
        
        default: // xltypeSRef, xltypeRef, xltypeFlow, xltypeInt
            pRtnVal->xltype = xltypeErr | xlbitDLLFree;
            pRtnVal->val.err = xlerrValue;
            return pRtnVal;
    }
}
```

### <a name="returning-modify-in-place-string-arguments"></a>Возвращение строковых аргументов, изменяемых на месте

���������, ������������������ ��� ��������� ����� **F**, **G**, **F%** � **G%**, ����� �������� �� �����. ������������� ��������� ��������� ��� ���� �����, Excel ������� ����� ������������� �������. ����� Excel �������� � ���� ������ ���������, ���� ���� ��� ����������� ������. ��� ��������� ������� XLL ���������� ������������ �������� ��������������� � �� �� ������. 
  
���� ��������� ������� ������, ������������� ��� ���� �����.
  
- **Строки байтов:** 256 байтов, включая счетчик длины (тип "G") или завершающий символ нуля (тип "F"). 
    
- **Строки в кодировке Юникод:** 32 768 расширенных символов (65 536 байтов), включая счетчик длины (тип "G%") или завершающий символ нуля (тип "F%"). 
    
> [!NOTE]
> [!����������] ��� ������� ���������� ������� ��������������� �� Visual Basic ��� ���������� (VBA), ��� ��� �� �� ������ ������������� ��������� ������ ���������� �������� �������. ��������� ��� ������� ����� ������� ������ �� ������ ���������� DLL, ���� �� ���� �������� ���������� ������� �����. 
  
���� �������� ������ ������� XLL, ������� �������� �� �������� ������������������ ����������� �������� � ���������� ������, �������������� �����, ��������� ����������� ������� ���������� **wcsrev**. �������� � ���� ������ ����� ��������������� ��� �������� ���� **F%**.
  
```cs
void WINAPI reverse_text_xl12(wchar_t *text)
{
    _wcsrev(text);
}
```

## <a name="persistent-storage-binary-names"></a>Постоянное хранилище (двоичные имена)

Двоичные имена определяются и связываются с блоками двоичных объектов, то есть с неструктурированными данными, хранящимися вместе с книгой. Они создаются с помощью функции [кслдефинебинаринаме](xldefinebinaryname.md), а данные извлекаются с помощью функции [кслжетбинаринаме](xlgetbinaryname.md). Обе функции описаны более подробно в справочнике по функциям (см. [функции API C, которые можно вызывать только из библиотеки DLL или XLL](c-api-functions-that-can-be-called-only-from-a-dll-or-xll.md)), и в обоих случаях используется структура **кслтипебигдата** **XLOPER**/ ****. 
  
�������� �� ��������� ���������, ������� ������������ ������������ ���������� �������� ����, ��. � ������ [��������� ��������, ����������� ��� ���������� XLL ��� Excel](known-issues-in-excel-xll-development.md).
  
## <a name="excel-stack"></a>Стек Excel

Excel использует стек вместе со всеми загруженными библиотеками DLL. Места в стеке обычно более чем достаточно для обычного использования. О нем не нужно беспокоиться, если вы выполняете следующие рекомендации: 
  
- �� ����������� ����� ������� ��������� � �������� ���������� ������� � ���� �������� � �����. ����������� ��������� ��� ������.
    
- �� ����������� ������� ��������� � �����. ����������� ��������� �� ����������� ��� ����������� ���������� ������ ��� ����������� ���������, ������������ � �������������� ������.
    
- �� ���������� ����� ������� ��������� �������������� ���������� � ���� �������. ���� ����������, �������� �� ��� �����������.
    
- �� ��������� ������� ����������, ���� �� �������, ��� �������� ������ ����� ��������. ������ ����� ����������� ����.
    
������� �������� ����� �� ���������� DLL � ������� API C, Excel ������� ���������, ���������� �� ����� � ����� ��� ������ ������� ��������. ���� Excel ���������, ��� ���������� ����� ����� ���� ������������, �� ���������� ����� ��� ������������, ���� ���� �� ����� ���� ����� ����������. � ���� ������ ��� �������� ������ ������������ ��� **xlretFailed**. ��� ������� ������������� API C � ����� ���� ������ API C ���� �� ���������� �� ���� �������.
  
���� �� ������ ��������� ���������� ����� � ����� �� ��������� ������ ����, ������� ����� �����, ������ ������� [xlStack](xlstack.md). 
  
## <a name="see-also"></a>См. также



[Многопоточный пересчет в Excel](multithreaded-recalculation-in-excel.md)
  
[��������������� � ��������� ������ � Excel](multithreading-and-memory-contention-in-excel.md)
  
[Разработка XLL-файлов для Excel](developing-excel-xlls.md)


---
title: Создание надстройки COM для добавления пользовательских функций в InfoPath
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
keywords:
- InfoPath 2007, создание надстроек COM, InfoPath 2007, Добавление настраиваемых компонентов, надстройки COM [InfoPath 2007]
localization_priority: Normal
ms.assetid: af0b0bc9-20ef-4503-8b3b-8f2a97b671a2
description: Microsoft InfoPath поддерживает надстройки для модели COM для расширения возможностей пользователя по редактированию форм. Несмотря на то, что поддержка надстроек COM впервые была добавлена в InfoPath, в других приложениях Office, таких как Microsoft Office Word и Microsoft Office Excel, есть поддерживаемые надстройки COM с момента выпуска Office 2000.
ms.openlocfilehash: f8dd16b161c4ea862cf3b15e56e26a2547c1fc4c
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32303789"
---
# <a name="create-a-com-add-in-to-add-custom-features-to-infopath"></a>Создание надстройки COM для добавления пользовательских функций в InfoPath

Microsoft InfoPath поддерживает надстройки для модели COM для расширения возможностей пользователя по редактированию форм. Несмотря на то, что поддержка надстроек COM впервые была добавлена в InfoPath, в других приложениях Office, таких как Microsoft Office Word и Microsoft Office Excel, есть поддерживаемые надстройки COM с момента выпуска Office 2000.
  
Поддержка надстроек COM в InfoPath доступна в среде редактирования форм. Среда конструирования форм не может быть расширена с помощью надстроек COM.
  
## <a name="the-idtextensibility2-interface"></a>Интерфейс IDTExtensibility2

Среда редактирования InfoPath обеспечивает поддержку интерфейса **IDTExtensibility2** , который должен быть реализован разработчикАМИ надстроек COM. **IDTExtensibility2** — это объект сдвоенного интерфейса, который предоставляет пять методов, которые действуют как события. в среде редактирования. Эти методы позволяют надстройке COM реагировать на условия запуска и завершения работы среды, перечисленные в следующей таблице. 
  
|**Интерфейс**|**Описание**|
|:-----|:-----|
|**Онаддинсупдате (ByVal Custom () AS Variant)** <br/> |Возникает, когда надстройка загружается или выгружается в среде.  <br/> |
|**OnBeginShutdown (ByVal Custom () AS Variant)** <br/> |Возникает при завершении работы среды.  <br/> |
|**OnConnection (ByVal Application As Object, ByVal Коннектмоде AS Екст_коннектмоде, ByVal Аддининст As Object, ByVal Custom () AS Variant)** <br/> |Возникает при загрузке надстройки в среде.  <br/> |
|**OnDisconnection (ByVal Ремовемоде AS Екст_дисконнектмоде, ByVal Custom () AS Variant)** <br/> |Возникает, когда надстройка выгружается из среды.  <br/> |
|**OnStartupComplete (ByVal Custom () AS Variant)** <br/> |Происходит при завершении запуска среды.  <br/> |
   
## <a name="registering-com-add-ins"></a>Регистрация надстроек COM

Все приложения Office, в том числе InfoPath, используют реестр для перечисления надстроек в коллекции COM-надстроек, для хранения состояния подключения и для хранения сведений о загрузке или загрузке по запросу. Для надстроек надстройки InfoPath имя каждой надстройки отображается в следующем разделе:
  
`HKEY_CURRENT_USER\Software\Microsoft\Office\InfoPath\AddIns\`
  
Для надстроек COM, установленных для каждого пользователя клиентского компьютера, раздел реестра размещается в кусте реестра HKLM:
  
`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Office\InfoPath\AddIns\`
  
Имя раздела реестра соответствует **прогидаттрибуте** надстройки и содержит следующие значения: 
  
|**Name**|**Type**|**Описание**|
|:-----|:-----|:-----|
|**FriendlyName** <br/> |**String** <br/> |Имя, отображаемое в диалоговом окне "надстройки **com** " и указанное на странице **** "надстройки" **центра управления безопасностью**.  <br/> |
|**Описание** <br/> |**Строка** <br/> |Строка, которая отображается, когда надстройка выбрана в **центре управления безопасностью**.  <br/> |
|**LoadBehavior** <br/> |**DWORD** <br/> |Задает способ загрузки надстройки COM. Значение может быть сочетанием 0, 1, 2, 8 и 16. В приведенной ниже таблице представлены дополнительные сведения.  <br/> |
   
Значение **параметра DWORD** для **LoadBehavior** должно содержать значение, описывающее, как надстройка COM загружается в среде редактирования. Значение может быть представлено в приведенной ниже таблице или сочетанием значений из таблицы. Например, надстройка COM, созданная в Visual Studio 2005, будет иметь значение **LoadBehavior** "3", загруженное при запуске приложения и подключено. 
  
|**Value**|**Описание**|
|:-----|:-----|
|нуль  <br/> |Подключения. Надстройка отображается как неАктивная в диалоговом окне **надстройки COM** .  <br/> |
|1,1  <br/> |Присоединен. Надстройка отображается как активная в диалоговом окне **надстройки COM** .  <br/> |
|2  <br/> |Загрузка при запуске. Надстройка загружается и подключается при запуске ведущего приложения.  <br/> |
|8,5  <br/> |Загружать по запросу. Надстройка загружается и подключается, когда ведущее приложение запрашивает ее, например, когда пользователь нажимает кнопку, которая использует функциональные возможности в надстройке.  <br/> |
|столбцов  <br/> |ПодКлючаться в первый раз. Надстройка будет загружена и подключена при первом запуске ведущего приложения, когда пользователь зарегистрирует надстройку.  <br/> |
   
## <a name="creating-a-managed-com-add-in-with-visual-studio-2005-or-visual-studio-2008"></a>Создание управляемой надстройки COM с помощью Visual Studio 2005 или Visual Studio 2008

Чтобы создать управляемую надстройку COM с помощью Microsoft Visual Studio 2005 или Visual Studio 2008, создайте общий проект надстройки, выполнив следующие действия: 
  
1. Запустите Visual Studio.
    
2. В меню **Файл ** выберите команду **Создать проект **.
    
3. В области **типы проектов** диалогового окна **Новый проект** щелкните папку **другие типы проектов** , а затем выберите **расширяемость**.
    
4. В области **шаблоны** выберите пункт **Общая надстройка**.
    
5. В поле **имя** введите имя проекта. 
    
6. В поле **Расположение** введите путь к папке или нажмите кнопку **Обзор** и выберите путь к папке, а затем нажмите кнопку **ОК**. Откроется **Мастер общих надстроек** . 
    
7. Нажмите кнопку **Далее** в **мастере общих надстроек**. Откроется страница " **Выбор языка программирования** ". 
    
8. Щелкните **создать надстройку с помощью Visual Basic**, а затем нажмите кнопку **Далее**. Откроется страница " **Выбор ведущего приложения** ". 
    
9. Снимите флажки рядом с каждым приложением, кроме **Microsoft InfoPath**, а затем нажмите кнопку **Далее**. Откроется страница **введите имя и описание** . 
    
10. В поле **имя** надстройки введите имя вашей надстройки COM в поле имя. 
    
11. В поле **Описание** надстройки введите описание для надстройки COM и нажмите кнопку **Далее**. Откроется страница " **Выбор параметров надстройки** ". 
    
12. Убедитесь, что надстройка загружается **при загрузке ведущего приложения** **, а надстройка должна быть доступна всем пользователям компьютера, на котором она была установлена, а не только к тому, кто устанавливает эти** поля. 
    
13. Нажмите кнопку **Далее** , чтобы просмотреть страницу **сводки** , а затем нажмите кнопку **Готово**.
    
После создания проекта в Visual Studio в окне Обозреватель решений появится два проекта. Первый проект — проект надстройки COM; Второй проект — это проект программы установки для развертывания надстройки COM. **Мастер общих надстроек** вставляет только ссылку на **библиотеку объектов Microsoft Office 14,0**, поэтому необходимо вставить ссылку на библиотеку объектов InfoPath, выполнив следующие действия:
  
1. Дважды щелкните **Мой проект** , чтобы отобразить свойства проекта надстройки. Перейдите на вкладку **ссылки** , чтобы отобразить ссылки, автоматически добавленные в проект. 
    
2. Нажмите кнопку **Добавить** , чтобы открыть диалоговое окно **Добавить ссылку** . 
    
3. На вкладке **com** дважды щелкните **библиотеку типов Microsoft. InfoPath 2,0**и нажмите кнопку **ОК**.
    
4. При добавлении ссылки на **библиотеку типов Microsoft InfoPath 3,0** также добавляются ссылки на три сборки, которые необходимо удалить: **ADODB**, **MSHTML**и **Msxml2**. В **обозревателе решений** в разделе **ссылки**щелкните правой кнопкой мыши каждую из этих ссылок, а затем нажмите кнопку **Удалить**.
    
## <a name="viewing-the-registry-settings"></a>Просмотр параметров реестра

Чтобы просмотреть параметры реестра, которые будут создаваться при установке надстройки COM, выполните следующие действия:
  
1. Щелкните правой кнопкой мыши корневой узел проекта установки в **обозревателе решений**и последовательно выберите пункты **вид**, **Редактор**и **Реестр**.
    
2. В области слева щелкните значок "плюс", чтобы развернуть раздел **HKEY_LOCAL_MACHINE**, **программное обеспечение**, **Microsoft**, **InfoPath**и **надстройки**.
    
3. Щелкните имя, соответствующее **идентификатору ProgID**проекта общей надстройки.
    
Чтобы изменить любое из этих свойств, щелкните его правой кнопкой мыши, выберите пункт **окно свойств**и измените значение в поле **значение** в **окне Свойства**.
  
## <a name="compiling-and-distributing-the-shared-add-in"></a>Компиляция и распространение общей надстройки

Чтобы скомпилировать управляемую надстройку COM для тестирования на компьютере, на котором разрабатывается общий проект надстройки, щелкните правой кнопкой мыши корневой узел общего проекта надстройки в обозревателе решений и выберите команду Создать. Если проект строится без ошибок, можно запустить среду редактирования InfoPath и начать использовать управляемую надстройку COM. Если запущен экземпляр InfoPath, закройте его перед построением проекта. Кроме того, может потребоваться открыть диалоговое окно надстройки COM, чтобы убедиться, что надстройка COM зарегистрирована. Чтобы открыть диалоговое окно "надстройки COM", выполните указанные ниже действия.
  
1. Откройте среду редактирования InfoPath. Проще всего сделать это, открыв существующий шаблон формы, который создаст новую форму на основе этого шаблона формы.
    
2. В меню **Сервис** выберите пункт **центр управления безопасностью** . 
    
3. Щелкните категорию **надстройки** слева. 
    
4. В разделе **Управление** в нижней части диалогового окна **центр управления безопасностью** выберите надстройки **com** в списке и нажмите кнопку **Go (перейти** ). 
    
5. В диалоговом окне **надстройки COM** отображается имя недавно созданной надстройки, и рядом с ней должен быть установлен флажок. Если рядом с ним нет флажка, не удалось загрузить надстройку COM из-за ошибки, которая будет отображаться в разделе **поведение при загрузке** диалогового окна. 
    
Чтобы скомпилировать управляемую надстройку COM для использования на компьютере, отличном от компьютера, на котором разрабатывается общий проект надстройки, необходимо выполнить дополнительные действия для защиты кода. Сведения о защите общих проектов надстроек для использования на других компьютерах представлены в следующих трех статьях:
  
- [Развертывание управляемых надстроек COM в Office XP](https://go.microsoft.com/fwlink/?LinkID=73473)
  
- [Использование решения оболочки совместимости надстроек COM для развертывания управляемых надстроек COM в Office XP](https://go.microsoft.com/fwlink/?LinkID=73474)
  
- [Изоляция расширений Office с помощью мастера оболочки совместимости COM](https://go.microsoft.com/fwlink/?LinkID=73475)
  
> [!IMPORTANT]
> Не изоляция надстройки COM может привести к утечкам памяти и нестабильной работе приложений. 
  
> [!NOTE]
> Если .NET Framework или другие необходимые сборки из проекта установки еще не установлены на конечных компьютерах, файл MSI может устанавливаться неправильно. Кроме того, невозможно распространить файл MSI, а затем попробовать установить MSI файл. Кроме того, необходимо распространить другие файлы поддержки в ту же папку, в которой находится исходный MSI файл, созданный Visual Studio. 
  
## <a name="coding-in-the-com-add-in"></a>Написание кода в надстройке COM

События приложений, происходящие в среде редактирования форм InfoPath, могут быть захвачены надстройкой COM. Надстройка COM может использовать следующие события объекта [аппликатионевентс](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath.ApplicationEvents.aspx) для реагирования на действия пользователя: 
  
|**Event**|**Описание**|
|:-----|:-----|
|[Невксдокумент](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.NewXDocument.aspx) Журнал  <br/> |Происходит при создании новой формы.  <br/> |
|[Quit (выход](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.Quit.aspx) ) Журнал  <br/> |Происходит, когда пользователь покидает InfoPath.  <br/> |
|[WindowActivate](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.WindowActivate.aspx) Журнал  <br/> |Происходит при активации любого окна документа.  <br/> |
|[Виндовдеактивате](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.WindowDeactivate.aspx) Журнал  <br/> |Происходит при отключении любого окна документа.  <br/> |
|[Виндовсизе](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.WindowSize.aspx) Журнал  <br/> |Происходит при изменении размера или перемещении любого окна документа.  <br/> |
|[Ксдокументбефореклосе](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.XDocumentBeforeClose.aspx) Журнал  <br/> |Происходит непосредственно перед закрытием любого открытого документа.  <br/> |
|[Ксдокументбефорепринт](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.XDocumentBeforePrint.aspx) Журнал  <br/> |Происходит непосредственно перед печатью любого открытого документа.  <br/> |
|[Ксдокументбефоресаве](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.XDocumentBeforeSave.aspx) Журнал  <br/> |Происходит непосредственно перед сохранением любого открытого документа.  <br/> |
|[Ксдокументчанже](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.XDocumentChange.aspx) Журнал  <br/> |Происходит при создании новой формы, при открытии существующей формы или при активировании другой формы.  <br/> |
|[Ксдокументопен](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._ApplicationEvents_Event.XDocumentOpen.aspx) Журнал  <br/> |Происходит при открытии документа.  <br/> |
   
Чтобы зафиксировать эти события в надстройке COM, необходимо объявить следующие переменные уровня класса в классе **Connect** : 
  
```vb
InfoPathApplication = DirectCast( _
   application, Microsoft.Office.Interop.InfoPath._Application3)
InfoPathApplicationEvents = DirectCast( _
   InfoPathApplication.Events, _
   Microsoft.Office.Interop.InfoPath.ApplicationEvents)
```

```cs
InfoPathApplication =
   (Microsoft.Office.Interop.InfoPath._Application3)application;
InfoPathApplicationEvents =
   (Microsoft.Office.Interop.InfoPath.ApplicationEvents)
   InfoPathApplication.Events;
```

В первой строке приводится **объект** универсального приложения, полученный надстройкой, объекту [_Application3](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._Application3.aspx) . Вторая строка приводит свойство Events [](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath._Application3.Events.aspx) объекта **_Application3** (представленное переменной **инфопасаппликатион** ) к объекту [аппликатионевентс](https://msdn.microsoft.com/library/Microsoft.Office.Interop.InfoPath.ApplicationEvents.aspx) . 
  
Чтобы создать обработчики событий, выберите **инфопасаппликатионевентс** в раскрывающемся списке **имя класса** в верхней части окна Visual Studio, а затем выберите событие, которое нужно обработать, в раскрывающемся списке **имя метода** в верхней части визуального элемента. Окно Studio. Например, если необходимо управлять сохранением формы, обрабатывается событие **ксдокументбефоресаве** . При выборе **ксдокументбефоресаве** из расКрывающегося **имени метода** автоматически вставляется Следующая процедура: 
  
```vb
Private Sub InfoPathApplicationEvents_XDocumentBeforeSave( _
   ByVal pDocument As Microsoft.Office.Interop.InfoPath._XDocument, _
   ByRef pfCancel As Boolean) _
   Handles InfoPathApplicationEvents.XDocumentBeforeSave
End Sub
```

```cs
private void InfoPathApplicationEvents_XDocumentBeforeSave(
   Microsoft.Office.Interop.InfoPath._XDocument pDocument, ref bool pfCancel)
{
}

```

Любой из событий объекта **аппликатионевентс** может обрабатываться надстройкой COM с помощью того же метода. 
  
## <a name="see-also"></a>См. также

- [Создание надстройки COM для Microsoft Office 2000](https://go.microsoft.com/fwlink/?LinkID=73468) 
- [Создание управляемых надстроек COM для Office с помощью Visual Studio .NET](https://go.microsoft.com/fwlink/?LinkID=73470)
- [Работа с процедурами обработки событий IDTExtensibility2](https://go.microsoft.com/fwlink/?LinkID=73471)
- [Создание надстройки COM для Office с помощью Visual Basic .NET](https://go.microsoft.com/fwlink/?LinkID=73469)
- [Создание надстройки Office COM с помощью Visual C# .NET](https://support.microsoft.com/en-us/help/302901/how-to-build-an-office-com-add-in-by-using-visual-c-net)
- [Создание надстроек InfoPath 2007 с помощью средств Visual Studio 2005 для системы Office SE](https://msdn.microsoft.com/library/bb968857%28office.12%29.aspx)


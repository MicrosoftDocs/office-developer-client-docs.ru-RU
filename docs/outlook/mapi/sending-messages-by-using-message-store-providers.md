---
title: Отправка сообщений с помощью поставщиков хранилищ сообщений
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 7632d784-00d8-48fd-a73b-73778efbef7f
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: b34714a230adb44417624d149d34ed6a14a2dfa5
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33437611"
---
# <a name="sending-messages-by-using-message-store-providers"></a>Отправка сообщений с помощью поставщиков хранилищ сообщений

**Относится к**: Outlook 2013 | Outlook 2016 
  
Поставщики store сообщений не обязаны поддерживать отправку исходяющих сообщений (то есть возможность клиентских приложений использовать поставщика для отправки сообщений). Клиентские приложения должны использовать хранилище сообщений при отправке сообщений, так как данные сообщения должны храниться где-то между моментом, когда пользователь завершает его составление, и временем, когда пулер MAPI передает сообщение поставщику транспорта для отправки в систему обмена сообщениями. Если поставщик вашего магазина сообщений не поддерживает отправку исходяющих сообщений, его нельзя использовать в качестве хранения сообщений по умолчанию.
  
Чтобы поддерживать отправку сообщений, поставщик вашего магазина сообщений должен сделать следующее:
  
- Реализация очереди исходяющих сообщений.
    
- Поддержка метода [IMessage::SubmitMessage](imessage-submitmessage.md) для объектов сообщений, созданных в хранилище сообщений. 
    
- Поддержка методов **IMsgStore,** характерных для пулера MAPI: [IMsgStore::FinishedMsg](imsgstore-finishedmsg.md), [IMsgStore::GetOutgoingQueue](imsgstore-getoutgoingqueue.md), [IMsgStore::NotifyNewMail](imsgstore-notifynewmail.md)и [IMsgStore::SetLockState](imsgstore-setlockstate.md).
    
Метод **SetLockState** важен для правильного взаимодействия между пулером MAPI и клиентами. Когда пулер MAPI вызывает **SetLockState** в исходяском сообщении, поставщик точки хранения сообщений не должен позволять клиентам открывать сообщение. Если клиент пытается открыть сообщение, заблокированное пулом MAPI, поставщик хранилище сообщений должен вернуть MAPI_E_NO_ACCESS. Заблокированное состояние сообщения не должно быть постоянным, если хранилище будет закрыто, пока сообщение заблокировано пулом MAPI. 
  
Независимо от того, заблокировали ли пулер MAPI исходяющие сообщения, поставщик хранилище сообщений не должен разрешить открытие сообщения в очереди исходяющих сообщений для записи. Если клиент вызывает метод [IMSgStore::OpenEntry](imsgstore-openentry.md) для исходяшего сообщения с флагом MAPI_MODIFY, вызов должен быть неудачным и возвращать MAPI_E_SUBMITTED. Если клиентские приложения вызывает **OpenEntry** в исходяском сообщении с флагом MAPI_BEST_ACCESS, поставщик хранилище сообщений должен разрешить доступ к сообщению только для чтения. 
  
Если сообщение обрабатывается пулом MAPI, поставщик хранилище сообщений задает для свойства **PR_SUBMIT_FLAGS** сообщения [(PidTagSubmitFlags)](pidtagsubmitflags-canonical-property.md)SUBMITFLAG_LOCKED. Значение SUBMITFLAG_LOCKED указывает, что пулер MAPI заблокировали сообщение для его монопольного использования. Другое значение **для** PR_SUBMIT_FLAGS , SUBMITFLAG_PREPROCESS, устанавливается, когда сообщение требует предварительной подготовки одной или более предпроцессорных функций, зарегистрированных поставщиком транспорта.
  
В следующих процедурах описано, как хранилище сообщений, транспортный пул и пул MAPI взаимодействуют для отправки сообщения от клиента одному или более получателям. 
  
Клиентские приложения вызывает [метод IMessage::SubmitMessage.](imessage-submitmessage.md) В **SubmitMessage** поставщик службы хранения сообщений делает следующее:
  
1. Вызывает [IMAPISupport::P repareSubmit](imapisupport-preparesubmit.md). Если MAPI возвращает ошибку, поставщик хранилище сообщений возвращает эту ошибку клиенту.
    
2. Задает MSGFLAG_SUBMIT в свойстве **PR_MESSAGE_FLAGS** ([PidTagMessageFlags)](pidtagmessageflags-canonical-property.md)сообщения.
    
3. Гарантирует, что в таблице **получателей** есть столбец для свойства PR_RESPONSIBILITY ([PidTagResponsibility),](pidtagresponsibility-canonical-property.md)и устанавливает для него false, чтобы указать, что транспорт еще не несет ответственности за передачу сообщения.
    
4. Задает дату и время начала в свойстве **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime).](pidtagclientsubmittime-canonical-property.md)
    
5. Вызывает [IMAPISupport::ExpandRecips,](imapisupport-expandrecips.md) чтобы сделать следующее: 
    
    1. ���������� ��� ������ �������� � ����������� � �������� ��� ���������� ������������ ����� � ��������� �������.
        
    2. �������� ������������� ����.
        
    3. Проверьте требуемую предварительную подготовку и при необходимости установите флаг NEEDS_PREPROCESSING и **свойство PR_PREPROCESS** ([PidTagPreprocess),](pidtagpreprocess-canonical-property.md)зарезервированное для MAPI. 
        
    4. ���������� ����� NEEDS_SPOOLER ��������� ��������� ����� ������� � ���������� � �� ����� ���������� ���� �����������. 
    
6. ���� ���������� ���� ��������� NEEDS_PREPROCESSING ��������� ��������� ������:
    
    1. Помещает сообщение в исходяную очередь с установленным SUBMITFLAG_PREPROCESS в **свойстве** PR_SUBMIT_FLAGS. 
        
    2. ���������� ��������� ������� MAPI, ������� ��� ������� �������.
        
    3. ��������� ���������� ������� � ����� ��������� ��-�������� ������������ � ��������� ������� MAPI. ��������� ������� MAPI ��������� ��������� ������: 
    
       1. Блокирует сообщение, вызывая [IMsgStore::SetLockState.](imsgstore-setlockstate.md)
            
       2. Выполняет необходимую предварительную подготовку, вызывая все функции предварительной подготовки в порядке регистрации. Поставщики транспорта [звонят IMAPISupport::RegisterPreprocessor для](imapisupport-registerpreprocessor.md) регистрации функций предварительной очистки. 
            
       3. Вызывает [IMessage::SubmitMessage](imessage-submitmessage.md) в открытом сообщении, чтобы указать в хранилище сообщений, что предварительная процессинг завершена. 
    
Если предварительной обработки не было или была предварительная обработка и пулер MAPI под названием **SubmitMessage,** поставщик службы хранения сообщений делает следующее в клиентском процессе: 
  
- Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):
    
   - ������������ �����������, ������� ����� ������������.
    
   - ������������� ��� �������� **PR_RESPONSIBILITY** �������� TRUE ��� �����������, ������� �� ������������. 
    
   - ���� ��� ���������� ��������, ��� ���� ����� ��������� ��������� � ����������, ��������� ��������� ������: 
    
     - Вызывает [IMAPISupport::CompleteMsg,](imapisupport-completemsg.md) если сообщение было предварительно обработчино или поставщику хранилище сообщений необходимо, чтобы пулер MAPI завершил обработку сообщений. Поток сообщений продолжается с помощью пула MAPI. 
    
     - Выполняет следующие задачи, если сообщение не было предварительно обрабатывается или поставщик хранилище сообщений не хочет, чтобы пулер MAPI выполнял обработку сообщений:
    
       1. Копирует сообщение в папку, идентифицируемую идентификатором записи в свойстве **PR_SENTMAIL_ENTRYID** ([PidTagSentMailEntryId),](pidtagsentmailentryid-canonical-property.md)если задан.
            
       2. Удаляет сообщение, если для **свойства PR_DELETE_AFTER_SUBMIT** ([PidTagDeleteAfterSubmit)](pidtagdeleteaftersubmit-canonical-property.md)установлено true.
            
       3. Разблокирует сообщение, если оно заблокировано.
            
       4. Возвращается клиенту. Поток сообщений завершен.
    
  - Выполняет следующие задачи, если сообщение было предварительно обрабатывается или поставщик хочет, чтобы пулер MAPI завершил обработку сообщений:
    
    1. Вызывает [IMAPISupport::CompleteMsg](imapisupport-completemsg.md). 
          
    2. Продолжает поток сообщений с помощью пула MAPI. Дополнительные сведения [см. в подзагонах "Отправка сообщений: задачи пула MAPI".](sending-messages-mapi-spooler-tasks.md)
    
  - Выполняет следующие задачи, если сообщение не было предварительно обрабатывается или поставщик не хочет, чтобы пулер завершил обработку сообщения:
    
    1. Копирует сообщение в папку, идентифицируемую идентификатором записи в свойстве **PR_SENTMAIL_ENTRYID,** если установлено. 
        
    2. Удаляет сообщение, если **PR_DELETE_AFTER_SUBMIT** имеет свойство TRUE. 
        
    3. Разблокирует сообщение, если оно заблокировано. 
        
    4. Возвращается вызываемой. Поток сообщений завершен.
    
- ���� ��������� ��������� �� ����� ���������� ��� ����������, �� ���� ����������� ��������, ��� ��������� ��������� ��� ���� NEEDS_SPOOLER ��������� ��������� ������:
    
  1. ��������� ���������� � ������� ��������� ��� ��������� ���� SUBMITFLAG_PREPROCESS � �������� **PR_SUBMIT_FLAGS**. 
    
  2. ���������� ��������� ������� MAPI, ��������� ������� ��� �������, ������ ����������� � �������. 
    
  3. ���������� ������� � ����� ��������� ��-�������� ������������ � ������� ������, ����������� ����������� ������� MAPI.
    
## <a name="see-also"></a>См. также

- [���������� ��������� ���������](message-store-features.md)


---
title: Отправка сообщений с помощью поставщиков хранилищ сообщений
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 7632d784-00d8-48fd-a73b-73778efbef7f
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: b34714a230adb44417624d149d34ed6a14a2dfa5
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33437611"
---
# <a name="sending-messages-by-using-message-store-providers"></a>Отправка сообщений с помощью поставщиков хранилищ сообщений

**Относится к**: Outlook 2013 | Outlook 2016 
  
Поставщики хранилища сообщений не обязательно должны поддерживать отправку исходящих сообщений (то есть, могут ли клиентские приложения использовать поставщика хранилища сообщений для отправки сообщений). Клиентским приложениям необходимо использовать хранилище сообщений при отправке сообщений, так как данные этого сообщения должны храниться в другом месте между моментом его создания, а диспетчер очереди MAPI передает сообщение поставщику транспорта для отправки в базовую систему обмена сообщениями. Если поставщик хранилища сообщений не поддерживает отправку исходящих сообщений, он не может использоваться в качестве хранилища сообщений по умолчанию.
  
Для поддержки отправки сообщений поставщик хранилища сообщений должен выполнить следующие действия:
  
- Реализация очереди исходящих сообщений.
    
- Поддерживает метод [iMessage:: субмитмессаже](imessage-submitmessage.md) для объектов сообщений, созданных в хранилище сообщений. 
    
- Поддержка методов **IMsgStore** , характерных для ДИСПЕТЧЕРА очереди MAPI: [IMsgStore:: финишедмсг](imsgstore-finishedmsg.md), [IMsgStore:: Жетаутгоингкуеуе](imsgstore-getoutgoingqueue.md), [IMsgStore:: нотифиневмаил](imsgstore-notifynewmail.md)и [IMsgStore:: сетлоккстате](imsgstore-setlockstate.md).
    
Метод **сетлоккстате** важен для правильной взаимодействия между диспетчером MAPI и клиентами. Когда диспетчер очереди MAPI вызывает **сетлоккстате** в исходящих сообщениях, поставщик хранилища сообщений не должен позволить клиентам открыть сообщение. Если клиент пытается открыть сообщение, заблокированное диспетчером очереди MAPI, поставщик хранилища сообщений должен возвратить MAPI_E_NO_ACCESS. Заблокированное состояние сообщения не обязательно должно быть постоянным в случае завершения работы хранилища, пока сообщение заблокировано с помощью диспетчера очереди MAPI. 
  
Независимо от того, заблокирован ли диспетчер очереди MAPI исходящее сообщение, поставщик хранилища сообщений не должен разрешить открытие сообщения в очереди исходящих сообщений для записи. Если клиент вызывает метод [IMSgStore:: OpenEntry](imsgstore-openentry.md) для исходящего сообщения с флагом MAPI_MODIFY, вызов не должен выполняться и возвращать MAPI_E_SUBMITTED. Если клиентское приложение вызывает **OpenEntry** для исходящего сообщения с флагом MAPI_BEST_ACCESS, то поставщик хранилища сообщений должен разрешить доступ к сообщению только для чтения. 
  
Когда сообщение должно быть обработано диспетчером MAPI, поставщик хранилища сообщений задает для свойства **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) сообщения значение SUBMITFLAG_LOCKED. Значение SUBMITFLAG_LOCKED указывает на то, что диспетчер очереди MAPI заблокировал сообщение для монопольного использования. Другое значение для **PR_SUBMIT_FLAGS**, SUBMITFLAG_PREPROCESS, задается, когда сообщение требует предварительной обработки с помощью одной или нескольких функций препроцессора, зарегистрированных поставщиком транспорта.
  
В следующих процедурах описывается, как служба хранилища сообщений, транспорта и диспетчер MAPI взаимодействуют для отправки сообщения от клиента одному или нескольким получателям. 
  
Клиентское приложение вызывает метод [iMessage:: субмитмессаже](imessage-submitmessage.md) . В **субмитмессаже**поставщик хранилища сообщений выполняет следующие действия:
  
1. Calls [имаписуппорт::P репаресубмит](imapisupport-preparesubmit.md). Если MAPI возвращает ошибку, поставщик хранилища сообщений возвращает эту ошибку клиенту.
    
2. Задает MSGFLAG_SUBMIT бит в свойстве **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) сообщения.
    
3. Проверяет наличие столбца для свойства **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) в таблице получателей и ЗАДАЕТ для него значение false, чтобы показать, что транспорт еще не предпринял ответственность за передачу сообщения.
    
4. Задает дату и время происхождения в свойстве **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)).
    
5. Вызывает [имаписуппорт:: експандреЦипс](imapisupport-expandrecips.md) для выполнения следующих действий: 
    
    1. ���������� ��� ������ �������� � ����������� � �������� ��� ���������� ������������ ����� � ��������� �������.
        
    2. �������� ������������� ����.
        
    3. Проверьте наличие необходимой предварительной обработки и, если необходима предварительная обработка, установите флаг NEEDS_PREPROCESSING и свойство **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)), зарезервированное для MAPI. 
        
    4. ���������� ����� NEEDS_SPOOLER ��������� ��������� ����� ������� � ���������� � �� ����� ���������� ���� �����������. 
    
6. ���� ���������� ���� ��������� NEEDS_PREPROCESSING ��������� ��������� ������:
    
    1. Помещает сообщение в исходящую очередь с SUBMITFLAG_PREPROCESS битом, заданным в свойстве **PR_SUBMIT_FLAGS** . 
        
    2. ���������� ��������� ������� MAPI, ������� ��� ������� �������.
        
    3. ��������� ���������� ������� � ����� ��������� ��-�������� ������������ � ��������� ������� MAPI. ��������� ������� MAPI ��������� ��������� ������: 
    
       1. Блокирует сообщение, вызывая [IMsgStore:: сетлоккстате](imsgstore-setlockstate.md).
            
       2. Выполняет необходимую предварительную обработку, вызывая все функции предварительной обработки в порядке регистрации. Поставщики транспорта вызывают [имаписуппорт:: регистерпрепроцессор](imapisupport-registerpreprocessor.md) для регистрации функций предварительной обработки. 
            
       3. Вызывает [iMessage:: субмитмессаже](imessage-submitmessage.md) в открытом сообщении, чтобы показать банк сообщений, что предварительная обработка завершена. 
    
Если Предварительная обработка не выполнялась, или при предварительной обработке и диспетчере очереди MAPI с именем **субмитмессаже**, то поставщик хранилища сообщений выполняет следующие действия в клиентском процессе. 
  
- Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):
    
   - ������������ �����������, ������� ����� ������������.
    
   - ������������� ��� �������� **PR_RESPONSIBILITY** �������� TRUE ��� �����������, ������� �� ������������. 
    
   - ���� ��� ���������� ��������, ��� ���� ����� ��������� ��������� � ����������, ��������� ��������� ������: 
    
     - Вызывает [имаписуппорт:: комплетемсг](imapisupport-completemsg.md) , если сообщение было предварительно обработано, или поставщик хранилища сообщений хочет, чтобы диспетчер очереди MAPI завершил обработку сообщения. Процесс обработки сообщений продолжается с помощью диспетчера очереди MAPI. 
    
     - Выполняет следующие задачи, если сообщение не было предварительно обработано, или поставщик хранилища сообщений не хочет, чтобы диспетчер очереди MAPI завершил обработку сообщений:
    
       1. Копирует сообщение в папку, определенную идентификатором записи, в свойстве **PR_SENTMAIL_ENTRYID** ([PidTagSentMailEntryId](pidtagsentmailentryid-canonical-property.md)), если оно задано.
            
       2. Удаляет сообщение, если для свойства **PR_DELETE_AFTER_SUBMIT** ([PidTagDeleteAfterSubmit](pidtagdeleteaftersubmit-canonical-property.md)) задано значение true.
            
       3. Разблокирует сообщение, если оно заблокировано.
            
       4. Возвращает клиенту. Процесс обработки сообщений завершен.
    
  - Выполняет следующие задачи, если сообщение было предварительно обработано, или поставщику требуется, чтобы диспетчер очереди MAPI завершил обработку сообщений:
    
    1. Calls [имаписуппорт:: комплетемсг](imapisupport-completemsg.md). 
          
    2. Продолжает процесс обработки сообщений с помощью диспетчера очереди MAPI. Более подробную информацию можно узнать в статье [Отправка сообщений: задачи системы буферизации MAPI](sending-messages-mapi-spooler-tasks.md).
    
  - Выполняет следующие задачи, если сообщение не было предварительно обработано, или поставщик не желает, чтобы диспетчер очереди завершил обработку сообщений:
    
    1. Копирует сообщение в папку, указанную идентификатором записи, в свойстве **PR_SENTMAIL_ENTRYID** , если оно задано. 
        
    2. Удаляет сообщение, если для свойства **PR_DELETE_AFTER_SUBMIT** ЗАДАНО значение true. 
        
    3. Разблокирует сообщение, если оно заблокировано. 
        
    4. Возвращает вызывающему абоненту. Процесс обработки сообщений завершен.
    
- ���� ��������� ��������� �� ����� ���������� ��� ����������, �� ���� ����������� ��������, ��� ��������� ��������� ��� ���� NEEDS_SPOOLER ��������� ��������� ������:
    
  1. ��������� ���������� � ������� ��������� ��� ��������� ���� SUBMITFLAG_PREPROCESS � �������� **PR_SUBMIT_FLAGS**. 
    
  2. ���������� ��������� ������� MAPI, ��������� ������� ��� �������, ������ ����������� � �������. 
    
  3. ���������� ������� � ����� ��������� ��-�������� ������������ � ������� ������, ����������� ����������� ������� MAPI.
    
## <a name="see-also"></a>См. также

- [���������� ��������� ���������](message-store-features.md)


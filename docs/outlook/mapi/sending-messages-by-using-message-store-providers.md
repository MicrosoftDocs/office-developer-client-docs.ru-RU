---
title: Отправка сообщений с помощью сообщения хранения поставщиков
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 7632d784-00d8-48fd-a73b-73778efbef7f
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: aaba816ca7efab6cee939087a18332561f31b81b
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2018
ms.locfileid: "19812242"
---
# <a name="sending-messages-by-using-message-store-providers"></a>Отправка сообщений с помощью сообщения хранения поставщиков

**Относится к**: Outlook 
  
Поставщики хранения сообщения не требуется для поддержки исходящих сообщений, отправляемых (то есть возможность клиентские приложения на использование поставщика хранилища сообщений для отправки сообщений). Клиентские приложения должны использовать хранилища сообщений во время отправки сообщений, так как данные сообщения должны быть сохранены с момента завершения пользователь создает его и время, диспетчер очереди MAPI выводит сообщение для поставщика транспорта для Отправка системы обмена сообщениями. Если поставщик хранилища сообщений не поддерживает исходящих сообщений, отправляемых, его нельзя использовать в качестве хранилище сообщений по умолчанию.
  
Чтобы обеспечить поддержку отправку сообщений, поставщиком хранилища сообщений необходимо выполните следующее:
  
- Реализация исходящей очереди сообщений.
    
- Поддерживает метод [IMessage::SubmitMessage](imessage-submitmessage.md) на объекты сообщения, созданные в хранилище сообщений. 
    
- Поддержка **IMsgStore** методы, которые специфичны для очереди MAPI: [IMsgStore::FinishedMsg](imsgstore-finishedmsg.md), [IMsgStore::GetOutgoingQueue](imsgstore-getoutgoingqueue.md), [IMsgStore::NotifyNewMail](imsgstore-notifynewmail.md)и [IMsgStore::SetLockState](imsgstore-setlockstate.md).
    
Метод **SetLockState** важна для правильного взаимодействия между клиентами и диспетчер очереди MAPI. Когда диспетчер очереди MAPI вызывает **SetLockState** для исходящих сообщений, поставщик хранения сообщений не следует допускать клиентов откройте сообщение. Если это клиент откройте сообщение, в котором заблокирован диспетчер очереди MAPI, поставщик хранения сообщений должна вернуть MAPI_E_NO_ACCESS. Блокированными сообщения не требуется, следует постоянное хранилище при сообщения заблокирован диспетчер очереди MAPI завершении работы. 
  
Независимо от того, является ли диспетчер очереди MAPI заблокировал исходящих сообщений поставщик хранения сообщения не следует разрешать сообщения в очереди исходящих сообщений, чтобы открыть для записи. Если клиент вызывает метод [IMSgStore::OpenEntry](imsgstore-openentry.md) исходящих сообщений с флагом MAPI_MODIFY, вызов следует давать сбой и возвращать MAPI_E_SUBMITTED. Если клиентское приложение вызывает **OpenEntry** для исходящих сообщений с флагом MAPI_BEST_ACCESS, поставщика хранилища сообщений следует разрешить доступ только для чтения к сообщению. 
  
Если сообщение не будут обрабатываться диспетчер очереди MAPI, поставщик хранения сообщений устанавливает значение свойства **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) сообщение SUBMITFLAG_LOCKED. Значение SUBMITFLAG_LOCKED указывает, что диспетчер очереди MAPI заблокировал сообщения его исключительно для использования. Другие для **PR_SUBMIT_FLAGS**, SUBMITFLAG_PREPROCESS, имеет значение при сообщение требует предварительной обработки одного или нескольких препроцессору функциями, зарегистрированные, поставщика транспорта.
  
Далее описывается взаимодействие хранилища сообщений, транспорта и диспетчер очереди MAPI для отправки сообщения от клиента для одного или нескольких получателей. 
  
Клиентское приложение вызывает метод [IMessage::SubmitMessage](imessage-submitmessage.md) . В **SubmitMessage**поставщика хранилища сообщений выполняет следующее.
  
1. Вызывает [IMAPISupport::PrepareSubmit](imapisupport-preparesubmit.md). Если MAPI возвращает ошибку, поставщик хранения сообщений возвращает клиенту этой ошибки.
    
2. Задает MSGFLAG_SUBMIT бит в свойстве **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) сообщения.
    
3. Гарантирует, что столбец для свойства **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) в таблице получателей и задает для него значение FALSE, чтобы указать, что нет транспортного еще не несет ответственность за передачи сообщения.
    
4. Задает дату и время возникновения в свойстве **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)).
    
5. Вызовы [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) для выполните следующие действия: 
    
    1. ���������� ��� ������ �������� � ����������� � �������� ��� ���������� ������������ ����� � ��������� �������.
        
    2. �������� ������������� ����.
        
    3. Проверить все необходимые предварительной обработки и, если требуется предварительной обработки, задайте флаг NEEDS_PREPROCESSING и свойство **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)), который зарезервирован для MAPI. 
        
    4. ���������� ����� NEEDS_SPOOLER ��������� ��������� ����� ������� � ���������� � �� ����� ���������� ���� �����������. 
    
6. ���� ���������� ���� ��������� NEEDS_PREPROCESSING ��������� ��������� ������:
    
    1. Размещение сообщения в очереди исходящих сообщений с SUBMITFLAG_PREPROCESS бит в свойстве **PR_SUBMIT_FLAGS** . 
        
    2. ���������� ��������� ������� MAPI, ������� ��� ������� �������.
        
    3. ��������� ���������� ������� � ����� ��������� ��-�������� ������������ � ��������� ������� MAPI. ��������� ������� MAPI ��������� ��������� ������: 
    
       1. Блокирует сообщения путем вызова [IMsgStore::SetLockState](imsgstore-setlockstate.md).
            
       2. Выполняет необходимые предварительной обработки, вызвав все функции предварительной обработки в порядке регистрации. Поставщики транспорта вызов [IMAPISupport::RegisterPreprocessor](imapisupport-registerpreprocessor.md) для регистрации функции предварительной обработки. 
            
       3. [IMessage::SubmitMessage](imessage-submitmessage.md) на открыть сообщение как к сообщению хранения, предварительной обработки вызовов будет завершена. 
    
Если не было без предварительной обработки или возникла предварительной обработки и диспетчер очереди MAPI, называется **SubmitMessage**поставщика хранилища сообщений производит следующие действия в процессе клиента: 
  
- Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):
    
   - ������������ �����������, ������� ����� ������������.
    
   - ������������� ��� �������� **PR_RESPONSIBILITY** �������� TRUE ��� �����������, ������� �� ������������. 
    
   - ���� ��� ���������� ��������, ��� ���� ����� ��������� ��������� � ����������, ��������� ��������� ������: 
    
     - Вызывает [IMAPISupport::CompleteMsg](imapisupport-completemsg.md) , если сообщение было предварительно или поставщика хранилища сообщений, где требуется реализовать диспетчер очереди MAPI для обработки завершения сообщения. Поток сообщений по-прежнему производится с помощью диспетчера очереди MAPI. 
    
     - Если без предварительной обработки сообщения или поставщика хранилища сообщений не нужно, чтобы диспетчер очереди MAPI для завершения обработки сообщений выполняет следующие задачи:
    
       1. Копии сообщения в папку, определяемую средством идентификатор записи в свойстве **PR_SENTMAIL_ENTRYID** ([PidTagSentMailEntryId](pidtagsentmailentryid-canonical-property.md)), если необходимо задать.
            
       2. Удаляет сообщение, если свойство **PR_DELETE_AFTER_SUBMIT** ([PidTagDeleteAfterSubmit](pidtagdeleteaftersubmit-canonical-property.md)) значение TRUE.
            
       3. Разблокирует сообщение, если она заблокирована.
            
       4. Возвращает клиенту. Поток сообщений завершена.
    
  - Если предварительно сообщение или предоставляющей диспетчер очереди MAPI для завершения обработки сообщений выполняет следующие задачи:
    
    1. Вызывает [IMAPISupport::CompleteMsg](imapisupport-completemsg.md). 
          
    2. По-прежнему производится поток сообщений с помощью диспетчера очереди MAPI. Дополнительные сведения можно [Отправка сообщений: задачи очереди MAPI](sending-messages-mapi-spooler-tasks.md).
    
  - Если без предварительной обработки сообщения или поставщика нежелательно очереди для завершения обработки сообщений выполняет следующие задачи:
    
    1. Копии сообщения в папку, определяемую средством идентификатор записи в свойстве **PR_SENTMAIL_ENTRYID** , если необходимо задать. 
        
    2. Удаляет сообщение, если свойство **PR_DELETE_AFTER_SUBMIT** значение TRUE. 
        
    3. Разблокирует сообщение, если она заблокирована. 
        
    4. Возврат к вызывающему. Поток сообщений завершена.
    
- ���� ��������� ��������� �� ����� ���������� ��� ����������, �� ���� ����������� ��������, ��� ��������� ��������� ��� ���� NEEDS_SPOOLER ��������� ��������� ������:
    
  1. ��������� ���������� � ������� ��������� ��� ��������� ���� SUBMITFLAG_PREPROCESS � �������� **PR_SUBMIT_FLAGS**. 
    
  2. ���������� ��������� ������� MAPI, ��������� ������� ��� �������, ������ ����������� � �������. 
    
  3. ���������� ������� � ����� ��������� ��-�������� ������������ � ������� ������, ����������� ����������� ������� MAPI.
    
## <a name="see-also"></a>См. также

- [���������� ��������� ���������](message-store-features.md)


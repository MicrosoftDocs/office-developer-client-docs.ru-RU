---
title: Отправка сообщений с помощью поставщиков хранилищ сообщений
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 7632d784-00d8-48fd-a73b-73778efbef7f
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: b34714a230adb44417624d149d34ed6a14a2dfa5
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33437611"
---
# <a name="sending-messages-by-using-message-store-providers"></a>Отправка сообщений с помощью поставщиков хранилищ сообщений

**Область применения**: Outlook 2013 | Outlook 2016 
  
Поставщики магазинов сообщений не обязаны поддерживать исходяние сообщений (то есть возможность для клиентских приложений использовать поставщика хранения сообщений для отправки сообщений). Клиентские приложения должны использовать хранилище сообщений при отправке сообщений, так как данные сообщения должны храниться где-то между временем его завершения и временем передачи сообщения поставщиком транспорта для отправки в систему обмена сообщениями. Если поставщик хранения сообщений не поддерживает исходяние сообщений, его нельзя использовать в качестве магазина сообщений по умолчанию.
  
Чтобы поддерживать отправку сообщений, поставщик магазина сообщений должен сделать следующее:
  
- Реализация очереди исходяющих сообщений.
    
- Поддержка [метода IMessage::SubmitMessage](imessage-submitmessage.md) для объектов сообщений, созданных в хранилище сообщений. 
    
- Поддержка методов **IMsgStore,** которые специфичен для шпалеров [MAPI: IMsgStore::FinishedMsg,](imsgstore-finishedmsg.md) [IMsgStore::GetOutgoingQueue,](imsgstore-getoutgoingqueue.md) [IMsgStore::NotifyNewMail](imsgstore-notifynewmail.md)и [IMsgStore::SetLockState](imsgstore-setlockstate.md).
    
Метод **SetLockState** важен для надлежащего взаимодействия между пулером MAPI и клиентами. Когда пульпер MAPI вызывает **SetLockState** в исходячее сообщение, поставщик магазина сообщений не должен позволять клиентам открывать сообщение. Если клиент пытается открыть сообщение, заблокированное пулером MAPI, поставщик магазина сообщений должен MAPI_E_NO_ACCESS. Заблокированное состояние сообщения не должно быть настойчивым в том случае, если хранилище закрывается, а сообщение заблокировано spooler MAPI. 
  
Независимо от того, заблокировали ли выполнитель MAPI исходячее сообщение, поставщик магазина сообщений не должен допускать открытия сообщения в очереди исходяющих сообщений для записи. Если клиент вызывает метод [IMSgStore::OpenEntry](imsgstore-openentry.md) для исходяшего сообщения с флагом MAPI_MODIFY, вызов должен быть неудачным и возвращаться MAPI_E_SUBMITTED. Если клиентская заявка вызывает **OpenEntry** в исходя из сообщения с флагом MAPI_BEST_ACCESS, поставщик магазина сообщений должен разрешить доступ к сообщению только для чтения. 
  
Когда сообщение должно обрабатываться пулером MAPI, поставщик магазина сообщений задает  свойство[PR_SUBMIT_FLAGS (PidTagSubmitFlags)](pidtagsubmitflags-canonical-property.md)для SUBMITFLAG_LOCKED. Значение SUBMITFLAG_LOCKED указывает, что шпалер MAPI заблокировали сообщение для его исключительного использования. Другое значение **для PR_SUBMIT_FLAGS** SUBMITFLAG_PREPROCESS, когда сообщение требует предварительной подготовки одной или более препроцессорных функций, зарегистрированных поставщиком транспорта.
  
В следующих процедурах описывается взаимодействие магазина сообщений, транспорта и пулера MAPI для отправки сообщения от клиента одному или более получателям. 
  
Клиентская заявка вызывает [метод IMessage::SubmitMessage.](imessage-submitmessage.md) В **SubmitMessage** поставщик магазина сообщений делает следующее:
  
1. Вызывает [IMAPISupport::P repareSubmit](imapisupport-preparesubmit.md). Если MAPI возвращает ошибку, поставщик магазина сообщений возвращает эту ошибку клиенту.
    
2. Задает MSGFLAG_SUBMIT в **свойстве PR_MESSAGE_FLAGS** [(PidTagMessageFlags).](pidtagmessageflags-canonical-property.md)
    
3. Гарантирует, что в таблице получателей **имеется** столбец для свойства [PR_RESPONSIBILITY (PidTagResponsibility)](pidtagresponsibility-canonical-property.md)и задает его false, чтобы указать, что транспорт еще не взял на себя ответственность за передачу сообщения.
    
4. Задает дату и время возникновения в **свойстве** [PR_CLIENT_SUBMIT_TIME (PidTagClientSubmitTime).](pidtagclientsubmittime-canonical-property.md)
    
5. Вызывает [IMAPISupport::ExpandRecips,](imapisupport-expandrecips.md) чтобы сделать следующее: 
    
    1. ���������� ��� ������ �������� � ����������� � �������� ��� ���������� ������������ ����� � ��������� �������.
        
    2. �������� ������������� ����.
        
    3. Проверьте, требуется ли предварительная процессировка и, если требуется предварительная проверка, установите флаг NEEDS_PREPROCESSING и свойство **PR_PREPROCESS** [(PidTagPreprocess),](pidtagpreprocess-canonical-property.md)зарезервированное для MAPI. 
        
    4. ���������� ����� NEEDS_SPOOLER ��������� ��������� ����� ������� � ���������� � �� ����� ���������� ���� �����������. 
    
6. ���� ���������� ���� ��������� NEEDS_PREPROCESSING ��������� ��������� ������:
    
    1. Помещает сообщение в исходяю очередь с SUBMITFLAG_PREPROCESS в свойстве  PR_SUBMIT_FLAGS. 
        
    2. ���������� ��������� ������� MAPI, ������� ��� ������� �������.
        
    3. ��������� ���������� ������� � ����� ��������� ��-�������� ������������ � ��������� ������� MAPI. ��������� ������� MAPI ��������� ��������� ������: 
    
       1. Блокирует сообщение, позвонив [в IMsgStore::SetLockState.](imsgstore-setlockstate.md)
            
       2. Выполняет необходимую предварительную подготовку, вызывая все функции предварительной подготовки в порядке регистрации. Поставщики транспорта [звонят по вызову IMAPISupport::RegisterPreprocessor](imapisupport-registerpreprocessor.md) для регистрации функций препроцессации. 
            
       3. Вызывает [IMessage::SubmitMessage](imessage-submitmessage.md) в открытом сообщении, чтобы указать в хранилище сообщений, что препроцессия завершена. 
    
Если не было предварительной обработки или была предварительная обработка и пульпер MAPI под названием **SubmitMessage,** поставщик магазина сообщений делает следующее в клиентском процессе: 
  
- Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):
    
   - ������������ �����������, ������� ����� ������������.
    
   - ������������� ��� �������� **PR_RESPONSIBILITY** �������� TRUE ��� �����������, ������� �� ������������. 
    
   - ���� ��� ���������� ��������, ��� ���� ����� ��������� ��������� � ����������, ��������� ��������� ������: 
    
     - Вызывает [IMAPISupport::CompleteMsg,](imapisupport-completemsg.md) если сообщение было предварительно оформлено или поставщик магазина сообщений хочет, чтобы пуллер MAPI завершил обработку сообщений. Поток сообщений продолжается с помощью пульпера MAPI. 
    
     - Выполняет следующие задачи, если сообщение не было предпроцессом или поставщик магазина сообщений не хочет, чтобы пулер MAPI завершил обработку сообщений:
    
       1. Копирует сообщение в папку, указанную идентификатором записи в **свойстве** [PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId),](pidtagsentmailentryid-canonical-property.md)если установлено.
            
       2. Удаляет сообщение, если **свойство PR_DELETE_AFTER_SUBMIT** [(PidTagDeleteAfterSubmit)](pidtagdeleteaftersubmit-canonical-property.md)было настроено на TRUE.
            
       3. Разблокирует сообщение, если оно заблокировано.
            
       4. Возвращается клиенту. Поток сообщений завершен.
    
  - Выполняет следующие задачи, если сообщение было предварительно выполнено или поставщик хочет, чтобы шпалер MAPI завершил обработку сообщений:
    
    1. Вызовы [IMAPISupport::CompleteMsg](imapisupport-completemsg.md). 
          
    2. Продолжается поток сообщений с помощью пульпера MAPI. Дополнительные сведения см. в [рублях Отправка сообщений: задачи Спулера MAPI](sending-messages-mapi-spooler-tasks.md).
    
  - Выполняет следующие задачи, если сообщение не было предварительно выполнено или поставщик не хочет, чтобы шпалер завершил обработку сообщений:
    
    1. Копирует сообщение в папку, определяемую идентификатором записи **в свойстве** PR_SENTMAIL_ENTRYID, если установлено. 
        
    2. Удаляет сообщение, если **PR_DELETE_AFTER_SUBMIT** установлено true. 
        
    3. Разблокирует сообщение, если оно заблокировано. 
        
    4. Возвращается вызываемой. Поток сообщений завершен.
    
- ���� ��������� ��������� �� ����� ���������� ��� ����������, �� ���� ����������� ��������, ��� ��������� ��������� ��� ���� NEEDS_SPOOLER ��������� ��������� ������:
    
  1. ��������� ���������� � ������� ��������� ��� ��������� ���� SUBMITFLAG_PREPROCESS � �������� **PR_SUBMIT_FLAGS**. 
    
  2. ���������� ��������� ������� MAPI, ��������� ������� ��� �������, ������ ����������� � �������. 
    
  3. ���������� ������� � ����� ��������� ��-�������� ������������ � ������� ������, ����������� ����������� ������� MAPI.
    
## <a name="see-also"></a>См. также

- [���������� ��������� ���������](message-store-features.md)


---
title: OpenIMsgOnIStg
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
ms.topic: reference
ms.prod: office-online-server
localization_priority: Normal
api_name:
- OpenIMsgOnIStg
api_type:
- HeaderDef
ms.assetid: a98b0b26-9b19-44ca-9b4e-0ad4d1c54325
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: 6d5ed20e532f0893757cc46d9ea478c7b65acc86
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33406523"
---
# <a name="openimsgonistg"></a>OpenIMsgOnIStg

**Относится к**: Outlook 2013 | Outlook 2016 
  
Создает новый объект [iMessage](imessageimapiprop.md) поверх существующего объекта OLE **IStorage** , который будет использоваться в сеансе сообщений. 
  
|||
|:-----|:-----|
|Файл заголовка:  <br/> |IMessage. h  <br/> |
|Реализовано в:  <br/> |MAPI  <br/> |
|Вызывающая сторона:  <br/> |Клиентские приложения и поставщики услуг  <br/> |
   
```cpp
SCODE OpenIMsgOnIStg(
  LPMSGSESS lpMsgSess,
  LPALLOCATEBUFFER lpAllocateBuffer,
  LPALLOCATEMORE lpAllocateMore,
  LPFREEBUFFER lpFreeBuffer,
  LPMALLOC lpmalloc,
  LPVOID lpMapiSup,
  LPSTORAGE lpStg,
  MSGCALLRELEASE FAR * lpfMsgCallRelease,
  ULONG ulCallerData,
  ULONG ulFlags,
  LPMESSAGE FAR * lppMsg
);
```

## <a name="parameters"></a>Параметры

_лпмсгсесс_
  
> возврата Указатель на объект сеанса сообщения, в котором будет создан новый объект **iMessage**-On- **IStorage** . 
    
_лпаллокатебуффер_
  
> возврата Указатель на функцию [мапиаллокатебуффер](mapiallocatebuffer.md) , которая будет использоваться для выделения памяти. 
    
_лпаллокатеморе_
  
> возврата Указатель на функцию [мапиаллокатеморе](mapiallocatemore.md) , которая будет использоваться для выделения дополнительной памяти. 
    
_лпфрибуффер_
  
> возврата Указатель на функцию [мапифрибуффер](mapifreebuffer.md) , который будет использоваться для освобождения памяти. 
    
_лпмаллок_
  
> возврата Указатель на объект распределителя памяти, который предоставляет интерфейс для **выделения** OLE. Интерфейс **iMessage** должен использовать этот метод распределения при работе с такими интерфейсами, как **IStorage** и **IStream**. 
    
_лпмаписуп_
  
> возврата Необязательный указатель на объект поддержки MAPI, который поставщик услуг может использовать для вызова методов интерфейса [имаписуппорт: IUnknown](imapisupportiunknown.md) . 
    
_лпстг_
  
> [вход, выход] Указатель на объект OLE **IStorage** , который открыт и имеет разрешение только на чтение или чтение и запись. Так как **iMessage** не поддерживает доступ только для записи, **опенимсгонистг** не принимает объект хранилища, Открытый в режиме "только для чтения". 
    
_лпфмсгкаллрелеасе_
  
> возврата Необязательный указатель на функцию обратного вызова, основанный на прототипе [мсгкаллрелеасе](msgcallrelease.md) , который вызывается с помощью MAPI после последнего выпуска объекта **iMessage**-On- **IStorage** . 
    
_улкаллердата_
  
> возврата Данные вызывающего абонента, сохраненные MAPI с помощью объекта **iMessage**On/ **IStorage** и переданные в функцию обратного вызова на основе **мсгкаллрелеасе** . Данные предоставляют контекст для вызываемого объекта **iMessage** и объект **IStorage** поверх его построения. 
    
_ulFlags_
  
> возврата Битовая маска флагов, используемых для управления тем, вызывает ли метод OLE **IStorage:: Commit** , когда клиентское приложение или поставщик услуг вызывает метод **iMessage:: SaveChanges** . Можно задать следующие флаги: 
    
IMSG_NO_ISTG_COMMIT 
  
> Метод OLE **IStorage:: Commit** не вызывается, когда клиент или поставщик вызывает [SaveChanges](imapiprop-savechanges.md). 
    
MAPI_UNICODE
  
> Позволяет создавать файлы Unicode. MSG. Полученный в результате файл [iMessage](imessageimapiprop.md) показывает STORE_UNICODE_OK в [PR_STORE_SUPPORT_MASK](pidtagstoresupportmask-canonical-property.md) и поддерживает свойства Юникода. 
    
  > [!NOTE]
  > Флаг MAPI_UNICODE поддерживается только в этой функции в Outlook 2003 или более поздней версии. 
  
_лппмсг_
  
> вышли Указатель на указатель на открытый объект **iMessage** . 
    
## <a name="return-value"></a>Возвращаемое значение

S_OK 
  
> ����� ������� � ������ ��������� ��������� ��� ��������.
    
## <a name="remarks"></a>Примечания

Доступ к атрибутам свойств возможен только для объектов Property, то есть объектов, реализующих интерфейс [IMAPIProp: IUnknown](imapipropiunknown.md) . Чтобы сделать свойства MAPI доступными в объекте структурированного хранилища OLE, **опенимсгонистг** создает объект [iMessage: IMAPIProp](imessageimapiprop.md) в начале объекта OLE **IStorage** . Атрибуты свойств таких объектов можно задавать или изменять с помощью [сетаттрибимсгонистг](setattribimsgonistg.md) и извлекаются с помощью [жетаттрибимсгонистг](getattribimsgonistg.md). 
  
## <a name="notes-to-callers"></a>Примечания для вызывающих методов

Перед вызовом **опенимсгонистг** необходимо открыть сеанс сообщений с [опенимсгсессион](openimsgsession.md) . Указание допустимого параметра _лпмсгсесс_ гарантирует, что новое сообщение будет создано в сеансе сообщений, чтобы оно закрылось при закрытии сеанса. Если _лпмсгсесс_ имеет значение null, сообщение создается независимо от любого сеанса сообщения. Если клиентское приложение или поставщик услуг, создавший сообщение, не освобождает его, а также все его вложения и открытые таблицы, память утечки и может привести к завершению работы приложения. 
  
MAPI использует функции, на которые указывает _лпаллокатебуффер_, _лпаллокатеморе_и _лпфрибуффер_ для большей части памяти и освобождений, в частности, для выделения памяти, используемой клиентскими приложениями при вызове интерфейсов объектов, таких как [IMAPIProp::](imapiprop-getprops.md) и [IMAPITable:: QueryRows](imapitable-queryrows.md). Указатели _лпаллокатебуффер_, _лпаллокатеморе_и _Лпфрибуффер_ необязательны, если функция **опенимсгонистг** вызывается с допустимым параметром _лпмаписуп_ . 
  
Так как он работает с базовым объектом OLE, для MAPI также необходимо использовать выделение памяти OLE. Дополнительные сведения об объектах структурированного хранилища OLE и выделении памяти OLE приведены в статье _Справочник программиста по OLE_. 
  
Если для _лпмаписуп_указано допустимое значение, **iMessage** поддерживает флаги MAPI_DIALOG и ATTACH_DIALOG, вызывая метод [имаписуппорт::D опрогрессдиалог](imapisupport-doprogressdialog.md) для предоставления пользовательского интерфейса хода выполнения для методов [IMAPIProp:: CopyTo](imapiprop-copyto.md) и [iMessage::D елетеаттач](imessage-deleteattach.md) . Кроме того, метод [iMessage:: модифиреЦипиентс](imessage-modifyrecipients.md) пытается преобразовать краткосрочные идентификаторы записей в долгосрочные идентификаторы записей, вызвав метод [Имаписуппорт:: опенаддрессбук](imapisupport-openaddressbook.md) и совершая вызовы для полученного объекта адресной книги. Если для _лпмаписуп_передается значение null, **iMessage** игнорирует MAPI_DIALOG и ATTACH_DIALOG и сохраняет краткосрочные идентификаторы записей без преобразования. 
  
Объект **IStorage** , на который указывает параметр _лпстг_ , должен быть открыт в режиме STGM_READ или STGM_READWRITE. Если используется режим STGM_READWRITE, также необходимо задать режим STGM_TRANSACTED. 
  
Функция обратного вызова, на которую указывает параметр _лпфмсгкаллрелеасе_ , является необязательной; Если этот параметр указан, он должен основываться на прототипе функции [мсгкаллрелеасе](msgcallrelease.md) . Интерфейс **iMessage** вызывает его, когда значение счетчика ссылок объекта **iMessage**-On- **IStorage** задается равным нулю по последнему вызову метода **Release** . Функция обратного вызова обычно используется для освобождения базового интерфейса **IStorage** . **IMessage** не будет пытаться получить доступ к объекту **IStorage** , на который указывает параметр _лпстг_ после выполнения обратного вызова. 
  
Некоторые клиенты или поставщики могут записывать дополнительные данные в объект **IStorage** , помимо того, что **iMessage** записывает при вызове метода [SaveChanges](imapiprop-savechanges.md) . Клиент или поставщик могут использовать флаг IMSG_NO_ISTG_COMMIT, чтобы запретить **iMessage** вызывать метод "OLE **IStorage:: Commit** " при обработке вызова **SaveChanges** ; в этом случае клиент или поставщик должны зафиксировать объект **IStorage** при записи дополнительных данных. Для этого реализация **iMessage** гарантирует именование всех подхранилищ, которые он создает, в объекте **IStorage** , начиная со строки "__", то есть с двумя знаками подчеркивания. Клиент или поставщик может избежать конфликтов имен, сохраняя их имена из этого пространства имен. 
  
MAPI не определяет поведение нескольких операций открытия, выполняемых над вложенным объектом сообщения, например вложением, потоком или внедренным сообщением. В настоящее время MAPI позволяет открыть еще один подобъект, который уже открыт, но MAPI выполняет операцию открытия путем увеличения числа ссылок для существующего открытого объекта и возвращения его клиенту или поставщику, вызвавшему метод [iMessage:: опенаттач](imessage-openattach.md) или [IMAPIProp:: опенпроперти](imapiprop-openproperty.md) . Это означает, что доступ, запрошенный для первой операции открытия для подобъекта, является доступным для всех последующих операций открытия, независимо от доступа, запрашиваемого операциями. 
  
Чтобы поместить сообщение в вложение, нужно вызвать метод [IMAPIProp:: опенпроперти](imapiprop-openproperty.md) с идентификатором интерфейса IID_IMessage. В настоящее время **опенпроперти** также поддерживает создание вложений сообщений, доступных непосредственно в интерфейсе OLE **IStorage** , то есть с помощью идентификатора интерфейса IID_IStorage. Доступ **IStorage** поддерживается, чтобы обеспечить простой способ поместить документ Microsoft Word во вложение без преобразования его в интерфейс OLE **IStream** или из него. Однако **iMessage** может вести себя непредсказуемо, если **опенимсгонистг** передается указатель **IStorage** на данные вложения, а затем объекты освобождаются в неправильном порядке. 
  
## <a name="mfcmapi-reference"></a>Справочные материалы по MFCMAPI

Пример кода MFCMAPI указан в приведенной ниже таблице.
  
|**Файл**|**Функция**|**Примечание**|
|:-----|:-----|:-----|
|Файл. cpp  <br/> |лоадмсгтомессаже  <br/> |MFCMAPI использует метод **опенимсгонистг** для открытия интерфейса IMessage на основе. MSG, чтобы файл мог управляться с помощью MAPI.  <br/> |
   
## <a name="see-also"></a>См. также

- [Mfcmapi (en) � �������� ������� ����](mfcmapi-as-a-code-sample.md)


---
title: Инициализация MAPI
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 22ee8157-d74e-4a94-9c76-b9ac736d5211
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: 5fde3e7eda8d98eb5080fff360616649b1eb96a5
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32309732"
---
# <a name="initializing-mapi"></a>Инициализация MAPI

  
  
**Область применения**: Outlook 2013 | Outlook 2016 
  
Все клиентские приложения, использующие библиотеки MAPI, должны вызывать функцию **мапиинитиализе** . Дополнительные сведения см. в разделе [мапиинитиализе](mapiinitialize.md). **Мапиинитиализе** инициализирует глобальные данные для сеанса и подготавливает библиотеки MAPI к приему вызовов. В некоторых ситуациях важно задать несколько флагов: 
  
- МАПИ_НТ_СЕРВИЦЕ
    
    Установите флаг МАПИ_НТ_СЕРВИЦЕ, если клиент реализован в виде службы Windows. Если ваш клиент является службой Windows, и этот флаг не установлен, MAPI не сможет распознать его как службу. 
    
- МАПИ_МУЛТИСРЕАД_НОТИФИКАТИОНС
    
    Флаг МАПИ_МУЛТИСРЕАД_НОТИФИКАТИОНС связан с тем, как MAPI управляет уведомлениями. MAPI создает скрытое окно, которое получает сообщения окна при изменении объекта, создающего уведомления. Сообщения окна обрабатываются в некоторый момент, в результате чего отправляются уведомления и подходящие методы [имапиадвисесинк:: OnNotify](imapiadvisesink-onnotify.md) , которые необходимо вызвать. 
    
- МАПИ_НО_КОИНИТ
    
    Установите флаг МАПИ_НО_КОИНТ таким образом, чтобы **мапиинитиализе** не пытался инициализировать COM при вызове функции [CoInitialize](https://msdn.microsoft.com/library/ms886303.aspx). Если структура **MAPIINIT_0** передается в **мапиинитиализе** с параметром _ulFlags_ , равным мапи_но_коинит, то MAPI предполагает, что com уже инициализирован и не обходит вызов **CoInitialize**.
    
Если флаг МАПИ_МУЛТИСРЕАД_НОТИФИКАТИОНС не передается, MAPI создает окно уведомления в потоке, который использовался для первого вызова **мапиинитиализе** . MAPI создает окно уведомления в отдельном потоке, если передается МАПИ_МУЛТИСРЕАД_НОТИФИКАТИОНС — поток, предназначенный для обработки уведомлений. MAPI ожидает, что поток, используемый для создания скрытого окна уведомлений, будет: 
  
- У вас есть цикл обработки сообщений.
    
- Не блокируется в течение всего времени жизни сеанса.
    
- Больше времени жизни, чем любой другой поток, созданный вашим клиентом. 
    
Вы можете выбрать, какой поток используется, установив флаг в первом вызове **мапиинитиализе** . Опасность, позволяющая одному из потоков обрабатывать уведомления, заключается в том, что в случае исчезновения потока окно уведомлений уничтожается, а уведомления не отправляются ни одному из других потоков. Кроме того, для управления отправкой сообщений уведомления, отправляемых в очередь сообщений скрытого окна, может потребоваться специальная обработка. 
  
Если вы используете отдельное окно для обработки уведомлений, будьте уверены, что уведомления будут отображаться в соответствующее время в соответствующем потоке. Для проверки и обработки сообщений Windows, отправленных в окно уведомления, не потребуется специальный код. 
  
MAPI рекомендует следующим типам клиентских приложений использовать отдельный поток для создания скрытого окна для поддержки уведомлений:
  
- Все многопоточные клиенты.
    
- Однопотоковые службы Windows и консольные приложения Win32.
    
- Однопотоковые клиенты, для которых не требуется использовать основной поток для уведомления.
    
Чтобы использовать отдельный подход к потоку, вызовите **мапиинитиализе** для каждого потока, УСТАНОВИВ флаг мапи_мултисреад_нотификатионс. 
  
> [!NOTE]
> Только первый вызов клиента **мапиинитиализе** приводит к созданию скрытого окна для поддержки уведомлений. Последующие вызовы приводят к увеличению счетчика ссылок. 
  


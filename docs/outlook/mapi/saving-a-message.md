---
title: Сохранение сообщения
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 97bff16b-dc7c-4eed-8834-d0c076d83ca3
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: d5ceeb46bded101700aec696a17d690bde80ce6d
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33420934"
---
# <a name="saving-a-message"></a><span data-ttu-id="1fae5-103">Сохранение сообщения</span><span class="sxs-lookup"><span data-stu-id="1fae5-103">Saving a Message</span></span>

  
  
<span data-ttu-id="1fae5-104">**Относится к**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="1fae5-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="1fae5-105">Перед сохранением сообщения клиенты обычно вызывают метод сообщения [IMAPIProp:: SetProps](imapiprop-setprops.md) , чтобы задать несколько свойств в дополнение к свойствам текста сообщений, свойствам вложений, **PR_SUBJECT** ([PidTagSubject](pidtagsubject-canonical-property.md)) и свойствам, связанным со списком получателей.</span><span class="sxs-lookup"><span data-stu-id="1fae5-105">Before a message is saved, clients typically call the message's [IMAPIProp::SetProps](imapiprop-setprops.md) method to set a few properties in addition to the message text properties, attachment properties, **PR_SUBJECT** ([PidTagSubject](pidtagsubject-canonical-property.md)), and properties associated with the recipient list.</span></span>
  
<span data-ttu-id="1fae5-106">Задайте для свойства **PR_MESSAGE_CLASS** ([PidTagMessageClass](pidtagmessageclass-canonical-property.md)) строку символов, например IPM. Обратите внимание, что описывает класс исходящего сообщения.</span><span class="sxs-lookup"><span data-stu-id="1fae5-106">Set the **PR_MESSAGE_CLASS** ([PidTagMessageClass](pidtagmessageclass-canonical-property.md)) property to a character string such as IPM.Note that describes the class of the outgoing message.</span></span> <span data-ttu-id="1fae5-107">Несмотря на то, что клиенты должны задать **PR_MESSAGE_CLASS** для всех исходящих сообщений, поставщик хранилища сообщений предоставляет значение по умолчанию, если оно не задано.</span><span class="sxs-lookup"><span data-stu-id="1fae5-107">Although clients should set **PR_MESSAGE_CLASS** on all outgoing messages, a default value is supplied by the message store provider if you do not set it.</span></span> <span data-ttu-id="1fae5-108">Классом сообщений по умолчанию для исходящих сообщений является IPM.</span><span class="sxs-lookup"><span data-stu-id="1fae5-108">The default message class for outgoing messages is IPM.</span></span> 
  
<span data-ttu-id="1fae5-109">Установите флаг MSGFLAG_UNSENT в свойстве **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="1fae5-109">Set the MSGFLAG_UNSENT flag in the **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) property.</span></span> <span data-ttu-id="1fae5-110">При необходимости также установите флаги MSGFLAG_READ и MSGFLAG_UNMODIFIED.</span><span class="sxs-lookup"><span data-stu-id="1fae5-110">If desired, also set the MSGFLAG_READ and MSGFLAG_UNMODIFIED flags.</span></span> <span data-ttu-id="1fae5-111">Установка MSGFLAG_UNMODIFIED позволяет имитировать доставленное сообщение в разделе композиция.</span><span class="sxs-lookup"><span data-stu-id="1fae5-111">Setting the MSGFLAG_UNMODIFIED allows a message under composition to simulate a delivered message.</span></span> <span data-ttu-id="1fae5-112">Клиенты могут устанавливать MSGFLAG_UNMODIFIED только после того, как оно будет сохранено в первый раз.</span><span class="sxs-lookup"><span data-stu-id="1fae5-112">MSGFLAG_UNMODIFIED can only be set by clients before a message has been saved for the first time.</span></span> 
  
<span data-ttu-id="1fae5-113">Когда вы будете готовы создать постоянную копию неотправленного сообщения, вызовите [IMAPIProp:: SaveChanges](imapiprop-savechanges.md) для сообщения и всех его вложений.</span><span class="sxs-lookup"><span data-stu-id="1fae5-113">When you are ready to make a permanent copy of an unsent message, call [IMAPIProp::SaveChanges](imapiprop-savechanges.md) on the message and all of its attachments.</span></span> <span data-ttu-id="1fae5-114">Если вы планируете отправить сообщение немедленно, вам не нужно вызывать **SaveChanges**.</span><span class="sxs-lookup"><span data-stu-id="1fae5-114">If you intend to send the message right away, you do not need to call **SaveChanges**.</span></span> <span data-ttu-id="1fae5-115">Вызов **субмитмессаже** внутренним образом сохраняет сообщение в ходе его обработки.</span><span class="sxs-lookup"><span data-stu-id="1fae5-115">The call to **SubmitMessage** internally saves the message as part of its processing.</span></span> 
  
<span data-ttu-id="1fae5-116">При вызове метода **SaveChanges**рекомендуется указать флаг KEEP_OPEN_READWRITE, который позволяет изменить сообщение позднее в дальнейшем.</span><span class="sxs-lookup"><span data-stu-id="1fae5-116">When calling **SaveChanges**, it is a good idea to specify the KEEP_OPEN_READWRITE flag, which allows the message to be modified at a later time.</span></span> <span data-ttu-id="1fae5-117">Другие устанавливаемые флаги включают FORCE_SAVE, что указывает на то, что сообщение или вложение необходимо закрыть после фиксации изменений, KEEP_OPEN_READONLY, что означает, что дальнейшие изменения не будут внесены, а флаг, позволяющий поставщику хранилища сообщений выполнять пакетные запросы клиентов, MAPI_DEFERRED_ERRORS.</span><span class="sxs-lookup"><span data-stu-id="1fae5-117">Other settable flags include FORCE_SAVE, which indicates that the message or attachment should be closed after changes are committed, KEEP_OPEN_READONLY, which indicates that no further changes will be made, and the flag to allow the message store provider to batch client requests, MAPI_DEFERRED_ERRORS.</span></span>
  
<span data-ttu-id="1fae5-118">Необходимо вызвать метод **SaveChanges** для каждого вложения в сообщении, прежде чем вызывать метод **SaveChanges** для сообщения.</span><span class="sxs-lookup"><span data-stu-id="1fae5-118">It is essential that you call **SaveChanges** for every attachment in the message before you call **SaveChanges** for the message.</span></span> <span data-ttu-id="1fae5-119">Если не удается сохранить вложение, вложение не будет включено в сообщение при его отправке и не будет отображаться в таблице вложений сообщения.</span><span class="sxs-lookup"><span data-stu-id="1fae5-119">If you fail to save an attachment, the attachment will not be included with the message when it is sent and it will not appear in the message's attachment table.</span></span> <span data-ttu-id="1fae5-120">Если не удается сохранить сообщение после сохранения всех вложений, сообщение и вложения будут потеряны.</span><span class="sxs-lookup"><span data-stu-id="1fae5-120">If you fail to save the message after saving all of the attachments, both the message and the attachments will be lost.</span></span> 
  
<span data-ttu-id="1fae5-121">При вызове **SaveChanges** поставщик хранилища сообщений обновляет следующие свойства:</span><span class="sxs-lookup"><span data-stu-id="1fae5-121">When **SaveChanges** is called, the message store provider updates the following properties:</span></span> 
  
- <span data-ttu-id="1fae5-122">**PR_DISPLAY_TO** ([PidTagDisplayTo](pidtagdisplayto-canonical-property.md)) — список всех основных получателей.</span><span class="sxs-lookup"><span data-stu-id="1fae5-122">**PR_DISPLAY_TO** ([PidTagDisplayTo](pidtagdisplayto-canonical-property.md)) lists all primary recipients.</span></span>
    
- <span data-ttu-id="1fae5-123">**PR_DISPLAY_TO** список всех получателей копии.</span><span class="sxs-lookup"><span data-stu-id="1fae5-123">**PR_DISPLAY_TO** lists all carbon copy recipients.</span></span> 
    
- <span data-ttu-id="1fae5-124">**PR_DISPLAY_BCC** ([PidTagDisplayBcc](pidtagdisplaybcc-canonical-property.md)) — список всех получателей скрытой копии.</span><span class="sxs-lookup"><span data-stu-id="1fae5-124">**PR_DISPLAY_BCC** ([PidTagDisplayBcc](pidtagdisplaybcc-canonical-property.md)) lists all blind carbon copy recipients.</span></span>
    
- <span data-ttu-id="1fae5-125">**PR_LAST_MODIFICATION_TIME** ([PidTagLastModificationTime](pidtaglastmodificationtime-canonical-property.md))</span><span class="sxs-lookup"><span data-stu-id="1fae5-125">**PR_LAST_MODIFICATION_TIME** ([PidTagLastModificationTime](pidtaglastmodificationtime-canonical-property.md))</span></span>
    
- <span data-ttu-id="1fae5-126">**PR_MESSAGE_FLAGS** задает MSGFLAG_HASATTACH, если одно или несколько вложений были сохранены, и очищает MSGFLAG_UNMODIFIED, чтобы показать сообщение изменилось.</span><span class="sxs-lookup"><span data-stu-id="1fae5-126">**PR_MESSAGE_FLAGS** sets MSGFLAG_HASATTACH if one or more attachments have been saved and clears MSGFLAG_UNMODIFIED to show the message has changed.</span></span> 
    
- <span data-ttu-id="1fae5-127">**PR_MESSAGE_SIZE** ([PidTagMessageSize](pidtagmessagesize-canonical-property.md)) содержит самый актуальный размер сообщения.</span><span class="sxs-lookup"><span data-stu-id="1fae5-127">**PR_MESSAGE_SIZE** ([PidTagMessageSize](pidtagmessagesize-canonical-property.md)) contains the most current size of the message.</span></span>
    
- <span data-ttu-id="1fae5-128">**PR_MESSAGE_ATTACHMENTS** ([PidTagMessageAttachments](pidtagmessageattachments-canonical-property.md)) предоставляет доступ к таблице вложений.</span><span class="sxs-lookup"><span data-stu-id="1fae5-128">**PR_MESSAGE_ATTACHMENTS** ([PidTagMessageAttachments](pidtagmessageattachments-canonical-property.md)) provides access to the attachment table.</span></span>
    
- <span data-ttu-id="1fae5-129">**PR_MESSAGE_RECIPIENTS** ([PidTagMessageRecipients](pidtagmessagerecipients-canonical-property.md)) предоставляет доступ к таблице получателей.</span><span class="sxs-lookup"><span data-stu-id="1fae5-129">**PR_MESSAGE_RECIPIENTS** ([PidTagMessageRecipients](pidtagmessagerecipients-canonical-property.md)) provides access to the recipient table.</span></span>
    
<span data-ttu-id="1fae5-130">Некоторые свойства сообщений обычно предоставляются клиентами или поставщиками услуг при создании сообщения.</span><span class="sxs-lookup"><span data-stu-id="1fae5-130">Some message properties are typically supplied by clients or service providers when a message is created.</span></span> <span data-ttu-id="1fae5-131">Если клиент не задает их, он может обновляться поставщиком хранилища сообщений при вызове метода **SaveChanges** .</span><span class="sxs-lookup"><span data-stu-id="1fae5-131">If a client neglects to set them, it is up to the message store provider to update them at the time **SaveChanges** is called.</span></span> <span data-ttu-id="1fae5-132">Например, если во время создания сообщения были заданы свойства **PR_ENTRYID** ([PidTagEntryId](pidtagentryid-canonical-property.md)) и **PR_RECORD_KEY** ([PidTagRecordKey](pidtagrecordkey-canonical-property.md)) сообщения, их не нужно изменять во время сохранения.</span><span class="sxs-lookup"><span data-stu-id="1fae5-132">For example, if a message's **PR_ENTRYID** ([PidTagEntryId](pidtagentryid-canonical-property.md)) and **PR_RECORD_KEY** ([PidTagRecordKey](pidtagrecordkey-canonical-property.md)) properties were set when the message was created, they need not be modified at save time.</span></span> <span data-ttu-id="1fae5-133">Однако поставщики хранилищ сообщений, которые не задают их при создании сообщения, должны задавать их при первом вызове метода **SaveChanges** .</span><span class="sxs-lookup"><span data-stu-id="1fae5-133">However, message store providers that neglect to set them at message creation must set them the first time that **SaveChanges** is called.</span></span> 
  
<span data-ttu-id="1fae5-134">Если параметр **SaveChanges** возвращает MAPI_E_CORRUPT_DATA, предполагается, что сохраняемые данные теперь теряются.</span><span class="sxs-lookup"><span data-stu-id="1fae5-134">If **SaveChanges** returns MAPI_E_CORRUPT_DATA, assume that the data being saved is now lost.</span></span> <span data-ttu-id="1fae5-135">Поставщики хранилища сообщений, использующие модель клиент-сервер для реализации, могут возвращать это значение при разрыве сетевого подключения или если сервер не работает.</span><span class="sxs-lookup"><span data-stu-id="1fae5-135">Message store providers that use a client-server model for their implementation might return this value when a network connection is lost or the server is not running.</span></span> <span data-ttu-id="1fae5-136">Прежде чем вернуть пользователю сообщение об ошибке, попытайтесь записать и сохранить данные еще раз, выполнив вызов **SetProps** , а затем еще раз вызвать **SaveChanges**.</span><span class="sxs-lookup"><span data-stu-id="1fae5-136">Before returning an error to the user, try to write and save the data a second time by making a call to **SetProps** followed by another call to **SaveChanges**.</span></span> <span data-ttu-id="1fae5-137">Если данные кэшируются локально, это не проблема.</span><span class="sxs-lookup"><span data-stu-id="1fae5-137">If the data is cached locally, this should not be a problem.</span></span> <span data-ttu-id="1fae5-138">Тем не менее, если локальный кэш отсутствует или не удается выполнить вызов **SaveChanges** , отобразится сообщение об ошибке, чтобы предупредить пользователя о проблеме.</span><span class="sxs-lookup"><span data-stu-id="1fae5-138">However, if there is no local cache or the second **SaveChanges** call fails, display an error to alert the user to the problem.</span></span> 
  


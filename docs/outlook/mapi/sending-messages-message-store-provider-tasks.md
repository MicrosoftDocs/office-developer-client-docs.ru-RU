---
title: �������� ��������� ������ ���������� ��������� ���������
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: acbfd3ae-bfdc-4103-bed2-6bcf7b9c448c
description: '���� ���������� ���������: 9 ����� 2015 �.'
ms.openlocfilehash: b65113e59b236b1f13596627a8669ae458f76369
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33406502"
---
# <a name="sending-messages-message-store-provider-tasks"></a>Отправка сообщений: задачи поставщика хранилища сообщений

**Относится к**: Outlook 2013 | Outlook 2016 
  
A message store provider gets involved with the message sending process when a client calls the message's [IMessage::SubmitMessage](imessage-submitmessage.md) method. If multiple messages are to be sent, the message store must send them in the same order that the client used for its **SubmitMessage** calls. 
  
��������� ��������� ��������� ���������� �� �������� ��������� ������� MAPI. ���� ��������� �������� ��������� �� �������� ����� ���������, ��������� ������� ��������������� ���������, ��� ����� ��������� ��������� � ���������� �� ������� ���������� ���� �����������, ��������� ������� MAPI ������ ��������� �������. 
  
��������� ��������� ��������� ������, ������� ���������� ���������� ��������� ��������� ��� �������� ���������. 
  
**В IMessage:: субмитмессаже, поставщик хранилища сообщений**:
  
1. Вызывает [имаписуппорт::P репаресубмит](imapisupport-preparesubmit.md) , если в свойстве **пр_мессаже_флагс** ([PIDTAGMESSAGEFLAGS](pidtagmessageflags-canonical-property.md)) сообщения задан флаг мсгфлаг_ресенд, и в клиенте возвращаются ошибки. **Препаресубмит** проверяет свойство **пр_реЦипиент_типе** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) каждого получателя в списке получателей сообщения.
    
   - Если установлен флаг МАПИ_СУБМИТТЕД, указывающий на то, что получатель не получил исходное сообщение, **препаресубмит** очищает флаг и задает для свойства **пр_респонсибилити** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) значение true. 
    
   - ���� ���� MAPI_SUBMITTED �� ����������, ������������ �� ��, ��� ���������� ��� ������� �������� ��������� **PrepareSubmit** �������� �������� **PR_RECIPIENT_TYPE** MAPI_P1 � ������������� ��� �������� **PR_RESPONSIBILITY** �������� TRUE � ���������� �� ������, ��������� �������� **PrepareSubmit** �������. 
    
2. ������ ���� MSGFLAG_SUBMIT � �������� **PR_MESSAGE_FLAGS** ���������. 
    
3. ������ �� ���, ��� ������� ��� **PR_RESPONSIBILITY** � ������� ����������� � ������ �������� FALSE, ����� �������, ��� ��� ���������� ��� �������������� ��������������� ��� �������� ���������. 
    
4. Задает дату и время происхождения в свойстве **пр_клиент_субмит_тиме** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)).
    
5. Calls [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) to: 
    
   - ���������� ��� ������ �������� � ����������� � �������� ��� ���������� ������������ ����� � ��������� �������.
   - �������� ������������� ����.
   - Проверьте наличие необходимой предварительной обработки и, если необходима предварительная обработка, установите флаг НИДС_ПРЕПРОЦЕССИНГ и свойство **пр_препроцесс** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)), свойство, зарезервированное для MAPI. 
   - ���������� ����� NEEDS_SPOOLER ��������� ��������� ����� ������� � ���������� � �� ����� ���������� ���� �����������. 
    
6. ���� ���������� ���� ��������� NEEDS_PREPROCESSING ��������� ��������� ������:
    
   - ПоМещает сообщение в исходящую очередь с установленным битом СУБМИТФЛАГ_ПРЕПРОЦЕСС в свойстве **пр_субмит_флагс** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)).
   - ���������� ��������� ������� MAPI, ������� ��� ������� �������.
   - ��������� ���������� ������� � ����� ��������� ��-�������� ������������ � ��������� ������� MAPI. 
   - ��������� ������� MAPI ��������� ��������� ������:
     - Блокирует сообщение, вызывая IMsgStore:: Сетлоккстате. 
     - Выполняет необходимую предварительную обработку, вызывая все функции предварительной обработки в порядке регистрации. Поставщики транспорта вызывают Имаписуппорт:: Регистерпрепроцессор для регистрации функций предварительной обработки. 
     - Вызывает IMessage:: Субмитмессаже в открытом сообщении, чтобы показать банк сообщений, что предварительная обработка завершена.

<br/>

Следующие два действия выполняются в клиентском процессе, если нет предварительной обработки, и когда диспетчер очереди MAPI вызывает **субмитмессаже** при выполнении предварительной обработки. 

**Поставщик хранилища сообщений**:

1. Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):
    
   - ������������ �����������, ������� ����� ������������.
   - ������������� ��� �������� **PR_RESPONSIBILITY** �������� TRUE ��� �����������, ������� �� ������������. 
   - ���� ��� ���������� ��������, ��� ���� ����� ��������� ��������� � ����������, ��������� ��������� ������:
     - Вызывает Имаписуппорт:: Комплетемсг, если сообщение было предварительно обработано, или поставщик хранилища сообщений хочет, чтобы диспетчер очереди MAPI выполнял обработку сообщений, что рекомендуется для вызова обработчиков сообщений. Процесс обработки сообщений продолжается с помощью диспетчера очереди MAPI, как описано в следующей процедуре.  
     - Выполняет следующие задачи, если сообщение не было предварительно обработано, или поставщик хранилища сообщений не хочет, чтобы диспетчер очереди MAPI завершил обработку сообщений:
       - Копирует сообщение в папку, указанную идентификатором записи, в свойстве ПР_СЕНТМАИЛ_ЕНТРИД (PidTagSentMailEntryId), если оно задано.
       - Удаляет сообщение, если для свойства ПР_ДЕЛЕТЕ_АФТЕР_СУБМИТ (PidTagDeleteAfterSubmit) задано значение TRUE.
       - Разблокирует сообщение, если оно заблокировано.
       - Возвращает клиенту. Процесс обработки сообщений завершен. 
   
2. ���� ��������� ��������� �� ����� ���������� ��� ����������, �� ���� ����������� ��������, ��� ��������� ��������� ��� ���� NEEDS_SPOOLER ��������� ��������� ������:
    
   - ��������� ���������� � ������� ��������� ��� ��������� ���� SUBMITFLAG_PREPROCESS � �������� **PR_SUBMIT_FLAGS**. 
   - ���������� ��������� ������� MAPI, ��������� ������� ��� �������, ������ ����������� � �������. 
   - ���������� ������� � ����� ��������� ��-�������� ������������ � ������� ������, ����������� ����������� ������� MAPI.
    
���� ��������� �� ����� �������������� ��������� ������� MAPI, ��������� �������� ��������� ������������� �������� �������� **PR_SUBMIT_FLAGS** ��������� SUBMITFLAG_LOCKED. ���� SUBMITFLAG_LOCKED ���������, ��� ��������� ������� MAPI ������������ ��������� ��� ������������� ��� �������������. ������ ��� **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, ����� �������� ��� ��������� ������� ��������������� ��������� ������ ��� ���������� ������������� ���������, ������������������, ���������� ����������. 
  


---
title: Загрузка поставщиков хранилищ сообщений
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 632d3ef9-43c5-429a-84d7-2dce543d49fb
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: fe3a76fa246cba9447db2f99562670973af183ab
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32307807"
---
# <a name="loading-message-store-providers"></a>Загрузка поставщиков хранилищ сообщений

  
  
**Относится к**: Outlook 2013 | Outlook 2016 
  
Когда клиентское приложение открывает хранилище сообщений, MAPI загружает в память DLL поставщика хранилища сообщений. После того как MAPI загрузит библиотеку DLL, между поставщиком хранилища сообщений и MAPI возникает очень конкретная последовательность вызовов метода. Эта последовательность вызовов метода позволяет интерфейсу MAPI получить Функцииimsprovider верхнего уровня [: IUnknown](imsprovideriunknown.md), [имслогон: IUnknown](imslogoniunknown.md)и [IMsgStore: IMAPIProp](imsgstoreimapiprop.md) интерфейсы и позволяет поставщику хранилища сообщений получать объект поддержки MAPI. После выполнения последовательности вызовов поставщик хранилища сообщений должен быть готов к приему входов от клиентов. 
  
Последовательность вызовов при загрузке библиотеки DLL поставщика сообщений выглядит следующим образом:
  
1. Клиент вызывает [IMAPISession:: опенмсгсторе](imapisession-openmsgstore.md).
    
2. Если хранилище сообщений еще не открыто, MAPI загружает библиотеку DLL поставщика хранилища и вызывает точку входа [МСПРОВИДЕРИНИТ](msproviderinit.md) DLL. Если хранилище сообщений уже открыто, MAPI пропускает действия 2 и 3, а затем использует существующий интерфейс [функцииimsprovider: IUnknown](imsprovideriunknown.md) для выполнения шага 4. 
    
3. **Мспровидеринит** создает и возвращает объект **функцииimsprovider** . 
    
4. MAPI вызывает [функцииimsprovider:: logon](imsprovider-logon.md), передавая идентификатор записи хранилища сообщений клиентского приложения.
    
5. **Функцииimsprovider:: logon** создает и возвращает интерфейс [имслогон: IUnknown](imslogoniunknown.md) и интерфейс [IMsgStore: IMAPIProp](imsgstoreimapiprop.md) , а затем вызывает метод [IUnknown:: AddRef](https://msdn.microsoft.com/library/b4316efd-73d4-4995-b898-8025a316ba63%28Office.15%29.aspx) для интерфейса [имаписуппорт: IUnknown](imapisupportiunknown.md) . Если идентификатор записи в банке сообщений клиента ссылается на уже открытое хранилище сообщений, поставщик хранилища сообщений может возвращать существующие интерфейсы **имслогон** и **IMsgStore** , а также не должен вызывать **AddRef** в своем объекте поддержки. 
    
6. Если клиент не установил флаг MAPI_NO_MAIL при входе в систему и не задал MDB_NO_MAIL на шаге 1, MAPI передает идентификатор записи в буфер обмена MAPI, чтобы диспетчер очереди MAPI мог выполнить вход в хранилище сообщений.
    
7. MAPI возвращает клиенту интерфейс **IMsgStore** . 
    
8. Диспетчер очереди MAPI вызывает [функцииimsprovider:: спулерлогон](imsprovider-spoolerlogon.md).
    
9. **Функцииimsprovider:: спулерлогон** возвращает те же интерфейсы **имслогон** и **IMsgStore** , что и на шаге 5. 
    
> [!NOTE]
> Если при входе в систему поставщика хранилища сообщений возникает ошибка, так как был введен неправильный пароль, а поставщик хранилища сообщений не может отобразить интерфейс для запроса правильного пароля, он должен возвратить MAPI_E_FAILONEPROVIDER из метода **функцииimsprovider:: logon** . Это позволит клиентам запрашивать пароль для повторного входа в систему поставщика хранилища сообщений вместо того, чтобы запретить поставщику использовать MAPI для всего сеанса. 
  
## <a name="see-also"></a>См. также



[Разработка поставщика хранилища сообщений MAPI](developing-a-mapi-message-store-provider.md)


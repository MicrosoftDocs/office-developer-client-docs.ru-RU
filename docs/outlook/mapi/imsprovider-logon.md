---
title: Имспровидерлогон
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: reference
ms.prod: office-online-server
localization_priority: Normal
api_name:
- IMSProvider.Logon
api_type:
- COM
ms.assetid: 890d9cbe-3570-4cf0-aeae-667c0e5ba181
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: 9c7f62c69c7a06f7ca0e4bfddcf789cddc536ea6
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32309669"
---
# <a name="imsproviderlogon"></a>IMSProvider::Logon

  
  
**Область применения**: Outlook 2013 | Outlook 2016 
  
Регистрирует MAPI на одном экземпляре поставщика хранилища сообщений.
  
```cpp
HRESULT Logon(
  LPMAPISUP lpMAPISup,
  ULONG_PTR ulUIParam,
  LPSTR lpszProfileName,
  ULONG cbEntryID,
  LPENTRYID lpEntryID,
  ULONG ulFlags,
  LPCIID lpInterface,
  ULONG FAR * lpcbSpoolSecurity,
  LPBYTE FAR * lppbSpoolSecurity,
  LPMAPIERROR FAR * lppMAPIError,
  LPMSLOGON FAR * lppMSLogon,
  LPMDB FAR * lppMDB
);
```

## <a name="parameters"></a>Параметры

 _Лпмаписуп_
  
> возврата Указатель на текущий объект поддержки MAPI для хранилища сообщений.
    
 _Улуипарам_
  
> возврата Дескриптор родительского окна любых диалоговых окон или окон, которые отображает этот метод. 
    
 _Лпсзпрофиленаме_
  
> возврата Указатель на строку, содержащую имя профиля, используемого для входа в систему поставщика хранилища. Эта строка может отображаться в диалоговых окнах, записанных в файл журнала или просто игнорироваться. Он должен быть в формате Юникод, если в параметре _ulFlags_ ЗАДАН флаг мапи_уникоде. 
    
 _Кбентрид_
  
> возврата Размер (в байтах) идентификатора записи, на который указывает параметр _лпентрид_ . 
    
 _Лпентрид_
  
> возврата Указатель на идентификатор записи для хранилища сообщений. При передаче **значения NULL** в _лпентрид_ показывается, что хранилище сообщений еще не выбрано и диалоговые окна, позволяющие пользователю выбрать хранилище сообщений, могут быть представлены. 
    
 _ulFlags_
  
> возврата Битовая маска флагов, определяющая способ выполнения входа. Можно задать следующие флаги:
    
МАПИ_ДЕФЕРРЕД_ЕРРОРС 
  
> Вызов может быть выполнен, даже если базовый объект недоступен для вызывающей реализации. Если объект недоступен, последующий вызов объекта может вызвать ошибку.
    
MAPI_UNICODE 
  
> Переданные строки имеют формат Юникод. Если МАПИ_УНИКОДЕ не задано, строки представлены в формате ANSI.
    
МДБ_НО_ДИАЛОГ 
  
> Запрещает отображение диалоговых окон входа в систему. Если этот флаг установлен, значение ошибки МАПИ_Е_ЛОГОН_ФАИЛЕД возвращается в случае неудачного входа. Если этот флаг не задан, поставщик хранилища сообщений может предложить пользователю исправить имя или пароль, вставить диск или выполнить другие действия, необходимые для подключения к хранилищу.
    
МДБ_НО_МАИЛ 
  
> Хранилище сообщений не следует использовать для отправки и получения почты. Флаг сигнализирует MAPI, что он не уведомляет Диспетчер очереди MAPI о том, что это хранилище сообщений открыто. Если этот флаг установлен и банк сообщений тесно связан с поставщиком транспорта, поставщику не требуется вызывать метод [имаписуппорт:: спулернотифи](imapisupport-spoolernotify.md) . 
    
МДБ_ТЕМПОРАРИ 
  
> ЗаНосит в журнал данные, чтобы данные можно было получать программно из раздела profile без использования диалоговых окон. Этот флаг указывает MAPI, что хранилище не добавляется в таблицу хранилища сообщений, и что хранилище невозможно сделать необратимым. Если этот флаг установлен, поставщикам хранилища сообщений не требуется вызывать метод [имаписуппорт:: модифипрофиле](imapisupport-modifyprofile.md) . 
    
МДБ_ВРИТЕ 
  
> ЗаПрашивает разрешение на чтение и запись.
    
 _Лпинтерфаце_
  
> возврата Указатель на идентификатор интерфейса (IID) для подключения к хранилищу сообщений. Передача **значения NULL** указывает, что возвращается интерфейс MAPI для хранилища сообщений ( [IMsgStore](imsgstoreimapiprop.md)). Для параметра _лпинтерфаце_ также можно задать идентификатор соответствующего интерфейса для хранилища сообщений (например, Иид_иункновн или иид_имапипроп). 
    
 _Лпкбспулсекурити_
  
> вышли Указатель на переменную, в которой поставщик хранилища возвращает размер данных проверки (в байтах) в параметре _лппбспулсекурити_ . 
    
 _Лппбспулсекурити_
  
> вышли Указатель на указатель на возвращенные данные проверки. Эти данные проверки предоставляются, поэтому метод [функцииimsprovider:: спулерлогон](imsprovider-spoolerlogon.md) может записать Диспетчер очереди MAPI в то же хранилище, что и поставщик хранилища сообщений. 
    
 _Лппмапиеррор_
  
> вышли Указатель на указатель на возвращенную структуру [мапиеррор](mapierror.md) (при наличии), содержащую сведения о версии, компоненте и контексте ошибки. Параметр _лппмапиеррор_ может иметь значение **null** , если структура **мапиеррор** для возврата отсутствует. 
    
 _Лппмслогон_
  
> вышли Указатель на указатель на объект входа хранилища сообщений для входа MAPI.
    
 _Лппмдб_
  
> вышли Указатель на указатель на объект хранилища сообщений для системы буферизации MAPI и клиентских приложений для входа в.
    
## <a name="return-value"></a>Возвращаемое значение

S_OK 
  
> ����� ������� � ������ ��������� ��������� ��� ��������.
    
МАПИ_Е_ФАИЛОНЕПРОВИДЕР 
  
> Этот поставщик не может выполнить вход, но эта ошибка не должна отключать службу. 
    
МАПИ_Е_ЛОГОН_ФАИЛЕД 
  
> Не удалось установить сеанс входа В систему.
    
МАПИ_Е_УНКОНФИГУРЕД 
  
> Профиль не содержит достаточно сведений для завершения входа. Когда возвращается это значение, MAPI вызывает функцию точки входа службы сообщений для поставщика хранилища сообщений.
    
МАПИ_Е_УСЕР_КАНЦЕЛ 
  
> Пользователь отменил операцию, как правило, нажав кнопку **Отмена** в диалоговом окне. 
    
МАПИ_Е_УНКНОВН_КПИД 
  
> Сервер не настроен для поддержки кодовой страницы клиента.
    
МАПИ_Е_УНКНОВН_ЛЦИД 
  
> Сервер не настроен для поддержки информации о языковых стандартах клиента.
    
МАПИ_В_ЕРРОРС_РЕТУРНЕД 
  
> Вызов выполнен успешно, но у поставщика хранилища сообщений есть доступные сведения об ошибке. При возвращении этого предупреждения вызов должен обрабатываться как успешный. Чтобы проверить это предупреждение, используйте макрос **хр_фаилед** . Дополнительные сведения см. [в разделе Использование макросов для обработки ошибок](using-macros-for-error-handling.md). Чтобы получить сведения об ошибке от поставщика, вызовите метод [IMAPISession:: GetLastError](imapisession-getlasterror.md) . 
    
## <a name="remarks"></a>Замечания

MAPI вызывает метод **функцииimsprovider:: logon** для выполнения большинства действий, необходимых для получения доступа к хранилищу сообщений. Поставщики хранилищ сообщений проверяйте все учетные данные пользователя, необходимые для доступа к определенному хранилищу, и возвращают объект хранилища сообщений в параметре _лппмдб_ , на который могут входить клиент и клиентские приложения. 
  
В дополнение к возвращенному объекту хранилища сообщений для использования диспетчером очереди для клиента и MAPI поставщик также возвращает объект входа в хранилище сообщений для MAPI, используемый для управления открытым хранилищем. Объект входа в хранилище сообщений и объект хранилища сообщений должны быть тесно связаны внутри поставщика хранилища сообщений, поэтому каждое из них может повлиять на другой. Использование объекта Store и объекта logon должно быть одинаковым; между объектом logon и объектом Store должно быть отношение "один к одному", чтобы объекты действовали так, как если бы они были одним объектом, который предоставляет два интерфейса. Оба объекта также должны быть созданы вместе и освобождены вместе. 
  
Объект поддержки MAPI, созданный MAPI и передаваемый поставщику в параметре _лпмаписуп_ , обеспечивает доступ к функциям MAPI, которые необходимы поставщику. Сюда входят функции, которые сохраняют и извлекают сведения о профиле, обращаются к адресным книгам и т. д. Указатель _лпмаписуп_ может различаться для каждого открываемого хранилища. При обработке вызовов для хранилища сообщений после входа поставщик магазина должен использовать переменную _лпмаписуп_ , относящуюся к этому хранилищу. Для любого **** вызова, которое открывает хранилище сообщений и успешно создает объект входа в хранилище сообщений, поставщик должен сохранить указатель на объект поддержки MAPI в объекте Store logon и вызвать метод [IUnknown:: AddRef](https://msdn.microsoft.com/library/ms691379%28v=VS.85%29.aspx) , чтобы добавить ссылку для Объект support. 
  
Параметр _улуипарам_ следует использовать, если поставщик представляет диалоговые окна во время вызова **входа** . Тем не менее диалоговые окна не отображаются, если _ulFlags_ содержит флаг мдб_но_диалог. Если пользовательский интерфейс необходимо вызвать, но _ulFlags_ не разрешает его, или если по какой – либо другой причине невозможно отобразить пользовательский интерфейс, поставщик должен возвратить мапи_е_логон_фаилед. Если при **входе** отображается диалоговое окно, а пользователь отменяет вход в систему, то, как правило, нажимает кнопку **Cancel** диалогового окна, поставщик должен возвратить мапи_е_усер_канцел. 
  
Параметр _лпентрид_ может иметь **значение NULL** или указывать на неупакованный идентификатор записи в хранилище сообщений, созданном ранее. Если _лпентрид_ указывает на неупакованный идентификатор записи, этот идентификатор может быть получен из одного из следующих мест: 
  
- Это может быть идентификатор записи, который ранее обернут и написал поставщик хранилища в раздел профиля как свойство **пр_ентрид** ([PidTagEntryId](pidtagentryid-canonical-property.md)).
    
- Это может быть идентификатор записи, который был ранее упакован и возвращен в вызывающий клиент как свойство **пр_сторе_ентрид** ([PidTagStoreEntryId](pidtagstoreentryid-canonical-property.md)). 
    
- Это может быть идентификатор записи, который поставщик ранее запр_ентрид и вернулся в вызывающий клиент в качестве свойства **** объекта хранилища сообщений. 
    
В любом из этих случаев возможно, что идентификатор записи был создан на компьютере, отличном от используемого в данный момент.
  
Если _лпентрид_ имеет значение, отличное от **null**, оно должно содержать все сведения, необходимые для идентификации и поиска хранилища сообщений. Эти сведения могут включать имена сетевых томов, Номера телефонов, имена учетных записей пользователей и т. д. Если подключение к хранилищу невозможно выполнить с помощью данных в идентификаторе записи, поставщик магазина должен отобразить диалоговое окно, которое позволяет пользователю выбрать открываемое хранилище. Может потребоваться диалоговое окно, например, если сервер был переименован, имя учетной записи изменилось или часть сети недоступна.
  
Если _лпентрид_ имеет **значение NULL**, то хранилище сообщений пока не выбрано. Поставщик по-прежнему может получить доступ к хранилищу без отображения диалогового окна, если он поддерживает дальнейшие действия для указания хранилища. Например, поставщик может проверить файл инициализации или выполнить поиск дополнительных свойств, которые были размещены в разделе профиля службы сообщений в конфигурации.
  
Если поставщик обнаружит, что все необходимые сведения отсутствуют в профиле, он должен возвратить МАПИ_Е_УНКОНФИГУРЕД. Затем MAPI выполнит функцию точки входа службы сообщений поставщика, чтобы позволить пользователю выбрать хранилище или даже создать его и ввести имя и пароль учетной записи по мере необходимости. MAPI автоматически создает новый раздел профиля для нового хранилища; Этот новый раздел профиля может быть временным или постоянным в зависимости от того, как он был добавлен. Если поставщик услуг хранения вызывает метод **имаписуппорт:: модифипрофиле** , новый раздел профиля становится постоянным и хранилище добавляется в список хранилищ сообщений, возвращаемых методом [IMAPISession:: жетмсгсторестабле](imapisession-getmsgstorestable.md) . 
  
Параметр _лпинтерфаце_ указывает IID интерфейса, необходимого для вновь открытого объекта Store. При передаче **значения NULL** в _лпинтерфаце_ указывается, что необходим интерфейс хранилища сообщений MAPI, **IMsgStore**. При передаче объекта хранилища сообщений Иид_имсгсторе также указывается, что **IMsgStore** является обязательным. Если Иид_иункновн передается в _лпинтерфаце_, то поставщик должен открыть хранилище с помощью любого интерфейса, производного от [IUnknown](https://msdn.microsoft.com/library/ms680509%28v=VS.85%29.aspx) , для поставщика (опять-то, обычно это **IMsgStore**). Когда Иид_иункновн передается, в вызове вызывается метод [IUnknown:: QueryInterface](https://msdn.microsoft.com/library/ms682521%28v=VS.85%29.aspx) для выбора интерфейса после успешного выполнения операции Store Open. 
  
Вызов **функцииimsprovider:: logon** должен возвращать достаточно информации, например путь к хранилищу и учетные данные для доступа к хранилищу, чтобы диспетчер очереди MAPI мог выполнить вход в то же хранилище, что и поставщик хранилища, не выполняя показ диалогового окна. Для возврата этих сведений используются параметры _лпкбспулсекурити_ и _лппбспулсекурити_ . Поставщик выделяет память для этих данных, передавая указатель на буфер в параметре _лпфаллокатебуффер_ функции [мспровидеринит](msproviderinit.md) . Поставщик поместит размер этого буфера в _лпкбспулсекурити_. 
  
При необходимости этот буфер освобождается MAPI. Если вход в магазин с помощью диспетчера MAPI может осуществляться только из сведений в разделе профиля, поставщик может вернуть значение NULL в _лппбспулсекурити_ и 0 для размера данных в _лпкбспулсекурити_. Вход в систему почтовых подстановки MAPI выполняется как часть процесса, отличного от процесса входа в хранилище; так как буфер, содержащий переданные сведения, копируется между процессами, он может не находиться в памяти в том же расположении, что и процесс поставщика хранилища MAPI. Таким образом, поставщик не должен помещать адреса в этот буфер. Дополнительные сведения о входе в систему почтовых [функцииimsprovider:: спулерлогон](imsprovider-spoolerlogon.md) . 
  
Большинство поставщиков магазинов используют метод [IMAPISession:: опенпрофилесектион](imapisession-openprofilesection.md) объекта support, переданный в параметре _лпмаписуп_ для сохранения и получения учетных данных и параметров пользователя. **Опенпрофилесектион** позволяет поставщику услуг хранения сохранять дополнительные сведения в разделе профиля и связывать его с определенным ресурсом. Например, поставщик хранилища может сохранить имя и пароль учетной записи пользователя, связанные с ресурсом, а также любые пути и другие сведения, необходимые для доступа к этому ресурсу. 
  
Свойства с идентификаторами свойств, 0x6600 через 0x67FF, — это безопасные свойства, доступные поставщику для собственного использования для хранения конфиденциальных данных в разделах Profile. Дополнительные сведения об использовании свойств в объектах разделов профилей см в методе [ипрофсект: IMAPIProp](iprofsectimapiprop.md) . 
  
В дополнение к личным данным в свойствах с идентификаторами 0x6600 через 0x67FF, поставщик магазина должен предоставить сведения для свойства **пр_дисплай_наме** ([PidTagDisplayName](pidtagdisplayname-canonical-property.md)) в разделе profile. Он должен размещаться в **пр_дисплай_наме** как отображаемое имя самого поставщика — идентифицирующая строка (например, "Банк личных данных Майкрософт"), которая отображается для пользователей, чтобы пользователи могли отличать это хранилище сообщений от других пользователей, у которых они могут иметь доступ. Кому. **Пр_дисплай_наме** обычно содержит имя сервера, имя учетной записи пользователя или путь. 
  
Некоторые свойства раздела профиля отображаются в таблице хранилища сообщений; другие пользователи отображаются во время установки, установки и настройки подсистемы MAPI. Поставщик обычно предоставляет сведения об этих видимых свойствах для нового раздела профиля, который пока не включает сохраненные учетные данные или конфиденциальные сведения, и когда обнаруживает, что сведения о свойстве изменились. Дополнительные сведения о разделах профилей можно найти в статье [имаписуппорт:: опенпрофилесектион](imapisupport-openprofilesection.md).
  
После успешного входа в систему пользователя и возврата в MAPI поставщик хранилища должен создать массив свойств для строки состояния ресурса и вызвать метод [имаписуппорт:: модифистатусров](imapisupport-modifystatusrow.md) . 
  
 Вызовы для **входа** , которые открывают хранилища сообщений, которые уже открыты для текущего сеанса MAPI, пропускают описанную выше обработку. Эти вызовы не создают строки состояния, возвращают объекты входа в хранилище сообщений, **AddRef** вызовов для объекта поддержки MAPI или возвращают данные для входа в систему буферизации MAPI. Эти вызовы возвращают значение S_OK и возвращают объект хранилища сообщений с запрошенным интерфейсом. 
  
Для обнаружения таких вызовов поставщик должен поддерживать список в объекте поставщика хранилища сообщений, который уже открыт для этого объекта поставщика. При обработке вызова для **входа** поставщик должен проверить этот список открытых магазинов и определить, открыто ли это хранилище. Если это так, учетные данные пользователя не нуждаются в проверке, и если это возможно, следует избегать отображения диалогового окна. Если должны отображаться диалоговые окна, поставщик должен проверить возвращенные сведения, чтобы узнать, было ли хранилище открыто еще раз. Кроме того, поставщик должен проверить наличие дубликатов, используя _лпентрид_ в начале обработки вызовов **входа** . 
  
Стандартная обработка вызова для **входа в систему** , обращающегося к открытому хранилищу, выглядит следующим образом: 
  
1. Поставщик услуг хранения вызывает **AddRef** для существующего объекта Store, если новый интерфейс совпадает с интерфейсом существующего хранилища. В противном случае вызывается метод **QueryInterface** для получения нового интерфейса. Если хранилище не поддерживает новый интерфейс, поставщик должен возвратить значение ошибки МАПИ_Е_ИНТЕРФАЦЕ_НОТ_СУППОРТЕД. 
    
2. Поставщик возвращает указатель на необходимый интерфейс существующего объекта Store в _лппмдб_.
    
3. Поставщик возвращает **значение NULL** в _лппмслогон_.
    
4. Поставщик не должен открывать профиль для объекта поддержки, переданного в вызове. Кроме того, он не должен регистрировать уникальный идентификатор поставщика, регистрировать строку состояния или возвращать данные для входа в систему диспетчера MAPI.
    
5. Поставщик не должен вызывать **AddRef** для объекта support, так как ему не требуется указатель на объект. 
    
По возможности поставщики должны возвращать соответствующие строки ошибок и предупреждений для вызовов **входа в систему** , так как это значительно упрощает нагрузку пользователей, чтобы определить, почему что-то не работает. Для возврата этих строк поставщик устанавливает элементы структуры **мапиеррор** . MAPI ищет, использует и освобождает структуру **мапиеррор** , если она возвращается поставщиком. 
  
Память для этой структуры **мапиеррор** должна быть выделена с помощью буфера, переданного в _лпфаллокатебуффер_ в вызове **мспровидеринит** . Все строки ошибок, входящие в возвращаемую структуру, должны быть в формате Юникод, если МАПИ_УНИКОДЕ задано в ulFlags **входа** _;_ в противном случае они должны находиться в наборе символов ANSI. 
  
Для большинства значений ошибок, возвращаемых при **входе в систему**, MAPI отключает службы сообщений, к которым относится неисправность поставщика. MAPI не будет вызывать поставщиков, принадлежащих этим службам, в течение времени жизни сеанса MAPI. В отличие от того, что при **входе** возвращает значение ошибки мапи_е_фаилонепровидер из входа в систему, MAPI не отключает службу сообщений, к которой относится поставщик. **Вход** должен возвращать мапи_е_фаилонепровидер, если обнаружена ошибка, которая не гарантирует отключение всей службы в течение сеанса. Например, поставщик может возвращать эту ошибку, если она не разрешает отображение пользовательского интерфейса и требуемый пароль недоступен. 
  
Если поставщик возвращает МАПИ_Е_УНКОНФИГУРЕД из входа в систему, MAPI вызывает функцию ввода службы сообщений поставщика и повторно пытается войти в систему. MAPI передает МСГ_СЕРВИЦЕ_КОНФИГУРЕ в качестве контекста, чтобы предоставить службе возможность настройки. Если клиент решил разрешить пользовательскому интерфейсу для входа в систему, эта служба может представить свой лист свойств конфигурации, чтобы пользователь мог вводить сведения о конфигурации.
  
## <a name="see-also"></a>См. также



[IMAPISession::GetMsgStoresTable](imapisession-getmsgstorestable.md)
  
[IMAPISession::OpenMsgStore](imapisession-openmsgstore.md)
  
[IMAPISession::OpenProfileSection](imapisession-openprofilesection.md)
  
[IMAPISupport::ModifyProfile](imapisupport-modifyprofile.md)
  
[IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md)
  
[IMsgStore: IMAPIProp](imsgstoreimapiprop.md)
  
[IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md)
  
[IProfSect : IMAPIProp](iprofsectimapiprop.md)
  
[MAPIERROR](mapierror.md)
  
[MSProviderInit](msproviderinit.md)
  
[IMSProvider : IUnknown](imsprovideriunknown.md)


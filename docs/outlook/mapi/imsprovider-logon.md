---
title: IMSProviderLogon
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: reference
ms.prod: office-online-server
localization_priority: Normal
api_name:
- IMSProvider.Logon
api_type:
- COM
ms.assetid: 890d9cbe-3570-4cf0-aeae-667c0e5ba181
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: 9c7f62c69c7a06f7ca0e4bfddcf789cddc536ea6
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32309669"
---
# <a name="imsproviderlogon"></a>IMSProvider::Logon

  
  
**Относится к**: Outlook 2013 | Outlook 2016 
  
Занося mapI в один экземпляр поставщика хранения сообщений.
  
```cpp
HRESULT Logon(
  LPMAPISUP lpMAPISup,
  ULONG_PTR ulUIParam,
  LPSTR lpszProfileName,
  ULONG cbEntryID,
  LPENTRYID lpEntryID,
  ULONG ulFlags,
  LPCIID lpInterface,
  ULONG FAR * lpcbSpoolSecurity,
  LPBYTE FAR * lppbSpoolSecurity,
  LPMAPIERROR FAR * lppMAPIError,
  LPMSLOGON FAR * lppMSLogon,
  LPMDB FAR * lppMDB
);
```

## <a name="parameters"></a>Параметры

 _lpMAPISup_
  
> [in] Указатель на текущий объект поддержки MAPI для хранения сообщений.
    
 _ulUIParam_
  
> [in] Handle to the parent window of any dialog boxes or windows this method displays. 
    
 _lpszProfileName_
  
> [in] Указатель на строку, содержаную имя профиля, используемого для имени поставщика магазина. Эта строка может отображаться в диалоговом окне, записана в файл журнала или просто игнорируется. Он должен быть в формате Юникод, MAPI_UNICODE флага в параметре _ulFlags._ 
    
 _cbEntryID_
  
> [in] Размер идентификатора записи в вайтах, на который указывает параметр _lpEntryID._ 
    
 _lpEntryID_
  
> [in] Указатель на идентификатор записи для хранения сообщений. Передача **null** в  _lpEntryID_ означает, что хранилище сообщений еще не выбрано и могут быть представлены диалоговое окно, в которое пользователь может выбрать хранилище сообщений. 
    
 _ulFlags_
  
> [in] Битоваяmas флагов, которая управляет выполнением при выполнении для этого. Можно установить следующие флаги:
    
MAPI_DEFERRED_ERRORS 
  
> Вызов может быть успешным, даже если его объект недопустим для реализации вызова. Если объект не доступен, последующий вызов объекта может вызвать ошибку.
    
MAPI_UNICODE 
  
> Переданные строки имеют формат Юникод. Если MAPI_UNICODE не установлен, строки будут в формате ANSI.
    
MDB_NO_DIALOG 
  
> Предотвращает отображение диалогов для логотипа. Если этот флаг установлен, значение ошибки MAPI_E_LOGON_FAILED возвращается в случае ошибки при запуске. Если этот флаг не установлен, поставщик store сообщений может отправить пользователю запрос на исправление имени или пароля, вставить диск или выполнить другие действия, необходимые для установления подключения к магазину.
    
MDB_NO_MAIL 
  
> Хранилище сообщений не должно использоваться для отправки или получения почты. Флаг сигнализирует MAPI не уведомлять пул MAPI о том, что это хранилище сообщений открыто. Если этот флаг установлен и хранилище сообщений тесно совмещение с поставщиком транспорта, поставщику не нужно вызывать метод [IMAPISupport::SpoolerNotify.](imapisupport-spoolernotify.md) 
    
MDB_TEMPORARY 
  
> Войдите в хранилище, чтобы получить сведения из раздела профиля программным путем без использования диалогов. Этот флаг сообщает MAPI, что хранилище не следует добавлять в таблицу хранения сообщений и что хранилище не может быть постоянным. Если этот флаг установлен, поставщикам хранения сообщений не нужно вызывать метод [IMAPISupport::ModifyProfile.](imapisupport-modifyprofile.md) 
    
MDB_WRITE 
  
> Запрашивает разрешение на чтение и записи.
    
 _lpInterface_
  
> [in] Указатель на идентификатор интерфейса для входа в хранилище сообщений. Передача **null** означает, что возвращается интерфейс MAPI для хранения сообщений [(IMsgStore).](imsgstoreimapiprop.md) Параметру  _lpInterface_ также можно присвоить идентификатор для соответствующего интерфейса для хранения сообщений (например, IID_IUnknown или IID_IMAPIProp). 
    
 _lpcbSpoolSecurity_
  
> [out] Указатель на переменную, в которой поставщик параметров хранения возвращает размер (в bytes) данных проверки в параметре _lppbSpoolSecurity._ 
    
 _lppbSpoolSecurity_
  
> [out] Указатель на указатель на возвращенные данные проверки. Эти данные проверки предоставляются, чтобы метод [IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md) может вести журнал пула MAPI в том же хранилище, что и поставщик хранения сообщений. 
    
 _lppMAPIError_
  
> [out] Указатель на указатель на возвращенную структуру [MAPIERROR](mapierror.md) (если таковые есть), которая содержит сведения о версии, компоненте и контексте для ошибки. Если возвращаемая структура MAPIERROR не имеет структуры **MAPIERROR,** для параметра _lppMAPIError_ можно установить **null.** 
    
 _lppMSLogon_
  
> [out] Указатель на указатель на объект входа в хранилище сообщений для входа в MAPI.
    
 _lppMDB_
  
> [out] Указатель на указатель на объект хранения сообщений для входа в пул MAPI и клиентских приложений.
    
## <a name="return-value"></a>Возвращаемое значение

S_OK 
  
> ����� ������� � ������ ��������� ��������� ��� ��������.
    
MAPI_E_FAILONEPROVIDER 
  
> Этот поставщик не может войти в систему, но эта ошибка не должна отключать службу. 
    
MAPI_E_LOGON_FAILED 
  
> Не удалось установить сеанс для сеанса.
    
MAPI_E_UNCONFIGURED 
  
> Профиль не содержит достаточно сведений для завершения работы с данными. При возврате этого значения MAPI вызывает функцию точки входа службы сообщений поставщика службы сообщений.
    
MAPI_E_USER_CANCEL 
  
> Пользователь отменил операцию, обычно нажав  кнопку "Отмена" в диалоговом окне. 
    
MAPI_E_UNKNOWN_CPID 
  
> Сервер не настроен для поддержки кодовой страницы клиента.
    
MAPI_E_UNKNOWN_LCID 
  
> Сервер не настроен для поддержки сведений о региональных настройках клиента.
    
MAPI_W_ERRORS_RETURNED 
  
> Вызов был успешным, но у поставщика хранения сообщений есть сведения об ошибке. При возвращении этого предупреждения вызов должен быть обработан как успешный. Чтобы проверить это предупреждение, используйте **макрос HR_FAILED.** Дополнительные сведения см. в [теме "Использование макроса для обработки ошибок".](using-macros-for-error-handling.md) Чтобы получить сведения об ошибке от поставщика, вызовите метод [IMAPISession::GetLastError.](imapisession-getlasterror.md) 
    
## <a name="remarks"></a>Примечания

MAPI вызывает метод **IMSProvider::Logon** для большинства обработки, необходимой для получения доступа к окну сообщений. Поставщики параметров хранения сообщений проверяют все учетные данные пользователя, необходимые для доступа к определенному хранилище, и возвращают объект банка сообщений в параметре  _lppMDB,_ в который могут войти пулер MAPI и клиентские приложения. 
  
Помимо возвращенного объекта хранения сообщений для использования клиентом и пулом MAPI поставщик также возвращает объект для открытия в хранилище сообщений, который mapI будет использовать для управления открытым хранилищем. Объекты для эмблемы для хранения сообщений и хранилище сообщений должны быть тесно связаны внутри поставщика хранения сообщений, чтобы каждый из них влияет на друг друга. Использование объекта store и объекта для логотипа должно быть идентичным; между объектом для логотипа и объектом хранения должно быть соответствие "один к одному", чтобы объекты действовали так, будто они являются одним объектом, который предоставляет два интерфейса. Эти два объекта также должны быть созданы вместе и освобождены вместе. 
  
Объект поддержки MAPI, созданный с помощью MAPI и переданный поставщику в параметре  _lpMAPISup,_ предоставляет доступ к функциям в MAPI, которые необходимы поставщику. К ним относятся функции, которые сохранения и получения сведений профиля, доступа к адресным книгам и так далее. Указатель  _lpMAPISup_ может быть разным для каждого открываемого магазина. Во время обработки вызовов для хранения сообщений после их обработки поставщик магазина должен использовать переменную  _lpMAPISup,_ которая характерна для этого магазина. Для любого вызова **для** локалки, который открывает хранилище сообщений и успешно создает объект для логотипа в хранилище сообщений, поставщик должен сохранить указатель на объект поддержки MAPI в объекте для логотипа магазина и вызвать метод [IUnknown::AddRef,](https://msdn.microsoft.com/library/ms691379%28v=VS.85%29.aspx) чтобы добавить ссылку на объект поддержки. 
  
Параметр _ulUIParam следует использовать,_ если поставщик представляет диалоговые окна во время вызова **для logon.** Однако диалоговое окно не должно быть представлено, если  _ulFlags_ содержит MDB_NO_DIALOG флага. Если пользовательский интерфейс должен быть вызван, но  _ulFlags_ не разрешает его, или если по какой-либо другой причине пользовательский интерфейс не может отображаться, поставщик должен вернуть MAPI_E_LOGON_FAILED. Если **в окне** "Войдите" отображается диалоговое окно, и пользователь отменяет его, обычно при нажатии кнопки "Отмена" в диалоговом окне поставщик должен вернуть MAPI_E_USER_CANCEL.  
  
Параметр  _lpEntryID_ может иметь либо **null,** либо указать на нерасхваченный идентификатор записи магазина, ранее созданный хранилищем сообщений. Если  _lpEntryID_ указывает на неподдержанный идентификатор записи, этот идентификатор записи может быть взят из одного из нескольких мест: 
  
- Это может быть идентификатор записи, ранее упакованный и записавший в раздел профиля как **свойство PR_ENTRYID** ([PidTagEntryId).](pidtagentryid-canonical-property.md)
    
- Это может быть идентификатор записи, который поставщик ранее упаковил и вернул вызываемому клиенту в качестве **свойства PR_STORE_ENTRYID** ([PidTagStoreEntryId).](pidtagstoreentryid-canonical-property.md) 
    
- Это может быть идентификатор записи, который поставщик ранее упаковил и  вернул вызываемому клиенту в PR_ENTRYID объекта хранения сообщений. 
    
В любом из этих случаев возможно, что идентификатор записи был создан на компьютере, который отличается от используемого в данный момент.
  
Если  _lpEntryID_ не имеет **null,** он должен содержать все сведения, необходимые для идентификации и поиска хранилище сообщений. Эти сведения могут включать сетевые тома, номера телефонов, имена учетных записей пользователей и так далее. Если подключение к окну не может быть выполнено с помощью данных в идентификаторе записи, поставщик должен отобразить диалоговое окно, в котором пользователь может выбрать хранилище для открытия. Диалоговое окно может потребоваться, например, если сервер был переименован, имя учетной записи изменилось или части сети недоступны.
  
Если  _lpEntryID_ имеет **null,** используемая хранилище сообщений еще не выбрана. Поставщик по-прежнему может получить доступ к окну, не отображая диалоговое окно, если оно поддерживает дополнительные методы для указания магазина. Например, поставщик может проверить файл инициализации или найти дополнительные свойства, размещенные в разделе профиля службы сообщений в конфигурации.
  
Если поставщик обнаружит, что все необходимые сведения не находятся в профиле, он должен вернуть MAPI_E_UNCONFIGURED. ПОСЛЕ этого MAPI будет вызывать функцию точки входа службы сообщений поставщика, чтобы позволить пользователю выбрать хранилище или даже создать его, а также ввести имя учетной записи и пароль при необходимости. MAPI автоматически создает новый раздел профиля для нового магазина; Этот новый раздел профиля может быть временным или постоянным в зависимости от того, как он был добавлен. Если поставщик хранилища вызывает метод **IMAPISupport::ModifyProfile,** новый раздел профиля становится постоянным и хранилище добавляется в список хранилищ сообщений, возвращаемых методом [IMAPISession::GetMsgStoresTable.](imapisession-getmsgstorestable.md) 
  
Параметр  _lpInterface_ указывает IID интерфейса, необходимого для только что открытого объекта store. Передача **null** в  _lpInterface_ указывает, что интерфейс хранения сообщений MAPI, **IMsgStore,** является обязательной. Передача объекта хранилищ сообщений IID_IMsgStore также указывает, что **требуется IMsgStore.** Если IID_IUnknown передается в _lpInterface,_ поставщик должен открыть магазин с помощью интерфейса, производного от [IUnknown,](https://msdn.microsoft.com/library/ms680509%28v=VS.85%29.aspx) лучше всего для поставщика (опять же, это обычно **IMsgStore).** При IID_IUnknown реализации вызова используется метод [IUnknown::QueryInterface](https://msdn.microsoft.com/library/ms682521%28v=VS.85%29.aspx) для выбора интерфейса после успешного открытия магазина. 
  
Вызов **IMSProvider::Logon** должен возвращать достаточную информацию, например путь к окну хранения и учетные данные для доступа к магазину, чтобы пулер MAPI мог войти в то же хранилище, что и поставщик магазина, не выведя диалоговое окно. Для возврата этих сведений используются параметры _lpcbSpoolSecurity_ и _lppbSpoolSecurity._ Поставщик выделяет память для этих данных, передавая указатель в буфер в параметре _lpfAllocateBuffer_ функции [MSProviderInit;](msproviderinit.md) поставщик помещает размер этого буфера в _lpcbSpoolSecurity._ 
  
MAPI при необходимости освободит этот буфер. Если в хранилище пула MAPI можно выполнить только данные из раздела профиля, поставщик может вернуть null в _lppbSpoolSecurity_ и 0 для размера информации в _lpcbSpoolSecurity._ В процессе, отличаемом от процесса, отличаемого от процесса, в рамках процесса, отличаемого от процесса, в который входит пул MAPI; так как буфер, содержащий переданные сведения, копируется между процессами, он может не храниться в памяти в одном расположении для процесса пула MAPI, как для процесса поставщика магазина. Поэтому поставщик не должен помещал адреса в этот буфер. Дополнительные сведения о том, как использовать mapI spooler, см. в [методе IMSProvider::SpoolerLogon.](imsprovider-spoolerlogon.md) 
  
Большинство поставщиков параметров хранения используют метод [IMAPISession::OpenProfileSection](imapisession-openprofilesection.md) объекта поддержки, переданного в  _параметре lpMAPISup,_ для сохранения и получения учетных данных и параметров пользователя. **OpenProfileSection** позволяет поставщику магазина сохранять дополнительные произвольные сведения в разделе профиля и связывать их с определенным ресурсом. Например, поставщик магазина может сохранить имя учетной записи пользователя и пароль, связанные с ресурсом, а также любые пути или другие сведения, необходимые для доступа к этому ресурсу. 
  
Свойства с идентификаторами 0x6600 через 0x67FF являются защищенными свойствами, доступными поставщику для собственного использования для хранения частных данных в разделах профилей. Дополнительные сведения о том, как использовать свойства в объектах раздела профиля, см. в статье о методе [IProfSect : IMAPIProp.](iprofsectimapiprop.md) 
  
Помимо любых личных данных в свойствах с идентификаторами, 0x6600 через 0x67FF, поставщик магазина должен предоставить сведения о свойстве **PR_DISPLAY_NAME** ([PidTagDisplayName)](pidtagdisplayname-canonical-property.md)в своем разделе профиля. Она должна  PR_DISPLAY_NAME отображаемого имени поставщика — идентифицирующей строки (например, "Microsoft Personal Information Store"), которая отображается для пользователей, чтобы они могли отличить это хранилище сообщений от других, к ним у них может быть доступ. **PR_DISPLAY_NAME** обычно содержит имя сервера, имя учетной записи пользователя или путь. 
  
Некоторые свойства раздела профиля видны в таблице хранения сообщений; другие будут видны во время установки, установки и настройки подсистемы MAPI. Поставщик обычно предоставляет сведения об этих видимых свойствах как для нового раздела профиля, который еще не содержит сохраненных учетных данных, так и для личных сведений, а также для того, когда обнаруживает, что эти сведения о свойстве изменились. Дополнительные сведения о разделах профиля см. в подразделе [IMAPISupport::OpenProfileSection.](imapisupport-openprofilesection.md)
  
После успешного входа пользователя в систему и перед возвращением в MAPI поставщик магазина должен создать массив свойств для строки состояния ресурса и вызвать метод [IMAPISupport::ModifyStatusRow.](imapisupport-modifystatusrow.md) 
  
 **Вызовы для** открытия хранилищ сообщений, которые уже открыты для текущего сеанса MAPI, пропускают большую часть обработки, описанную выше. Эти вызовы не создают строки состояния, возвращают объекты для хранения сообщений, вызовите **AddRef** для объекта поддержки MAPI и не возвращают данные для для этого объекта. Эти вызовы возвращают S_OK и возвращают объект хранения сообщений с запрашиваемом интерфейсом. 
  
Для обнаружения таких вызовов поставщик должен вести список в объекте поставщика хранилища сообщений, уже открытых для этого объекта поставщика. При **обработке вызова входа** поставщик должен проверить этот список открытых хранилищ и определить, открыт ли магазин, в который необходимо войти. В этом случае учетные данные пользователя не нужно проверять, и по возможности следует избегать отображения диалоговых окна. Если необходимо отобразить диалоговое окно, поставщик должен проверить возвращенные сведения, чтобы узнать, было ли хранилище открыто еще раз. Кроме того, поставщик должен проверить повторяющиеся открытия с помощью _lpEntryID_ в начале обработки вызовов **для logon.** 
  
Стандартная обработка для вызова **для входов,** который открывается в открытом хранилище, является следующим образом: 
  
1. Поставщик магазина вызывает **AddRef** для существующего объекта store, если запрашивается тот же интерфейс, что и для существующего магазина. В противном случае он **вызывает QueryInterface** для получения нового интерфейса. Если магазин не поддерживает новый интерфейс, поставщик должен вернуть значение ошибки MAPI_E_INTERFACE_NOT_SUPPORTED. 
    
2. Поставщик возвращает указатель на необходимый интерфейс существующего объекта store в _lppMDB._
    
3. Поставщик возвращает **null** в _lppMSLogon._
    
4. Поставщик не должен открывать профиль для объекта поддержки, переданного в вызове. Кроме того, он не должен регистрировать уникальный идентификатор поставщика, регистрировать строку состояния или возвращать данные о регистрации пула MAPI.
    
5. Поставщик не должен вызывать **AddRef** для объекта поддержки, так как для него не требуется указатель на объект. 
    
По возможности поставщики должны возвращать соответствующие строки ошибок и предупреждений для вызовов для **logon,** так как это значительно облегчает пользователям определение причин, по которым что-то не работает. Чтобы вернуть эти строки, поставщик задает члены в структуре **MAPIERROR.** MAPI ищет, использует и освобождает структуру **MAPIERROR,** если она возвращается поставщиком. 
  
Память для этой структуры **MAPIERROR** должна быть выделена с помощью буфера, переданного _в lpfAllocateBuffer_ при вызове **MSProviderInit.** Все строки ошибок, содержащиеся в возвращаемой структуре, должны быть в формате Юникод, если MAPI_UNICODE в _ulFlags_ **logon;** в противном случае они должны быть в наборе символов ANSI. 
  
Для большинства значений ошибок, возвращаемой при **logon,** MAPI отключает службы сообщений, к которым принадлежит поставщик, к которому относится сбой. MAPI не будет вызывать поставщиков, которые относятся к этим службам в течение всего жизненного года сеанса MAPI. В отличие от этого, когда **logon** возвращает значение ошибки MAPI_E_FAILONEPROVIDER из своего логотипа, MAPI не отключать службу сообщений, к которой принадлежит поставщик. **При MAPI_E_FAILONEPROVIDER** ошибки, которая не требует отключения всей службы на протяжении всего сеанса, необходимо вернуть MAPI_E_FAILONEPROVIDER. Например, поставщик может вернуть эту ошибку, если не позволяет отобразить пользовательский интерфейс, а требуемый пароль недоступен. 
  
Если поставщик возвращает MAPI_E_UNCONFIGURED из своего входа, MAPI будет вызывать функцию записи службы сообщений поставщика, а затем повторить попытку входа. MAPI передает MSG_SERVICE_CONFIGURE в качестве контекста, чтобы дать службе возможность настроить себя. Если клиент разрешил пользовательский интерфейс для входа, служба может представить свою таблицу свойств конфигурации, чтобы пользователь введет сведения о конфигурации.
  
## <a name="see-also"></a>См. также



[IMAPISession::GetMsgStoresTable](imapisession-getmsgstorestable.md)
  
[IMAPISession::OpenMsgStore](imapisession-openmsgstore.md)
  
[IMAPISession::OpenProfileSection](imapisession-openprofilesection.md)
  
[IMAPISupport::ModifyProfile](imapisupport-modifyprofile.md)
  
[IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md)
  
[IMsgStore: IMAPIProp](imsgstoreimapiprop.md)
  
[IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md)
  
[IProfSect : IMAPIProp](iprofsectimapiprop.md)
  
[MAPIERROR](mapierror.md)
  
[MSProviderInit](msproviderinit.md)
  
[IMSProvider : IUnknown](imsprovideriunknown.md)


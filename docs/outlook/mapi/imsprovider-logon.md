---
title: IMSProviderLogon
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
ms.topic: reference
ms.prod: office-online-server
localization_priority: Normal
api_name:
- IMSProvider.Logon
api_type:
- COM
ms.assetid: 890d9cbe-3570-4cf0-aeae-667c0e5ba181
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: 9c7f62c69c7a06f7ca0e4bfddcf789cddc536ea6
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32309669"
---
# <a name="imsproviderlogon"></a>IMSProvider::Logon

  
  
**Область применения**: Outlook 2013 | Outlook 2016 
  
Журнал MAPI для одного экземпляра поставщика магазина сообщений.
  
```cpp
HRESULT Logon(
  LPMAPISUP lpMAPISup,
  ULONG_PTR ulUIParam,
  LPSTR lpszProfileName,
  ULONG cbEntryID,
  LPENTRYID lpEntryID,
  ULONG ulFlags,
  LPCIID lpInterface,
  ULONG FAR * lpcbSpoolSecurity,
  LPBYTE FAR * lppbSpoolSecurity,
  LPMAPIERROR FAR * lppMAPIError,
  LPMSLOGON FAR * lppMSLogon,
  LPMDB FAR * lppMDB
);
```

## <a name="parameters"></a>Parameters

 _lpMAPISup_
  
> [in] Указатель на текущий объект поддержки MAPI для магазина сообщений.
    
 _ulUIParam_
  
> [in] Ручка родительского окна любых диалогов или окон, отображаемая этим методом. 
    
 _lpszProfileName_
  
> [in] Указатель на строку, содержаную имя профиля, используемого для логотипа поставщика магазина. Эта строка может отображаться в диалоговом окне, записана в файл журнала или просто игнорируется. Он должен быть в формате Unicode, если MAPI_UNICODE в параметре _ulFlags._ 
    
 _cbEntryID_
  
> [in] Размер в bytes идентификатора записи, на который указывает _параметр lpEntryID._ 
    
 _lpEntryID_
  
> [in] Указатель на идентификатор записи для магазина сообщений. Передача **null** в  _lpEntryID_ указывает на то, что хранилище сообщений еще не выбрано и что диалоговое окно, которое позволяет пользователю выбрать хранилище сообщений, может быть представлено. 
    
 _ulFlags_
  
> [in] Битмаска флагов, которые контролируют выполнение логотипа. Можно установить следующие флаги:
    
MAPI_DEFERRED_ERRORS 
  
> Вызов может быть успешным, даже если его объект недопустим для реализации вызова. Если объект не доступен, последующий вызов объекта может привести к ошибке.
    
MAPI_UNICODE 
  
> Переданные строки находятся в формате Unicode. Если MAPI_UNICODE не установлено, строки находятся в формате ANSI.
    
MDB_NO_DIALOG 
  
> Предотвращает отображение диалогов с логотипом. Если этот флаг заданной, значение MAPI_E_LOGON_FAILED возвращается, если логотип неуспешен. Если этот флаг не установлен, поставщик магазина сообщений может побудить пользователя исправить имя или пароль, вставить диск или выполнить другие действия, необходимые для установления подключения к магазину.
    
MDB_NO_MAIL 
  
> Хранилище сообщений не должно использоваться для отправки или получения почты. Флаг сигнализирует MAPI не уведомлять шпалер MAPI о том, что этот хранилище сообщений открывается. Если этот флаг установлен и хранилище сообщений тесно соедино с поставщиком транспорта, поставщику не нужно вызывать [метод IMAPISupport::SpoolerNotify.](imapisupport-spoolernotify.md) 
    
MDB_TEMPORARY 
  
> Журналы в магазине, чтобы информация была извлечена программным образом из раздела профилей без использования диалогов. Этот флаг предписывает MAPI, чтобы хранилище не добавляли в таблицу хранения сообщений и чтобы хранилище не было постоянным. Если этот флаг установлен, поставщикам магазина сообщений не нужно вызывать [метод IMAPISupport::ModifyProfile.](imapisupport-modifyprofile.md) 
    
MDB_WRITE 
  
> Запросы на чтение и написание разрешений.
    
 _lpInterface_
  
> [in] Указатель на идентификатор интерфейса (IID) для входа в хранилище сообщений. Передача **null** указывает, что возвращается интерфейс MAPI для магазина сообщений [(IMsgStore).](imsgstoreimapiprop.md) Параметр  _lpInterface_ также может быть задан идентификатору для соответствующего интерфейса для магазина сообщений (например, IID_IUnknown или IID_IMAPIProp). 
    
 _lpcbSpoolSecurity_
  
> [вышел] Указатель на переменную, в которой поставщик магазина возвращает в bytes размер данных проверки в _параметре lppbSpoolSecurity._ 
    
 _lppbSpoolSecurity_
  
> [вышел] Указатель на указатель на возвращенные данные проверки. Эти данные проверки предоставляются таким образом, что метод [IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md) может войти в пулер MAPI в тот же магазин, что и поставщик магазина сообщений. 
    
 _lppMAPIError_
  
> [вышел] Указатель на указатель на возвращаемую структуру [MAPIERROR,](mapierror.md) если таковые есть, содержит сведения о версии, компоненте и контексте для ошибки. Параметр  _lppMAPIError можно_ установить на **нуль,** если нет структуры **MAPIERROR** для возврата. 
    
 _lppMSLogon_
  
> [вышел] Указатель на указатель на объект логотипа магазина сообщений для входа в MAPI.
    
 _lppMDB_
  
> [вышел] Указатель на указатель на объект хранения сообщений для пульпера MAPI и клиентских приложений для входа в систему.
    
## <a name="return-value"></a>Возвращаемое значение

S_OK 
  
> ����� ������� � ������ ��������� ��������� ��� ��������.
    
MAPI_E_FAILONEPROVIDER 
  
> Этот поставщик не может войти в систему, но эта ошибка не должна отключать службу. 
    
MAPI_E_LOGON_FAILED 
  
> Сеанс логотипа не удалось установить.
    
MAPI_E_UNCONFIGURED 
  
> Профиль не содержит достаточно сведений для завершения логотипа. Когда это значение возвращается, MAPI вызывает функцию точки входа поставщика сообщений-службы в хранилище сообщений.
    
MAPI_E_USER_CANCEL 
  
> Пользователь отменил операцию, как правило, нажав кнопку **Отмена** в диалоговом окне. 
    
MAPI_E_UNKNOWN_CPID 
  
> Сервер не настроен для поддержки страницы кода клиента.
    
MAPI_E_UNKNOWN_LCID 
  
> Сервер не настроен для поддержки сведений о локальном уровне клиента.
    
MAPI_W_ERRORS_RETURNED 
  
> Вызов удался, но у поставщика магазина сообщений есть сведения об ошибках. Когда это предупреждение возвращается, вызов должен быть обработан как успешный. Чтобы проверить это предупреждение, используйте **HR_FAILED** макрос. Дополнительные сведения см. в [дополнительных сведениях Об использовании макроса для обработки ошибок.](using-macros-for-error-handling.md) Чтобы получить сведения об ошибках от поставщика, позвоните по [методу IMAPISession::GetLastError.](imapisession-getlasterror.md) 
    
## <a name="remarks"></a>Примечания

MAPI вызывает **метод IMSProvider::Logon,** чтобы сделать большую часть обработки, необходимой для получения доступа к хранилище сообщений. Поставщики магазинов сообщений проверяют все учетные данные пользователей, необходимые для доступа к определенному магазину, и возвращают объект магазина сообщений в  _параметре lppMDB,_ в который могут войти шпалер MAPI и клиентские приложения. 
  
Помимо возвращаемого объекта хранения сообщений для использования клиентского и пульпера MAPI, поставщик также возвращает объект логотипа магазина сообщений для MAPI для управления открытым хранилищем. Объект logon магазина сообщений и объект магазина сообщений должны быть тесно связаны внутри поставщика магазина сообщений, чтобы каждый из них повлиял на другого. Использование объекта магазина и объекта logon должно быть идентичным; между объектом logon и объектом магазина должна быть одна к одной, чтобы объекты действовали так, как если бы они были одним объектом, который предоставляет два интерфейса. Эти два объекта также должны быть созданы вместе и освобождены вместе. 
  
Объект поддержки MAPI, созданный MAPI и переданный поставщику в  _параметре lpMAPISup,_ предоставляет доступ к функциям MAPI, которые требуется поставщику. К ним относятся функции, которые сохранения и получения сведений о профиле, доступа к адресным книгам и так далее. Указатель  _lpMAPISup_ может быть разным для каждого открываемого магазина. При обработке вызовов для магазина сообщений после логотипа поставщику магазина следует использовать переменную  _lpMAPISup,_ которая является определенной для этого магазина. Для любого вызова **Logon,** который открывает хранилище сообщений и успешно создает объект logon магазина сообщений, поставщик должен сохранить указатель на объект поддержки MAPI в объекте logon магазина и вызвать метод [IUnknown::AddRef,](https://msdn.microsoft.com/library/ms691379%28v=VS.85%29.aspx) чтобы добавить ссылку для объекта поддержки. 
  
Параметр _ulUIParam следует_ использовать, если поставщик представляет диалоговые окна во время вызова **Logon.** Однако диалоговое окно не должно быть представлено, если  _ulFlags_ содержит MDB_NO_DIALOG флага. Если требуется назвать пользовательский интерфейс, но  _ulFlags_ не разрешает его, или если по какой-либо другой причине пользовательский интерфейс не может отображаться, поставщик должен вернуться MAPI_E_LOGON_FAILED. Если **logon** отображает диалоговое окно и пользователь отменяет логотип, как правило, щелкнув кнопку Отмена диалогового окна, поставщик должен MAPI_E_USER_CANCEL.  
  
Параметр  _lpEntryID может_ быть **null** или указать на идентификатор входа в хранилище, созданный ранее в этом хранилище сообщений. Если  _lpEntryID_ указывает на идентификатор незаверченной записи, этот идентификатор записи может быть из одного из нескольких мест: 
  
- Это может быть идентификатор записи, который поставщик магазина ранее завернули и написали в профильный раздел как **свойство PR_ENTRYID** [(PidTagEntryId).](pidtagentryid-canonical-property.md)
    
- Это может быть идентификатор записи, который поставщик ранее завернули и **вернули** вызываемому клиенту в качестве свойства [PR_STORE_ENTRYID (PidTagStoreEntryId).](pidtagstoreentryid-canonical-property.md) 
    
- Это может быть идентификатор записи, который поставщик ранее завернули и **вернули** вызываемому клиенту в качестве PR_ENTRYID объекта магазина сообщений. 
    
В любом из этих случаев не исключено, что идентификатор записи был создан на другом компьютере, чем используемый в настоящее время.
  
Если  _lpEntryID_ не **является null,** он должен содержать всю информацию, необходимую для идентификации и обнаружения магазина сообщений. Эти сведения могут включать имена сетевых томов, номера телефонов, имена учетных записей пользователей и так далее. Если подключение к магазину невозможно сделать с помощью данных в идентификаторе входа, поставщик магазина должен отобразить диалоговое окно, которое позволяет пользователю выбрать открытый магазин. Диалоговое окно может потребоваться, например, если сервер был переименован, изменено имя учетной записи или недоступны части сети.
  
Когда  _lpEntryID_ **является null,** хранилище сообщений для использования еще не выбрано. Поставщик по-прежнему может получить доступ к магазину, не отобразив диалоговое окно, если он поддерживает дополнительные методы для указания магазина. Например, поставщик может проверить файл инициализации или найти дополнительные свойства, размещенные в разделе профилей службы сообщений в конфигурации.
  
Если поставщик обнаруживает, что все необходимые сведения не находятся в профиле, он должен MAPI_E_UNCONFIGURED. После этого MAPI вызовет функцию точки входа службы сообщений поставщика, чтобы пользователь при необходимости выбрал магазин или даже создал его, а также ввести имя и пароль учетной записи. MAPI автоматически создает новый раздел профилей для нового магазина; этот новый раздел профиля может быть временным или постоянным в зависимости от того, как он был добавлен. Если поставщик магазина вызывает метод **IMAPISupport::ModifyProfile,** новый раздел профиля становится постоянным и магазин добавляется в список магазинов сообщений, возвращаемых методом [IMAPISession::GetMsgStoresTable.](imapisession-getmsgstorestable.md) 
  
Параметр  _lpInterface_ указывает IID интерфейса, необходимый для вновь открываемого объекта магазина. Передача **null** в  _lpInterface_ указывает, что интерфейс магазина сообщений **MAPI, IMsgStore,** необходим. Передача объекта магазина сообщений, IID_IMsgStore указывает, что **IMsgStore** необходим. Если IID_IUnknown передается в _lpInterface,_ поставщик должен открыть магазин, используя любой интерфейс, полученный из [IUnknown,](https://msdn.microsoft.com/library/ms680509%28v=VS.85%29.aspx) лучше всего для поставщика (опять же, это обычно **IMsgStore).** Когда IID_IUnknown, реализация вызовов использует [метод IUnknown::QueryInterface](https://msdn.microsoft.com/library/ms682521%28v=VS.85%29.aspx) для выбора интерфейса после успешной операции открытия магазина. 
  
Вызов **IMSProvider::Logon** должен возвращать достаточную информацию, например путь к магазину и учетные данные для доступа к магазину, чтобы позволить шпалеру MAPI войти в тот же магазин, что и поставщик магазина, не предъявив диалоговое окно. Для возврата этих сведений используются параметры _lpcbSpoolSecurity_ и _lppbSpoolSecurity._ Поставщик выделяет память для этих данных, передав указатель в буфер в _параметре lpfAllocateBuffer_ функции [MSProviderInit;](msproviderinit.md) поставщик помещает размер этого буфера в _lpcbSpoolSecurity_. 
  
MAPI освободит этот буфер при необходимости. Если логотип пульпера MAPI в магазине можно выполнить только из сведений в разделе профилей, поставщик может вернуть null в  _lppbSpoolSecurity_ и 0 для размера сведений  _в lpcbSpoolSecurity_. Логотип шпалеров MAPI происходит в рамках другого процесса, чем логотип магазина; так как буфер, содержащий переданную информацию, копируется между процессами, он может не быть в памяти в том же расположении для процесса пульпера MAPI, что и для процесса поставщика магазина. Поэтому поставщик не должен помещал адреса в этот буфер. Дополнительные сведения о логотипе шпалеров MAPI см. в [методе IMSProvider::SpoolerLogon.](imsprovider-spoolerlogon.md) 
  
Большинство поставщиков магазинов используют метод [IMAPISession::OpenProfileSection](imapisession-openprofilesection.md) объекта поддержки, переданного в  _параметре lpMAPISup_ для сохранения и получения учетных данных и параметров пользователей. **OpenProfileSection** позволяет поставщику магазинов сохранять дополнительные произвольные сведения в разделе профилей и связывать их с определенным ресурсом. Например, поставщик магазина может сохранить имя и пароль учетной записи пользователя, связанные с ресурсом, а также любые пути или другие сведения, необходимые для доступа к этому ресурсу. 
  
Свойства с идентификаторами свойств 0x6600 через 0x67FF являются безопасными свойствами, доступными поставщику для собственного использования для хранения частных данных в разделах профилей. Дополнительные сведения об использованиях свойств в объектах раздела профилей см. в [методе IProfSect: IMAPIProp.](iprofsectimapiprop.md) 
  
Помимо любых частных данных в свойствах с идентификаторами 0x6600 через 0x67FF, поставщик магазина должен предоставить сведения о свойстве **PR_DISPLAY_NAME** [(PidTagDisplayName)](pidtagdisplayname-canonical-property.md)в своем разделе профилей. Он должен  PR_DISPLAY_NAME имя самого поставщика — строку идентификации (например, "Microsoft Personal Information Store"), отображаемую пользователям, чтобы они могли отличать этот магазин сообщений от других, к ним может быть доступ. **PR_DISPLAY_NAME** обычно содержит имя сервера, имя учетной записи пользователя или путь. 
  
Некоторые свойства раздела профилей видны в таблице хранения сообщений; другие видны во время установки, установки и конфигурации подсистемы MAPI. Поставщик обычно предоставляет сведения для этих видимых свойств как для нового раздела профилей, который еще не содержит сохраненных учетных данных или частных сведений, так и когда он обнаруживает, что сведения о свойстве изменились. Дополнительные сведения о разделах профилей см. в [разделах IMAPISupport::OpenProfileSection.](imapisupport-openprofilesection.md)
  
После успешного входа в систему пользователя и перед возвращением в MAPI поставщик магазина должен создать массив свойств для строки состояния для ресурса и вызвать [метод IMAPISupport::ModifyStatusRow.](imapisupport-modifystatusrow.md) 
  
 **Logon** вызывает, что открытые хранилища сообщений, которые уже открыты для текущего сеанса MAPI, пропускают большую часть ранее описанной обработки. Эти вызовы не создают строки состояния, не возвращают объекты хранения сообщений, не звонят **AddRef** для объекта поддержки MAPI или возвращают данные для логотипа пульпера MAPI. Эти вызовы возвращают S_OK и возвращают объект магазина сообщений с запрашиваемом интерфейсом. 
  
Чтобы обнаружить такие вызовы, поставщик должен сохранить список в объекте поставщика сообщений в уже открытых для этого объекта-поставщика магазинах. При обработке **вызова Logon** поставщик должен сканировать этот список открытых магазинов и определить, открыт ли уже вход в магазин. Если это так, учетные данные пользователей не нужно проверять, а отображение диалоговых окне следует избегать, если это возможно. Если диалоговое окно необходимо отобразить, поставщик должен проверить возвращаемую информацию, чтобы узнать, был ли магазин открыт во второй раз. Кроме того, поставщик должен проверить на дублирование открытий с помощью _lpEntryID_ в начале обработки вызовов **Logon.** 
  
Стандартная обработка для вызова **Logon,** который имеет доступ к открытому магазину, следующим образом: 
  
1. Поставщик магазина вызывает **AddRef** для существующего объекта магазина, если запрашивается новый интерфейс, такой же, как интерфейс для существующего магазина. В противном случае для получения нового интерфейса **вызывается QueryInterface.** Если магазин не поддерживает новый интерфейс, поставщик должен вернуть значение ошибки MAPI_E_INTERFACE_NOT_SUPPORTED. 
    
2. Поставщик возвращает указатель в необходимый интерфейс существующего объекта магазина _в lppMDB._
    
3. Поставщик возвращает **null** в  _lppMSLogon_.
    
4. Поставщик не должен открывать профиль для объекта поддержки, переданного в вызове. Кроме того, он не должен зарегистрировать уникальный идентификатор поставщика, зарегистрировать строку состояния или вернуть данные логотипа шпалеров MAPI.
    
5. Поставщик не должен вызывать **AddRef** для объекта поддержки, так как для него не требуется указатель на объект. 
    
По возможности поставщики должны возвращать соответствующие строки ошибок и предупреждений для вызовов **Logon,** так как это значительно облегчает бремя пользователей при определении причин, по которым что-то не работает. Чтобы вернуть эти строки, поставщик задает участников в **структуре MAPIERROR.** MAPI ищет, использует и выпускает структуру **MAPIERROR,** если она возвращается поставщиком. 
  
Память для этой **структуры MAPIERROR** должна быть выделена с помощью буфера, переданного _в lpfAllocateBuffer_ по **вызову MSProviderInit.** Все строки ошибок, содержащиеся в возвращенной структуре, должны быть в формате Unicode, если MAPI_UNICODE задаваем в _ulFlags_ **Logon;** в противном случае они должны быть в наборе символов ANSI. 
  
Для большинства значений ошибок, возвращаемой из **Logon,** MAPI отключает службы сообщений, к которым принадлежит поставщик ошибок. MAPI не будет вызывать поставщиков, которые относятся к этим службам в течение всего сеанса MAPI. В отличие от этого, когда **Logon** возвращает значение MAPI_E_FAILONEPROVIDER ошибки из своего логотипа, MAPI не отключит службу сообщений, к которой принадлежит поставщик. **Logon** должен возвращать MAPI_E_FAILONEPROVIDER, если он сталкивается с ошибкой, которая не требует отключения всей службы на весь срок службы сеанса. Например, поставщик может вернуть эту ошибку, если она не позволяет отображать пользовательский интерфейс, а необходимый пароль недоступен. 
  
Если поставщик возвращает MAPI_E_UNCONFIGURED из своего логотипа, MAPI будет вызывать функцию входа в службу сообщений поставщика, а затем повторить логон. MAPI передает MSG_SERVICE_CONFIGURE как контекст, чтобы дать службе возможность настроить себя. Если клиент решил разрешить пользовательский интерфейс на логотипе, служба может представить свой лист свойств конфигурации, чтобы пользователь может ввести сведения о конфигурации.
  
## <a name="see-also"></a>См. также



[IMAPISession::GetMsgStoresTable](imapisession-getmsgstorestable.md)
  
[IMAPISession::OpenMsgStore](imapisession-openmsgstore.md)
  
[IMAPISession::OpenProfileSection](imapisession-openprofilesection.md)
  
[IMAPISupport::ModifyProfile](imapisupport-modifyprofile.md)
  
[IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md)
  
[IMsgStore: IMAPIProp](imsgstoreimapiprop.md)
  
[IMSProvider::SpoolerLogon](imsprovider-spoolerlogon.md)
  
[IProfSect : IMAPIProp](iprofsectimapiprop.md)
  
[MAPIERROR](mapierror.md)
  
[MSProviderInit](msproviderinit.md)
  
[IMSProvider : IUnknown](imsprovideriunknown.md)


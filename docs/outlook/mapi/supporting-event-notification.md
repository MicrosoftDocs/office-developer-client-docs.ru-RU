---
title: Поддержка уведомлений о событиях
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: a1e3e49c-8d1d-4f7e-ba5a-be441f0f10ae
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: 83c102c25b17b6769c0c676bbadd874224f75cf6
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32327428"
---
# <a name="supporting-event-notification"></a><span data-ttu-id="3cba3-103">Поддержка уведомлений о событиях</span><span class="sxs-lookup"><span data-stu-id="3cba3-103">Supporting Event Notification</span></span>

  
  
<span data-ttu-id="3cba3-104">**Относится к**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="3cba3-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="3cba3-105">Поскольку поддержка уведомлений о событиях может быть сложной, MAPI обеспечивает три метода объекта поддержки, реализующих наиболее сложные части процесса.</span><span class="sxs-lookup"><span data-stu-id="3cba3-105">Because supporting event notification can be complicated, MAPI supplies three support object methods that implement the most difficult parts of the process.</span></span> <span data-ttu-id="3cba3-106">Эти методы работают как единица, и поставщик должен использовать все три или ни один из них.</span><span class="sxs-lookup"><span data-stu-id="3cba3-106">These methods work as a unit, and a provider must use all three or none of them.</span></span>
  
<span data-ttu-id="3cba3-107">Методы поддержки MAPI используют ключи уведомлений для управления подключениями между приемниками уведомлений и объектами, которые создают уведомления.</span><span class="sxs-lookup"><span data-stu-id="3cba3-107">The MAPI support methods use notification keys to manage the connections between the advise sinks and the objects that generate the notifications.</span></span> <span data-ttu-id="3cba3-108">Ключ уведомления — это структура [NOTIFKEY,](notifkey.md) которая содержит двоичные данные, определяя объект в процессах.</span><span class="sxs-lookup"><span data-stu-id="3cba3-108">A notification key is a [NOTIFKEY](notifkey.md) structure that contains binary data that identifies an object across processes.</span></span> <span data-ttu-id="3cba3-109">Ключ уведомления обычно копируется из долгосрочного идентификатора записи объекта источника консультации.</span><span class="sxs-lookup"><span data-stu-id="3cba3-109">A notification key is typically copied from the long-term entry identifier of the advise source object.</span></span> <span data-ttu-id="3cba3-110">Если клиент предоставил идентификатор записи в вызове "Сообщить", его можно использовать в качестве ключа уведомления.</span><span class="sxs-lookup"><span data-stu-id="3cba3-110">If the client has supplied an entry identifier in the call to **Advise**, you can use it for the notification key.</span></span> <span data-ttu-id="3cba3-111">Если параметр _lpEntryID_ для advise имеет NULL, используйте идентификатор записи для максимального возможного объекта контейнера, например для хранения сообщений. </span><span class="sxs-lookup"><span data-stu-id="3cba3-111">If the  _lpEntryID_ parameter to **Advise** is NULL, use the entry identifier of the outermost possible container object, such as the message store.</span></span> 
  
<span data-ttu-id="3cba3-112">Чтобы использовать методы поддержки, вызовите [IMAPISupport::Subscribe](imapisupport-subscribe.md) каждый раз, когда клиент вызывает метод **Advise** для регистрации уведомления.</span><span class="sxs-lookup"><span data-stu-id="3cba3-112">To use the support methods, call [IMAPISupport::Subscribe](imapisupport-subscribe.md) whenever a client calls your **Advise** method to register for a notification.</span></span> <span data-ttu-id="3cba3-113">[Выделите структуру NOTIFKEY](notifkey.md) и создайте уникальный ключ уведомления для объекта источника консультации.</span><span class="sxs-lookup"><span data-stu-id="3cba3-113">Allocate a [NOTIFKEY](notifkey.md) structure and create a unique notification key for your advise source object.</span></span> <span data-ttu-id="3cba3-114">Например, поставщик store сообщений, который получает запрос на уведомление клиента при получении сообщения в определенную папку, создает ключ уведомления для этой папки.</span><span class="sxs-lookup"><span data-stu-id="3cba3-114">For example, a message store provider that is prompted to notify a client when a message is received into a particular folder creates a notification key for that folder.</span></span> <span data-ttu-id="3cba3-115">Передайте указатель в структуру **NOTIFKEY** в вызове **подписки** вместе с указателем на клиентский канал с советом.</span><span class="sxs-lookup"><span data-stu-id="3cba3-115">Pass a pointer to the **NOTIFKEY** structure in the call to **Subscribe** along with a pointer to the client's advise sink.</span></span> <span data-ttu-id="3cba3-116">**Подписка** вызывает метод [IUnknown::AddRef](https://msdn.microsoft.com/library/b4316efd-73d4-4995-b898-8025a316ba63%28Office.15%29.aspx) приемника консультации для инкрементного подсчета ссылок, а MAPI сохраняет указатель, пока регистрация не будет отменена.</span><span class="sxs-lookup"><span data-stu-id="3cba3-116">**Subscribe** calls the advise sink's [IUnknown::AddRef](https://msdn.microsoft.com/library/b4316efd-73d4-4995-b898-8025a316ba63%28Office.15%29.aspx) method to increment its reference count and MAPI retains the pointer until the registration is canceled.</span></span> 
  
<span data-ttu-id="3cba3-117">Вы можете передать флаг NOTIFY_SYNC  для подписки, чтобы запросить, что **Notify** работает синхронно и не возвращается, пока он не будет выполнен все вызовы методов [IMAPIAdviseSink::OnNotify](imapiadvisesink-onnotify.md) зарегистрированных приемники рекомендации.</span><span class="sxs-lookup"><span data-stu-id="3cba3-117">You can pass the NOTIFY_SYNC flag to **Subscribe** to request that **Notify** behave synchronously and not return until it has made all calls to the [IMAPIAdviseSink::OnNotify](imapiadvisesink-onnotify.md) methods of registered advise sinks.</span></span> <span data-ttu-id="3cba3-118">Установите этот флаг только для собственного внутреннего использования.</span><span class="sxs-lookup"><span data-stu-id="3cba3-118">Set this flag only for your own internal use.</span></span> <span data-ttu-id="3cba3-119">Не устанавливайте его при ответе на звонок **"Консультация** клиента".</span><span class="sxs-lookup"><span data-stu-id="3cba3-119">Do not set it when you respond to a client **Advise** call.</span></span> <span data-ttu-id="3cba3-120">Уведомления о событиях между клиентами и поставщиками всегда асинхронные.</span><span class="sxs-lookup"><span data-stu-id="3cba3-120">Event notification between clients and providers is always asynchronous.</span></span> <span data-ttu-id="3cba3-121">То есть MAPI гарантирует, что вызов, во время которого происходит событие, будет возвращен клиенту до того, как будет выполнен какой-либо из вызовов **OnNotify.**</span><span class="sxs-lookup"><span data-stu-id="3cba3-121">That is, MAPI guarantees that the call during which an event happens will return to the client before any of the **OnNotify** calls are made.</span></span> 
  
<span data-ttu-id="3cba3-122">Если вы установите флаг NOTIFY_SYNC, не вносим никаких изменений ни в какие объекты-оболочки-оболочки и не передайте оболочку, созданную [HrThisThreadAdviseSink](hrthisthreadadvisesink.md) для подписки.</span><span class="sxs-lookup"><span data-stu-id="3cba3-122">If you set the NOTIFY_SYNC flag, do not make any changes to any of the advise sink objects, and do not pass a wrapper advise sink created by [HrThisThreadAdviseSink](hrthisthreadadvisesink.md) to **Subscribe**.</span></span> <span data-ttu-id="3cba3-123">**HrThisThreadAdviseSink** создает потокобезопасную версию замещения для использования только с асинхронным уведомлением.</span><span class="sxs-lookup"><span data-stu-id="3cba3-123">**HrThisThreadAdviseSink** creates a thread-safe version of an advise sink to be used with asynchronous notification only.</span></span> 
  
<span data-ttu-id="3cba3-124">Если замещает уведомление, зарегистрированное для синхронного уведомления, возвращается из **OnNotify** с установленным флагом CALLBACK_DISCONTINUE, [IMAPISupport::Notify](imapisupport-notify.md) устанавливает флаг NOTIFY_CANCELED и возвращается без каких-либо вызовов **OnNotify.**</span><span class="sxs-lookup"><span data-stu-id="3cba3-124">If an advise sink registered for synchronous notification returns from **OnNotify** with the CALLBACK_DISCONTINUE flag set, [IMAPISupport::Notify](imapisupport-notify.md) sets the NOTIFY_CANCELED flag and returns without making any calls to **OnNotify**.</span></span> 
  
<span data-ttu-id="3cba3-125">Когда **подписка** будет возвращена, вам больше не придется удерживать свою копию клиентского мюнике с консультацией.</span><span class="sxs-lookup"><span data-stu-id="3cba3-125">Once **Subscribe** has returned, you will no longer have any need to hold onto your copy of the client's advise sink.</span></span> <span data-ttu-id="3cba3-126">Вызовите метод [IUnknown::Release,](https://msdn.microsoft.com/library/4b494c6f-f0ee-4c35-ae45-ed956f40dc7a%28Office.15%29.aspx) чтобы освободить его.</span><span class="sxs-lookup"><span data-stu-id="3cba3-126">Call its [IUnknown::Release](https://msdn.microsoft.com/library/4b494c6f-f0ee-4c35-ae45-ed956f40dc7a%28Office.15%29.aspx) method to release it.</span></span> <span data-ttu-id="3cba3-127">**Подписка** возвращает номер подключения без 0, который необходимо вернуть клиенту.</span><span class="sxs-lookup"><span data-stu-id="3cba3-127">**Subscribe** returns a nonzero connection number that you should return to the client.</span></span> <span data-ttu-id="3cba3-128">Номер подключения представляет собой ссылку между источником консультации и оконсультантом.</span><span class="sxs-lookup"><span data-stu-id="3cba3-128">The connection number represents the link between the advise source and the advise sink.</span></span> <span data-ttu-id="3cba3-129">Он остается действительным, пока клиент не сделает успешный вызов **Unadvise.**</span><span class="sxs-lookup"><span data-stu-id="3cba3-129">It remains valid until the client makes a successful call to **Unadvise**.</span></span> 
  
<span data-ttu-id="3cba3-130">Когда клиент готов отменить регистрацию, он вызывает метод **Unadvise.**</span><span class="sxs-lookup"><span data-stu-id="3cba3-130">When the client is ready to cancel a registration, it calls your **Unadvise** method.</span></span> <span data-ttu-id="3cba3-131">Передав номер подключения из вызова **Unadvise** в [IMAPISupport::Unsubscribe](imapisupport-unsubscribe.md).</span><span class="sxs-lookup"><span data-stu-id="3cba3-131">Pass the connection number from the **Unadvise** call to [IMAPISupport::Unsubscribe](imapisupport-unsubscribe.md).</span></span> <span data-ttu-id="3cba3-132">**При отписке** вызывается метод **IUnknown::Release** приемника рекомендации.</span><span class="sxs-lookup"><span data-stu-id="3cba3-132">**Unsubscribe** calls the advise sink's **IUnknown::Release** method.</span></span> <span data-ttu-id="3cba3-133">Как и **в окне** **"Сообщить"** и "Отписаться", вызовы **подписки** и подписки должны **быть** сопряжены.</span><span class="sxs-lookup"><span data-stu-id="3cba3-133">As with **Advise** and **Unadvise**, calls to **Subscribe** and **Unsubscribe** must be paired.</span></span> <span data-ttu-id="3cba3-134">Необходимо сделать один вызов для **подписки на** каждый вызов, сделанный для **подписки.**</span><span class="sxs-lookup"><span data-stu-id="3cba3-134">You must make one call to **Unsubscribe** for every call that is made to **Subscribe**.</span></span> <span data-ttu-id="3cba3-135">Однако вам не нужно вызывать **подписку каждый** раз при вызове метода **Advise.**</span><span class="sxs-lookup"><span data-stu-id="3cba3-135">However, you do not have to call **Subscribe** every time your **Advise** method is called.</span></span> <span data-ttu-id="3cba3-136">И наоборот, его можно вызвать для настройки внутренних уведомлений.</span><span class="sxs-lookup"><span data-stu-id="3cba3-136">Conversely, you can call it for setting up internal notifications.</span></span> 
  
<span data-ttu-id="3cba3-137">При событии выделяем одну или несколько структур [УВЕДОМЛЕНий](notification.md) типа, соответствующего событию, и вызовите [IMAPISupport::Notify.](imapisupport-notify.md)</span><span class="sxs-lookup"><span data-stu-id="3cba3-137">When an event occurs, allocate one or more [NOTIFICATION](notification.md) structures of the type appropriate for the event and call [IMAPISupport::Notify](imapisupport-notify.md).</span></span> <span data-ttu-id="3cba3-138">**Уведомление** создает уведомление для каждого зарегистрированного мюник консультации.</span><span class="sxs-lookup"><span data-stu-id="3cba3-138">**Notify** generates a notification for each registered advise sink.</span></span> <span data-ttu-id="3cba3-139">Для всех неиспользованных членов структуры [NOTIFICATION](notification.md) необходимо установить нулевое значение.</span><span class="sxs-lookup"><span data-stu-id="3cba3-139">You should set all the unused members of the [NOTIFICATION](notification.md) structure to zero.</span></span> <span data-ttu-id="3cba3-140">Этот метод инициализации структуры **УВЕДОМЛЕНий** помогает клиентам создавать более мелкие, быстрые и менее подверженные ошибкам реализации **OnNotify.**</span><span class="sxs-lookup"><span data-stu-id="3cba3-140">This technique for initializing the **NOTIFICATION** structure can help clients create smaller, faster, and less error-prone **OnNotify** implementations.</span></span> 
  
<span data-ttu-id="3cba3-141">Обратите внимание, что для **каждого** события требуется отдельная структура УВЕДОМЛЕНий, даже для нескольких событий одного типа.</span><span class="sxs-lookup"><span data-stu-id="3cba3-141">Note that a separate **NOTIFICATION** structure is necessary for each event, even for multiple events of the same type.</span></span> <span data-ttu-id="3cba3-142">Например, если для уведомления о таблице в конкретной таблице зарегистрировано три клиента и в  таблицу добавлены пять строк, необходимо создать пять OBJECT_NOTIFICATION для вызова **Notify.**</span><span class="sxs-lookup"><span data-stu-id="3cba3-142">For example, if three clients are registered for table notification on a particular table and five rows are added to the table, you must create five **OBJECT_NOTIFICATION** structures for your **Notify** call.</span></span> <span data-ttu-id="3cba3-143">Пакетное уведомление, например это, приводит к более производительности, чем вызов **Notify** пять раз.</span><span class="sxs-lookup"><span data-stu-id="3cba3-143">A batch notification such as this results in better performance than calling **Notify** five times.</span></span> <span data-ttu-id="3cba3-144">Для каждого **вызова Notify** MAPI вызывает метод [IMAPIAdviseSink::OnNotify](imapiadvisesink-onnotify.md) каждого зарегистрированного приемника консультации.</span><span class="sxs-lookup"><span data-stu-id="3cba3-144">For each **Notify** call, MAPI calls the [IMAPIAdviseSink::OnNotify](imapiadvisesink-onnotify.md) method of every registered advise sink.</span></span> <span data-ttu-id="3cba3-145">Если зарегистрированные мюникы для консультаций не зарегистрированы, MAPI игнорирует вызов.</span><span class="sxs-lookup"><span data-stu-id="3cba3-145">If there are no registered advise sinks, MAPI ignores the call.</span></span> 
  
<span data-ttu-id="3cba3-146">Поставщики услуг, которые отправляют пакетные уведомления, должны указать их, чтобы их можно было интерпретировать с первого уведомления до последнего.</span><span class="sxs-lookup"><span data-stu-id="3cba3-146">Service providers that send batched notifications must order them so that they can be interpreted from the first notification to the last.</span></span> <span data-ttu-id="3cba3-147">Этот порядок особенно необходим, если пакет уведомлений содержит ряд событий, например события TABLE_ROW_ADDED с одним событием, которое ссылается на предыдущие строки, добавленные в другое событие в том же пакете.</span><span class="sxs-lookup"><span data-stu-id="3cba3-147">This ordering is especially necessary when a notification batch contains a series of events, such as TABLE_ROW_ADDED with one event that refers to a prior row that was added in another event in the same batch.</span></span>
  
## <a name="see-also"></a><span data-ttu-id="3cba3-148">См. также</span><span class="sxs-lookup"><span data-stu-id="3cba3-148">See also</span></span>



[<span data-ttu-id="3cba3-149">Поставщики услуг MAPI</span><span class="sxs-lookup"><span data-stu-id="3cba3-149">MAPI Service Providers</span></span>](mapi-service-providers.md)


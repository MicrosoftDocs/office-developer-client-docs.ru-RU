---
title: Механизм бездействия MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 755d096a-2a61-44d2-a765-5d464a857756
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: d8d591c02bb621c16a1d1b46272b19573ea79785
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33428454"
---
# <a name="mapi-idle-engine"></a>Механизм бездействия MAPI

  
  
**Относится к**: Outlook 2013 | Outlook 2016 
  
MAPI предоставляет несколько функций, которые в совокупности называются механизмом бездействия. Эти функции позволяют клиентам, поставщикам адресных книг и поставщикам хранимых сообщений выполнять различные задачи во время медленного сеанса или в ответ на медленное время. Например, клиенты и поставщики услуг могут откладывать медленные операции или закрывать файлы, которые остаются неиспользоваными в течение длительного периода времени. Поставщики транспорта обычно не используют механизм бездействия, так как его место занимает метод **IXPLogon::Idle.** Дополнительные сведения см. в [IXPLogon::Idle.](ixplogon-idle.md)
  
Чтобы использовать механизм бездействия, клиенты и поставщики услуг создают функцию вызова, которая содержит задачи, которые должны выполняться при бездействии подсистемы MAPI. Когда MAPI обнаруживает время бездействия, он вызывает эту функцию вызова. Функция вызова следует **прототипу FNIDLE,** определенному следующим образом: 
  
 `BOOL (STDAPICALLTYPE FNIDLE) (LPVOID lpvContext)`
  
Дополнительные сведения см. в [FNIDLE.](fnidle.md)
  
Функции, которые составляют механизм бездействия:
  
[ChangeIdleRoutine](changeidleroutine.md)
  
[DeregisterIdleRoutine](deregisteridleroutine.md)
  
[EnableIdleRoutine](enableidleroutine.md)
  
[FtgRegisterIdleRoutine](ftgregisteridleroutine.md)
  
[MAPIDeInitIdle](mapideinitidle.md)
  
[MAPIInitIdle](mapiinitidle.md)
  
Чтобы зарегистрировать функцию callback, клиенты и поставщики услуг вызовите функцию **FtgRegisterIdleRoutine.** Входные параметры включают необязательный приоритет, блок памяти, который передается функции ответного вызова в качестве входных данных, количество времени, которое будет использоваться любым способом, и набор флажков параметров. 
  
Клиенты и поставщики услуг могут указать приоритет в параметре  _priIdle,_ который управляет запуском функции бездействия, или ноль, если приоритет не является проблемой. Так как отрицательные числа представляют более высокие приоритеты, чем положительные числа или ноль, операции сжатия и поиска должны быть назначены отрицательным числам. Задачам, которые происходят один раз, должны быть назначены положительные числа. 
  
Чтобы отозвать активную функцию вызова, клиенты и поставщики услуг вызывали **функцию DeregisterIdleRoutine.** Так как **DeregisterIdleRoutine** работает асинхронно, функция обратного вызова может вызываться в любое время во время вызова deregister и, возможно, даже после возврата **DeregisterIdleRoutine.** 
  
Чтобы изменить некоторые или все характеристики функции callback, клиенты и поставщики услуг вызов **функции ChangeIdleRoutine.** **ChangeIdleRoutine** вносит изменения в соответствии с тем, как задан параметр  _flags ircIdle;_ **ChangeIdleRoutine** может изменять функцию, ее приоритет, параметр времени и входной параметр. 
  
MAPI определяет бездействие так же, как операционная система, если у операционной системы есть определение. В Win32 MAPI создает поток с приоритетом бездействия класса, чтобы запланировать задачи без простоя. Этот поток отслеживает время и публикует сообщение в потоке, который должен выполнять задачу бездействия при ее выполнении. Win32 планирует потоки, а не процессы. Если задачи с приоритетом выше приоритета простоя, которые находятся на рабочей станции, простаивающие задачи не должны быть запланированы для выполнения, пока задачи не будут завершены. 
  
Все задачи бездействуют в потоке, который называется **MAPIInitIdle.** MAPI имеет отдельный поток для планирования, но когда простаиваемая задача становится доступной, она возвращает сообщение обратно в поток инициализации, и в нем выполняется простаиваемая задача. Для разных типов клиентов это может быть следующим образом.
  
|**Потоковая модель**|**Последствие**|
|:-----|:-----|
|Однопотоковая  <br/> |Это не проблема. Функции бездействия выполняются в основном потоке клиента и сериализируются через цикл сообщений.  <br/> |
|Free-threaded  <br/> |Функции бездействия должны быть потокобезопасны, но клиент уже имеет необходимую инфраструктуру. Возможно, вашему клиенту не нужен механизм бездействия MAPI.  <br/> |
|Многопотоковая анонатная  <br/> |Функция idle должна выполняться в том же потоке, который ее зарегистрировал, если она хочет использовать ИНТЕРФЕЙСЫ MAPI, OLE или любые другие COM-интерфейсы. Самый простой способ — зарегистрировать функцию бездействия с помощью MAPI, которая отправляет сообщение в нужный поток и отправляет «реальную» функцию бездействия непосредственно из цикла сообщений этого потока.  <br/> |
   


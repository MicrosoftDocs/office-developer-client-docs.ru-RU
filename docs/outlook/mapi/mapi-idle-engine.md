---
title: Простой двигатель MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 755d096a-2a61-44d2-a765-5d464a857756
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: d8d591c02bb621c16a1d1b46272b19573ea79785
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33428454"
---
# <a name="mapi-idle-engine"></a><span data-ttu-id="cdaa2-103">Простой двигатель MAPI</span><span class="sxs-lookup"><span data-stu-id="cdaa2-103">MAPI Idle Engine</span></span>

  
  
<span data-ttu-id="cdaa2-104">**Область применения**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="cdaa2-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="cdaa2-105">MAPI предоставляет несколько функций, которые в совокупности называются простаивающим двигателем.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-105">MAPI provides several functions that are collectively known as the idle engine.</span></span> <span data-ttu-id="cdaa2-106">Эти функции позволяют клиентам, поставщикам адресных книг и поставщикам хранения сообщений выполнять различные задачи во время медленного сеанса или в ответ на медленное время.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-106">These functions allow clients, address book providers, and message store providers to perform various tasks during slow times in the session or in response to a slow time.</span></span> <span data-ttu-id="cdaa2-107">Например, клиенты и поставщики услуг могут откладывать медленные операции или закрывать файлы, которые длительное время оставались неиспользоваными.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-107">For example, clients and service providers can defer slow operations or close files that have remained unused for a lengthy period.</span></span> <span data-ttu-id="cdaa2-108">Поставщики транспорта обычно не используют простой двигатель, так как на его месте используется метод **IXPLogon::Idle.**</span><span class="sxs-lookup"><span data-stu-id="cdaa2-108">Transport providers typically do not use the idle engine because the **IXPLogon::Idle** method takes its place.</span></span> <span data-ttu-id="cdaa2-109">Дополнительные сведения см. в [ссылке IXPLogon::Idle.](ixplogon-idle.md)</span><span class="sxs-lookup"><span data-stu-id="cdaa2-109">For more information, see [IXPLogon::Idle](ixplogon-idle.md).</span></span>
  
<span data-ttu-id="cdaa2-110">Чтобы использовать простой двигатель, клиенты и поставщики услуг создают функцию вызова, которая содержит задачи, которые должны возникать при простое подсистемы MAPI.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-110">To use the idle engine, clients and service providers create a callback function that contains the tasks that should occur when the MAPI subsystem is idle.</span></span> <span data-ttu-id="cdaa2-111">Когда MAPI обнаруживает время простоя, он вызывает эту функцию вызова.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-111">When MAPI detects idle time, it invokes this callback function.</span></span> <span data-ttu-id="cdaa2-112">Функция вызова следует **прототипу FNIDLE,** который определяется следующим образом:</span><span class="sxs-lookup"><span data-stu-id="cdaa2-112">The callback function follows the **FNIDLE** prototype, defined as follows:</span></span> 
  
 `BOOL (STDAPICALLTYPE FNIDLE) (LPVOID lpvContext)`
  
<span data-ttu-id="cdaa2-113">Дополнительные сведения см. в [fNIDLE.](fnidle.md)</span><span class="sxs-lookup"><span data-stu-id="cdaa2-113">For more information, see [FNIDLE](fnidle.md).</span></span>
  
<span data-ttu-id="cdaa2-114">Функции, которые составляют простой двигатель:</span><span class="sxs-lookup"><span data-stu-id="cdaa2-114">The functions that make up the idle engine are:</span></span>
  
[<span data-ttu-id="cdaa2-115">ChangeIdleRoutine</span><span class="sxs-lookup"><span data-stu-id="cdaa2-115">ChangeIdleRoutine</span></span>](changeidleroutine.md)
  
[<span data-ttu-id="cdaa2-116">DeregisterIdleRoutine</span><span class="sxs-lookup"><span data-stu-id="cdaa2-116">DeregisterIdleRoutine</span></span>](deregisteridleroutine.md)
  
[<span data-ttu-id="cdaa2-117">EnableIdleRoutine</span><span class="sxs-lookup"><span data-stu-id="cdaa2-117">EnableIdleRoutine</span></span>](enableidleroutine.md)
  
[<span data-ttu-id="cdaa2-118">FtgRegisterIdleRoutine</span><span class="sxs-lookup"><span data-stu-id="cdaa2-118">FtgRegisterIdleRoutine</span></span>](ftgregisteridleroutine.md)
  
[<span data-ttu-id="cdaa2-119">MAPIDeInitIdle</span><span class="sxs-lookup"><span data-stu-id="cdaa2-119">MAPIDeInitIdle</span></span>](mapideinitidle.md)
  
[<span data-ttu-id="cdaa2-120">MAPIInitIdle</span><span class="sxs-lookup"><span data-stu-id="cdaa2-120">MAPIInitIdle</span></span>](mapiinitidle.md)
  
<span data-ttu-id="cdaa2-121">Чтобы зарегистрировать функцию вызова, клиенты и поставщики услуг звонят в **функцию FtgRegisterIdleRoutine.**</span><span class="sxs-lookup"><span data-stu-id="cdaa2-121">To register a callback function, clients and service providers call the **FtgRegisterIdleRoutine** function.</span></span> <span data-ttu-id="cdaa2-122">Параметры ввода включают необязательный приоритет, блок памяти, который передается в функцию вызова в качестве ввода, количество времени, которое необходимо использовать в любом случае, и набор флагов опций.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-122">The input parameters include an optional priority, a block of memory that is passed to your callback function as input, an amount of time to be used in any way appropriate, and a set of option flags.</span></span> 
  
<span data-ttu-id="cdaa2-123">Клиенты и поставщики услуг могут указать приоритет в параметре  _priIdle,_ который контролирует, как выполняется простая функция, или указать ноль, если приоритет не является проблемой.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-123">Clients and service providers can specify a priority in the  _priIdle_ parameter that controls how the idle function runs or specify zero if priority is not an issue.</span></span> <span data-ttu-id="cdaa2-124">Так как отрицательные числа представляют более высокие приоритеты, чем положительные цифры или ноль, операции сжатия и поиска должны быть назначены отрицательные номера.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-124">Because negative numbers represent higher priorities than positive numbers or zero, compression and search operations should be assigned negative numbers.</span></span> <span data-ttu-id="cdaa2-125">Задачи, которые возникают один раз, должны быть назначены положительные номера.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-125">Tasks that occur once should be assigned positive numbers.</span></span> 
  
<span data-ttu-id="cdaa2-126">Чтобы отозвать активную функцию вызова, клиенты и поставщики услуг вызывали **функцию DeregisterIdleRoutine.**</span><span class="sxs-lookup"><span data-stu-id="cdaa2-126">To deregister an active callback function, clients and service providers call the **DeregisterIdleRoutine** function.</span></span> <span data-ttu-id="cdaa2-127">Так как **deregisterIdleRoutine** работает асинхронно, функция обратного вызова может вызываться в любое время во время вызова дерегистрации и, возможно, даже после возврата **DeregisterIdleRoutine.**</span><span class="sxs-lookup"><span data-stu-id="cdaa2-127">Because **DeregisterIdleRoutine** operates asynchronously, it is possible for the callback function to be invoked at any time during the deregister call and possibly even after **DeregisterIdleRoutine** has returned.</span></span> 
  
<span data-ttu-id="cdaa2-128">Чтобы изменить некоторые или все характеристики функции вызова, клиенты и поставщики услуг называют **функцию ChangeIdleRoutine.**</span><span class="sxs-lookup"><span data-stu-id="cdaa2-128">To modify some or all of the characteristics of a callback function, clients and service providers call the **ChangeIdleRoutine** function.</span></span> <span data-ttu-id="cdaa2-129">**ChangeIdleRoutine** вносит изменения в зависимости от того, как задан параметр  _ircIdle_ флагов; **ChangeIdleRoutine может** изменить функцию, ее приоритет, параметр времени и параметр ввода.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-129">**ChangeIdleRoutine** makes changes according to how the flags parameter  _ircIdle_ is set; **ChangeIdleRoutine** can change the function itself, its priority, time setting, and input parameter.</span></span> 
  
<span data-ttu-id="cdaa2-130">MAPI определяет простое так же, как операционная система, когда у операционной системы есть определение.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-130">MAPI defines idle the same as the operating system, when the operating system has a definition.</span></span> <span data-ttu-id="cdaa2-131">В Win32 MAPI создает поток с приоритетом праздного класса для расписания недействуя задач.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-131">On Win32, MAPI creates a thread with idle-class priority to schedule idle tasks.</span></span> <span data-ttu-id="cdaa2-132">Этот поток отслеживает время и публикует сообщение в поток, который должен выполнять простаиваю задачу, когда придет время для ее выполнения.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-132">This thread keeps track of the time and posts a message to the thread that is to execute the idle task when the time for its execution arrives.</span></span> <span data-ttu-id="cdaa2-133">Win32 запланирует потоки, а не процессы.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-133">Win32 schedules threads, not processes.</span></span> <span data-ttu-id="cdaa2-134">Если задачи с приоритетом выше, чем праздный, происходят на рабочей станции, простаивающие задачи не должны выполняться до завершения задач.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-134">If tasks that have a priority higher than the idle priority are occurring on the workstation, the idle task should not get scheduled for execution until the tasks have completed.</span></span> 
  
<span data-ttu-id="cdaa2-135">Все простаивающим задачам выполняться в потоке, который называется **MAPIInitIdle**.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-135">All idle tasks run on the thread that called **MAPIInitIdle**.</span></span> <span data-ttu-id="cdaa2-136">MAPI имеет отдельный поток для планирования, но когда простая задача становится доступной, она возвращает сообщение обратно в поток инициализации, и простая задача выполняется там.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-136">MAPI has a separate thread for scheduling, but when an idle task becomes eligible, it posts a message back over to the initialization thread and the idle task is executed there.</span></span> <span data-ttu-id="cdaa2-137">Последствия для разных типов клиентов являются следующими.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-137">The implications for different types of clients are as follows.</span></span>
  
|<span data-ttu-id="cdaa2-138">**Модель threading**</span><span class="sxs-lookup"><span data-stu-id="cdaa2-138">**Threading model**</span></span>|<span data-ttu-id="cdaa2-139">**Implication**</span><span class="sxs-lookup"><span data-stu-id="cdaa2-139">**Implication**</span></span>|
|:-----|:-----|
|<span data-ttu-id="cdaa2-140">Однопотокая</span><span class="sxs-lookup"><span data-stu-id="cdaa2-140">Single-threaded</span></span>  <br/> |<span data-ttu-id="cdaa2-141">Это не проблема.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-141">No problem.</span></span> <span data-ttu-id="cdaa2-142">Функции idle выполняются в основном потоке клиента и сериализируются в цикле сообщений.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-142">Idle functions execute on your client's main thread and are serialized through the message loop.</span></span>  <br/> |
|<span data-ttu-id="cdaa2-143">Free-threaded</span><span class="sxs-lookup"><span data-stu-id="cdaa2-143">Free-threaded</span></span>  <br/> |<span data-ttu-id="cdaa2-144">Функции idle должны быть безопасными для потока, но у клиента уже есть необходимая инфраструктура.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-144">Idle functions must be thread-safe, but your client already has the necessary infrastructure.</span></span> <span data-ttu-id="cdaa2-145">Возможно, вашему клиенту вообще не понадобится простой двигатель MAPI.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-145">Your client might not need the MAPI idle engine at all.</span></span>  <br/> |
|<span data-ttu-id="cdaa2-146">Квартира с резьбой</span><span class="sxs-lookup"><span data-stu-id="cdaa2-146">Apartment-threaded</span></span>  <br/> |<span data-ttu-id="cdaa2-147">Функция Idle должна выполняться на том же потоке, который зарегистрировал ее, если она хочет использовать MAPI, OLE или любые другие интерфейсы COM.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-147">Idle function has to execute on the same thread that registered it if it wants to use MAPI, OLE, or any other COM interfaces.</span></span> <span data-ttu-id="cdaa2-148">Самый простой способ — зарегистрировать праздную функцию MAPI, которая отправляет сообщение в нужный поток и отправляет "реальную" функцию простоя непосредственно из цикла сообщений этого потока.</span><span class="sxs-lookup"><span data-stu-id="cdaa2-148">The most straightforward way is to register an idle function with MAPI that posts a message to the right thread and dispatch the "real" idle function directly from that thread's message loop.</span></span>  <br/> |
   


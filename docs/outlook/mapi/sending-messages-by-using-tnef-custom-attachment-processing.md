---
title: Отправка сообщений с помощью настраиваемой обработки вложений в TNEF
manager: soliver
ms.date: 12/07/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: da318b6f-128a-44b5-8357-a130022030a1
description: '���� ���������� ���������: 7 ������� 2015 �.'
ms.openlocfilehash: f9d154b26319f5ed72b1abd6aeef307d07a63bda
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32339699"
---
# <a name="sending-messages-by-using-tnef-custom-attachment-processing"></a>Отправка сообщений с помощью настраиваемой обработки вложений в TNEF

 
  
**Относится к**: Outlook 2013 | Outlook 2016 
  
Настройка обработки вложений при отправке сообщения:
  
1. Получите объект TNEF, передав **интерфейс IStream** и сообщение в [функцию OpenTnefStreamEx.](opentnefstreamex.md) 
    
2. Получите список всех определенных свойств сообщения, вызывая метод [IMAPIProp::GetPropList.](imapiprop-getproplist.md) 
    
3. Используйте [методы IMAPIProp,](imapipropiunknown.md) чтобы исключить все свойства, поддерживаемые системой обмена сообщениями. В соответствующее время запишите эти свойства в систему обмена сообщениями в формате, требуемом системой обмена сообщениями. 
    
4. Вызовите метод [ITnef::AddProps,](itnef-addprops.md) чтобы добавить только свойства сообщения ( то есть ни одно из свойств вложений), установив флаг TNEF_PROP_MESSAGE_ONLY. 
    
5. Вызовите [ITnef::AddProps](itnef-addprops.md) с помощью этих элементов: флаг TNEF_PROP_EXCLUDE, массив тегов свойств, содержащий **свойство PR_ATTACH_DATA_BIN** ([PidTagAttachDataBinary)](pidtagattachdatabinary-canonical-property.md)или **PR_ATTACH_DATA_OBJ** ([PidTagAttachDataObject),](pidtagattachdataobject-canonical-property.md)а также идентификатор вложения, который указывает вложение для обработки.
    
6. Используйте метод [ITnef::SetProps,](itnef-setprops.md) чтобы добавить тег свойства **PR_ATTACH_TRANSPORT_NAME** [(PidTagAttachTransportName)](pidtagattachtransportname-canonical-property.md)с уникальной строкой, идентифицирующий вложение в системе обмена сообщениями, если вложение имеет имя файла, которое система обмена сообщениями не может поддерживать. Например, несколько вложений с одним и тем же исходным именом файла или имя файла, которое не является допустимым и имям файла для системы обмена сообщениями. Эта строка будет использоваться с номером ключа при написании тегов вложений в тексте помеченного сообщения, чтобы связать вложение с его данными. Дополнительные сведения см. в тексте сообщения с тегом [TNEF.](tnef-tagged-message-text.md)
    
7. Повторите **вызовы AddProps** и **SetProps** для каждого вложения. 
    
8. Вызовите [метод ITnef::Finish,](itnef-finish.md) чтобы закодировать сообщение в поток TNEF после того, как будут добавлены все запрашиваемые свойства. 
    
9. Получите помеченный текст сообщения, вызывая метод [ITnef::OpenTaggedBody.](itnef-opentaggedbody.md) Этот помеченный текст считывания с помощью методов из интерфейса **IStream,** закодирован с помощью модели вложений системы обмена сообщениями и записан в систему обмена сообщениями. 
    
10. Вызовите [метод IUnknown::Release,](https://msdn.microsoft.com/library/4b494c6f-f0ee-4c35-ae45-ed956f40dc7a%28Office.15%29.aspx) чтобы освободить объект [ITnef.](itnefiunknown.md) 
    
11. Запишите оставшиеся вложения в систему обмена сообщениями с помощью модели вложений системы обмена сообщениями.
    
Поставщик транспорта должен использовать описанную выше процедуру для обработки вложений. Если это невозможно, поставщик транспорта должен использовать следующие действия для обработки настраиваемых вложений:
  
1. Поставщик транспорта гарантирует,  что PR_ATTACH_TRANSPORT_NAME всех вложений содержат уникальные значения, которые являются допустимым идентификатором вложений для системы обмена сообщениями. 
    
2. Затем поставщик транспорта использует один вызов **ITnef::AddProps** для каждого вложения, передав TNEF_PROP_CONTAINED флаг. 
    


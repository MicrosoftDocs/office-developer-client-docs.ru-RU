---
title: Отправка сообщений с использованием настраиваемой обработки вложений TNEF
manager: soliver
ms.date: 12/07/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: da318b6f-128a-44b5-8357-a130022030a1
description: '���� ���������� ���������: 7 ������� 2015 �.'
ms.openlocfilehash: f9d154b26319f5ed72b1abd6aeef307d07a63bda
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32339699"
---
# <a name="sending-messages-by-using-tnef-custom-attachment-processing"></a>Отправка сообщений с использованием настраиваемой обработки вложений TNEF

 
  
**Область применения**: Outlook 2013 | Outlook 2016 
  
Настройка обработки вложений при отправке сообщения:
  
1. Получите объект TNEF, передав интерфейс **IStream** и сообщение в функцию [опентнефстреамекс](opentnefstreamex.md) . 
    
2. Получите список всех определенных свойств сообщения, вызвав метод [IMAPIProp:: жетпроплист](imapiprop-getproplist.md) . 
    
3. Используйте методы [IMAPIProp](imapipropiunknown.md) , чтобы исключить все свойства, поддерживаемые системой обмена сообщениями. В нужное время эти свойства записываются в систему обмена сообщениями в формате, требуемом системой обмена сообщениями. 
    
4. ВыЗовите метод [итнеф:: аддпропс](itnef-addprops.md) , чтобы добавить только свойства сообщения (то есть ни одно из свойств вложений), УСТАНОВИВ флаг тнеф_проп_мессаже_онли. 
    
5. Call [итнеф:: аддпропс](itnef-addprops.md) с этими элементами: флаг тнеф_проп_ексклуде, массив тегов свойств, который содержит **пр_аттач_дата_бин** ([PidTagAttachDataBinary](pidtagattachdatabinary-canonical-property.md)) или **пр_аттач_дата_обж** ([PidTagAttachDataObject](pidtagattachdataobject-canonical-property.md)) и идентификатор вложения, который указывает вложение для обработки.
    
6. Используйте метод [итнеф:: SetProps](itnef-setprops.md) , чтобы добавить тег свойства **пр_аттач_транспорт_наме** ([PidTagAttachTransportName](pidtagattachtransportname-canonical-property.md)) с уникальной строкой, которая определяет вложение в систему обмена сообщениями, если вложение содержит имя файла, система обмена сообщениями не поддерживает эту возможность. Например, несколько вложений с одинаковым исходным именем или имя файла, которое не является допустимым именем для системы обмена сообщениями. Эта строка будет использоваться с номером ключа при записи тегов вложений в тексте сообщения с тегами, чтобы связать вложение с его данными. Для получения дополнительных сведений см [текст сообщения с тегами в формате TNEF](tnef-tagged-message-text.md).
    
7. Повторите вызовы **аддпропс** и **SetProps** для каждого вложения. 
    
8. ВыЗовите метод [итнеф:: Finish](itnef-finish.md) для кодирования сообщения в поток TNEF после добавления всех запрошенных свойств. 
    
9. Получите текст сообщения с тегами, вызвав метод [итнеф:: опентагжедбоди](itnef-opentaggedbody.md) . Этот текст с тегами считывается с помощью методов из интерфейса **IStream** и кодируется с помощью модели вложений системы обмена сообщениями и записывается в систему обмена сообщениями. 
    
10. ВыЗовите метод [IUnknown:: Release](https://msdn.microsoft.com/library/4b494c6f-f0ee-4c35-ae45-ed956f40dc7a%28Office.15%29.aspx) , чтобы освободить объект [итнеф](itnefiunknown.md) . 
    
11. ЗаПишите оставшиеся вложения в систему обмена сообщениями через модель вложений системы обмена сообщениями.
    
Поставщик транспорта должен использовать описанную выше процедуру для обработки вложений. Если это невозможно, поставщик транспорта должен выполнить следующие действия для настроенной обработки вложений:
  
1. Поставщик транспорта гарантирует, что свойства **пр_аттач_транспорт_наме** всех вложений содержат уникальные значения, которые являются допустимыми идентификаторами вложений для системы обмена сообщениями. 
    
2. Затем поставщик транспорта использует один вызов **итнеф:: аддпропс** для каждого вложения, передавая флаг тнеф_проп_контаинед. 
    


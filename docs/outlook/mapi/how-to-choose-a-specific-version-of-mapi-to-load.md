---
title: Выбор определенной версии MAPI для загрузки
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 85539a7f-74b6-4267-86ea-00da2c900c34
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: d353eba55e33b8ab48b3c47d2f31f1b5e0973b58
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32344522"
---
# <a name="choose-a-specific-version-of-mapi-to-load"></a>Выбор определенной версии MAPI для загрузки

**Область применения**: Outlook 2013 | Outlook 2016 
  
При явном связывании с реализацией MAPI необходимо тщательно выбирать реализацию для загрузки. 
  
Существует два метода, которые явно связываются с реализацией MAPI. 
  
1. Вы можете загрузить библиотеку заглушек MAPI и указать в реестре пользовательскую БИБЛИОТЕКУ DLL для загрузки и отправки вызовов MAPI.
    
2. Вы можете реализовать алгоритм поиска клиентов MAPI, чтобы найти версию MAPI, используемую почтовым клиентом по умолчанию, и загрузить ее.
    
Так как вы можете изменить [параметры реестра для заглушки MAPI32. dll](https://msdn.microsoft.com/library/ms531218%28EXCHG.10%29.aspx) , чтобы приложение могло использовать любую реализацию MAPI, рекомендуется направлять приложение для использования реализации MAPI, с которой вы тестировали. Далее описаны оба метода связывания явным образом. 
  
## <a name="reading-from-the-registry"></a>Чтение из реестра

### <a name="to-read-mapi-implementation-information-from-the-registry"></a>Чтение сведений о реализации MAPI из реестра

1. Разделы реестра, указывающие на пользовательскую БИБЛИОТЕКУ DLL для почтового клиента, расположены `HKLM\Software\Clients\Mail` в ключе почтового клиента. 
    
   В следующей таблице описываются эти ключи:
    
   |**Клавиша**|**Описание**|
   |:-----|:-----|
   |Мсикомпонентид  <br/> |Идентификатор категории Публишкомпонент установщика Windows (GUID), который определяет БИБЛИОТЕКУ DLL, которая экспортирует простые вызовы MAPI или MAPI. Если этот параметр установлен, этот ключ имеет приоритет над ключом **DLLPath** или **дллпасекс** .  <br/> |
   |МсиаппликатионлЦид  <br/> |Идентификатор языкового стандарта (LCID) для вашего приложения. Первое строковое значение определяет подключ из `HKLM\Software` , а последующие строковые значения определяют значения реестра под этим ключом, содержащие сведения о языковых стандартах.  <br/> |
   |МсиоффицелЦид  <br/> |LCID для Microsoft Office. Первое строковое значение определяет подключ из `HKLM\Software` и последующие строковые значения, определяющие значения реестра под этим ключом.  <br/> |
   
   Получите сведения из этих разделов.
    
2. Передайте значения, полученные на предыдущем шаге, в функцию [фжеткомпонентпас](fgetcomponentpath.md) . **Фжеткомпонентпас** — это функция, которая экспортируется библиотекой-заглушкой MAPI мапистуб. dll. Он возвращает путь к настраиваемой версии MAPI. 


### <a name="to-load-the-implementation-of-mapi-marked-as-default"></a>Загрузка реализации MAPI, помеченной как используемая по умолчанию

1. Считывание `HKLM\Software\Clients\Mail::(default)` значения реестра. 
    
2. Найдите сведения об указанном клиенте, как описано выше.
    
> [!NOTE]
> Обратите внимание, что почтовый клиент по умолчанию не может реализовать расширенный MAPI. 
  
#### <a name="example"></a>Пример

Чтобы загрузить MAPI как реализованное в Outlook, найдите разделы реестра в разделе `HKLM\Software\Clients\Mail\Microsoft Outlook` и передайте их в **фжеткомпонентпас**. **Фжеткомпонентпас** вернет путь для реализации MAPI в Outlook. 
  
Если ключи **мсикомпонентид**, **мсиаппликатионлЦид**и **мсиоффицелЦид** не заданы, проверьте значение реестра **дллпасекс** . Если заданы ключи, **фжеткомпонентпас** предоставляет путь к реализации MAPI клиентом. 
  
## <a name="implementing-the-mapi-client-lookup-algorithm"></a>Реализация алгоритма поиска клиентов MAPI

В следующей таблице перечислены четыре функции MFCMAPI, которые используются для поиска пути для пользовательской реализации MAPI:
  
|**Function**|**Описание**|
|:-----|:-----|
| `GetMAPIPath` <br/> |Получает путь к библиотеке MAPI.  <br/> |
| `GetMailKey` <br/> |Возвращает раздел почтового ящика MAPI.  <br/> |
| `GetMapiMsiIds` <br/> |Получает идентификатор установщика Windows.  <br/> |
| `GetComponentPath` <br/> |Получает путь к компоненту с помощью [фжеткомпонентпас](fgetcomponentpath.md).  <br/> |
   
Так как MFCMAPI загружает стандартную по умолчанию MAPI по умолчанию, если вы хотите использовать другую реализацию MAPI, необходимо явно направлять ее. Это выполняется с помощью процедуры **MAPI сессион\лоад** . 
  
### <a name="how-these-functions-work"></a>Принципы работы этих функций

1. Вызовы `GetMAPIPath`MFCMAPI, передающие значение NULL для параметра Client, для загрузки реализации MAPI по умолчанию.
    
2.  `GetMAPIPath`вызывает `GetMapiMsiIds` чтение значений для **мсикомпонентид**, **мсиаппликатионлЦид**и **мсиоффицелЦид**.
    
3.  `GetMapiMsiIds`вызывает `GetMailKey` открытие раздела реестра для почтового клиента по умолчанию. 
    
4.  `GetMapiMsiIds`использует дескриптор реестра, возвращенный `GetMailKey` для поиска значений для **мсикомпонентид**, **мсиаппликатионлЦид**и **мсиоффицелЦид**.
    
5. Возвращаются значения для **мсикомпонентид**, **мсиаппликатионлЦид**и **мсиоффицелЦид** `GetMAPIPath`.  `GetMAPIPath`затем передает их в `GetComponentPath`.
    
6.  `GetComponentPath`загружает библиотеку-заглушку MAPI (MAPI32. dll) из системного каталога. 
    
7.  `GetComponentPath`затем получает адрес функции **фжеткомпонентпас** из MAPI32. dll, предполагая, что MAPI32. DLL экспортирует **фжеткомпонентпас**.
    
8. При сбое получения адреса **фжеткомпонентпас** из MAPI32. dll `GetComponentPath` извлекается адрес из мапистуб. dll. 
    
9.  `GetComponentPath`затем вызывает **фжеткомпонентпас**, получая путь к версии MAPI по умолчанию.
    
10.  `GetMAPIPath`затем возвращает этот путь к вызывающему абоненту, который затем загружает MAPI и явно ссылается на него, как описано в статье [links to MAPI functions](how-to-link-to-mapi-functions.md).
    
> [!NOTE] 
> - Для поддержки локализованных копий MAPI для английских и не английских языковых стандартов `GetMAPIPath` считываются значения подразделов **мсиаппликатионлЦид** и **мсиоффицелЦид** .  `GetMAPIPath`затем вызывает **фжеткомпонентпас**, сначала задавая **мсиаппликатионлЦид** как **Сзкуалифиер**, и повторно указывая **мсиоффицелЦид** как **сзкуалифиер**. Дополнительные сведения о разделах реестра для почтовых клиентов, поддерживающих языки, отличные от английского, приведены [в разделе Настройка разделов MSI для библиотеки MAPI](https://msdn.microsoft.com/library/ee909494%28VS.85%29.aspx).   
> - Если MFCMAPI не получает путь для MAPI using `GetMAPIPath`, он загружает библиотеку заглушки MAPI из системного каталога.
> - Значение реестра **Мсмапиаппс** , описываемое в явном соПоставлении [вызовов MAPI с БИБЛИОТЕКАми DLL MAPI](https://msdn.microsoft.com/library/ee909490%28VS.85%29.aspx) , применяется только при использовании библиотеки-заглушки MAPI. Приложения, которые загружают конкретную реализацию MAPI или загружают реализацию по умолчанию, не обязательно устанавливать раздел реестра **мсмапиаппс** . 
    
## <a name="see-also"></a>См. также

- [FGetComponentPath](fgetcomponentpath.md)
- [Общие сведения о программировании MAPI](mapi-programming-overview.md)
- [Ссылки на функции MAPI](how-to-link-to-mapi-functions.md)
- [Параметры реестра для заглушки MAPI32. dll](https://msdn.microsoft.com/library/ms531218%28EXCHG.10%29.aspx)
- [Настройка ключей MSI для библиотеки MAPI](https://msdn.microsoft.com/library/ee909494%28VS.85%29.aspx)
- [Явное сопоставление вызовов MAPI с библиотеками DLL MAPI](https://msdn.microsoft.com/library/ee909490%28VS.85%29.aspx)


---
title: Завершение сеанса MAPI
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: ca153737-75dc-426a-a410-7a7ab3264f23
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: 74c2a7247df02570761247a9e4a6fae378f37312
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32287155"
---
# <a name="ending-a-mapi-session"></a>Завершение сеанса MAPI

  
  
**Область применения**: Outlook 2013 | Outlook 2016 
  
Клиенты могут завершать свои сеансы в ответ на запрос пользователя либо сразу же, либо после того, как все исходящие сообщения будут обработаны, а также при возникновении критической ошибки. Для некоторых клиентов необходимо оставаться в системе, чтобы ожидающие исходящие сообщения могли получить доступ к поставщику транспорта и конечной системе обмена сообщениями. Если такой клиент отправляет сообщение и сразу же выходит из нее, сообщение может находиться в исходящей очереди до тех пор, пока пользователь не войдет в систему и не войдет в систему достаточно долго для передачи сообщения.
  
 **Когда необходимо завершить сеанс с подсистемой MAPI**
  
1. Отмените регистрацию для всех уведомлений, вызвав метод **unadvise** каждого зарегистрированного объекта. 
    
2. Освободите все открытые объекты, вызвав их методы [IUnknown:: Release](https://msdn.microsoft.com/library/ms682317%28VS.85%29.aspx) . Типы открытых объектов могут включать приемники уведомлений, таблицу состояния, папку "исХодящие", одно или несколько хранилищ сообщений и адресную книгу. 
    
3. ВыЗовите [мапифрибуффер](mapifreebuffer.md) , чтобы освободить память для всех кэшированных идентификаторов записей, таких как **пр_ипм_субтри_ентрид** ([PidTagIpmSubtreeEntryId](pidtagipmsubtreeentryid-canonical-property.md)).
    
4. Call [IMAPISession:: logoff](imapisession-logoff.md), установка флага мапи_логофф_уи, если вы разрешите пользовательский интерфейс и флаг мапи_логофф_шаред, если вы владеете текущим общим сеансом. **Выход из системы** уведомляет всех остальных клиентов, использующих текущий общий сеанс, которые должны выйти из системы, отправив уведомление об ошибке. 
    
5. Освободите указатель сеанса, вызвав метод **IUnknown:: Release** сеанса. 
    
6. Если вы вызвали [олеинитиализе](https://msdn.microsoft.com/library/ms690134%28v=VS.85%29.aspx) во время запуска сеанса для инициализации библиотек OLE, теперь вызовите их, вызвав [олеунинитиализе](https://msdn.microsoft.com/library/ms691326%28VS.85%29.aspx). Только клиенты, вызываемые **олеинитиализе** , должны вызывать **олеунинитиализе**. 
    
7. Инициализируйте библиотеки MAPI, вызвав [мапиунинитиализе](mapiuninitialize.md). Если вы вызвали **олеинитиализе** в некоторый момент, убедитесь, что вызов **олеунинитиализе** происходит перед этим вызовом **мапиунинитиализе**. Время имеет решающее значение. Если при вызове **олеунинитиализе** вызывается метод **мапиунинитиализе**, клиент может завершиться некорректно. 
    
8. Если во время запуска сеанса вызывается [сЦинитмапиутил](scinitmapiutil.md) для инициализации библиотеки служебной программы MAPI, его можно деинициализировать, вызвав [деинитмапиутил](deinitmapiutil.md). Только клиенты, вызываемые **сЦинитмапиутил** , должны вызывать **деинитмапиутил**.
    
> [!NOTE]
> Все открытые объекты должны быть выпущены перед вызовом **IMAPISession:: logoff**. Объекты, которые остались открытыми после **выхода из системы** , становятся недопустимыми; они не могут принимать звонки и не могут быть освобождены. Если выполняется вызов одного из этих объектов, ожидается, что вызов завершается с ошибками. 
  
 В MAPI отсутствует механизм для удаления библиотек DLL в процессе завершения сеанса. БИБЛИОТЕКУ DLL поставщика услуг можно удалить только в том случае, если клиент конфигурации, например панель управления, вызывает функцию точки входа службы сообщений с событием МСГ_СЕРВИЦЕ_ИНСТАЛЛ. 
  


---
title: Завершение сеанса MAPI
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: ca153737-75dc-426a-a410-7a7ab3264f23
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: e8fa8df4e1439db3f1bc688d282e5ebdd3503024
ms.sourcegitcommit: 0cf39e5382b8c6f236c8a63c6036849ed3527ded
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2018
ms.locfileid: "22575506"
---
# <a name="ending-a-mapi-session"></a>Завершение сеанса MAPI

  
  
**Применимо к**: Outlook 2013 | Outlook 2016 
  
Клиенты могут завершить их сеансов в ответ на запрос пользователя, либо сразу же или обработки после всех исходящих сообщений и когда происходит критическая ошибка. Некоторые клиенты необходимость всегда оставаться на вход в систему, ожидающие исходящих сообщений можно сделать доступными поставщика транспорта и назначение системы обмена сообщениями. Если такой клиент отправляет сообщение и немедленно выходит из системы, сообщение может оставаться в очереди исходящих сообщений, пока пользователь входит задний план и остается выполнившего вход достаточно времени для сообщения для передачи.
  
 **Когда следует завершить сеанс с подсистемой MAPI**
  
1. Отмена регистрации для всех уведомлений путем вызова метода **Unadvise** всех зарегистрированных объектов. 
    
2. Освобождение всех открытых объектов, вызвав их [функции IUnknown::Release](http://msdn.microsoft.com/en-us/library/ms682317%28VS.85%29.aspx) методы. Типы объектов, open может включать уведомить приемники, в таблице состояния, папке Исходящие, один или несколько хранилищ сообщений и адресной книги. 
    
3. Вызовите [MAPIFreeBuffer](mapifreebuffer.md) , чтобы освободить память для каких-либо идентификаторов кэшированной записи, такие как **PR_IPM_SUBTREE_ENTRYID** ([PidTagIpmSubtreeEntryId](pidtagipmsubtreeentryid-canonical-property.md)).
    
4. Вызовите [IMAPISession::Logoff](imapisession-logoff.md), установка флага MAPI_LOGOFF_UI, если вы включили пользовательского интерфейса и флаг MAPI_LOGOFF_SHARED, если у вас есть Текущий совместный сеанс. **Выход из системы** уведомляет все другие клиенты, использующие текущий совместный сеанс, необходимо выйти, отправив уведомление об ошибке. 
    
5. Выпуск указатель сеанса, вызвав метод **функции IUnknown::Release** сеанса. 
    
6. Если [OleInitialize](http://msdn.microsoft.com/en-us/library/ms690134%28v=VS.85%29.aspx) вызван при запуске сеанса для инициализации библиотеки OLE, выполнении отмены инициализации их теперь путем вызова [OleUninitialize](http://msdn.microsoft.com/en-us/library/ms691326%28VS.85%29.aspx). Только клиенты, которые вызвали **OleInitialize** необходимо вызвать **OleUninitialize**. 
    
7. Выполнении отмены инициализации библиотеки MAPI путем вызова [MAPIUninitialize](mapiuninitialize.md). Если **OleInitialize** вызван в определенный момент, убедитесь в том, что **OleUninitialize** вызывается до этого вызова **MAPIUninitialize**. Важно правильно выбрать время. Если вызов **OleUninitialize** за вызов **MAPIUninitialize**, клиент может завершить ungracefully. 
    
8. Если [ScInitMapiUtil](scinitmapiutil.md) вызван при запуске сеанса для инициализации библиотеки служебной программы MAPI, выполнении отмены инициализации его теперь путем вызова [DeinitMapiUtil](deinitmapiutil.md). Только клиенты, которые вызвали **ScInitMapiUtil** необходимо вызвать **DeinitMapiUtil**.
    
> [!NOTE]
> Все открытые объекты освобождается до вызова **IMAPISession::Logoff**. Объекты, которые остаются открытыми после **выхода из системы** становятся недействительными; они не могут принимать вызовы и никогда не может быть освободить. Если вызов выполняется одно из этих объектов, согласно прогнозу, вызов к ошибке. 
  
 MAPI не имеет механизма для удаления библиотеки DLL при завершении сеанса работы. Служба библиотеку DLL поставщика можно удалить только при вызове его сообщения службы функцию точки входа с событием MSG_SERVICE_INSTALL клиентом конфигурации например панель управления. 
  


---
title: Окончание сеанса MAPI
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: ca153737-75dc-426a-a410-7a7ab3264f23
description: 'Дата последнего изменения: 23 июля 2011 г.'
ms.openlocfilehash: 74c2a7247df02570761247a9e4a6fae378f37312
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32287155"
---
# <a name="ending-a-mapi-session"></a>Окончание сеанса MAPI

  
  
**Область применения**: Outlook 2013 | Outlook 2016 
  
Клиенты могут закончить сеансы в ответ на запрос пользователя, как сразу, так и после обработки всех исходящие сообщения, а также при критической ошибке. Некоторые клиенты должны оставаться в журнале, чтобы ожидающие исходящие сообщения могли доехать до поставщика транспорта и системы обмена сообщениями назначения. Если такой клиент отправляет сообщение и немедленно выходит из нее, сообщение может оставаться в исходя из очереди до тех пор, пока пользователь не вернется в систему и не будет входить в систему достаточно долго, чтобы сообщение было передано.
  
 **При необходимости завершить сеанс с помощью подсистемы MAPI**
  
1. Отмените регистрации для всех уведомлений, позвонив **методу Unadvise** для каждого зарегистрированного объекта. 
    
2. Отпустите все открытые объекты, назвав их [методы IUnknown::Release.](https://msdn.microsoft.com/library/ms682317%28VS.85%29.aspx) Типы открытых объектов могут включать приемники рекомендации, таблицу состояния, папку "Избокс", один или несколько магазинов сообщений и адресную книгу. 
    
3. Вызов [MAPIFreeBuffer,](mapifreebuffer.md) чтобы освободить память для любых кэшных идентификаторов записей, **таких** как PR_IPM_SUBTREE_ENTRYID [(PidTagIpmSubtreeEntryId).](pidtagipmsubtreeentryid-canonical-property.md)
    
4. [Вызывайте IMAPISession::Logoff](imapisession-logoff.md), устанавливая флаг MAPI_LOGOFF_UI, если вы разрешаете пользовательский интерфейс и флаг MAPI_LOGOFF_SHARED, если у вас есть текущий общий сеанс. **Logoff** сообщает всем другим клиентам, использующим текущий общий сеанс, что они должны выйти из системы, отправив уведомление об ошибке. 
    
5. Отпустите указатель сеанса, назвав метод **IUnknown::Release** сеанса. 
    
6. Если вы вызвали [OleInitialize](https://msdn.microsoft.com/library/ms690134%28v=VS.85%29.aspx) во время запуска сеанса, чтобы инициализировать библиотеки OLE, униниализайте их сейчас, позвонив [в OleUninitialize](https://msdn.microsoft.com/library/ms691326%28VS.85%29.aspx). Только клиенты, которые вызвали **OleInitialize,** должны вызывать **OleUninitialize.** 
    
7. Униниализать библиотеки MAPI, позвонив [в MAPIUninitialize.](mapiuninitialize.md) Если вы вызвали **OleInitialize** в какой-то момент, убедитесь, что вызов **OleUninitialize** происходит до этого вызова **MAPIUninitialize**. Важное значение имеет время. Если вызов **OleUninitialize** следует **вызову MAPIUninitialize,** клиент может завершиться неграцессно. 
    
8. Если вы вызвали [ScInitMapiUtil](scinitmapiutil.md) во время запуска сеанса, чтобы инициализировать библиотеку утилиты MAPI, унинициализировать ее сейчас, позвонив [DeinitMapiUtil](deinitmapiutil.md). Только клиенты, которые вызвали **ScInitMapiUtil,** должны вызывать **DeinitMapiUtil.**
    
> [!NOTE]
> Все открытые объекты должны быть выпущены перед вызовом **в IMAPISession::Logoff**. Объекты, которые остаются открытыми после того, как **logoff** называется, становятся недействительными; они не могут принимать звонки и могут никогда не быть освобождены. Если к одному из этих объектов будет выполнен вызов, ожидайте сбой вызова. 
  
 MAPI не имеет механизма удаления DLLs во время завершения сеанса. DLL поставщика услуг может быть удалена только в том случае, если клиент конфигурации, например панель управления, вызывает функцию точки входа службы сообщений с MSG_SERVICE_INSTALL событием. 
  


---
title: Реализация метода FlushQueues
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 8719f8aa-a537-4253-b67d-c4d38c40472b
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: baafd8b6437f4febaee9420b274c20ba3242cae6
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2018
ms.locfileid: "19809340"
---
# <a name="implementing-the-flushqueues-method"></a>Реализация метода FlushQueues

  
  
**Относится к**: Outlook 
  
Диспетчер очереди MAPI использует метод [IXPLogon::FlushQueues](ixplogon-flushqueues.md) для загрузки и передать все ожидающие сообщения, чтобы и от поставщика транспорта. Как правило диспетчер очереди MAPI будет Очистка очереди для всех транспорта поставщиков, зарегистрированных в сеансе, начиная с первого поставщика транспорта, как указано в разделе порядок транспорта профиля пользователя. Очистка очереди почти всегда производится в результате прямого запроса пользователем, поэтому отправку и получение сообщений во время очистки очереди синхронные диспетчер очереди MAPI. Так как эти вызовы являются синхронными, поставщика транспорта их обработки как можно скорее. 
  
Поставщики транспорта должен обрабатывать вызова **FlushQueues** как описано в следующей последовательности шагов для включения обработки соответствующее сообщение и для включения внешних ресурсов, таких как модема для использования с другими поставщиками транспорта в составе диспетчер очереди MAPI Операция **FlushQueues** . 
  
|**Этап**|**Компонент**|**Реализация**|
|:-----|:-----|:-----|
|1.  <br/> |Диспетчер очереди MAPI  <br/> |Вызывает метод **FlushQueues** для первого поставщика транспорта в списке транспортный профиль пользователя, передав запрошенные флаги с помощью параметра _ulFlags_ . **FlushQueues** вызывается один раз с все флаги для всей отправки и загрузки операции.  <br/> |
|2.  <br/> |Поставщик транспорта  <br/> |Необходимо выполнить ряд операций до возвращения из вызова **FlushQueues** . Если ранее отправивший отложенное сообщения, метод [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) должна вызываться с установленным флагом NOTIFY_SENT_DEFERRED. Обратите внимание, что существует возможность диспетчер очереди MAPI для отмены сообщение, в котором был отложен до поставщика транспорта имеет возможность окончания обработки сообщения.  <br/> Если поставщик транспорта использует внешний ресурс, например модем, необходимо установить подключение с внешним ресурсом.  <br/> STATUS_OUTBOUND_FLUSH бит в свойстве **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) из строки состояния поставщика транспорта должен иметь значение с помощью метода [IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md) .  <br/> Затем поставщика транспорта должен возвращать значение S_OK для вызова **FlushQueues** .  <br/> |
|3.  <br/> |Диспетчер очереди MAPI  <br/> |Проверяет, поставщика транспорта строке состояния для разрядной STATUS_OUTBOUND_FLUSH и вызывает [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) для первого сообщения в очереди.  <br/> |
|4.  <br/> |Поставщик транспорта  <br/> |Обрабатывает сообщение и возвращает **SubmitMessage** звонок.  <br/> |
|5.  <br/> |Диспетчер очереди MAPI  <br/> |Если поставщик транспорта возвращает значение S_OK из **SubmitMessage**, диспетчер очереди MAPI вызывает [IXPLogon::EndMessage](ixplogon-endmessage.md) сообщение как в случае с Отправка регулярных сообщений.  <br/> Если поставщик транспорта возвращает значение, отличное от S_OK из **SubmitMessage**, диспетчер очереди MAPI обрабатывает значение надлежащим образом до вызова метода **EndMessage**или до вызова метода **SubmitMessage** еще раз.  <br/> |
|6.  <br/> |Поставщик транспорта  <br/> |Возвращает **EndMessage** с его состояния с помощью параметра _lpulFlags_ обработки сообщений.  <br/> |
|7.  <br/> |Поставщик очереди и транспорта MAPI  <br/> |**SubmitMessage**- **EndMessage** цикл продолжается, пока не были загружены все сообщения в очереди.  <br/> |
|8.  <br/> |Диспетчер очереди MAPI  <br/> |Уведомляет поставщика транспорта о завершении загрузки сообщений с помощью метода [IXPLogon::TransportNotify](ixplogon-transportnotify.md) поставщика транспорта с установленным флагом NOTIFY_END_OUTBOUND_FLUSH.  <br/> |
|9.  <br/> |Поставщик транспорта  <br/> |Освобождает внешние ресурсы, используемые при отправке исходящих сообщений, поэтому их можно использовать с другими поставщиками транспорта Очистка свои очереди.  <br/> С помощью **ModifyStatusRow**должно иметь значение STATUS_INBOUND_FLUSH бит в свойстве **PR_STATUS_CODE** строки состояния поставщика транспорта.  <br/> |
|10.  <br/> |Диспетчер очереди MAPI  <br/> |Проверяет строке состояния поставщика транспорта для разрядной STATUS_INBOUND_FLUSH и вызывает [IXPLogon::StartMessage](ixplogon-startmessage.md) , если оно установлено.  <br/> |
|11.  <br/> |Поставщик транспорта  <br/> |Обрабатывает сообщение и возвращает **StartMessage**. Если поставщика транспорта других сообщений для загрузки, он должен вызвать **SpoolerNotify** с установленным флагом NOTIFY_NEWMAIL.  <br/> Если поставщик транспорта не содержит сообщений для загрузки, он должен вызвать [IMAPIProp::SaveChanges](imapiprop-savechanges.md) в окне сообщения, диспетчер очереди MAPI передается в **StartMessage** и возврата.  <br/> |
|12.  <br/> |Диспетчер очереди MAPI  <br/> |По-прежнему производится вызов **StartMessage** , пока не будет вызван **SaveChanges** на сообщение. После завершения загрузки поставщика транспорта диспетчер очереди MAPI вызывает **TransportNotify** с установленным флагом NOTIFY_END_INBOUND_FLUSH.  <br/> |
|13.  <br/> |Поставщик транспорта  <br/> |Очищает STATUS_INBOUND_FLUSH бит в свойстве **PR_STATUS_CODE** его с помощью **ModifyStatusRow** и все внешние ресурсы, чтобы они были доступны для использования версий строки состояния с другими поставщиками транспорта.  <br/> |
|14.  <br/> |Диспетчер очереди MAPI  <br/> |Вызывает **FlushQueues** для следующего поставщика транспорта в списке транспортный профиль пользователя.  <br/> |
   
Если приложение вызовы клиента [IMAPIStatus::FlushQueues](imapistatus-flushqueues.md) поставщика транспорта состояние объекта, поставщика транспорта следует установить соответствующий бит в строке его состояния с **ModifyStatusRow**. Затем диспетчер очереди MAPI вызывает метод **IXPLogon::FlushQueues** поставщика транспорта при удобства диспетчер очереди MAPI. Когда поставщика транспорта **IXPLogon::FlushQueues** вызывается метод из-за вызова **IMAPIStatus::FlushQueues** клиентского приложения, операция выполняется асинхронно в клиентское приложение. В противном случае **IXPLogon::FlushQueues** работает синхронно с очередью MAPI. 
  
В целях повышения производительности очереди MAPI только вызвать метод **FlushQueues** поставщика транспорта, если установлены флаги STATUS_INBOUND_FLUSH и STATUS_OUTBOUND_FLUSH в строке состояния поставщика транспорта. Следовательно поставщика транспорта остановить эту операцию **FlushQueues** в любое время, сняв флаги STATUS_OUTBOUND_FLUSH и STATUS_INBOUND_FLUSH его строке состояния. Если необходимо завершить операцию **FlushQueues** диспетчер очереди MAPI завершает работу, он вызывает **TransportNotify** с NOTIFY_END_INBOUND_FLUSH и NOTIFY_END_OUTBOUND_FLUSH набор флагов. Поставщика транспорта следует освобождения всех внешних ресурсов и возврата. 
  


---
title: Реализация метода FlushQueues
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 8719f8aa-a537-4253-b67d-c4d38c40472b
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: 1e5c78c71f7fddb04d3517aca0a34efa151ece08
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32310117"
---
# <a name="implementing-the-flushqueues-method"></a><span data-ttu-id="a56d7-103">Реализация метода FlushQueues</span><span class="sxs-lookup"><span data-stu-id="a56d7-103">Implementing the FlushQueues Method</span></span>

  
  
<span data-ttu-id="a56d7-104">**Область применения**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="a56d7-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="a56d7-105">Диспетчер очереди MAPI использует метод [иксплогон:: FlushQueues](ixplogon-flushqueues.md) для загрузки и отправки ожидающих сообщений в поставщик транспорта и из него.</span><span class="sxs-lookup"><span data-stu-id="a56d7-105">The MAPI spooler uses the [IXPLogon::FlushQueues](ixplogon-flushqueues.md) method to download and upload any pending messages to and from a transport provider.</span></span> <span data-ttu-id="a56d7-106">Как правило, диспетчер очереди MAPI очищает очереди для всех поставщиков транспорта, которые вошли в сеанс, начиная с первого поставщика транспорта, как указано в разделе порядок транспорта в профиле пользователя.</span><span class="sxs-lookup"><span data-stu-id="a56d7-106">Typically, the MAPI spooler will flush the queues for all transport providers that are logged on to the session, starting with the first transport provider as set in the transport order section of the user's profile.</span></span> <span data-ttu-id="a56d7-107">Очистка очередей почти всегда является результатом непосредственных запросов пользователя, поэтому отправка и получение сообщений при очистке очередей происходит синхронно с диспетчером MAPI.</span><span class="sxs-lookup"><span data-stu-id="a56d7-107">Flushing queues is almost always the result of a direct request by the user, so the sending and receiving of messages while queues are flushing is synchronous to the MAPI spooler.</span></span> <span data-ttu-id="a56d7-108">Так как эти вызовы синхронны, поставщик транспорта должен как можно быстрее обработать их.</span><span class="sxs-lookup"><span data-stu-id="a56d7-108">Because these calls are synchronous, the transport provider should process them as quickly as possible.</span></span> 
  
<span data-ttu-id="a56d7-109">Поставщики транспорта должны обработать вызов **FlushQueues** , как описано в следующей последовательности действий, чтобы включить правильную обработку сообщений и разрешить использование внешних ресурсов, таких как модемы, в составе ДИСПЕТЧЕРА очереди MAPI Операция **FlushQueues** .</span><span class="sxs-lookup"><span data-stu-id="a56d7-109">Transport providers must handle the **FlushQueues** call as described in the following sequence of steps to enable proper message processing and to enable external resources such as modems to be used by other transport providers as part of the MAPI spooler's **FlushQueues** operation.</span></span> 
  
|<span data-ttu-id="a56d7-110">**Шаг**</span><span class="sxs-lookup"><span data-stu-id="a56d7-110">**Step**</span></span>|<span data-ttu-id="a56d7-111">**Компонент**</span><span class="sxs-lookup"><span data-stu-id="a56d7-111">**Component**</span></span>|<span data-ttu-id="a56d7-112">**Реализация**</span><span class="sxs-lookup"><span data-stu-id="a56d7-112">**Implementation**</span></span>|
|:-----|:-----|:-----|
|<span data-ttu-id="a56d7-113">1.</span><span class="sxs-lookup"><span data-stu-id="a56d7-113">1.</span></span>  <br/> |<span data-ttu-id="a56d7-114">Диспетчер очереди MAPI</span><span class="sxs-lookup"><span data-stu-id="a56d7-114">MAPI spooler</span></span>  <br/> |<span data-ttu-id="a56d7-115">Вызывает метод **FlushQueues** для первого поставщика транспорта, указанного в порядке транспорта в профиле пользователя, передавая запрошенные флаги в параметре _ulFlags_ .</span><span class="sxs-lookup"><span data-stu-id="a56d7-115">Calls the **FlushQueues** method for the first transport provider listed in the transport order of the user's profile, passing the requested flags in the  _ulFlags_ parameter.</span></span> <span data-ttu-id="a56d7-116">**FlushQueues** вызывается один раз со всеми флагами, установленными для всей операции отправки и загрузки.</span><span class="sxs-lookup"><span data-stu-id="a56d7-116">**FlushQueues** is called once with all flags set for the entire upload and download operation.</span></span>  <br/> |
|<span data-ttu-id="a56d7-117">2.</span><span class="sxs-lookup"><span data-stu-id="a56d7-117">2.</span></span>  <br/> |<span data-ttu-id="a56d7-118">Поставщик транспорта</span><span class="sxs-lookup"><span data-stu-id="a56d7-118">Transport Provider</span></span>  <br/> |<span data-ttu-id="a56d7-119">Необходимо выполнить ряд действий перед возвратом из вызова **FlushQueues** .</span><span class="sxs-lookup"><span data-stu-id="a56d7-119">Needs to do a number of things before returning from the **FlushQueues** call.</span></span> <span data-ttu-id="a56d7-120">Если отправляются ранее отправленные сообщения, метод [имаписуппорт:: спулернотифи](imapisupport-spoolernotify.md) должен вызываться с установленным флагом нотифи_сент_деферред.</span><span class="sxs-lookup"><span data-stu-id="a56d7-120">If previously submitted messages are being deferred, the [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) method should be called with the NOTIFY_SENT_DEFERRED flag set.</span></span> <span data-ttu-id="a56d7-121">Обратите внимание, что диспетчер очереди MAPI может отменить сообщение, которое было отложено до того, как поставщик транспорта сможет завершить обработку сообщения.</span><span class="sxs-lookup"><span data-stu-id="a56d7-121">Note that it is possible for the MAPI spooler to cancel a message that has been deferred before the transport provider has a chance to finish processing the message.</span></span>  <br/> <span data-ttu-id="a56d7-122">Если поставщик транспорта использует внешний ресурс, такой как модем, необходимо установить подключение к внешнему ресурсу.</span><span class="sxs-lookup"><span data-stu-id="a56d7-122">If the transport provider uses an external resource such as a modem, the connection to the external resource should be established.</span></span>  <br/> <span data-ttu-id="a56d7-123">Бит СТАТУС_АУТБАУНД_ФЛУШ в свойстве **пр_статус_коде** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) в строке состояния поставщика транспорта необходимо задать с помощью метода [имаписуппорт:: модифистатусров](imapisupport-modifystatusrow.md) .</span><span class="sxs-lookup"><span data-stu-id="a56d7-123">The STATUS_OUTBOUND_FLUSH bit in the **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) property of the transport provider's status row must be set using the [IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md) method.</span></span>  <br/> <span data-ttu-id="a56d7-124">Затем поставщик транспорта возвращает значение S_OK для вызова **FlushQueues** .</span><span class="sxs-lookup"><span data-stu-id="a56d7-124">The transport provider should then return S_OK for the **FlushQueues** call.</span></span>  <br/> |
|<span data-ttu-id="a56d7-125">3.</span><span class="sxs-lookup"><span data-stu-id="a56d7-125">3.</span></span>  <br/> |<span data-ttu-id="a56d7-126">Диспетчер очереди MAPI</span><span class="sxs-lookup"><span data-stu-id="a56d7-126">MAPI spooler</span></span>  <br/> |<span data-ttu-id="a56d7-127">Проверяет строку состояния поставщика транспорта для бита СТАТУС_АУТБАУНД_ФЛУШ и вызывает [иксплогон:: субмитмессаже](ixplogon-submitmessage.md) для первого сообщения в очереди.</span><span class="sxs-lookup"><span data-stu-id="a56d7-127">Checks the transport provider's status row for the STATUS_OUTBOUND_FLUSH bit and calls [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) for the first message in the queue.</span></span>  <br/> |
|<span data-ttu-id="a56d7-128">4.</span><span class="sxs-lookup"><span data-stu-id="a56d7-128">4.</span></span>  <br/> |<span data-ttu-id="a56d7-129">Поставщик транспорта</span><span class="sxs-lookup"><span data-stu-id="a56d7-129">Transport provider</span></span>  <br/> |<span data-ttu-id="a56d7-130">Обрабатывает сообщение и возвращается из вызова **субмитмессаже** .</span><span class="sxs-lookup"><span data-stu-id="a56d7-130">Handles the message and returns from the **SubmitMessage** call.</span></span>  <br/> |
|<span data-ttu-id="a56d7-131">5.</span><span class="sxs-lookup"><span data-stu-id="a56d7-131">5.</span></span>  <br/> |<span data-ttu-id="a56d7-132">Диспетчер очереди MAPI</span><span class="sxs-lookup"><span data-stu-id="a56d7-132">MAPI spooler</span></span>  <br/> |<span data-ttu-id="a56d7-133">Если поставщик транспорта возвращает значение S_OK из **субмитмессаже**, то диспетчер очереди MAPI вызывает [Иксплогон:: ендмессаже](ixplogon-endmessage.md) для сообщения, как в случае с обычной отправкой сообщений.</span><span class="sxs-lookup"><span data-stu-id="a56d7-133">If the transport provider returns S_OK from **SubmitMessage**, the MAPI spooler calls [IXPLogon::EndMessage](ixplogon-endmessage.md) for the message as it does with regular message sending.</span></span>  <br/> <span data-ttu-id="a56d7-134">Если поставщик транспорта возвращает значение, отличное от S_OK, в **субмитмессаже**, то диспетчер очереди MAPI обрабатывает значение до вызова **ендмессаже**или до повторного вызова **субмитмессаже** .</span><span class="sxs-lookup"><span data-stu-id="a56d7-134">If the transport provider returns a value other than S_OK from **SubmitMessage**, the MAPI spooler handles the value appropriately before calling **EndMessage**, or before calling **SubmitMessage** again.</span></span>  <br/> |
|<span data-ttu-id="a56d7-135">6.</span><span class="sxs-lookup"><span data-stu-id="a56d7-135">6.</span></span>  <br/> |<span data-ttu-id="a56d7-136">Поставщик транспорта</span><span class="sxs-lookup"><span data-stu-id="a56d7-136">Transport provider</span></span>  <br/> |<span data-ttu-id="a56d7-137">Возвращает из **ендмессаже** с состоянием обработки сообщения в параметре _лпулфлагс_ .</span><span class="sxs-lookup"><span data-stu-id="a56d7-137">Returns from **EndMessage** with its message processing status in the  _lpulFlags_ parameter.</span></span>  <br/> |
|<span data-ttu-id="a56d7-138">7.</span><span class="sxs-lookup"><span data-stu-id="a56d7-138">7.</span></span>  <br/> |<span data-ttu-id="a56d7-139">Диспетчер очереди MAPI и поставщик транспорта</span><span class="sxs-lookup"><span data-stu-id="a56d7-139">MAPI spooler and transport provider</span></span>  <br/> |<span data-ttu-id="a56d7-140">Цикл \*\*\*\*- **ендмессаже** субмитмессаже продолжается до тех пор, пока все сообщения в очереди не будут загружены.</span><span class="sxs-lookup"><span data-stu-id="a56d7-140">The **SubmitMessage**- **EndMessage** loop continues until all messages in the queue have been downloaded.</span></span>  <br/> |
|<span data-ttu-id="a56d7-141">8.</span><span class="sxs-lookup"><span data-stu-id="a56d7-141">8.</span></span>  <br/> |<span data-ttu-id="a56d7-142">Диспетчер очереди MAPI</span><span class="sxs-lookup"><span data-stu-id="a56d7-142">MAPI spooler</span></span>  <br/> |<span data-ttu-id="a56d7-143">Уведомляет поставщика транспорта о том, что загрузка сообщений завершена путем вызова метода [иксплогон:: транспортнотифи](ixplogon-transportnotify.md) поставщика транспорта с установленным флагом нотифи_енд_аутбаунд_флуш.</span><span class="sxs-lookup"><span data-stu-id="a56d7-143">Notifies the transport provider that it has finished downloading messages by calling the transport provider's [IXPLogon::TransportNotify](ixplogon-transportnotify.md) method with the NOTIFY_END_OUTBOUND_FLUSH flag set.</span></span>  <br/> |
|<span data-ttu-id="a56d7-144">9.</span><span class="sxs-lookup"><span data-stu-id="a56d7-144">9.</span></span>  <br/> |<span data-ttu-id="a56d7-145">Поставщик транспорта</span><span class="sxs-lookup"><span data-stu-id="a56d7-145">Transport provider</span></span>  <br/> |<span data-ttu-id="a56d7-146">Освобождает все внешние ресурсы, используемые для отправки исходящих сообщений, чтобы их могли использовать другие поставщики транспорта для очистки очередей.</span><span class="sxs-lookup"><span data-stu-id="a56d7-146">Frees any external resources used in sending outbound messages so they can be used by other transport providers to flush their queues.</span></span>  <br/> <span data-ttu-id="a56d7-147">Бит СТАТУС_ИНБАУНД_ФЛУШ в свойстве **пр_статус_коде** в строке состояния поставщика транспорта необходимо задать с помощью **модифистатусров**.</span><span class="sxs-lookup"><span data-stu-id="a56d7-147">The STATUS_INBOUND_FLUSH bit in the **PR_STATUS_CODE** property of the transport provider's status row must be set using **ModifyStatusRow**.</span></span>  <br/> |
|<span data-ttu-id="a56d7-148">десяти.</span><span class="sxs-lookup"><span data-stu-id="a56d7-148">10.</span></span>  <br/> |<span data-ttu-id="a56d7-149">Диспетчер очереди MAPI</span><span class="sxs-lookup"><span data-stu-id="a56d7-149">MAPI spooler</span></span>  <br/> |<span data-ttu-id="a56d7-150">Проверяет строку состояния поставщика транспорта для бита СТАТУС_ИНБАУНД_ФЛУШ и вызывает [иксплогон:: стартмессаже](ixplogon-startmessage.md) , если она задана.</span><span class="sxs-lookup"><span data-stu-id="a56d7-150">Checks the transport provider's status row for the STATUS_INBOUND_FLUSH bit and calls [IXPLogon::StartMessage](ixplogon-startmessage.md) if it is set.</span></span>  <br/> |
|<span data-ttu-id="a56d7-151">-11:00.</span><span class="sxs-lookup"><span data-stu-id="a56d7-151">11.</span></span>  <br/> |<span data-ttu-id="a56d7-152">Поставщик транспорта</span><span class="sxs-lookup"><span data-stu-id="a56d7-152">Transport provider</span></span>  <br/> |<span data-ttu-id="a56d7-153">Обрабатывает сообщение и возвращает из **стартмессаже**.</span><span class="sxs-lookup"><span data-stu-id="a56d7-153">Processes the message and returns from **StartMessage**.</span></span> <span data-ttu-id="a56d7-154">Если у поставщика транспорта есть другие сообщения для отправки, он должен вызвать **спулернотифи** с установленным флагом нотифи_невмаил.</span><span class="sxs-lookup"><span data-stu-id="a56d7-154">If the transport provider has other messages to upload, it should call **SpoolerNotify** with the NOTIFY_NEWMAIL flag set.</span></span>  <br/> <span data-ttu-id="a56d7-155">Если у поставщика транспорта нет сообщений для отправки, он должен вызывать [IMAPIProp:: SaveChanges](imapiprop-savechanges.md) сообщения, переданные в **стартмессаже** и возвращаемые в очередь MAPI.</span><span class="sxs-lookup"><span data-stu-id="a56d7-155">If the transport provider has no messages to upload, it should call [IMAPIProp::SaveChanges](imapiprop-savechanges.md) on the message the MAPI spooler passed in **StartMessage** and return.</span></span>  <br/> |
|<span data-ttu-id="a56d7-156">12.</span><span class="sxs-lookup"><span data-stu-id="a56d7-156">12.</span></span>  <br/> |<span data-ttu-id="a56d7-157">Диспетчер очереди MAPI</span><span class="sxs-lookup"><span data-stu-id="a56d7-157">MAPI spooler</span></span>  <br/> |<span data-ttu-id="a56d7-158">Продолжает вызывать **стартмессаже** , пока не будет вызван метод **SaveChanges** для сообщения.</span><span class="sxs-lookup"><span data-stu-id="a56d7-158">Continues calling **StartMessage** until **SaveChanges** is called on a message.</span></span> <span data-ttu-id="a56d7-159">После того как поставщик транспорта завершит отправку, диспетчер очереди MAPI вызывает **транспортнотифи** с установленным флагом нотифи_енд_инбаунд_флуш.</span><span class="sxs-lookup"><span data-stu-id="a56d7-159">After the transport provider has finished uploading, the MAPI spooler calls **TransportNotify** with the NOTIFY_END_INBOUND_FLUSH flag set.</span></span>  <br/> |
|<span data-ttu-id="a56d7-160">13.</span><span class="sxs-lookup"><span data-stu-id="a56d7-160">13.</span></span>  <br/> |<span data-ttu-id="a56d7-161">Поставщик транспорта</span><span class="sxs-lookup"><span data-stu-id="a56d7-161">Transport provider</span></span>  <br/> |<span data-ttu-id="a56d7-162">Очищает бит СТАТУС_ИНБАУНД_ФЛУШ в свойстве **пр_статус_коде** строки состояния с помощью **модифистатусров** и освобождает все внешние ресурсы, чтобы они были доступны для использования другими поставщиками транспорта.</span><span class="sxs-lookup"><span data-stu-id="a56d7-162">Clears the STATUS_INBOUND_FLUSH bit in the **PR_STATUS_CODE** property of its status row using **ModifyStatusRow** and releases all external resources so they are available for use by other transport providers.</span></span>  <br/> |
|<span data-ttu-id="a56d7-163">14.</span><span class="sxs-lookup"><span data-stu-id="a56d7-163">14.</span></span>  <br/> |<span data-ttu-id="a56d7-164">Диспетчер очереди MAPI</span><span class="sxs-lookup"><span data-stu-id="a56d7-164">MAPI spooler</span></span>  <br/> |<span data-ttu-id="a56d7-165">Вызывает **FlushQueues** для следующего поставщика транспорта, указанного в порядке транспорта в профиле пользователя.</span><span class="sxs-lookup"><span data-stu-id="a56d7-165">Calls **FlushQueues** for the next transport provider listed in the transport order of the user's profile.</span></span>  <br/> |
   
<span data-ttu-id="a56d7-166">Если клиентское приложение вызывает [имапистатус:: FlushQueues](imapistatus-flushqueues.md) на объекте состояния поставщика транспорта, то поставщик транспорта должен установить соответствующий бит в строке состояния с **модифистатусров**.</span><span class="sxs-lookup"><span data-stu-id="a56d7-166">If a client application calls [IMAPIStatus::FlushQueues](imapistatus-flushqueues.md) on a transport provider's status object, the transport provider should set the appropriate bit in its status row with **ModifyStatusRow**.</span></span> <span data-ttu-id="a56d7-167">После этого диспетчер очереди MAPI вызывает метод **иксплогон:: FlushQueues** поставщика транспорта в удобном для вас ДИСПЕТЧЕРЕ очереди MAPI.</span><span class="sxs-lookup"><span data-stu-id="a56d7-167">The MAPI spooler then calls the transport provider's **IXPLogon::FlushQueues** method at the MAPI spooler's convenience.</span></span> <span data-ttu-id="a56d7-168">Когда метод **иксплогон:: FlushQueues** поставщика транспорта вызывается в результате вызова **Имапистатус:: FlushQueues** клиентского приложения, операция асинхронно выполняется в клиентском приложении.</span><span class="sxs-lookup"><span data-stu-id="a56d7-168">When the transport provider's **IXPLogon::FlushQueues** method is called as a result of a client application's **IMAPIStatus::FlushQueues** call, the operation occurs asynchronously to the client application.</span></span> <span data-ttu-id="a56d7-169">В противном случае **иксплогон:: FlushQueues** работает синхронно с диспетчером очереди MAPI.</span><span class="sxs-lookup"><span data-stu-id="a56d7-169">Otherwise **IXPLogon::FlushQueues** works synchronously with the MAPI spooler.</span></span> 
  
<span data-ttu-id="a56d7-170">В целях повышения производительности Диспетчер очереди MAPI будет вызывать метод **FlushQueues** поставщика транспорта только в том случае, если в строке состояния поставщика транспорта заданы флаги СТАТУС_ИНБАУНД_ФЛУШ и статус_аутбаунд_флуш.</span><span class="sxs-lookup"><span data-stu-id="a56d7-170">For performance reasons, the MAPI spooler will only call a transport provider's **FlushQueues** method if the STATUS_INBOUND_FLUSH and STATUS_OUTBOUND_FLUSH flags are set in the transport provider's status row.</span></span> <span data-ttu-id="a56d7-171">Следовательно, поставщик транспорта может остановить операцию **FlushQueues** в любое время, сняв флаги СТАТУС_АУТБАУНД_ФЛУШ и статус_инбаунд_флуш в строке состояния.</span><span class="sxs-lookup"><span data-stu-id="a56d7-171">Consequently, a transport provider can stop the **FlushQueues** operation at any time by clearing the STATUS_OUTBOUND_FLUSH and STATUS_INBOUND_FLUSH flags in its status row.</span></span> <span data-ttu-id="a56d7-172">Если буферизация MAPI завершается и требуется завершить операцию **FlushQueues** , вызывается **транспортнотифи** с установленным флагом нотифи_енд_инбаунд_флуш и нотифи_енд_аутбаунд_флуш.</span><span class="sxs-lookup"><span data-stu-id="a56d7-172">If the MAPI spooler is shutting down and needs to end the **FlushQueues** operation, it calls **TransportNotify** with both the NOTIFY_END_INBOUND_FLUSH and NOTIFY_END_OUTBOUND_FLUSH flags set.</span></span> <span data-ttu-id="a56d7-173">Поставщик транспорта должен освободить все внешние ресурсы и вернуться.</span><span class="sxs-lookup"><span data-stu-id="a56d7-173">The transport provider should release all external resources and return.</span></span> 
  


---
title: Реализация метода FlushQueues
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 8719f8aa-a537-4253-b67d-c4d38c40472b
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: 1e5c78c71f7fddb04d3517aca0a34efa151ece08
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411780"
---
# <a name="implementing-the-flushqueues-method"></a>Реализация метода FlushQueues

  
  
**Относится к**: Outlook 2013 | Outlook 2016 
  
Пулер MAPI использует метод [IXPLogon::FlushQueues](ixplogon-flushqueues.md) для загрузки и отправки ожидающих сообщений поставщику транспорта и от него. Как правило, пул MAPI очищает очереди для всех поставщиков транспорта, во время входа в сеанс, начиная с первого поставщика транспорта, как заданная в разделе порядка транспорта профиля пользователя. Очистка очередей почти всегда является результатом прямого запроса пользователя, поэтому отправка и получение сообщений во время очистки очередей синхронно с пулом MAPI. Так как эти вызовы являются синхронными, поставщик транспорта должен обрабатывать их как можно быстрее. 
  
Поставщики транспорта должны обрабатывать вызов **FlushQueues,** как описано в следующей последовательности действий, чтобы обеспечить правильную обработку сообщений и позволить внешним ресурсам, таким как модемы, использоваться другими поставщиками транспорта в рамках операции **FlushQueues** пула MAPI. 
  
|**Этап**|**Компонент**|**Реализация**|
|:-----|:-----|:-----|
|1.  <br/> |MapI spooler  <br/> |Вызывает метод **FlushQueues** для первого поставщика транспорта, перечисленного в порядке транспорта профиля пользователя, передавая запрошенные флаги в _параметре ulFlags._ **FlushQueues** будет вызван один раз со всеми флагами, установленными для всей операции отправки и скачивания.  <br/> |
|2.  <br/> |Поставщик транспорта  <br/> |Прежде чем возвращаться из вызова **FlushQueues,** необходимо сделать несколько вещей. Если ранее отправленные сообщения откладываются, следует использовать метод [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) с установленным NOTIFY_SENT_DEFERRED флагом. Обратите внимание, что пульщик MAPI может отменить сообщение, которое было отложено до того, как поставщик транспорта может завершить обработку сообщения.  <br/> Если поставщик транспорта использует внешний ресурс, например модем, необходимо установить подключение к внешнему ресурсу.  <br/> Бит STATUS_OUTBOUND_FLUSH в **свойстве PR_STATUS_CODE** ([PidTagStatusCode)](pidtagstatuscode-canonical-property.md)строки состояния поставщика транспорта необходимо настроить с помощью метода [IMAPISupport::ModifyStatusRow.](imapisupport-modifystatusrow.md)  <br/> Затем поставщик транспорта должен вернуть S_OK для вызова **FlushQueues.**  <br/> |
|3.  <br/> |MapI spooler  <br/> |Проверяет строку состояния поставщика транспорта на наличие бита STATUS_OUTBOUND_FLUSH и вызывает [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) для первого сообщения в очереди.  <br/> |
|4.  <br/> |Поставщик транспорта  <br/> |Обрабатывает сообщение и возвращается при вызове **SubmitMessage.**  <br/> |
|5.  <br/> |MapI spooler  <br/> |Если поставщик транспорта возвращает S_OK из **SubmitMessage,** пулер MAPI вызывает [IXPLogon::EndMessage](ixplogon-endmessage.md) для сообщения так же, как и при обычной отправке сообщения.  <br/> Если поставщик транспорта возвращает значение, не S_OK **из SubmitMessage,** то пулер MAPI обрабатывает значение соответствующим образом перед вызовом **EndMessage** или перед повтором вызова **SubmitMessage.**  <br/> |
|6.  <br/> |Поставщик транспорта  <br/> |Возвращается из **EndMessage** с состоянием обработки сообщений в _параметре lpulFlags._  <br/> |
|7.  <br/> |Поставщик услуг пула и транспорта MAPI  <br/> |Цикл **SubmitMessage** -  **EndMessage** продолжается до скачивания всех сообщений в очереди.  <br/> |
|8.  <br/> |MapI spooler  <br/> |Сообщает поставщику транспорта, что он завершил загрузку сообщений, вызывая метод [IXPLogon::TransportNotify](ixplogon-transportnotify.md) поставщика транспорта с установленным NOTIFY_END_OUTBOUND_FLUSH флагом.  <br/> |
|9.  <br/> |Поставщик транспорта  <br/> |Освободит все внешние ресурсы, используемые для отправки исходящие сообщения, чтобы их могли использовать другие поставщики транспорта для очистки очередей.  <br/> Бит STATUS_INBOUND_FLUSH в свойстве **PR_STATUS_CODE** строки состояния поставщика транспорта необходимо настроить с помощью **ModifyStatusRow.**  <br/> |
|10.  <br/> |MapI spooler  <br/> |Проверяет строку состояния поставщика транспорта на наличие STATUS_INBOUND_FLUSH и вызывает [IXPLogon::StartMessage,](ixplogon-startmessage.md) если он установлен.  <br/> |
|11.  <br/> |Поставщик транспорта  <br/> |Обрабатывает сообщение и возвращается **из StartMessage.** Если у поставщика транспорта есть другие сообщения для отправки, он должен вызвать **SpoolerNotify** с установленным NOTIFY_NEWMAIL флагом.  <br/> Если у поставщика транспорта нет сообщений для отправки, он должен вызвать [IMAPIProp::SaveChanges](imapiprop-savechanges.md) в сообщении, переданное в **StartMessage** и возвращенное пулом MAPI.  <br/> |
|12.  <br/> |MapI spooler  <br/> |Продолжает вызывать **StartMessage,** пока **не будет вызвано сообщение SaveChanges.** После того как поставщик транспорта завершит отправку, пулер MAPI вызывает **TransportNotify** с установленным NOTIFY_END_INBOUND_FLUSH флагом.  <br/> |
|13.  <br/> |Поставщик транспорта  <br/> |Очищает STATUS_INBOUND_FLUSH в свойстве **PR_STATUS_CODE** строки состояния с помощью **ModifyStatusRow** и освобождает все внешние ресурсы, чтобы они были доступны для использования другими поставщиками транспорта.  <br/> |
|14.  <br/> |MapI spooler  <br/> |Вызывает **FlushQueues для** следующего поставщика транспорта, перечисленного в порядке транспорта профиля пользователя.  <br/> |
   
Если клиентский приложение вызывает [IMAPIStatus::FlushQueues](imapistatus-flushqueues.md) в объекте состояния поставщика транспорта, поставщик транспорта должен установить соответствующий бит в строке состояния с **помощью ModifyStatusRow**. Затем пульер MAPI вызывает метод **IXPLogon::FlushQueues** поставщика транспорта в удобное время. При вызове метода **IXPLogon::FlushQueues** поставщика транспорта в результате вызова **IMAPIStatus::FlushQueues** клиентского приложения операция происходит асинхронно для клиентского приложения. В **противном случае IXPLogon::FlushQueues** работает синхронно с пулером MAPI. 
  
Из соображений производительности пул MAPI будет вызывать метод **FlushQueues** поставщика транспорта, только если флаги STATUS_INBOUND_FLUSH и STATUS_OUTBOUND_FLUSH установлены в строке состояния поставщика транспорта. Следовательно, поставщик транспорта может в любое время остановить операцию **FlushQueues,** с помощью очистки флагов STATUS_OUTBOUND_FLUSH и STATUS_INBOUND_FLUSH в строке состояния. Если пулер MAPI выключается и должен закончить операцию **FlushQueues,** он вызывает **TransportNotify** с установленными NOTIFY_END_INBOUND_FLUSH и NOTIFY_END_OUTBOUND_FLUSH флагами. Поставщик транспорта должен освободить все внешние ресурсы и вернуть их. 
  


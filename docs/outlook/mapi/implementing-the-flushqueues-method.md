---
title: Реализация метода FlushQueues
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 8719f8aa-a537-4253-b67d-c4d38c40472b
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: 1e5c78c71f7fddb04d3517aca0a34efa151ece08
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411780"
---
# <a name="implementing-the-flushqueues-method"></a>Реализация метода FlushQueues

  
  
**Область применения**: Outlook 2013 | Outlook 2016 
  
Spooler MAPI использует [метод IXPLogon::FlushQueues](ixplogon-flushqueues.md) для загрузки и отправки любых ожидающих сообщений поставщику транспорта и от него. Обычно шпалер MAPI сбрасывает очереди для всех поставщиков транспорта, которые вошли в сеанс, начиная с первого поставщика транспорта, как установлено в разделе заказ транспорта профиля пользователя. Очистка очередей почти всегда является результатом прямого запроса пользователя, поэтому отправка и получение сообщений во время очистки очередей синхронна с пулером MAPI. Поскольку эти вызовы синхронны, поставщик транспорта должен обрабатывать их как можно быстрее. 
  
Поставщики транспорта должны обрабатывать вызов **FlushQueues,** как описано в следующей последовательности действий, чтобы обеспечить надлежащую обработку сообщений и включить внешние ресурсы, такие как модемы, которые будут использоваться другими поставщиками транспорта в рамках операции **flushQueues** спулера MAPI. 
  
|**Этап**|**Компонент**|**Реализация**|
|:-----|:-----|:-----|
|1.  <br/> |Шпалер MAPI  <br/> |Вызывает метод **FlushQueues** для первого поставщика транспорта, перечисленного в порядке транспортировки профиля пользователя, передав запрашиваемую флажку в _параметре ulFlags._ **FlushQueues** называется один раз со всеми флагами, установленными для всей операции загрузки и загрузки.  <br/> |
|2.  <br/> |Поставщик транспорта  <br/> |Необходимо сделать ряд вещей перед возвращением из **вызова FlushQueues.** Если отправка ранее отправленных сообщений откладывается, метод [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) должен быть вызван с NOTIFY_SENT_DEFERRED флагом. Обратите внимание, что пуллер MAPI может отменить сообщение, отложенное до того, как поставщик транспорта может завершить обработку сообщения.  <br/> Если поставщик транспорта использует внешний ресурс, например модем, необходимо установить подключение к внешнему ресурсу.  <br/> Свойство STATUS_OUTBOUND_FLUSH в **свойстве PR_STATUS_CODE** [(PidTagStatusCode)](pidtagstatuscode-canonical-property.md)строки состояния поставщика транспорта должно быть установлено с помощью метода [IMAPISupport::ModifyStatusRow.](imapisupport-modifystatusrow.md)  <br/> Затем поставщик транспорта должен S_OK для вызова **FlushQueues.**  <br/> |
|3.  <br/> |Шпалер MAPI  <br/> |Проверяет строку состояния поставщика транспорта для STATUS_OUTBOUND_FLUSH и вызывает [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) для первого сообщения в очереди.  <br/> |
|4.  <br/> |Поставщик транспорта  <br/> |Обрабатывает сообщение и возвращается из **вызова SubmitMessage.**  <br/> |
|5.  <br/> |Шпалер MAPI  <br/> |Если поставщик транспорта возвращает S_OK **из SubmitMessage,** шпалер MAPI вызывает [IXPLogon::EndMessage](ixplogon-endmessage.md) для сообщения, как это происходит при регулярной отправке сообщений.  <br/> Если поставщик транспорта возвращает значение, помимо S_OK **из SubmitMessage,** шпалер MAPI обрабатывает это значение надлежащим образом, прежде чем вызывать **EndMessage** или снова вызывать **SubmitMessage.**  <br/> |
|6.  <br/> |Поставщик транспорта  <br/> |Возвращается из **EndMessage** со статусом обработки сообщений в _параметре lpulFlags._  <br/> |
|7.  <br/> |Поставщик шпалеров и транспорта MAPI  <br/> |Цикл **SubmitMessage** -  **EndMessage** продолжается до загрузки всех сообщений в очереди.  <br/> |
|8.  <br/> |Шпалер MAPI  <br/> |Сообщает поставщику транспорта о том, что он завершил скачивание сообщений, позвонив в метод [IXPLogon::TransportNotify](ixplogon-transportnotify.md) поставщика транспорта с NOTIFY_END_OUTBOUND_FLUSH флагом.  <br/> |
|9.  <br/> |Поставщик транспорта  <br/> |Освободит все внешние ресурсы, используемые при отправке исходящие сообщения, чтобы они могли использоваться другими поставщиками транспорта для очистки очередей.  <br/> Параметр STATUS_INBOUND_FLUSH в свойстве **PR_STATUS_CODE** строки состояния поставщика транспорта должен быть установлен с помощью **ModifyStatusRow.**  <br/> |
|10.  <br/> |Шпалер MAPI  <br/> |Проверяет строку состояния поставщика транспорта на наличие STATUS_INBOUND_FLUSH и вызывает [IXPLogon::StartMessage,](ixplogon-startmessage.md) если она установлена.  <br/> |
|11.  <br/> |Поставщик транспорта  <br/> |Обрабатывает сообщение и возвращается из **StartMessage.** Если у поставщика транспорта есть другие сообщения для отправки, он должен вызвать **SpoolerNotify** с NOTIFY_NEWMAIL флагом.  <br/> Если у поставщика транспорта нет сообщений для отправки, он должен вызвать [IMAPIProp::SaveChanges](imapiprop-savechanges.md) в сообщении, переданное пулером MAPI в **StartMessage** и возвращаемом.  <br/> |
|12.  <br/> |Шпалер MAPI  <br/> |Продолжает вызывать **StartMessage** до тех пор, пока **SaveChanges** не будет вызвано сообщение. После завершения загрузки поставщика транспорта шпалер MAPI вызывает **TransportNotify** с NOTIFY_END_INBOUND_FLUSH флагом.  <br/> |
|13.  <br/> |Поставщик транспорта  <br/> |Очищает STATUS_INBOUND_FLUSH в свойстве **PR_STATUS_CODE** строки состояния с **помощью ModifyStatusRow** и освобождает все внешние ресурсы, чтобы они были доступны для использования другими поставщиками транспорта.  <br/> |
|14.  <br/> |Шпалер MAPI  <br/> |Вызывает **flushQueues** для следующего поставщика транспорта, указанных в порядке транспортировки профиля пользователя.  <br/> |
   
Если клиентская заявка вызывает [IMAPIStatus::FlushQueues](imapistatus-flushqueues.md) на объекте состояния транспортного поставщика, поставщик транспорта должен зафиксировать соответствующий бит в строке состояния **с Помощью ModifyStatusRow**. Затем шпалер MAPI вызывает метод **IXPLogon::FlushQueues** поставщика транспорта в удобном для mapi spooler. Когда метод **IXPLogon::FlushQueues** поставщика транспорта вызван в результате вызова **IMAPIStatus::FlushQueues** клиентского приложения, операция происходит асинхронно для клиентского приложения. В **противном случае IXPLogon::FlushQueues** синхронно работает с шпалером MAPI. 
  
По соображениям производительности шпалер MAPI будет вызывать метод **FlushQueues** поставщика транспорта только в том случае, если флаги STATUS_INBOUND_FLUSH и STATUS_OUTBOUND_FLUSH в строке состояния поставщика транспорта. Следовательно, поставщик транспорта может остановить операцию **FlushQueues** в любое время, расчистив флаги STATUS_OUTBOUND_FLUSH и STATUS_INBOUND_FLUSH в строке состояния. Если шпалер MAPI закрывается и должен прекратить операцию **FlushQueues,** он вызывает **TransportNotify** с набором NOTIFY_END_INBOUND_FLUSH и NOTIFY_END_OUTBOUND_FLUSH флагов. Поставщик транспорта должен освободить все внешние ресурсы и вернуться. 
  


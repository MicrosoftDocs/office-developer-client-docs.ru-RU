---
title: Реализация метода FlushQueues
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 8719f8aa-a537-4253-b67d-c4d38c40472b
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: 1e5c78c71f7fddb04d3517aca0a34efa151ece08
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411780"
---
# <a name="implementing-the-flushqueues-method"></a>Реализация метода FlushQueues

  
  
**Относится к**: Outlook 2013 | Outlook 2016 
  
Диспетчер очереди MAPI использует метод [иксплогон:: FlushQueues](ixplogon-flushqueues.md) для загрузки и отправки ожидающих сообщений в поставщик транспорта и из него. Как правило, диспетчер очереди MAPI очищает очереди для всех поставщиков транспорта, которые вошли в сеанс, начиная с первого поставщика транспорта, как указано в разделе порядок транспорта в профиле пользователя. Очистка очередей почти всегда является результатом непосредственных запросов пользователя, поэтому отправка и получение сообщений при очистке очередей происходит синхронно с диспетчером MAPI. Так как эти вызовы синхронны, поставщик транспорта должен как можно быстрее обработать их. 
  
Поставщики транспорта должны обработать вызов **FlushQueues** , как описано в следующей последовательности действий, чтобы включить правильную обработку сообщений и включить внешние ресурсы, такие как модемы, которые будут использоваться другими поставщиками транспорта в рамках операции **FLUSHQUEUES** очереди обмена MAPI. 
  
|**Шаг**|**Компонент**|**Реализация**|
|:-----|:-----|:-----|
|1.  <br/> |Диспетчер очереди MAPI  <br/> |Вызывает метод **FlushQueues** для первого поставщика транспорта, указанного в порядке транспорта в профиле пользователя, передавая запрошенные флаги в параметре _ulFlags_ . **FlushQueues** вызывается один раз со всеми флагами, установленными для всей операции отправки и загрузки.  <br/> |
|2.  <br/> |Поставщик транспорта  <br/> |Необходимо выполнить ряд действий перед возвратом из вызова **FlushQueues** . Если отправляются ранее отправленные сообщения, метод [имаписуппорт:: спулернотифи](imapisupport-spoolernotify.md) должен вызываться с установленным флагом NOTIFY_SENT_DEFERRED. Обратите внимание, что диспетчер очереди MAPI может отменить сообщение, которое было отложено до того, как поставщик транспорта сможет завершить обработку сообщения.  <br/> Если поставщик транспорта использует внешний ресурс, такой как модем, необходимо установить подключение к внешнему ресурсу.  <br/> Бит STATUS_OUTBOUND_FLUSH в свойстве **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) в строке состояния поставщика транспорта необходимо задать с помощью метода [имаписуппорт:: модифистатусров](imapisupport-modifystatusrow.md) .  <br/> Затем поставщик транспорта возвращает S_OK для вызова **FlushQueues** .  <br/> |
|3.  <br/> |Диспетчер очереди MAPI  <br/> |Проверяет строку состояния поставщика транспорта на STATUS_OUTBOUND_FLUSH бит и вызывает [иксплогон:: субмитмессаже](ixplogon-submitmessage.md) для первого сообщения в очереди.  <br/> |
|4.  <br/> |Поставщик транспорта  <br/> |Обрабатывает сообщение и возвращается из вызова **субмитмессаже** .  <br/> |
|5.  <br/> |Диспетчер очереди MAPI  <br/> |Если поставщик транспорта возвращает S_OK из **субмитмессаже**, диспетчер очереди MAPI вызывает [Иксплогон:: ендмессаже](ixplogon-endmessage.md) для сообщения, как в случае с обычной отправкой сообщений.  <br/> Если поставщик транспорта возвращает значение, отличное от S_OK из **субмитмессаже**, диспетчер очереди MAPI обрабатывает значение до вызова **ендмессаже**или до повторного вызова **субмитмессаже** .  <br/> |
|6.  <br/> |Поставщик транспорта  <br/> |Возвращает из **ендмессаже** с состоянием обработки сообщения в параметре _лпулфлагс_ .  <br/> |
|7.  <br/> |Диспетчер очереди MAPI и поставщик транспорта  <br/> |Цикл **SubmitMessage**- **ендмессаже** субмитмессаже продолжается до тех пор, пока все сообщения в очереди не будут загружены.  <br/> |
|8.  <br/> |Диспетчер очереди MAPI  <br/> |Уведомляет поставщика транспорта о том, что загрузка сообщений завершена путем вызова метода [иксплогон:: транспортнотифи](ixplogon-transportnotify.md) поставщика транспорта с установленным флагом NOTIFY_END_OUTBOUND_FLUSH.  <br/> |
|9.  <br/> |Поставщик транспорта  <br/> |Освобождает все внешние ресурсы, используемые для отправки исходящих сообщений, чтобы их могли использовать другие поставщики транспорта для очистки очередей.  <br/> Бит STATUS_INBOUND_FLUSH в свойстве **PR_STATUS_CODE** строки состояния поставщика транспорта должен быть установлен с помощью **модифистатусров**.  <br/> |
|десяти.  <br/> |Диспетчер очереди MAPI  <br/> |Проверяет строку состояния поставщика транспорта на STATUS_INBOUND_FLUSH бит и вызывает [иксплогон:: стартмессаже](ixplogon-startmessage.md) , если он задан.  <br/> |
|-11:00.  <br/> |Поставщик транспорта  <br/> |Обрабатывает сообщение и возвращает из **стартмессаже**. Если у поставщика транспорта есть другие сообщения для отправки, он должен вызвать **спулернотифи** с установленным флагом NOTIFY_NEWMAIL.  <br/> Если у поставщика транспорта нет сообщений для отправки, он должен вызывать [IMAPIProp:: SaveChanges](imapiprop-savechanges.md) сообщения, переданные в **стартмессаже** и возвращаемые в очередь MAPI.  <br/> |
|12.  <br/> |Диспетчер очереди MAPI  <br/> |Продолжает вызывать **стартмессаже** , пока не будет вызван метод **SaveChanges** для сообщения. После того как поставщик транспорта завершит отправку, диспетчер очереди MAPI вызывает **транспортнотифи** с установленным флагом NOTIFY_END_INBOUND_FLUSH.  <br/> |
|13.  <br/> |Поставщик транспорта  <br/> |Очищает STATUS_INBOUND_FLUSH бит в свойстве **PR_STATUS_CODE** строки состояния с помощью **модифистатусров** и освобождает все внешние ресурсы, чтобы они были доступны для использования другими поставщиками транспорта.  <br/> |
|14.  <br/> |Диспетчер очереди MAPI  <br/> |Вызывает **FlushQueues** для следующего поставщика транспорта, указанного в порядке транспорта в профиле пользователя.  <br/> |
   
Если клиентское приложение вызывает [имапистатус:: FlushQueues](imapistatus-flushqueues.md) на объекте состояния поставщика транспорта, то поставщик транспорта должен установить соответствующий бит в строке состояния с **модифистатусров**. После этого диспетчер очереди MAPI вызывает метод **иксплогон:: FlushQueues** поставщика транспорта в удобном для вас ДИСПЕТЧЕРЕ очереди MAPI. Когда метод **иксплогон:: FlushQueues** поставщика транспорта вызывается в результате вызова **Имапистатус:: FlushQueues** клиентского приложения, операция асинхронно выполняется в клиентском приложении. В противном случае **иксплогон:: FlushQueues** работает синхронно с диспетчером очереди MAPI. 
  
В целях повышения производительности Диспетчер очереди MAPI будет вызывать метод **FlushQueues** поставщика транспорта только в том случае, если в строке состояния поставщика транспорта заданы флаги STATUS_INBOUND_FLUSH и STATUS_OUTBOUND_FLUSH. Следовательно, поставщик транспорта может остановить операцию **FlushQueues** в любое время, сняв флажки STATUS_OUTBOUND_FLUSH и STATUS_INBOUND_FLUSH в строке состояния. Если буферизация MAPI завершается и требуется завершить операцию **FlushQueues** , она вызывает **транспортнотифи** с установленным флагом NOTIFY_END_INBOUND_FLUSH и NOTIFY_END_OUTBOUND_FLUSH. Поставщик транспорта должен освободить все внешние ресурсы и вернуться. 
  


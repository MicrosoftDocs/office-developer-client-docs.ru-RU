---
title: Структурированное хранилище в MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: f58fa70e98841db5507323a63737f1df6c1b7a6d
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411752"
---
# <a name="structured-storage-in-mapi"></a>Структурированное хранилище в MAPI

  
  
**Относится к**: Outlook 2013 | Outlook 2016 
  
Структурированное хранилище — это иерархическая организация хранилища, появившаяся в COM. В структурированной среде хранения хранилище разбито на два или три типа объектов: 
  
- Объекты Stream
    
- Блокировка объектов bytes
    
- Объекты хранилища
    
Байты потока и блокировки — это объекты нижнего уровня, которые напрямую обращаются к данным. Объекты Stream реализуют интерфейс **IStream** , который определяет методы для чтения, записи, позиционирования и копирования байтов данных. Объекты блокировки байтов реализуют другой COM-интерфейс, **ILockBytes**для доступа к данным с помощью массива байтов. Байтовые массивы обычно используются для предоставления настраиваемого доступа к базовому хранилищу.
  
Объекты хранилища размещаются поверх потоков или объектов блокировки байтов; они могут содержать один или несколько таких объектов, а также другие объекты хранилища. Объекты хранилища реализуют интерфейс **IStorage** , который определяет методы для создания и обслуживания вложенных объектов, а также для доступа к ним. 
  
Так как **IStream**, **ILockBytes**и **IStorage** являются COM-интерфейсами, а не интерфейсами MAPI, их методы возвращают значения ошибок COM, а не значения MAPI. Клиенты и поставщики услуг, вызывающие методы в этих интерфейсах, должны использовать функцию API **мапсторажескоде** для преобразования этих значений в значения ошибок MAPI. Дополнительные сведения см. в разделе [мапсторажескоде](mapstoragescode.md).
  
Клиенты и поставщики услуг используют структурированное хранилище для работы со свойствами, которые слишком велики для поддержки с помощью методов **IMAPIProp** , обычно больших строк и двоичных свойств. Одним из распространенных способов доступа клиентов или поставщиков услуг является указание **IStream** или **IStorage** в качестве идентификатора интерфейса при вызове метода [IMAPIProp:: опенпроперти](imapiprop-openproperty.md) . Например, клиенты вызывают **опенпроперти** с помощью **PR_ATTACH_DATA_BIN** в качестве тега свойства и IID_IStream в качестве идентификатора интерфейса для доступа к двоичному вложению в сообщении. 
  
Клиенты и поставщики услуг могут реализовать собственные объекты Stream и Storage, а также вызываемые функции API для доступа к реализациям, предоставляемым MAPI или COM. Так как предоставляемые реализации служат большинству целей, клиентам и поставщикам услуг редко приходится создавать свои собственные. 
  
Когда клиент вызывает **опенпроперти** для объекта MAPI, чтобы получить доступ к одному из его свойств через объект Storage, поставщик услуг обычно открывает объект Storage в прямом режиме. Однако это типичное, а не обязательное поведение. Клиенты должны предполагать, что все объекты хранилища, открытые или созданные поставщиками службы, являются транзакционными и требуют вызова **IStorage:: Commit**. Кроме того, следует помнить, что изменения объектов хранилища не будут выполняться до тех пор, пока не будут вызваны **IMAPIProp:: SaveChanges** после окончательной **фиксации** для сохранения объекта MAPI. Дополнительные сведения см. в разделе [IMAPIProp:: SaveChanges](imapiprop-savechanges.md).
  
MAPI и COM предоставляют несколько функций API для определения или доступа к хранилищу и объектам потока. В приведенной ниже таблице описаны часто используемые функции.
  
**Функции для доступа к хранилищу и объектам потока**

|**Function**|**Описание**|
|:-----|:-----|
|[HrIStorageFromStream](hristoragefromstream.md) <br/> |Создает объект Storage для доступа к потоку или объекту блокировки байтов.  <br/> |
|[OpenIMsgOnIStg](openimsgonistg.md) <br/> |Создает объект Message для доступа к объекту хранилища.  <br/> |
|[OpenStreamOnFile](openstreamonfile.md) <br/> |Создает объект Stream для доступа к файлу.  <br/> |
|[WrapCompressedRTFStream](wrapcompressedrtfstream.md) <br/> |Создает объект Stream, содержащий сжатую или несжатую версию потока, содержащего форматированный текст сообщения.  <br/> |
   
 **Извлечение имен потоков в заданном подхранилище**
  
1. Вызовите метод **IStorage:: енумелементс** , чтобы получить интерфейс **иенумстатстг** . 
    
2. Вызов **иенумстатстг:: Next** со как можно большим количеством структур **статстг** . Если вы запрашиваете 100, то **Далее** обычно возвращается S_FALSE с содержимым _, которое_ было получено на самом деле. 
    
3. Проверьте структуры **статстг** , помеченные с помощью STGTY_STREAM. 
    
4. Освободите параметр _пвкснаме_ . 
    
 **Создание объекта хранилища для доступа к существующему потоку или объекту блокировки байтов**
  
- Клиенты вызывают [христоражефромстреам](hristoragefromstream.md). 
    
 **Создание объекта Message для доступа к существующему объекту хранилища**
  
- Поставщики услуг и клиенты вызывают [опенимсгонистг](openimsgonistg.md). Созданный объект сообщения отличается от объектов сообщений, обычно создаваемых поставщиками хранилища сообщений, в том, что он не поддерживает все методы интерфейса [iMessage: IMAPIProp](imessageimapiprop.md) , такие как **iMessage:: субмитмессаже**. Необязательный входной параметр для **опенимсгонистг** — это функция обратного вызова, которая соответствует прототипу [мсгкаллрелеасе](msgcallrelease.md) . Эта функция вызывается новым объектом Message, когда число ссылок сообщения достигает нуля. Реализация функции **мсгкаллрелеасе** может быть полезной для выполнения завершающей обработки, прежде чем новое сообщение будет полностью удалено. 
    
[Опенстреамонфиле](openstreamonfile.md) обычно используется для хранения вложенных файлов, так как создает поток, считывающий из файла и записывающий в него. **Опенпроперти** с **PR_ATTACH_DATA_BIN** в качестве тега свойства создает поток для хранения данных двоичных вложений. 
  
 **Сжатие и распаковка потока, содержащего текст сообщения в формате RTF**
  
- Клиенты вызывают [врапкомпресседртфстреам](wrapcompressedrtfstream.md). **Врапкомпресседртфстреам** создает поток, который УПАКОВЫВАЕТ поток RTF. В потоке-оболочке не реализованы все методы **IStream** ; исключены следующие методы: **Seek**, **SetSize**, **revert**, **локкрегион**, **унлоккрегион**, **stat**и **clone**. Это связано с тем, что объекты потока, созданные в **врапкомпресседртфстреам** , не поддерживают метод **SetSize** или **stat**, но не существует простого способа для расширения или извлечения их размера. Оптимальной стратегией является выбор приемлемого размера буфера и чтения или записи в цикле.
    
> [!NOTE]
> COM имеет реализацию объекта хранилища на основе массива байтов, который возвращает объект **иенумстатстг** из метода **енумелементс** , который является проблематичным. В частности, метод **QueryInterface** работает неправильно. Поставщики услуг, реализующие собственные объекты хранения с помощью реализации COM, должны создать тонкую оболочку для объекта **иенумстатстг** , который перенаправляет вызовы в базовые методы **иенумстатстг** , но реализуют собственные методы **AddRef**, **Release**, **QueryInterface**и **clone** . 
  


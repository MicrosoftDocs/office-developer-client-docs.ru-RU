---
title: Структурированные служба хранилища MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: f58fa70e98841db5507323a63737f1df6c1b7a6d
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411752"
---
# <a name="structured-storage-in-mapi"></a>Структурированные служба хранилища MAPI

  
  
**Область применения**: Outlook 2013 | Outlook 2016 
  
Структурированное хранилище относится к иерархической организации хранилища, введенной с помощью COM. В структурированной среде хранения хранение организовано на два или три типа объектов: 
  
- Объекты stream
    
- Блокировка объектов bytes
    
- служба хранилища объектов
    
Поток и блокировка — это объекты более низкого уровня, которые непосредственно имеют доступ к данным. Объекты stream реализуют **интерфейс IStream,** который определяет методы чтения, записи, позиционирования и копирования bytes данных. Объекты блокировки bytes реализуют другой интерфейс **COM, ILockBytes,** чтобы получить доступ к данным с помощью массива byte. Массивы byte обычно используются для предоставления настраиваемого доступа к основному хранилищу.
  
служба хранилища объекты слоистые поверх объектов потока или блокировки bytes; они могут содержать один или несколько таких объектов, а также другие объекты хранения. служба хранилища реализуют интерфейс **IStorage,** который определяет методы создания, доступа и обслуживания вложенных объектов. 
  
Поскольку **интерфейсы IStream,** **ILockBytes** и **IStorage** являются com-интерфейсами, а не интерфейсами MAPI, их методы возвращают значения ошибок COM, а не значения MAPI. Для перевода этих значений в значения ошибок MAPI клиенты и поставщики услуг в этих интерфейсах должны использовать функцию **API MapStorageSCode.** Дополнительные сведения см. [в странице MapStorageSCode.](mapstoragescode.md)
  
Клиенты и поставщики услуг используют структурированное хранилище для работы с слишком большими свойствами, чтобы поддерживать их с помощью методов **IMAPIProp,** как правило, больших строковых и двоичных свойств. Одним из распространенных способов доступа к ним для клиентов или поставщиков услуг является указание **IStream** или **IStorage** в качестве идентификатора интерфейса в вызове метода [IMAPIProp::OpenProperty.](imapiprop-openproperty.md) Например, клиенты называют **OpenProperty** **PR_ATTACH_DATA_BIN** тегом свойства и IID_IStream как идентификатор интерфейса для доступа к двоичному вложению в сообщении. 
  
Клиенты и поставщики услуг могут реализовать собственные объекты потока и хранилища или вызвать API-функции для доступа к реализациям, предоставленным MAPI или COM. Так как поставленные реализации служат большинству целей, клиентам и поставщикам услуг редко требуется создавать свои собственные. 
  
Когда клиент вызывает **OpenProperty** на объект MAPI, чтобы получить доступ к одному из его свойств с помощью объекта хранения, поставщик услуг обычно открывает объект хранилища в прямом режиме. Однако это обычное, а не обязательное поведение. Клиенты должны предполагать, что все объекты хранения, открытые или созданные поставщиками услуг, будут выполняться и требуют вызова **в IStorage::Commit.** Они также должны помнить, что изменения в объектах хранения не будут вноситься постоянно, пока  они не вызовут **IMAPIProp::SaveChanges** после окончательного коммита для сохранения объекта MAPI. Дополнительные сведения см. [в iMAPIProp::SaveChanges.](imapiprop-savechanges.md)
  
MAPI и COM предоставляют несколько функций API для определения или доступа к объектам хранения и потоковой передачи. Обычно используемые функции описаны в следующей таблице.
  
**Функции для доступа к объектам служба хранилища и потоку**

|**Function**|**Описание**|
|:-----|:-----|
|[HrIStorageFromStream](hristoragefromstream.md) <br/> |Создает объект хранилища для доступа к объекту поток или блокировка bytes.  <br/> |
|[OpenIMsgOnIStg](openimsgonistg.md) <br/> |Создает объект сообщения для доступа к объекту хранения.  <br/> |
|[OpenStreamOnFile](openstreamonfile.md) <br/> |Создает объект потока для доступа к файлу.  <br/> |
|[WrapCompressedRTFStream](wrapcompressedrtfstream.md) <br/> |Создает объект потока, содержащий сжатую или ненажатую версию потока с богатым текстом сообщения.  <br/> |
   
 **Извлечение имен потоков в заданной подстраховки**
  
1. Чтобы получить интерфейс **IEnumSTATSTG,** вызовите метод **IStorage::EnumElements.** 
    
2. Вызов **IEnumSTATSTG:::Далее** с таким количеством **структур STATSTG** одновременно, как вы можете. Если запросить 100 за один раз, **далее** обычно возвращается S_FALSE с содержимым  _pceltFetched,_ задаваемого на номер, который был фактически извлечен. 
    
3. Проверьте, **имеются ли структуры STATSTG,** помеченные STGTY_STREAM. 
    
4. _Отпустите параметр pwcsName._ 
    
 **Создание объекта хранения для доступа к существующему объекту потока или блокировки bytes**
  
- Клиенты называют [HrIStorageFromStream](hristoragefromstream.md). 
    
 **Создание объекта сообщения для доступа к существующему объекту хранения**
  
- Поставщики и клиенты служб называют [OpenIMsgOnIStg](openimsgonistg.md). Созданный объект сообщения отличается от объектов сообщения, обычно созданных поставщиками хранения сообщений, тем, что он не поддерживает все методы интерфейса [IMessage: IMAPIProp,](imessageimapiprop.md) такие как **IMessage::SubmitMessage**. Необязательный параметр ввода **в OpenIMsgOnIStg** — это функция вызова, которая соответствует прототипу [MSGCALLRELEASE.](msgcallrelease.md) Эта функция вызвана новым объектом сообщения, когда количество ссылок на сообщение достигает нуля. Реализация функции **MSGCALLRELEASE** может быть полезной для выполнения конечной обработки до полного удаления нового сообщения. 
    
[OpenStreamOnFile](openstreamonfile.md) обычно используется для хранения вложений файлов, так как создает поток, который считывает и записывает в файл. **OpenProperty** **с PR_ATTACH_DATA_BIN** как тег свойства создает поток для хранения данных двоичных вложений. 
  
 **Сжатие или отжатие потока, содержащего текст сообщения в формате Rich Text**
  
- Клиенты называют [WrapCompressedRTFStream](wrapcompressedrtfstream.md). **WrapCompressedRTFStream** создает поток, который завершает поток RTF. Поток оболочки не реализует все методы **IStream;** Исключены следующие методы: **Seek,** **SetSize,** **Revert,** **LockRegion,** **UnlockRegion,** **Stat** и **Clone.** Это потому, что объекты потока, созданные **WrapCompressedRTFStream,** не поддерживают **SetSize** или **Stat,** существует непростой способ расширения или получения их размера. Лучше всего выбрать разумный размер буфера и прочитать или написать в цикле.
    
> [!NOTE]
> Com имеет реализацию объекта хранения на основе массива байтов, возвращаемого **объекту IEnumSTATSTG** из проблемного метода **EnumElements.** В частности, **метод QueryInterface** работает неправильно. Поставщики услуг, реализующие собственные объекты хранения с помощью реализации COM, должны создать тонкую оболочку для объекта **IEnumSTATSTG,** который передает вызовы на основе методов **IEnumSTATSTG,** но реализует собственные методы **AddRef**, **Release**, **QueryInterface** и **Clone.** 
  


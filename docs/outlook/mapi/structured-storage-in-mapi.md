---
title: Структурированные хранилища в MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: 937643d90534f73477b90fd7ce883615a7e296f2
ms.sourcegitcommit: 0cf39e5382b8c6f236c8a63c6036849ed3527ded
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2018
ms.locfileid: "22569717"
---
# <a name="structured-storage-in-mapi"></a>Структурированные хранилища в MAPI

  
  
**Применимо к**: Outlook 2013 | Outlook 2016 
  
Структурированные хранилища относится к иерархической организации хранения, представленной в COM. В среде структурированным хранилища иерархическую двух или трех типов объектов: 
  
- Поток объектов
    
- Блокировка байт объектов
    
- Хранение объектов
    
Поток и блокировки байт являются объектами нижнего уровня, прямого доступа к данным. Объекты потока реализует интерфейс **IStream** , который определяет методы для чтения, записи, размещение и копирование данных в байтах. Блокировка байт объектов реализации другого интерфейса COM, **ILockBytes**, для доступа к данным с помощью массива байтов. Массивы байтов обычно используются для пользовательского доступа к базовое хранилище.
  
Хранение объектов помещаются на верхнем блокировки или потока в байтах объектов; они могут содержать одно или несколько из этих объектов, а также других объектов хранилища. Хранение объектов реализует интерфейс **IStorage** , который определяет методы для создания, доступ к и обслуживание вложенных объектов. 
  
Так как **IStream**, **ILockBytes**и **IStorage** COM-интерфейсы, а не интерфейсы MAPI, их методы возвращают COM ошибочные значения, а не значения MAPI. Клиенты и поставщиков услуг, вызов методов в эти интерфейсы необходимо использовать функцию API **MapStorageSCode** переводить эти значения в MAPI ошибочных значений. Для получения дополнительных сведений см [MapStorageSCode](mapstoragescode.md).
  
Клиенты и поставщики услуг работа со свойствами, которые являются слишком велик для методы, обычно большого строки и двоичные свойства **IMAPIProp** для обслуживания с помощью структурированного хранилища. Распространенные способами, что клиентов или поставщиков услуг к ним доступ — путем указания **IStream** или **IStorage** идентификатор интерфейса, при вызове метода [IMAPIProp::OpenProperty](imapiprop-openproperty.md) . Например клиенты вызывать **OpenProperty** с **PR_ATTACH_DATA_BIN** как свойство tag и IID_IStream идентификатор интерфейса для доступа к двоичные вложения в сообщение. 
  
Клиенты и поставщиков услуг можно реализовать свои собственные объекты потока и хранилища или вызвать функции интерфейса API для доступа к реализации в телефонном MAPI или COM. Так как заданный реализации работать в большинстве случаев, клиентов и поставщиков услуг редко требуется создавать свои собственные. 
  
При вызовах клиента **OpenProperty** на объект MAPI для доступа к одному из его свойств через объект хранилища, поставщик услуг обычно откройте объект хранилища в режиме прямого. Тем не менее это обычно требуется поведение. Клиенты должны Предположим, что все объекты хранилища открывается или созданных поставщиков услуг являются транзакции и требует вызова **IStorage::Commit**. Они не следует забывать, что изменения объектов хранения не станут постоянное до звонят **IMAPIProp::SaveChanges** после окончательной **фиксации** сохранить объект MAPI. Для получения дополнительных сведений см [IMAPIProp::SaveChanges](imapiprop-savechanges.md).
  
MAPI и COM обеспечивают несколько функций API для определения или доступ к объему хранилища и поток объектов. В следующей таблице описаны часто используемые функции.
  
**Функции для доступа к хранилищу и поток объектов**

|**Функция**|**Описание**|
|:-----|:-----|
|[HrIStorageFromStream](hristoragefromstream.md) <br/> |Создает объект хранилища для доступа к объекту блокировки или потока в байтах.  <br/> |
|[OpenIMsgOnIStg](openimsgonistg.md) <br/> |Создает объект сообщения для доступа к объекту хранилища.  <br/> |
|[OpenStreamOnFile](openstreamonfile.md) <br/> |Создает объект stream для доступа к файлу.  <br/> |
|[WrapCompressedRTFStream](wrapcompressedrtfstream.md) <br/> |Создает объект stream, содержащий сжатых или несжатых версию потока руку форматированного текста сообщения.  <br/> |
   
 **Для извлечения имен потоков данного вложенного хранилища**
  
1. Вызов метода **IStorage::EnumElements** вложенного хранилища для получения интерфейс **IEnumSTATSTG** . 
    
2. Вызов **IEnumSTATSTG::Next** столько структуры **STATSTG** за раз, как. Если запрос 100 одновременно, **Далее** обычно возвращает значение S_FALSE с содержимым _pceltFetched_ номер, который фактически были извлечены. 
    
3. Проверка структуры **STATSTG** со STGTY_STREAM. 
    
4. Выпуск параметр _pwcsName_ . 
    
 **Для создания объекта хранилища для доступа к существующий объект блокировки или потока в байтах**
  
- Клиенты вызывать [HrIStorageFromStream](hristoragefromstream.md). 
    
 **Для создания объекта сообщения для доступа к объекту существующего хранилища**
  
- Поставщиков услуг и клиентами вызов [OpenIMsgOnIStg](openimsgonistg.md). Объект message, которая создается отличается от объекты сообщений, обычно создаются поставщиков хранилища сообщений, то есть не поддерживает все [IMessage: IMAPIProp](imessageimapiprop.md) методы, такие как **IMessage::SubmitMessage**интерфейса. Необязательный входного параметра, чтобы **OpenIMsgOnIStg** является функцию обратного вызова, которая соответствует прототип [MSGCALLRELEASE](msgcallrelease.md) . Эта функция вызывается новый объект message, когда счетчик ссылок сообщение будет равно нулю. Реализация функции **MSGCALLRELEASE** можно использовать для выполнения окончательной обработки перед окончательным удалением нового сообщения. 
    
[OpenStreamOnFile](openstreamonfile.md) обычно используется для хранения файлов вложений, так как он создает поток, который считывает из и записывает в файл. **OpenProperty** с **PR_ATTACH_DATA_BIN** как свойство tag создает поток для хранения данных двоичные вложения. 
  
 **Сжатие и распаковка потока, содержащая текст сообщения в формате RTF**
  
- Клиенты вызывать [WrapCompressedRTFStream](wrapcompressedrtfstream.md). **WrapCompressedRTFStream** создает поток, который имеет формат RTF потока. Программы-оболочки для потока не реализует все методы **IStream** ; следующие методы могут быть исключены: **Seek**, **SetSize**, **Возврат**, **LockRegion**, **UnlockRegion**, **Статистика**и **клонирования**. Тем, что поток объектов, созданных **WrapCompressedRTFStream** не поддерживают **SetSize** или **Статистика**, не простой способ расширения или получить их размер. Рекомендуется выбрать размер разумные буфера и чтение или запись в цикле.
    
> [!NOTE]
> COM имеет реализацию объекта хранилища на основании массив байтов, который возвращает объект **IEnumSTATSTG** из **EnumElements** метод, который представляет проблему. В частности метод **QueryInterface** работает неправильно. Поставщики услуг, которые реализуют свои собственные объекты хранилища, с помощью реализации COM, должны создавать тонкие программы-оболочки для объекта **IEnumSTATSTG** , который перенаправляет звонки вход в систему базовых методов **IEnumSTATSTG** , но реализует свой собственный **AddRef **, **Выпуска**, **QueryInterface**и **клонированной** методы. 
  


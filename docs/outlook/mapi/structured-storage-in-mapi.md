---
title: Структурированное хранилище в MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: f58fa70e98841db5507323a63737f1df6c1b7a6d
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411752"
---
# <a name="structured-storage-in-mapi"></a>Структурированное хранилище в MAPI

  
  
**Относится к**: Outlook 2013 | Outlook 2016 
  
Структурированное хранилище — это иерархическая организация хранилища, представленная в COM. В структурированной среде хранения хранилище организовано на два или три типа объектов: 
  
- Объекты Stream
    
- Блокировка объектов bytes
    
- Объекты хранилища
    
Поток и блокировка данных — это объекты нижнего уровня, которые непосредственно имеют доступ к данным. Объекты Stream реализуют **интерфейс IStream,** который определяет методы чтения, записи, позиционирования и копирования данных. Объекты блокировки bytes реализуют другой COM-интерфейс, **ILockBytes,** для доступа к данным с помощью массива byte. Массивы byte обычно используются для предоставления настраиваемого доступа к основному хранилищу.
  
Объекты хранилища на уровне верхней части потока или блокирования объектов bytes; они могут содержать один или несколько таких объектов, а также другие объекты хранения. Объекты хранилища реализуют **интерфейс IStorage,** который определяет методы создания, доступа и обслуживания вложенных объектов. 
  
Так **как IStream,** **ILockBytes** и **IStorage** являются com-интерфейсами, а не интерфейсами MAPI, их методы возвращают значения ошибок COM, а не значения MAPI. Клиенты и поставщики услуг, вызывая методы в этих интерфейсах, должны использовать функцию API **MapStorageSCode** для перевода этих значений в значения ошибок MAPI. Дополнительные сведения [см. в mapStorageSCode.](mapstoragescode.md)
  
Клиенты и поставщики услуг используют структурированное хранилище для работы со свойствами, которые слишком большие для работы с методами **IMAPIProp,** как правило, большими строками и двоичными свойствами. Одним из распространенных способов доступа клиентов или поставщиков услуг является указание **IStream** или **IStorage** в качестве идентификатора интерфейса в вызове метода [IMAPIProp::OpenProperty.](imapiprop-openproperty.md) Например, клиенты **вызывают OpenProperty** **с PR_ATTACH_DATA_BIN** как тег свойства и IID_IStream в качестве идентификатора интерфейса для доступа к двоичному вложению в сообщении. 
  
Клиенты и поставщики услуг могут реализовать собственные объекты потока и хранилища или вызывать функции API для доступа к реализациям, предоставленным MAPI или COM. Так как предоставленные реализации служат большинству целей, клиентам и поставщикам услуг редко требуется создавать собственные. 
  
Когда клиент вызывает **OpenProperty** для объекта MAPI, чтобы получить доступ к одному из его свойств через объект хранилища, поставщик услуг обычно открывает объект хранилища в прямом режиме. Однако это обычное, а не обязательное поведение. Клиенты должны предполагать, что все объекты хранилища, открытые или созданные поставщиками услуг, будут выполняться и требовать вызова **IStorage::Commit.** Они также должны помнить, что изменения объектов хранилища не будут постоянными, пока они не  будут вызывать **IMAPIProp::SaveChanges** после окончательного фиксации для сохранения объекта MAPI. Дополнительные сведения см. в [подразделе IMAPIProp::SaveChanges.](imapiprop-savechanges.md)
  
MAPI и COM предоставляют несколько функций API для определения объектов хранилища и потока или доступа к ним. Часто используемые функции описаны в следующей таблице.
  
**Функции для доступа к объектам хранилища и потока**

|**Function**|**Описание**|
|:-----|:-----|
|[HrIStorageFromStream](hristoragefromstream.md) <br/> |Создает объект хранилища для доступа к объекту потока или блокировки объектов bytes.  <br/> |
|[OpenIMsgOnIStg](openimsgonistg.md) <br/> |Создает объект сообщения для доступа к объекту хранилища.  <br/> |
|[OpenStreamOnFile](openstreamonfile.md) <br/> |Создает объект stream для доступа к файлу.  <br/> |
|[WrapCompressedRTFStream](wrapcompressedrtfstream.md) <br/> |Создает объект stream, содержащий сжатую или несжатую версию потока, вмествуя в себе полный текст сообщения.  <br/> |
   
 **Извлечение имен потоков в заданной подмадре.**
  
1. Вызовите метод **IStorage::EnumElements** подмагистрали, чтобы получить интерфейс **IEnumSTATSTG.** 
    
2. Вызовите **IEnumSTATSTG::Next** с максимальной количеством структур **STATSTG** одновременно. Если запросить 100 за **раз,** next обычно возвращает S_FALSE содержимое  _pceltFetched,_ задаваемого на число, которое было фактически извлечено. 
    
3. Проверьте структуры **STATSTG,** помеченные STGTY_STREAM. 
    
4. _Отпустите параметр pwcsName._ 
    
 **Создание объекта хранилища для доступа к существующему объекту потока или блокировки объектов bytes**
  
- Клиенты [звонят hrIStorageFromStream.](hristoragefromstream.md) 
    
 **Создание объекта сообщения для доступа к существующему объекту хранилища**
  
- Поставщики услуг и клиенты [звонят openIMsgOnIStg.](openimsgonistg.md) Созданный объект сообщения отличается от объектов сообщений, обычно созданных поставщиками store сообщений тем, что он не поддерживает все методы интерфейса [IMAPIProp: IMAPIProp,](imessageimapiprop.md) такие как **IMessage::SubmitMessage.** Необязательный входной параметр **OpenIMsgOnIStg** — это функция вызова, которая соответствует [прототипу MSGCALLRELEASE.](msgcallrelease.md) Эта функция будет вызвана новым объектом сообщения, когда количество ссылок на сообщение достигает нуля. Реализация **функции MSGCALLRELEASE** может быть полезна для выполнения окончательной обработки перед окончательным удалением нового сообщения. 
    
[OpenStreamOnFile](openstreamonfile.md) обычно используется для хранения вложенных файлов, так как он создает поток, который считывает и записывает в файл. **OpenProperty** **с PR_ATTACH_DATA_BIN** как тег свойства создает поток для хранения двоичных данных вложений. 
  
 **Сжатие или сжатие потока, содержащего текст сообщения в формате RICH Text**
  
- Клиенты называют [WrapCompressedRTFStream.](wrapcompressedrtfstream.md) **WrapCompressedRTFStream** создает поток, который создает поток RTF. Поток-оболочка не реализует все методы **IStream;** Исключаются следующие методы: **Seek,** **SetSize,** **Revert,** **LockRegion,** **UnlockRegion,** **Stat** и **Clone.** Это необходимо из-за того, что потоки объектов, созданные **WrapCompressedRTFStream** не поддерживают **SetSize** или **Stat,** существует не простой способ расширения или получения их размера. Лучше всего выбрать разумный размер буфера и считывать или записывать в цикле.
    
> [!NOTE]
> COM имеет реализацию объекта хранилища на основе массива байтов, который возвращает **объект IEnumSTATSTG** из проблемного метода **EnumElements.** В частности, **метод QueryInterface** работает неправильно. Поставщики услуг, реализующие собственные объекты хранения с помощью реализации COM, должны создать тонкую оболочку для объекта **IEnumSTATSTG,** которая перенанолает вызовы в методы **IEnumSTATSTG,** но реализует собственные методы **AddRef,** **Release,** **QueryInterface** и **Clone.** 
  


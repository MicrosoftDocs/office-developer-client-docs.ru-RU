---
title: Структурированное хранилище в MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Дата последнего изменения: 9 марта 2015 г.'
ms.openlocfilehash: f58fa70e98841db5507323a63737f1df6c1b7a6d
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "32327435"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="e42c8-103">Структурированное хранилище в MAPI</span><span class="sxs-lookup"><span data-stu-id="e42c8-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="e42c8-104">**Область применения**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="e42c8-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="e42c8-105">Структурированное хранилище — это иерархическая организация хранилища, появившаяся в COM.</span><span class="sxs-lookup"><span data-stu-id="e42c8-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="e42c8-106">В структурированной среде хранения хранилище разбито на два или три типа объектов:</span><span class="sxs-lookup"><span data-stu-id="e42c8-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="e42c8-107">Объекты Stream</span><span class="sxs-lookup"><span data-stu-id="e42c8-107">Stream objects</span></span>
    
- <span data-ttu-id="e42c8-108">Блокировка объектов bytes</span><span class="sxs-lookup"><span data-stu-id="e42c8-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="e42c8-109">Объекты хранилища</span><span class="sxs-lookup"><span data-stu-id="e42c8-109">Storage objects</span></span>
    
<span data-ttu-id="e42c8-110">Байты потока и блокировки — это объекты нижнего уровня, которые напрямую обращаются к данным.</span><span class="sxs-lookup"><span data-stu-id="e42c8-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="e42c8-111">Объекты Stream реализуют интерфейс **IStream** , который определяет методы для чтения, записи, позиционирования и копирования байтов данных.</span><span class="sxs-lookup"><span data-stu-id="e42c8-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="e42c8-112">Объекты блокировки байтов реализуют другой COM-интерфейс, **ILockBytes**для доступа к данным с помощью массива байтов.</span><span class="sxs-lookup"><span data-stu-id="e42c8-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="e42c8-113">Байтовые массивы обычно используются для предоставления настраиваемого доступа к базовому хранилищу.</span><span class="sxs-lookup"><span data-stu-id="e42c8-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="e42c8-114">Объекты хранилища размещаются поверх потоков или объектов блокировки байтов; они могут содержать один или несколько таких объектов, а также другие объекты хранилища.</span><span class="sxs-lookup"><span data-stu-id="e42c8-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="e42c8-115">Объекты хранилища реализуют интерфейс **IStorage** , который определяет методы для создания и обслуживания вложенных объектов, а также для доступа к ним.</span><span class="sxs-lookup"><span data-stu-id="e42c8-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="e42c8-116">Так как **IStream**, **ILockBytes**и **IStorage** являются com-интерфейсАМИ, а не интерфейсами MAPI, их методы возвращают значения ошибок COM, а не значения MAPI.</span><span class="sxs-lookup"><span data-stu-id="e42c8-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="e42c8-117">Клиенты и поставщики услуг, вызывающие методы в этих интерфейсах, должны использовать функцию API **мапсторажескоде** для преобразования этих значений в значения ошибок MAPI.</span><span class="sxs-lookup"><span data-stu-id="e42c8-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="e42c8-118">Дополнительные сведения см. в разделе [мапсторажескоде](mapstoragescode.md).</span><span class="sxs-lookup"><span data-stu-id="e42c8-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="e42c8-119">Клиенты и поставщики услуг используют структурированное хранилище для работы со свойствами, которые слишком велики для поддержки с помощью методов **IMAPIProp** , обычно больших строк и двоичных свойств.</span><span class="sxs-lookup"><span data-stu-id="e42c8-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="e42c8-120">Одним из распространенных способов доступа клиентов или поставщиков услуг является указание **IStream** или **IStorage** в качестве идентификатора интерфейса при вызове метода [IMAPIProp:: опенпроперти](imapiprop-openproperty.md) .</span><span class="sxs-lookup"><span data-stu-id="e42c8-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="e42c8-121">Например, клиенты вызывают **опенпроперти** с **пр_аттач_дата_бин** в качестве тега свойства и иид_истреам в качестве идентификатора интерфейса для доступа к двоичному вложению в сообщении.</span><span class="sxs-lookup"><span data-stu-id="e42c8-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="e42c8-122">Клиенты и поставщики услуг могут реализовать собственные объекты Stream и Storage, а также вызываемые функции API для доступа к реализациям, предоставляемым MAPI или COM.</span><span class="sxs-lookup"><span data-stu-id="e42c8-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="e42c8-123">Так как предоставляемые реализации служат большинству целей, клиентам и поставщикам услуг редко приходится создавать свои собственные.</span><span class="sxs-lookup"><span data-stu-id="e42c8-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="e42c8-124">Когда клиент вызывает **опенпроперти** для объекта MAPI, чтобы получить доступ к одному из его свойств через объект Storage, поставщик услуг обычно открывает объект Storage в прямом режиме.</span><span class="sxs-lookup"><span data-stu-id="e42c8-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="e42c8-125">Однако это типичное, а не обязательное поведение.</span><span class="sxs-lookup"><span data-stu-id="e42c8-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="e42c8-126">Клиенты должны предполагать, что все объекты хранилища, открытые или созданные поставщиками службы, являются транзакционными и требуют вызова **IStorage:: Commit**.</span><span class="sxs-lookup"><span data-stu-id="e42c8-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="e42c8-127">Кроме того, следует помнить, что изменения объектов хранилища не будут выполняться до тех пор, пока не будут вызваны **IMAPIProp:: SaveChanges** после окончательной **фиксации** для сохранения объекта MAPI.</span><span class="sxs-lookup"><span data-stu-id="e42c8-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="e42c8-128">Дополнительные сведения см. в разделе [IMAPIProp:: SaveChanges](imapiprop-savechanges.md).</span><span class="sxs-lookup"><span data-stu-id="e42c8-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="e42c8-129">MAPI и COM предоставляют несколько функций API для определения или доступа к хранилищу и объектам потока.</span><span class="sxs-lookup"><span data-stu-id="e42c8-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="e42c8-130">В приведенной ниже таблице описаны часто используемые функции.</span><span class="sxs-lookup"><span data-stu-id="e42c8-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="e42c8-131">**Функции для доступа к хранилищу и объектам потока**</span><span class="sxs-lookup"><span data-stu-id="e42c8-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="e42c8-132">**Function**</span><span class="sxs-lookup"><span data-stu-id="e42c8-132">**Function**</span></span>|<span data-ttu-id="e42c8-133">**Описание**</span><span class="sxs-lookup"><span data-stu-id="e42c8-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="e42c8-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="e42c8-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="e42c8-135">Создает объект Storage для доступа к потоку или объекту блокировки байтов.</span><span class="sxs-lookup"><span data-stu-id="e42c8-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="e42c8-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="e42c8-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="e42c8-137">Создает объект Message для доступа к объекту хранилища.</span><span class="sxs-lookup"><span data-stu-id="e42c8-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="e42c8-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="e42c8-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="e42c8-139">Создает объект Stream для доступа к файлу.</span><span class="sxs-lookup"><span data-stu-id="e42c8-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="e42c8-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="e42c8-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="e42c8-141">Создает объект Stream, содержащий сжатую или несжатую версию потока, содержащего форматированный текст сообщения.</span><span class="sxs-lookup"><span data-stu-id="e42c8-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="e42c8-142">**Извлечение имен потоков в заданном подхранилище**</span><span class="sxs-lookup"><span data-stu-id="e42c8-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="e42c8-143">ВыЗовите метод **IStorage:: енумелементс** , чтобы получить интерфейс **иенумстатстг** .</span><span class="sxs-lookup"><span data-stu-id="e42c8-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="e42c8-144">Вызов **иенумстатстг:: Next** со как можно большим количеством структур **статстг** .</span><span class="sxs-lookup"><span data-stu-id="e42c8-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="e42c8-145">Если вы запрашиваете 100, то **Далее** обычно возвращается S_FALSE с содержимым _пцелтфетчед_ , равным реально полученному числу.</span><span class="sxs-lookup"><span data-stu-id="e42c8-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="e42c8-146">Проверьте структуры **статстг** , помеченные с помощью стгти_стреам.</span><span class="sxs-lookup"><span data-stu-id="e42c8-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="e42c8-147">Освободите параметр _пвкснаме_ .</span><span class="sxs-lookup"><span data-stu-id="e42c8-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="e42c8-148">**Создание объекта хранилища для доступа к существующему потоку или объекту блокировки байтов**</span><span class="sxs-lookup"><span data-stu-id="e42c8-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="e42c8-149">Клиенты вызывают [христоражефромстреам](hristoragefromstream.md).</span><span class="sxs-lookup"><span data-stu-id="e42c8-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="e42c8-150">**Создание объекта Message для доступа к существующему объекту хранилища**</span><span class="sxs-lookup"><span data-stu-id="e42c8-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="e42c8-151">Поставщики услуг и клиенты вызывают [опенимсгонистг](openimsgonistg.md).</span><span class="sxs-lookup"><span data-stu-id="e42c8-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="e42c8-152">Созданный объект сообщения отличается от объектов сообщений, обычно создаваемых поставщиками хранилища сообщений, в том, что он не поддерживает все методы интерфейса [iMessage: IMAPIProp](imessageimapiprop.md) , такие как **iMessage:: субмитмессаже**.</span><span class="sxs-lookup"><span data-stu-id="e42c8-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="e42c8-153">Необязательный входной параметр для **опенимсгонистг** — это функция обратного вызова, которая соответствует прототипу [мсгкаллрелеасе](msgcallrelease.md) .</span><span class="sxs-lookup"><span data-stu-id="e42c8-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="e42c8-154">Эта функция вызывается новым объектом Message, когда число ссылок сообщения достигает нуля.</span><span class="sxs-lookup"><span data-stu-id="e42c8-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="e42c8-155">Реализация функции **мсгкаллрелеасе** может быть полезной для выполнения завершающей обработки, прежде чем новое сообщение будет полностью удалено.</span><span class="sxs-lookup"><span data-stu-id="e42c8-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="e42c8-156">[Опенстреамонфиле](openstreamonfile.md) обычно используется для хранения вложенных файлов, так как создает поток, считывающий из файла и записывающий в него.</span><span class="sxs-lookup"><span data-stu-id="e42c8-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="e42c8-157">**Опенпроперти** с **пр_аттач_дата_бин** в качестве тега свойства создает поток для хранения данных двоичных вложений.</span><span class="sxs-lookup"><span data-stu-id="e42c8-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="e42c8-158">**Сжатие и распаковка потока, содержащего текст сообщения в формате RTF**</span><span class="sxs-lookup"><span data-stu-id="e42c8-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="e42c8-159">Клиенты вызывают [врапкомпресседртфстреам](wrapcompressedrtfstream.md).</span><span class="sxs-lookup"><span data-stu-id="e42c8-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="e42c8-160">**Врапкомпресседртфстреам** создает поток, который УПАКОВЫВАЕТ поток RTF.</span><span class="sxs-lookup"><span data-stu-id="e42c8-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="e42c8-161">В потоке-оболочке не реализованы все методы **IStream** ; исключены следующие методы: **Seek**, **SetSize**, revert, **локкрегион**, **унлоккрегион**, **stat**и **clone**. \*\*\*\*</span><span class="sxs-lookup"><span data-stu-id="e42c8-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="e42c8-162">Это связано с тем, что объекты потока, созданные в **врапкомпресседртфстреам** , не поддерживают метод **SetSize** или **stat**, но не существует простого способа для расширения или извлечения их размера.</span><span class="sxs-lookup"><span data-stu-id="e42c8-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="e42c8-163">Оптимальной стратегией является выбор приемлемого размера буфера и чтения или записи в цикле.</span><span class="sxs-lookup"><span data-stu-id="e42c8-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="e42c8-164">COM имеет реализацию объекта хранилища на основе массива байтов, который возвращает объект **иенумстатстг** из метода **енумелементс** , который является проблематичным.</span><span class="sxs-lookup"><span data-stu-id="e42c8-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="e42c8-165">В частности, метод **QueryInterface** работает неправильно.</span><span class="sxs-lookup"><span data-stu-id="e42c8-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="e42c8-166">Поставщики услуг, реализующие собственные объекты хранения с помощью реализации COM, должны создать тонкую оболочку для объекта **иенумстатстг** , который перенаправляет вызовы в базовые методы **иенумстатстг** , но реализует собственный \*\*AddRef. \*\*Методы **Release**, **QueryInterface**и **clone** .</span><span class="sxs-lookup"><span data-stu-id="e42c8-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  


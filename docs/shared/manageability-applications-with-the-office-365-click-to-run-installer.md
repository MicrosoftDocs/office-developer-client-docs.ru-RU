---
title: Интеграция приложений управления с установщиком Microsoft 365 приложений с помощью командлетов "нажми и работай"
manager: lindalu
ms.date: 09/28/2020
ms.audience: ITPro
localization_priority: Normal
ms.assetid: c0fa8fed-1585-4566-a9be-ef6d6d1b4ce8
description: Сведения о том, как интегрировать установщик приложений Microsoft 365 с помощью решения для управления программным обеспечением.
ms.openlocfilehash: eccd634f7906acf25b521ed2deb456ca914f37da
ms.sourcegitcommit: c8c51bd3f51c0a59fe44c014c8e56f1ba7c7aa03
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2020
ms.locfileid: "48297316"
---
# <a name="integrating-manageability-applications-with-microsoft-365-apps-click-to-run-installer"></a>Интеграция приложений управления с установщиком Microsoft 365 приложений с помощью командлетов "нажми и работай"

Сведения о том, как интегрировать установщик приложений Microsoft 365 с помощью решения для управления программным обеспечением.
  
Установщик приложений Microsoft 365 нажми и работай предоставляет интерфейс COM, который позволяет ИТ-специалистам и решениям управления программным способом управлять управлением обновлениями. Этот интерфейс предоставляет дополнительные возможности управления помимо того, что предоставляется средством развертывания Office.
  
> [!NOTE]
> Эта статья относится к приложениям Office, использующим установщик "нажми и работай". 
  
## <a name="integrating-with-the-click-to-run"></a>Интеграция с "нажми и работай"

Чтобы использовать этот интерфейс, приложение управляемости вызывает COM-интерфейс и вызывает интерфейсы API, напрямую взаимодействующие с службой установки "нажми и работай". 
  
> [!NOTE]
> Установщик Office нажми и работай можно запустить из командной строки с параметрами, которые могут управлять поведением, как описано в разделе [средство развертывания Office для "нажми и работай](https://docs.microsoft.com/DeployOffice/overview-office-deployment-tool)". 
  
**Ниже приведена концептуальная схема COM-интерфейса**

![Схема использования интерфейса COM в установщике Office нажми и работай.](media/e7ac2523-e67b-4a44-ae67-c048709f872a.png "Схема использования интерфейса COM в установщике Office "нажми и работай"")
  
Установщик приложений Microsoft 365 с поддержкой технологии "нажми и работай" реализует интерфейс на основе COM, **иупдатенотифи** зарегистрированный в CLSID **CLSID_UpdateNotifyObject**.
  
Этот интерфейс можно вызвать следующим образом:
  
```cpp
hr = CoCreateInstance(CLSID_UpdateNotifyObject, NULL, CLSCTX_ALL,
       IID_IUpdateNotify, 
      (void **)&p); 
```

Вызов будет успешным только в том случае, если вызывающий абонент работает с повышенными привилегиями, так как программа установки "нажми и работай" должна выполняться с повышенными привилегиями.
  
COM-интерфейс **иупдатенотифи** предоставляет три асинхронные функции, ответственные за проверку команд и параметров и выполнение планирования с помощью службы установки "нажми и работай". 
  
```cpp
HRESULT Download([in] LPWSTR pcwszParameters) // Download update content.
HRESULT Apply([in] LPWSTR pcwszParameters) // Apply update content.
HRESULT Cancel() // Cancel the download action.

```

Метод, **Status**, может использоваться для получения сведений о состоянии последней выполненной команды или о состоянии выполняемой в данный момент команды (например, успех, сбой, подробные коды ошибок).
  
```cpp
HRESULT status([out] _UPDATE_STATUS_REPORT* pUpdateStatusReport) // Get status of current action. 
typedef struct _UPDATE_STATUS_REPORT  
{  
UPDATE_STATUS status;  
UINT error; 
BSTR contentid;  
} UPDATE_STATUS_REPORT;

```

Во время жизненного цикла служба установки "нажми и работай" может находиться в четырех состояниях, в которых могут вызываться методы **иупдатенотифи** ; Перезагрузка, бездействие, Загрузка и применение. 
  
**Ниже показана схема конечного автомата COM-интерфейса**

![Схема состояний для интерфейса COM.](media/a409003e-6876-4ab3-bb4c-cd0c0fed5cbb.png "Схема состояний для интерфейса COM")
  
> [!NOTE]
> **Перезагрузка**: при загрузке компьютера в случае недоступности службы установки "нажми и работай" происходит определенный период времени. Успешный вызов метода status после перезагрузки приведет к возвращению eUPDATE_UNKNOWN. 
  
**Бездействие:** Когда установщик "нажми и работай" находится в состоянии простоя, вы можете вызвать: 
  
- **Apply**: установка ранее загруженного контента.
    
- **Cancel**: возвращает  `0x800000e` , "метод был вызван в непредвиденное время."
    
- **Download**: Загрузка нового контента в клиент для последующей установки.
    
- **Status**: возвращает результат последнего выполненного действия или сообщение об ошибке, если действие завершилось с ошибкой. Если предыдущее действие отсутствует, возвращается **состояние**  `eUPDATE_UNKNOWN` .
    
**Скачивание:** Когда установщик "нажми и работай" находится в состоянии загрузки, вы можете вызвать: 
  
- **Apply**: возвращает **HRESULT** со значением  `0x800000e` "метод был вызван в непредвиденное время".
    
- **Отмена**: остановка скачивания и удаление частично загруженного контента.
    
- **Download**: возвращает **HRESULT** со значением  `0x800000e` "метод был вызван в непредвиденное время". 
    
- **Status**: возвращает **DOWNLOAD_WIP** , чтобы указать, что выполняется загрузка. 
    
**Применение:** Когда установщик "нажми и работай" находится в процессе установки ранее загружаемого содержимого: 
  
- **Apply**: возвращает **HRESULT** со значением  `0x800000e` "метод был вызван в непредвиденное время".
    
- **Cancel**: возвращает  `0x800000e` , действие Apply не может быть отменено.
    
- **Download**: возвращает **HRESULT** со значением  `0x800000e` "метод был вызван в непредвиденное время". 
    
- **Status**: возвращает **APPLY_WIP** , указывающие на то, что выполняется работа. 
    
> [!NOTE]
> Так как OfficeC2RCOM является службой COM+ и динамически загружается, вам необходимо вызвать функцию **CoCreateInstance** при каждом вызове метода для этого класса, чтобы убедиться, что вы получаете ожидаемый результат. При необходимости служба COM+ будет обрабатывать создание нового экземпляра. Когда один из методов вызывается в первый раз, COM+ загрузит объект **иупдатенотифи** и запустит его в одном из экземпляров dllhost.exe. Новый объект остается активным в течение приблизительно 3 минут. Если последующий вызов выполняется через три минуты последнего вызова, объект **иупдатенотифи** останется загруженным, а новый экземпляр не будет создан. Если в течение трех минут ничего не происходит, объект Иупдатенотифи будет выгружен, а при следующем вызове будет создан новый объект **иупдатенотифи** . 
  
## <a name="click-to-run-installer-com-api-reference-guide"></a>Справочное руководство по API-интерфейсу API для установщика "нажми и работай"

В следующей справочной документации по API:
  
- Параметры представлены в формате "ключ-значение", разделенном пробелом.
    
- В параметрах регистр не учитывается.
    
- Существует [список параметров](https://blogs.technet.microsoft.com/odsupport/2014/03/03/the-new-update-now-feature-for-office-2013-click-to-run-for-office365-and-its-associated-command-line-and-switches/) , доступных в документации. 
    
- Сводка интерфейса IUpdateNotify2 теперь включена.
    
### <a name="apply"></a>Применить

```cpp
HRESULT Apply([in] LPWSTR pcwszParameters) // Apply update content.
```

#### <a name="parameters"></a>Параметры

-  _displaylevel_: **true** , чтобы показать состояние установки, включая ошибки, во время процесса обновления; **значение false** , чтобы скрыть состояние установки, включая ошибки, во время процесса обновления. Значение по умолчанию: **false**.
    
-  _forceappshutdown_: **true** для принудительного завершения работы приложений Office при запуске действия **Apply** ; в противном случае — **false** . Значение по умолчанию: **false**. Дополнительные [сведения см.](#bk_ApplyRemark) 
    
  Если какое-либо приложение Office запускается при запуске действия **Apply** , действие **Применить** обычно завершится с ошибками. Передача  `forceappshutdown=true` в метод **Apply** приведет к тому, что служба **оффицекликкторун** сразу же завершит работу приложений и применит обновление. В этом случае в работе пользователя могут возникать потери данных. 
    
#### <a name="return-results"></a>Возвращаемые результаты

|||
|:-----|:-----|
|**S_OK** <br/> |Действие успешно отправлено службе "нажми и работай" для выполнения.  <br/> |
|**E_ACCESSDENIED** <br/> |Вызывающий абонент не работает с повышенными привилегиями.  <br/> |
|**E_INVALIDARG** <br/> |Переданы недопустимые параметры.  <br/> |
|**E_ILLEGAL_METHOD_CALL** <br/> |В настоящее время действие не разрешено. Дополнительные [сведения см.](#bk_ApplyRemark)  <br/> |

<a name="bk_ApplyRemark"></a>

#### <a name="remarks"></a>Примечания

- Если какое-либо приложение Office запускается при запуске действия **Apply** , действие **Apply** завершится с ошибками. `forceappshutdown=true`При передаче в метод **Apply** служба **оффицекликкторун** немедленно завершит работу всех запущенных приложений Office и применить обновление. Пользователь может столкнуться с данными, так как они не получают запроса на сохранение изменений в открытых документах... 
    
- Это действие может быть вызвано только в том случае, если состоянием COM является один из следующих: 
    
  - **eUPDATE_UNKNOWN**
    
  - **eDOWNLOAD_CANCELLED**
    
  - **eDOWNLOAD_FAILED**
    
  - **eDOWNLOAD_SUCCEEDED**
    
  - **eAPPLY_SUCCEEDED**
    
  - **eAPPLY_FAILED**
    
- При вызове метода **Apply** без предварительной загрузки содержимого метод **Apply** будет сообщать об **успешном** завершении, так как он не обнаружил, что успешно применялся и завершил процесс **применения** . 
    
### <a name="cancel"></a>Отменить

```cpp
HRESULT Cancel() // Cancel the download action.
```

#### <a name="return-results"></a>Возвращаемые результаты

|||
|:-----|:-----|
|S_OK  <br/> |Действие успешно отправлено службе "нажми и работай" для выполнения.  <br/> |
|E_ILLEGAL_METHOD_CALL  <br/> |В настоящее время действие не разрешено. Для получения дополнительных сведений см раздел ["Примечания](#bk_CancelRemarks) ".  <br/> |

<a name="bk_CancelRemarks"></a>

#### <a name="remarks"></a>Примечания

- Этот метод можно запускать только при **eDOWNLOAD_WIP**идентификатора состояния com. Будет предпринята попытка отменить текущее действие скачивания. Состояние COM изменится на **eDOWNLOAD_CANCELLING** и в конечном итоге изменится на **eDOWNLOAD_CANCELED**. Состояние COM возвращает **E_ILLEGAL_METHOD_CALL** , если триггер запускается в любое другое время. 
    
### <a name="download"></a>Скачать

```cpp
HRESULT Download([in] LPWSTR pcwszParameters) // Download update content.
```

#### <a name="parameters"></a>Параметры

-  _displaylevel_: **true** , чтобы показать состояние установки, включая ошибки, во время процесса обновления; **значение false** , чтобы скрыть состояние установки, включая ошибки, во время процесса обновления. Значение по умолчанию: **false**.
    
-  _упдатебасеурл_: URL-адрес альтернативного источника скачивания.
    
-  _упдатетоверсион_: версия для обновления Office. Определите этот параметр, если необходимо обновить более старую версию, чем версия, установленная в данный момент.
    
-  _довнлоадсаурце_: CLSID настраиваемой реализации **ИБАККГРАУНДКОПИМАНАЖЕР** (диспетчер BITS). 
    
-  Идентификатор _ContentId_: определяет содержимое для загрузки с сервера контента через настраиваемый диспетчер BITS. Это значение передается через интерфейс BITS для интерпретации.
    
#### <a name="return-results"></a>Возвращаемые результаты

|||
|:-----|:-----|
|**S_OK** <br/> |Действие успешно отправлено службе "нажми и работай" для выполнения.  <br/> |
|**E_ACCESSDENIED** <br/> |Вызывающий абонент не работает с повышенными привилегиями.  <br/> |
|**E_INVALIDARG** <br/> |Переданы недопустимые параметры.  <br/> |
|**E_ILLEGAL_METHOD_CALL** <br/> |В настоящее время действие не разрешено. Дополнительные [сведения см.](#bk_DownloadRemark)  <br/> |

<a name="bk_DownloadRemark"></a>

#### <a name="remarks"></a>Примечания

- Необходимо указать  _довнлоадсаурце_ и идентификатор  _ContentId_ в виде связывания. В противном случае метод **download** возвратит ошибку **E_INVALIDARG** . 
    
- Если указаны  _довнлоадсаурце_,  _ContentId_и  _упдатебасеурл_ ,  _упдатебасеурл_ будет игнорироваться. 
    
- Это действие может быть вызвано только в том случае, если состоянием COM является один из следующих: 
    
  - **eUPDATE_UNKNOWN**
    
  - **eDOWNLOAD_CANCELLED**
    
  - **eDOWNLOAD_FAILED**
    
  - **eDOWNLOAD_SUCCEEDED**
    
  - **eAPPLY_SUCCEEDED**
    
  - **eAPPLY_FAILED**
    
- При вызове метода **Apply** без ранее скачанного содержимого метод **Apply** будет сообщать об **успешном** завершении, так как он не обнаружил, что успешно применялся и завершил процесс **применения** . 
    
#### <a name="examples"></a>Примеры

- Чтобы скачать содержимое из настраиваемого диспетчера BITS: вызовите функцию **скачать ()** , передав следующие параметры: 
    
  ```cpp
  "downloadsource=CLSIDofBITSInterface contentid=BITSServerContentIdentifier"
  ```

- Чтобы скачать содержимое из сети доставки содержимого Office (CDN): вызовите функцию **скачать ()** , не указывая параметры  _довнлоадсаурце_,  _ContentId_или  _упдатебасеурл_ . 
    
- Чтобы скачать содержимое из настраиваемого расположения: вызовите функцию **скачать ()** , передав следующий параметр: 
    
  ```cpp
  "updatebaseurl=yourcontentserverurl"
  ```

### <a name="status"></a>Статус

```cpp
typdef struct _UPDATE_STATUS_REPORT
{
    UPDATE_STATUS status;
    UINT error;
    LPCWSTR contentid;
}UPDATE_STATUS_REPORT;
HRESULT status([out] _UPDATE_STATUS_REPORT& pUpdateStatusReport) // Get status of current action
```

#### <a name="parameters"></a>Параметры

|||
|:-----|:-----|
| _пупдатестатусрепорт_ <br/> |Указатель на структуру UPDATE_STATUS_REPORT.  <br/> |
   
#### <a name="return-results"></a>Возвращаемые результаты

|||
|:-----|:-----|
|**S_OK** <br/> |Метод **Status** всегда возвращает этот результат. Проверка  `UPDATE_STATUS_RESULT` структуры на состояние текущего действия.  <br/> |
   
#### <a name="remarks"></a>Примечания

- В поле Status (состояние)  `UPDATE_STATUS_REPORT` содержится состояние текущего действия. Возвращается одно из следующих значений состояния: 
    
  ```cpp
  typedef enum _UPDATE_STATUS
  {
  eUPDATE_UNKNOWN = 0,
  eDOWNLOAD_PENDING,
  eDOWNLOAD_WIP,
  eDOWNLOAD_CANCELLING,
  eDOWNLOAD_CANCELLED,
  eDOWNLOAD_FAILED,
  eDOWNLOAD_SUCCEEDED,
  eAPPLY_PENDING,
  eAPPLY_WIP,
  eAPPLY_SUCCEEDED,
  eAPPLY_FAILED,
  } UPDATE_STATUS;
  
  ```

- Если последняя команда привела к ошибке, в поле ошибка  `UPDATE_STATUS_REPORT` содержится подробная информация об ошибке. В методе **Status** возвращается два типа кодов ошибок. 
    
- Если ошибка меньше  `UPDATE_ERROR_CODE::eUNKNOWN` , то ошибка является одним из следующих предварительно определенных кодов ошибок:
    
  ```cpp
  typedef enum _UPDATE_ERROR_CODE
  {
  eOK = 0,
  eFAILED_UNEXPECTED,
  eTRIGGER_DISABLED,
  ePIPELINE_IN_USE,
  eFAILED_STOP_C2RSERVICE,
  eFAILED_GET_CLIENTUPDATEFOLDER,
  eFAILED_LOCK_PACKAGE_TO_UPDATE,
  eFAILED_CREATE_STREAM_SESSION,
  eFAILED_PUBLISH_WORKING_CONFIGURATION,
  eFAILED_DOWNLOAD_UPGRADE_PACKAGE,
  eFAILED_APPLY_UPGRADE_PACKAGE,
  eFAILED_INITIALIZE_RSOD,
  eFAILED_PUBLISH_RSOD,
  // Keep this one as the last
  eUNKNOWN
  } UPDATE_ERROR_CODE;
  
  ```

  Если код ошибки возврата превышает значение  `UPDATE_ERROR_CODE::eUNKNOWN` **HRESULT** неудачного вызова функции. Чтобы извлечь значение HRESULT, вычитаемое  `UPDATE_ERROR_CODE::eUNKNOWN` из значения, которое возвращается в поле "ошибка"  `UPDATE_STATUS_REPORT` .
    
  Полный список значений состояния и ошибок можно просмотреть, изучив библиотеку типов **иупдатенотифи** , встроенную в OfficeC2RCom.dll. 
    
- Поле ContentId используется для вызовов с **состоянием** после **загрузки** и возвращает идентификатор ContentId, переданный в вызов **загрузки** . Рекомендуется инициализировать это поле до **значения NULL** перед вызовом метода **Status** , а затем проверить значение после того, как было возвращено значение **Status** . Если значение по-прежнему равно **null**, это означает, что идентификатор ContentId не возвращается. Если значение отлично от **null**, его необходимо освободить с помощью вызова **SysFreeString ()**. Ниже приведен фрагмент кода, посвященный вызову **состояния** после **загрузки**.
    
  ```cpp
  std::wstring contentID;
  UPDATE_STATUS_REPORT statusReport;
  statusReport.status = eUPDATE_UNKNOWN;
  statusReport.error = eOK;
  statusReport.contentid = NULL;
  hr = p->Status(&statusReport);
  if (statusReport.contentid != NULL)
  {
  contentID = statusReport.contentid;
  SysFreeString(statusReport.contentid);
  }
  wprintf(L"ContentID: %s, Status: %d, LastError: %d", contentID.c_str(), statusReport.status, statusReport.error);
  
  ```

### <a name="summary-of-iupdatenotify2-interface"></a>Сводка по интерфейсу IUpdateNotify2

Из версии [16.0.8208.6352] мы добавили новый интерфейс **IUpdateNotify2** . 
  
- CLSID_UpdateNotifyObject2 {52C2F9C2 — F1AC – 4021 – BF50.756A5FA8DDFE}
    
- Этот интерфейс также размещает исходный интерфейс Иупдатенотифи для обеспечения обратной совместимости. Это означает, что при использовании этого интерфейса вы можете получить доступ ко всем методам, предоставляемым в интерфейсе **упдатенотифйобжект** . 
    
- Новые методы, добавленные в IUpdateNotify2:
    
  - **HRESULT** Жетблоккингаппс ([выходной] BSTR \* аппслист). Получение списка заблокированных приложений для обновления. Этот вызов возвратит запуск приложений Office, которые будут блокировать процесс обновления. 
    
  - **HRESULT** Жетоффицедеплойментдата ([in] int dataType, [in] **значение LPCWSTR** пквсзнаме, [out] BSTR * оффицедата). Получение данных развертывания Office. 
    
- Если вы хотите использовать новые методы, необходимо убедиться в том, что:
    
  - Ваша версия C2R более новая, чем приведенная выше сборка (= с помощью \> построения разветвления за июнь).
    
  - Используйте UpdateNotifyObject2, а не **упдатенотифйобжект** , чтобы вызвать функцию **CoCreateInstance**.
    
Если вы не используете ни один из новых методов, вам не нужно ничего менять. Все существующие методы будут работать точно так же, как и раньше.
  
## <a name="implementing-the-bits-interface"></a>Реализация интерфейса BITS

[Фоновая интеллектуальная служба передачи](https://docs.microsoft.com/windows/win32/bits/background-intelligent-transfer-service-portal) (BITS) — это служба, предоставляемая корпорацией Майкрософт для передачи файлов между клиентом и сервером. BITS это один из каналов, которые может использовать установщик Office нажми и работай для загрузки контента. По умолчанию установщик Office 365 Apps нажми и работай использует встроенную в Windows реализацию BITS для загрузки содержимого из сети CDN. 
  
Предоставляя настраиваемую реализацию BITS методу **Download ()** интерфейса **иупдатенотифи** , программное обеспечение управления может управлять тем, где и как клиент загружает контент. Настраиваемый интерфейс BITS полезен при предоставлении настраиваемого канала распространения содержимого, отличного от встроенных каналов "нажми и работай", таких как CDN, серверы IIS или файловые ресурсы. 
  
Минимальное требование для настраиваемого интерфейса BITS для работы со службой Office C2R:
  
- Для **ибаккграундкопиманажер**:
    
  ```cpp
  HRESULT _stdcall CreateJob(
                      [in] LPWSTR DisplayName, 
                      [in] BG_JOB_TYPE Type, 
                      [out] GUID* pJobId, 
                      [out] IBackgroundCopyJob** ppJob)
  HRESULT _stdcall GetJob(
                      [in] GUID* jobID, 
                      [out] IBackgroundCopyJob** ppJob)
  HRESULT _stdcall EnumJobs(
                      [in] unsigned long dwFlags, 
                      [out] IEnumBackgroundCopyJobs** ppenum)
  
  ```

- Для **ибаккграундкопижоб**:
    
  ```cpp
  HRESULT _stdcall AddFile(
                      [in] LPWSTR RemoteUrl, 
                      [in] LPWSTR LocalName)
  HRESULT _stdcall Resume()
  HRESULT _stdcall Complete()
  HRESULT _stdcall Cancel();
  HRESULT _stdcall GetState([out] BG_JOB_STATE* pVal);
  HRESULT GetProgress( [out] BG_JOB_PROGRESS *pProgress);
  
  ```

- Для **IBackgroundCopyJob3**:
    
  ```cpp
  HRESULT _stdcall AddFileWithRanges(
                      [in] LPWSTR RemoteUrl, 
                      [in] LPWSTR LocalName,
                      [in] DWORD RangeCount,
                      [in] BG_FILE_RANGE Ranges[])
  
  ```

- Для  `Addfile` функций и  `AddFileWithRanges` функции and удаленный URL-адрес имеет следующий формат: 
    
  ```cpp
  cmbits://<contentid>/<relative path to target file>
  ```

  - кмбитс жестко запрограммирована, а обозначает настроенные биты.
    
  -  _\<contentid\>_ — Это параметр  _ContentId_ для метода **Download ()** . 
    
  -  _\<relative path to target file\>_ Указывает расположение и имя файла, который требуется скачать. 
    
    Например, если вы указали объект  _ContentId_  `f732af58-5d86-4299-abe9-7595c35136ef` для метода **Download ()** , и Office C2R хочет скачать CAB-файл версии, например  `v32.cab` File, он вызовите **аддфиле ()** , выполнив следующие  `RemoteUrl` действия:
    
  ```cpp
  cmbits://f732af58-5d86-4299-abe9-7595c35136ef/Office/Data/V32.cab
  ```

- Для **ибаккграундкоперрор**:
    
  ```cpp
  HRESULT _stdcall GetErrorDescription(
        [in]  DWORD  LanguageId,
        [out] LPWSTR *ppErrorDescription);
  
  ```

- Для **ибаккграундкопифиле**:
    
  ```cpp
  HRESULT _stdcall GetLocalName([out] LPWSTR *ppName); 
  HRESULT _stdcall GetRemoteName([out] LPWSTR *ppName);
  
  ```
## <a name="automating-content-staging"></a>Автоматизация промежуточного хранения контента

ИТ — администраторы могут разрешить клиентам для настольных ПК автоматически получать обновления, когда они доступны непосредственно из сети CDN, или управлять развертыванием обновлений, доступных в каналах обновления с помощью средства развертывания Office или диспетчера конфигураций конечных точек Майкрософт.
  
Служба поддерживает возможность средств управления определять и автоматизировать загрузку контента при наличии обновлений.
  
**На следующем рисунке представлен обзор загрузки настраиваемого изображения.**

![Схема использования интерфейса COM в установщике Office нажми и работай.](media/e7ac2523-e67b-4a44-ae67-c048709f872a.png "Схема использования интерфейса COM в установщике Office "нажми и работай"")
  
### <a name="overview-of-downloading-a-custom-image"></a>Обзор загрузки настраиваемого изображения
  
На предыдущей схеме вы увидите, что новый образ приложений Microsoft 365 доступен в сети CDN. Вместе с изображением приложений Microsoft 365 доступен API, который содержит сведения, необходимые для включения программного обеспечения управления для непосредственного создания настраиваемых образов, которые заменяют необходимость использования средства развертывания Office.

Предприятие настраивает свои WSUS для синхронизации обновлений приложений Microsoft 365. Эти обновления не содержат полезных данных изображения, но позволяют программному обеспечению для управления распознать, когда будет доступен новый контент. Программное обеспечение для управления может прочитать метаданные обновления приложений Microsoft 365, чтобы узнать, к какой версии Office относится обновление.

Если обновление возможно, программное обеспечение для управления может использовать содержимое CDN и список файлов для создания настраиваемого образа и сохранения его в расположении общего файлового ресурса, который он использует.
  
### <a name="using-the-microsoft-365-apps-file-list-api"></a>Использование API списка файлов приложений Microsoft 365

API списка файлов приложений Microsoft 365 используется для получения имен файлов, необходимых для конкретного обновления приложений Майкрософт 365.

HTTP-запрос

GET https://config.office.com/api/filelist

Не указывайте текст запроса для этого метода.

Для вызова этого API не требуется никаких разрешений.

Необязательные параметры запросов

|**Имя**|**Описание**|
|:-----|:-----|
| channel <br/>| Указывает имя канала  <br/> Необязательный — по умолчанию "полугодовые" <br/> Поддерживаемые значения https://docs.microsoft.com/DeployOffice/office-deployment-tool-configuration-options#channel-attribute-part-of-add-element |
| version <br/>| Указывает версию обновления <br/> Необязательный параметр — значение по умолчанию для последней версии, доступной для указанного канала |
| зубц <br/>| Определяет архитектуру клиента <br/> Необязательный параметр — значение по умолчанию: "x64" <br/> Поддерживаемые значения: x64, x86 |
| действие <br/>| Указывает языковые файлы, которые необходимо включить <br/> Необязательный параметр — значение по умолчанию — None <br/> Чтобы указать несколько языков, включите параметр запроса на закрышку для каждого языка <br/> Используйте формат идентификатора языка, например, "en $ US", "fr – FR" |
| алллангуажес <br/>| Включение всех языковых файлов <br/> Необязательный параметр — значение по умолчанию — false. |

HTTP-ответ

В случае успешного выполнения этот метод возвращает код отклика 200 ОК и коллекцию объектов File в тексте отклика.

Чтобы создать изображение, выполните следующие действия:
1.  Вызовите API, предоставив соответствующие параметры запроса для канала, версии и архитектуры интересующего обновления.
Note: объекты File с атрибутом "LCID": "0" — это независимые от языка файлы, которые должны быть включены в образ.
2.  Создайте локальное изображение сети CDN, переполнив все объекты File и скопировав файлы CDN, создавая структуру папок в соответствии с атрибутом "Релативепас", определенным для каждого объекта File.

В следующем примере извлекается список файлов для текущего канала и версия 16.0.4229.1004 для 64 64, а также файлы на французском и английском языках:

```http
Get https://config.office.com/api/filelist?Channel=Current&Version=16.0.4229.1004&Arch=x64&Lid=fr-fr&Lid=en-US
```

### <a name="hash-verification-of-dat-files"></a>Проверка хэша файлов DAT

Средства создания изображений могут проверить целостность скачанных файлов DAT, сравнив вычисленное значение хэша с заданным хэшем со значением, сопоставленным с каждым из DAT-файлов. Ниже приведен пример объекта File, который определяет значения Хашлокатион и Хашалгорисм:
  
```xml
{
  "url": "https://officecdn.microsoft.com/pr/7ffbc6bf-bc32-4f92-8982-f9dd17fd3114/office/data/16.0.1234.1001/stream.x64.x-none.dat",
  "name": "stream.x64.x-none.dat",
  "relativePath": "/office/data/16.0.1234.1001/",
  "hashLocation": "s640.cab/stream.x64.x-none.hash",
  "hashAlgorithm": "Sha256",
  "lcid": "0"
},
```

- Атрибут **хашлокатион** указывает расположение относительного пути CAB-файла, который содержит хэш-значение. Создайте расположение хэш-файла с помощью сцепления URL + Релативепас + Хашлокатион. В следующем примере расположение stream.x64.bg-bg. hash будет следующим: 
    
  ```http
  https://officecdn.microsoft.com/pr/492350f6-3a01-4f97-b9c0-c7c6ddf67d60/office/data/16.0.4229.1004/s641026.cab/stream.x64.bg-bg.hash 
  ```

- Атрибут **хашалгорисм** указывает, какой алгоритм хеширования использовался. 
    
  Чтобы проверить целостность файла stream.x64.bg-БГ. dat, откройте stream.x64.bg-bg. hash и прочтите хэш-значение, которое является первой строкой текста в хэш-файле. Сравните это с вычисленным значением хэша (с использованием указанного алгоритма хеширования), чтобы проверить целостность загруженного файла. dat.
    
  В следующем примере показан код C# для считывания хеша.
    
  ```cs
    string[] readHashes = System.IO.File.ReadAllLines(tmpFile, Encoding.Unicode);
    string readHash = readHashes.First();
  ```

### <a name="microsoft-365-apps-updates"></a>Обновления для приложений Microsoft 365

Все обновления для приложений Microsoft 365 опубликованы в [каталоге обновлений Майкрософт](https://www.catalog.update.microsoft.com/Search.aspx?q=office+365+client).
  
Обновления для приложений Microsoft 365 позволяют программному обеспечению программного обеспечения обрабатывать обновления для приложений Microsoft 365 аналогично любому другому обновлению WU с одним исключением; обновления клиента не содержат реальных полезных данных. Обновления для приложений Microsoft 365 не должны устанавливаться на всех клиентах, а использовать для запуска рабочих процессов с программным обеспечением с программным обеспечением, заменив команду установки на механизм установки на основе COM, показанный выше.

**На следующем рисунке показана схема рабочего процесса обновления клиента Office 365.**

![Схема рабочего процесса для обновлений клиента O365PP.](media/bc8092b0-62b8-402c-a5c0-04d55cca01d4.png "Схема рабочего процесса для обновлений клиента O365PP")
  
Каждое публикуемое обновление приложений Microsoft 365 содержит метаданные об обновлении. Эти метаданные содержат параметр с именем Мореинфаурл, который можно использовать для получения вызова API списка файлов для этого конкретного обновления.

В следующем примере API списка файлов внедряется в Мореинфаурл и начинается с "Сервицепас ="

http://go.microsoft.com/fwlink/?LinkId=626090&Ver=16.0.12527.21104&Branch=Insiders&Arch=64&XMLVer=1.6&xmlPath=http://officecdn.microsoft.com/pr/wsus/ofl.cab&xmlFile=O365Client_64bit.xml& Сервицепас =https://config.office.com/api/filelist?Channel=Insiders&Version=16.0.12527.21104&Arch=64&AllLanguages=True
  
### <a name="additional-metadata-for-automating-content-staging"></a>Дополнительные метаданные для автоматизации промежуточного хранения контента

**API истории выпуска**
  
API истории выпуска приложений Microsoft 365 используется для получения сведений о каждом обновлении, опубликованном в сети CDN, вместе с именами каналов и другими атрибутами канала.

HTTP-запрос

```http
GET https://config.office.com/api/filelist/channels 
```

Не указывайте текст запроса для этого метода.

Для вызова этого API не требуется никаких разрешений.

HTTP-ответ

В случае успешного выполнения этот метод возвращает код отклика 200 ОК и коллекцию объектов File в тексте отклика.

**API SKU**
  
API SKU возвращает сведения, которые помогут определить, какие продукты доступны для развертывания и обслуживания из сети CDN Office, а также различные варианты для каждого из них.

HTTP-запрос

```http
GET https://config.office.com/api/filelist/skus 
```

Не указывайте текст запроса для этого метода.

Для вызова этого API не требуется никаких разрешений.

HTTP-ответ

В случае успешного выполнения этот метод возвращает код отклика 200 ОК и коллекцию объектов File в тексте отклика.

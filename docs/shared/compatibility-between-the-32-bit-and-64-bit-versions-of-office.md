---
title: Совместимость 32- и 64-разрядных версий Office
ms.date: 04/27/2016
ms.audience: ITPro
localization_priority: Normal
ms.assetid: ff49dc9e-daf8-43cf-8802-51c2537ed561
description: Узнайте, как 32-разрядной версии Office совместим с 64-разрядной версии Office.
ms.openlocfilehash: 924f7a1aa891addc5841e6cdefc5226dcb056096
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2018
ms.locfileid: "19813067"
---
# <a name="compatibility-between-the-32-bit-and-64-bit-versions-of-office"></a>Совместимость 32- и 64-разрядных версий Office

Узнайте, как 32-разрядной версии Office совместим с 64-разрядной версии Office.
  
Приложения Office доступны в 32-разрядной и 64-разрядных версиях. 
  
64-разрядных версиях Office позволяют перемещать больше данных для повышения возможности, например, при работе с большим количеством в Microsoft Excel 2010. При создании кода 32-разрядная версия, можно использовать 64-разрядной версии Office без изменений. Тем не менее, при написании кода 64-разрядная версия, необходимо убедиться, что код содержит определенные ключевые слова и констант условной компиляции, чтобы убедиться, что код входит обратную совместимость с более ранней версии Office, и что правильный код выполняется, если вы Использование 32-разрядных и 64-разрядная версия кода.
  
Visual Basic для приложений 7.0 (VBA 7) выпущена в 64-разрядных версиях для Office и работает с 32-разрядной и 64-разрядных приложений. Изменения, описанные в этой статье применимы только для 64-разрядных версиях Office. Использование 32-разрядных версиях enable Microsoft Office для использования решений созданных в предыдущих версиях Office без дальнейших изменений.
  
> [!NOTE]
> По умолчанию при установке 64-разрядной версии Office, вам также установить 32-разрядная версия устанавливается вместе с 64-разрядной системе. Необходимо явно задать параметр установки Microsoft Office 64-разрядные версии. 
  
В VBA 7 необходимо обновить существующие операторов Windows API (инструкции**Declare** ) для работы с 64-разрядной версии. Кроме того необходимо обновить указатели адрес и отображение дескрипторы окон в пользовательских типов, которые использует эти инструкции. Эта процедура рассматривается более подробно в этой статье также проблемы совместимости между 32-разрядной и 64-разрядных версий и рекомендуемые решения. 
  
## <a name="comparing-32-bit-and-64-bit-systems"></a>Сравнение 32-разрядной и 64-разрядных систем
<a name="odc_office_Compatibility32bit64bit_Comparing32BitSystemsto64BitSystems"> </a>

Приложения, созданные с помощью 64-разрядных версиях Office можно ссылаться на большего адресного пространства, чем 32-разрядные версии. Это означает, которые можно использовать для данных, чем прежде чем физическую память, потенциально уменьшая нагрузку, затраченное на перенос данных и выходить из нее физической памяти
  
В дополнение к ссылке (известную как указатели) определенного расположения в физической памяти, можно также использовать адреса для отображения окна идентификаторы (известную как значками) ссылки. Размер (в байтах) указателя или дескриптора зависит от того, используется ли в 32-разрядная или 64-разрядная версия системы. 
  
Если вы хотите запустить существующих решений с 64-разрядных версий Office, необходимо учитывать следующее:
  
- Собственные 64-разрядные процессы в Office не удается загрузить 32-разрядных двоичных файлов. Это должен быть распространенные проблемы при наличии существующих элементов управления Microsoft ActiveX и существующих надстроек.
    
- VBA ранее не имеют тип данных указатель, поэтому было необходимо использовать 32-разрядная версия переменных для хранения указателей и дескрипторов. Теперь эти переменные усекать 64-разрядная версия значения, возвращаемые вызовов API при использовании инструкции **Declare** . 
    
## <a name="vba-7-code-base"></a>Базу кода VBA 7
<a name="odc_office_Compatibility32bit64bit_IntroducingVBA7CodeBase"> </a>

VBA 7 заменяет кода VBA в Office 2007 и более ранних версий. VBA 7 доступна в 32-разрядной и 64-разрядных версиях Office. Она предоставляет два константы условной компиляции: 
  
- **VBA7** - помогает обеспечить обратной совместимости кода путем тестирования ли ваше приложение использует VBA 7 или предыдущей версии VBA. 
    
- **Win64** Проверяет, является ли код выполняется как 32-разрядная или 64-разрядная версия. 
    
С определенными исключениями макросов в документе, которые работают в 32-разрядная версия приложения также работать в 64-разрядной версии.
  
## <a name="activex-control-and-com-add-in-compatibility"></a>Элемент управления ActiveX и надстройки COM и совместимость
<a name="odc_office_Compatibility32bit64bit_ActiveXControlCOMAddinCompatibility"> </a>

Существующие элементы управления ActiveX 32-разрядная версия, не совместимы с 64-разрядных версиях Office. Для элементов управления ActiveX и COM-объектов:
  
- Если у вас есть исходный код, создайте 64-разрядная версия самостоятельно.
- Если у вас нет исходного кода, обратитесь к производителю за обновленной версией.
    
Собственные 64-разрядные процессы в Office не удается загрузить 32-разрядных двоичных файлов. Сюда входят общие элементы управления **MSComCtl** (TabStrip, панель инструментов, строка состояния, ProgressBar, TreeView, ListViews, ImageList, ползунок, ImageComboBox) и элементы управления **MSComCt2** (анимации "Счетчик", управления MonthView, DateTimePicker, FlatScrollBar). Эти элементы управления были установлены с 32-разрядных версиях Office до Office 2010. Вам потребуется найти альтернативы для существующих решений VBA, использующие эти элементы управления при переходе код на 64-разрядных версиях Office. 
  
## <a name="api-compatibility"></a>API совместимости
<a name="odc_office_Compatibility32bit64bit_ApplicationProgrammingInterfaceCompatibility"> </a>

Сочетание библиотек VBA и тип предоставляет многие функции для создания приложения на базе Office. Тем не менее в некоторых случаях вы должны напрямую связываются с операционной системы и других компонентов, таких как при управлении памяти или процессами, при работе с windows linke элементы пользовательского интерфейса и элементов управления, либо при изменении реестра Windows. В следующих ситуациях лучше использовать одну из внешних функций, внедренных в DLL-файлы. Для этого в VBA путем вызова API, с помощью инструкции **Declare** . 
  
> [!NOTE]
> Корпорация Майкрософт предоставляет Win32API.txt файл, содержащий 1500 инструкции Declare и средства для копирования оператор **Declare** , который будет в коде. Тем не менее, эти инструкции для 32-разрядных систем и должен быть преобразован в 64-разрядная версия с помощью сведений, представленных далее в этой статье. Существующие инструкции **Declare** не компиляции в 64-разрядных версиях VBA, пока они помечены как безопасные для 64-разрядная версия с помощью атрибута **PtrSafe** . Примеры этого типа преобразования можно найти на веб-сайте Jan Karel Excel со статусом MVP Pieterse по [http://www.jkp-ads.com/articles/apideclarations.asp](http://www.jkp-ads.com/articles/apideclarations.asp). [Руководство пользователя инспектор совместимости кода Office](http://technet.microsoft.com/en-us/library/ee833946%28office.14%29.aspx) полезно для проверки синтаксиса инструкции API **Declare** для атрибута **PtrSafe** при необходимости и соответствующий тип возвращаемого значения. 
  
Операторы **Declare** похожи на один из следующих действий в зависимости от того, вызывается подпрограмма (без возвращаемого значения) или функция (имеют возвращаемое значение). 
  
```vb
Public/Private Declare Sub SubName Lib "LibName" Alias "AliasName" (argument list)
Public/Private Declare Function FunctionName Lib "Libname" alias "aliasname" (argument list) As Type

```

Функция **Дополнительное_имя** или функция **имяФункции** заменяется реальное имя процедуры в DLL-файла и представляет имя, которое используется при вызове процедуры из кода VBA. Можно также указать аргумент **AliasName** для имени процедуры. Имя DLL-файла, который содержит вызываемой процедуры следует ключевое слово **Lib** . И наконец, список аргумент содержит параметры и типы данных, которые нужно передать в процедуру. 
  
Следующий оператор **Declare** открывает *подраздел* реестра Windows и заменяет его значение. 
  
```vb
Declare Function RegOpenKeyA Lib "advapi32.dll" (ByVal Key As Long, ByVal SubKey As String, NewKey As Long) As Long
```

Запись Windows.h (дескриптор окна) для функции **RegOpenKeyA** выглядит следующим образом. 
  
```vb
LONG RegOpenKeyA ( HKEY hKey, LPCSTR lpSubKey, HKEY *phkResult );
```

В Visual C и Microsoft Visual C++ предыдущий пример компилируется правильно для 32- и 64-разрядная версия. Это HKEY определяется как указатель, размер которого отражает объем памяти платформы, код компилируется в.
  
В предыдущих версиях VBA возникла тип данных не определенный указатель, поэтому использовать тип данных **Long** . И так как тип данных **Long** всегда используется 32-разрядной, этот разрывов при использовании в системе с 64-разрядных, так как верхнем 32 разряда может усекаться или перезаписать другие адреса памяти. Любой из этих ситуаций можно привести непредсказуемое поведение и сбоям системы. 
  
Чтобы решить эту проблему, VBA включает в себя тип данных true *указатель* : **LongPtr**. Этот новый тип данных позволяет создавать исходный оператор **Declare** правильно как: 
  
```vb
Declare PtrSafe Function RegOpenKeyA Lib "advapire32.dll" (ByVal hKey as LongPtr, ByVal lpSubKey As String, phkResult As LongPtr) As Long
```

Этот тип данных и новый атрибут **PtrSafe** позволяют использовать этот оператор **Declare** в 32-разрядная или 64-разрядных системах. Атрибут **PtrSafe** указывает компилятора VBA, что оператор **Declare** предназначен для 64-разрядной версии Office. Если этот атрибут не с помощью оператора **Declare** в системе с 64-разрядная версия приведет к ошибке компиляции. Атрибут **PtrSafe** является необязательным на 32-разрядной версии Office. Это позволяет работать, как у существующего выражения **Declare** . 
  
В следующей таблице представлены дополнительные сведения о новых квалификатор и typeas данных, а также другой тип данных, два операторы преобразования и три функции.
  
|Тип|Элемент|Описание|
|:-----|:-----|:-----|
|Квалификатор  <br/> |**PtrSafe** <br/> |Обозначает, что оператор **Declare** совместим с 64-разрядными системами. Этот атрибут обязателен для 64-разрядных систем.<br/> |
|Тип данных  <br/> |**LongPtr** <br/> |Тип данных переменной, которой имеет тип данных 4 байта в 32-разрядных версий и типа данных 8 байтов в 64-разрядных версиях системы Microsoft Office. Это рекомендуемый способ объявления указатель или дескриптор для нового кода, но также для кода прежних версий, если оно должно работать в 64-разрядной версии Office. Это только поддерживаемые в среде выполнения VBA 7 в 32-разрядной и 64-разрядная версия. Обратите внимание на то, что можно назначить числовых значений его, но не числовые типы.  <br/> |
|Тип данных  <br/> |**LongLong** <br/> |Это относится к типу данных 8 байтов, которое доступно только в 64-разрядных версиях системы Microsoft Office. Можно назначить числовые значения, но не числовые типы (во избежание усечения).  <br/> |
|Оператор преобразования  <br/> |**CLngPtr** <br/> |Преобразует простое выражение в тип данных **LongPtr**.  <br/> |
|Оператор преобразования  <br/> |**CLngLng** <br/> |Преобразует простое выражение в тип данных **LongLong**.  <br/> |
|Функция  <br/> |**VarPtr** <br/> |Преобразователь вариантов. Возвращает тип **LongPtr** для 64-разрядных версий и тип **Long** для 32-разрядных версий (4 байта).<br/> |
|Функция  <br/> |**ObjPtr** <br/> |Преобразователь объектов. Возвращает тип **LongPtr** для 64-разрядных версий и тип **Long** для 32-разрядных версий (4 байта).<br/> |
|Функция  <br/> |**StrPtr** <br/> |Преобразователь строк. Возвращает тип **LongPtr** для 64-разрядных версий и тип **Long** для 32-разрядных версий (4 байта).<br/> |
   
В следующем примере показано, как использовать эти элементы в операторе **Declare**. 
  
```vb
Declare PtrSafe Function RegOpenKeyA Lib "advapi32.dll" (ByVal Key As LongPtr, ByVal SubKey As String, NewKey As LongPtr) As Long
```

Обратите внимание, что операторы **Declare** без атрибута **PtrSafe** предполагается, что не совместимы с 64-разрядной версии Office. 
  
Существует две константы условной компиляции: **VBA7** и **Win64**. Для обеспечения обратной совместимости с предыдущими версиями Microsoft Office, используйте константу **VBA7** (это обычно case) для предотвращения использования в более ранней версии Office 64-разрядного кода. Для кода, который различие между 32-разрядная и 64-разрядная версия, такие как вызова math API, которое использует **LongLong** для 64-разрядной версии и **времени** для его 32-разрядная версия используйте константу **Win64** . Приведенный ниже код показывает использование этих двух констант. 
  
```vb
#if Win64 then
   Declare PtrSafe Function MyMathFunc Lib "User32" (ByVal N As LongLong) As LongLong
#else
   Declare Function MyMathFunc Lib "User32" (ByVal N As Long) As Long
#end if
#if VBA7 then
   Declare PtrSafe Sub MessageBeep Lib "User32" (ByVal N AS Long)
#else
   Declare Sub MessageBeep Lib "User32" (ByVal N AS Long)
#end if
```

В целом, если писать код 64-разрядная версия и планируется использовать его в предыдущих версиях Office, необходимо использовать **VBA7** константа условной компиляции. Тем не менее при написании кода 32-разрядная версия пакета Office этот код работает как в предыдущих версиях Office без необходимости константы компиляции. Если вы хотите убедиться, что используется 32-разрядная версия операторов для 32-разрядных версий и 64-разрядная версия операторов для 64-разрядных версий, лучше использовать константа условной компиляции **Win64** . 
  
## <a name="using-conditional-compilation-attributes"></a>Использование атрибутов условной компиляции
<a name="odc_office_Compatibility32bit64bit_UsingConditionalCompilationAttributes"> </a>

Пример кода VBA, написанные для 32-разрядная версия, которую требуется обновить. Обратите внимание на то типы данных в прежних версий кода, которые обновляются для использования **LongPtr** , так как они ссылаются на обработчика или указателя. 
  
### <a name="vba-code-written-for-32-bit-versions"></a>Код VBA, написанные для 32-разрядные версии
  
```vb
Declare Function SHBrowseForFolder Lib "shell32.dll" _
  Alias "SHBrowseForFolderA" (lpBrowseInfo As BROWSEINFO) As Long
  
Public Type BROWSEINFO
  hOwner As Long
  pidlRoot As Long
  pszDisplayName As String
  lpszTitle As String
  ulFlags As Long
  lpfn As Long
  lParam As Long
  iImage As Long
End Type
```

### <a name="vba-code-rewritten-for-64-bit-versions"></a>Код VBA, переопределяются для 64-разрядных версий
  
```vb
#if VBA7 then    ' VBA7 
Declare PtrSafe Function SHBrowseForFolder Lib "shell32.dll" _
  Alias "SHBrowseForFolderA" (lpBrowseInfo As BROWSEINFO) As Long
Public Type BROWSEINFO
  hOwner As LongPtr
  pidlRoot As Long
  pszDisplayName As String
  lpszTitle As String
  ulFlags As Long
  lpfn As LongPtr
  lParam As LongPtr
  iImage As Long
End Type
 
#else    ' Downlevel when using previous version of VBA7
Declare Function SHBrowseForFolder Lib "shell32.dll" _
  Alias "SHBrowseForFolderA" (lpBrowseInfo As BROWSEINFO) As Long
Public Type BROWSEINFO
  hOwner As Long
  pidlRoot As Long
  pszDisplayName As String
  lpszTitle As String
  ulFlags As Long
  lpfn As Long
  lParam As Long
  iImage As Long
End Type
 
#end if
Sub TestSHBrowseForFolder ()
    Dim bInfo As BROWSEINFO
    Dim pidList As Long
    bInfo.pidlRoot = 0&amp;
    bInfo.ulFlags = &amp;H1
    pidList = SHBrowseForFolder(bInfo)
End Sub
```

<a name="odc_office_Compatibility32bit64bit_FrequentlyAskedQuestions"> </a>

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

#### <a name="when-should-i-use-the-64-bit-version-of-office"></a>Когда следует использовать 64-разрядной версии Office?
  
Эта функция больше используется независимо от того, какие приложения узла (Excel, Word и т. д.). Например Excel будет обрабатывать намного более листов с 64-разрядная версия Microsoft Office.
  
#### <a name="can-i-install-64-bit-and-32-bit-versions-of-office-side-by-side"></a>Как установить 32-разрядной и 64-разрядных версий Office одновременно?
  
Нет.
  
#### <a name="when-should-i-convert-long-parameters-to-longptr"></a>Когда следует преобразовать длинные параметры в LongPtr
  
Следует проверить документация по Windows API в сети разработчиков Microsoft функции, которую нужно позвонить. Маркеры и указатели нужно преобразовать в **LongPtr**. Например документации по [RegOpenKeyA](http://msdn.microsoft.com/library/c8a590f2-3249-437f-a320-c7443d42b792.aspx) предоставляет следующую подпись: 
  
```cs
LONG WINAPI RegOpenKeyEx(
  __in        HKEY hKey,
  __in_opt    LPCTSTR lpSubKey,
  __reserved  DWORD ulOptions,
  __in        REGSAM samDesired,
  __out       PHKEY phkResult
);
```

Параметры имеют следующее значение.
  
|Параметр|Описание|
|:-----|:-----|
|hKey [in]  <br/> |*Обработка* открыть раздел реестра.  <br/> |
|lpSubKey [в, необязательно]  <br/> |Имя подраздела реестра, чтобы открыть.  <br/> |
|ulOptions  <br/> |Этот параметр зарезервирован и должно быть равно нулю.  <br/> |
|samDesired [in]  <br/> |Маска, указывающая требуемые права доступа к ключу.  <br/> |
|phkResult [out]  <br/> |*Указатель* на переменную, которая получает маркер открытого ключа.  <br/> |
   
В [Win32API_PtrSafe.txt](http://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=035b72a5-eef9-4baf-8dbc-63fbd2dd982b)оператор **Declare** определяются следующим образом. 
  
```vb
Declare PtrSafe Function RegOpenKeyEx Lib "advapi32.dll" Alias "RegOpenKeyExA" (ByVal hKey As LongPtr , ByVal lpSubKey As String, ByVal ulOptions As Long, ByVal samDesired As Long, phkResult As LongPtr ) As Long
```

#### <a name="should-i-convert-pointers-and-handles-in-structures"></a>Преобразование указателей и дескрипторов в структуры?
  
Да. Просмотрите тип **сообщений** в Win32API_PtrSafe.txt: 
  
```vb
Type MSG
    hwnd As LongPtr 
    message As Long
    wParam As LongPtr 
    lParam As LongPtr 
    time As Long
    pt As POINTAPI
End TypeF
```

#### <a name="when-should-i-use-strptr-varpt-and-objptr"></a>Когда следует использовать strptr, varpt и objptr?
  
Эти функции следует использовать для получения указатели строк, переменных и объектов, соответственно. 64-разрядной версии Office эти функции возвращают в 64-разрядная версия **LongPtr**, который может быть передан инструкции **Declare** . Использование этих функций не был изменен в предыдущих версиях VBA. Единственное отличие — это теперь возвращают **LongPtr**.
  
## <a name="see-also"></a>См. также
<a name="odc_office_Compatibility32bit64bit_AdditionalResources"> </a>

- [Анатомия оператор Declare](https://msdn.microsoft.com/en-us/library/office/aa671659.aspx)
    

